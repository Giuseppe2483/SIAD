CREATE OR REPLACE PACKAGE DWH_EDW_FSALM."PKG_DWH_DET_FSALM" is

  -- Author  : ALBERTO.GIOVANNELLI
  -- Created : 21/09/2022 09:45:14
  -- Purpose :

  -- Public type declarations
  --type <TypeName> is <Datatype>;

  -- Public constant declarations
  --<ConstantName> constant <Datatype> := <Value>;

  -- Public variable declarations
  --<VariableName> <Datatype>;

  -- Public function and procedure declarations
  --function <FunctionName>(<Parameter> <Datatype>) return <Datatype>;
PROCEDURE PRC_INS_TAB_LOG_ETL(
                  P_IN_TYP_LOG   TAB_LOG_ERR.TIPO_LOG%TYPE,
                  P_IN_COD_LOG   TAB_LOG_ERR.COD_ERR%TYPE,
                  P_IN_MSG_LOG   TAB_LOG_ERR.DES_LOG%TYPE,
                  P_IN_COD_LOG_ORA   TAB_LOG_ERR.COD_ERR_ORA%TYPE,
                  P_IN_MSG_LOG_ORA   TAB_LOG_ERR.DES_ERR_ORA%TYPE--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );
 FUNCTION stacco_sk ( sk in number, k in number) return number;
 procedure prc_dim_reg (Param in varchar2);
  procedure prc_dim_tipocampo (Param in varchar2);
  procedure prc_dim_asl (Param in varchar2);
  procedure prc_dim_legref (Param in varchar2);
  procedure prc_dim_sampstr (Param in varchar2);
  procedure prc_dim_progtyp (Param in varchar2);
  procedure prc_dim_sampmd (Param in varchar2);
  procedure prc_dim_samplr(Param in varchar2);
  --procedure prc_dim_smpnt_vig(Param in varchar2);
  procedure prc_dim_smpnt_ita(Param in varchar2);
  procedure prc_dim_sampuntyp(Param in varchar2);
  procedure prc_dim_nonidon(Param in varchar2);
  procedure prc_dim_modallev(Param in varchar2);
  procedure prc_dim_mtxtyp(Param in varchar2);
  procedure prc_dim_MTX_VMPR_IT(Param in varchar2);
  procedure prc_dim_country(Param in varchar2);
  procedure prc_dim_laboratori (Param in varchar2);
  procedure prc_dim_paramtyp (Param in varchar2);
  procedure prc_DIM_PARAM_VMPR_IT (Param in varchar2);
  procedure prc_DIM_PARAM_VMPR_IT_test (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_ANIMAL_AGE (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_COOKEXT (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_GEN (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_GENDER (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_INGRED (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_LEGIS (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_PACKFORMAT (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_PACKMAT (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_PART_NATURE (Param in varchar2);
  procedure prc_dim_anagrafica_partconsum (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_PLACE (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_PROCES (Param in varchar2);
  procedure prc_dim_anagrafica_prod_meth (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_QUALINFO (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_REPORT (Param in varchar2);
  procedure prc_dim_anagrafica_reproductiv (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_SOURCE (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_SOURCE_COM (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_TARGET (Param in varchar2);
  procedure prc_DIM_ANAGRAFICA_USE (Param in varchar2);
  procedure prc_DIM_PARAM (Param in varchar2);
  procedure prc_dim_anlytyp (Param in varchar2);
  procedure prc_dim_anlymd (Param in varchar2);
  procedure prc_dim_mdacc (Param in varchar2);
  procedure prc_dim_unit (Param in varchar2);
  procedure prc_dim_exprres (Param in varchar2);
  procedure prc_dim_valtyp (Param in varchar2);
  procedure prc_dim_lmttyp (Param in varchar2);
  procedure prc_dim_reseval(Param in varchar2);
  procedure prc_dim_conclus(Param in varchar2);
  procedure prc_dim_aetate (Param in varchar2);
  procedure prc_dim_azienda (Param in varchar2);
  procedure prc_dim_azienda_PLUS (Param in varchar2);
  --procedure prc_DIM_ACTION (Param in varchar2);
  procedure prc_DIM_POSNEG (Param in varchar2);
  procedure prc_ft_det_pnr (Param in varchar2) ;

  procedure  prc_DIM_LABACC(Param in varchar2) ;
  procedure  PRC_DIM_PROGID(Param in varchar2) ;
  procedure  PRC_DIM_ANLYREFMD(Param in varchar2) ;
  procedure  prc_DIM_YESNO(Param in varchar2) ;
  procedure  prc_DIM_FARAREA(Param in varchar2) ;

  --procedure prc_ft_det_pnr_test (Param in varchar2) ;
  procedure prc_dim(Param in varchar2);


  PROCEDURE CARICAMENTO_BULK_SAMPDATE(Param in varchar2);


  PROCEDURE PRC_GET_SK_AZIENDA( SAMPPOINT in varchar2,
                              /*SAMPUNIT_SAMPHOLDINGID in varchar2,
                              SAMPUNIT_SLAUGHTERHOUSEID  in varchar2,
                              SAMPUNIT_SAMPPLANTID  in varchar2,*/      -- 
                              --rec_az_vld in r_dim_azienda,
                              OSAID in VARCHAR2,
                              RAGSOC in varchar2,
                              VIA_PIAZ in varchar2,
                              CITTA in varchar2,
                              PROVINCIA in varchar2,
                                  nome_dimensione   VARCHAR2
                                  );
  FUNCTION ELAB_OSAID (OSAID_IN IN varchar2)return varchar2;

  PROCEDURE PRC_GET_SK_CODAZALLORIG( SAMPPOINT in varchar2,
                              /*SAMPUNIT_SAMPHOLDINGID in varchar2,
                              SAMPUNIT_SLAUGHTERHOUSEID  in varchar2,
                              SAMPUNIT_SAMPPLANTID  in varchar2,*/      -- 
                              --rec_az_vld in r_dim_azienda,
                              CodAzAllOrig in VARCHAR2,
                              RAGSOC in varchar2,
                              VIA_PIAZ in varchar2,
                              CITTA in varchar2,
                              PROVINCIA in varchar2,
                              nome_dimensione   VARCHAR2);

  PROCEDURE PRC_GET_SK_CODAZALLORIG_NEW( SAMPPOINT in varchar2,

                              CodAzAllOrig in VARCHAR2,
                              RAGSOC in varchar2,
                              VIA_PIAZ in varchar2,
                              CITTA in varchar2,
                              PROVINCIA in varchar2,
                              nome_dimensione   VARCHAR2);

END;
/

--------------------------------------------------------
--  DDL for Package Body PKG_DWH_DET_FSALM
--------------------------------------------------------

  create or replace NONEDITIONABLE PACKAGE BODY               "PKG_DWH_DET_FSALM" is

  -- Private type declarations
  --type <TypeName> is <Datatype>;

  -- Private constant declarations
  adesso date := sysdate;
  sk integer;
  sk_ACT integer;
  n_dummy integer;
  differenza integer:=0;
  var_rows integer;
  -- Private variable declarations
  --<VariableName> <Datatype>;
/*
  -- Function and procedure implementations
  function <FunctionName>(<Parameter> <Datatype>) return <Datatype> is
    <LocalVariable> <Datatype>;
  begin
    <Statement>;
    return(<Result>);
  end;
*/

-- Dichiarazione della tipologia Record per DIM_AZIENDA
   type r_dim_azienda is record  (
                                       SK_azienda           number,
                                       SK_ACT_azienda       number,
                                       APN_N_REGISTRAZIONE   dim_azienda.APN_N_REGISTRAZIONE%type,
                                       RAGSOC   dim_azienda.RAGSOC%type,
                                       VIA_PIAZ   dim_azienda.VIA_PIAZ%type,
                                       CITTA   dim_azienda.CITTA%type,
                                       PROVINCIA    dim_azienda.PROVINCIA%type
                                     );
   rec_azienda r_dim_azienda;
   rec_azienda_vld  r_dim_azienda;

-- Dichiarazione della tipologia Record per DIM
   type r_dim_generica is record  (
                                       SK           number,
                                       SK_ACT       number
                                      ,chiave_ricerca    varchar2(4000)
                                     );
   -- definizione della variabile RECORD DIM
   dim_generica  r_dim_generica;

-- definizione della variabile RECORD x FT_DET_PNR
   FT_PNR  ft_det_vld%rowtype;
   FT_esteso_PNR  ft_esteso_action%rowtype;

    -- Bulk Collection per i dati da utilizzare per la ricerca della DIM
   TYPE tab_dim_generica IS TABLE OF dim_generica%type index by varchar2(4000);

   -- Struttura dell'indice di ricerca del record da Storicizzare ( o inserire )
   type tab_indice_dim_generica is table of dim_generica%type index by binary_integer;

    tmp_dim_gen tab_indice_dim_generica;
    bk_dim_reg tab_dim_generica;  --bulk da popolare con i record da selezionare per la DIM_REG
    bk_dim_reg_id tab_dim_generica;  --bulk da popolare con i record da selezionare per la DIM_REG
    bk_dim_tipocampo tab_dim_generica;  --bulk da popolare con i record da selezionare per la DIM_REG
    bk_dim_anlymd tab_dim_generica;
    bk_dim_anlytyp tab_dim_generica;
    bk_dim_asl tab_dim_generica;
    bk_dim_azienda tab_dim_generica;
    bk_dim_conclus tab_dim_generica;
    bk_dim_country tab_dim_generica;
    bk_dim_exprres tab_dim_generica;
    bk_dim_laboratori tab_dim_generica;
    bk_dim_legref tab_dim_generica;
    bk_dim_lmttyp tab_dim_generica;
    bk_dim_mdacc tab_dim_generica;
    bk_dim_modallev tab_dim_generica;
    bk_dim_mtx_vmpr_it tab_dim_generica;
    bk_dim_mtxtyp tab_dim_generica;
    bk_dim_nonidon tab_dim_generica;
    --BK_DIM_PARAM_VMPR_IT    tab_dim_generica;
    bk_dim_paramtyp tab_dim_generica;
    bk_dim_posneg tab_dim_generica;
    bk_dim_progtyp tab_dim_generica;
    bk_dim_reseval tab_dim_generica;
    bk_dim_samplr tab_dim_generica;
    bk_dim_sampmd tab_dim_generica;
    bk_dim_sampstr tab_dim_generica;
    bk_dim_sampuntyp tab_dim_generica;
    bk_dim_smpnt_ita tab_dim_generica;
    bk_dim_unit tab_dim_generica;
    bk_dim_valtyp tab_dim_generica;
    bk_dim_aetate tab_dim_generica;
    bk_dim_action tab_dim_generica;
    bk_dim_animal_age tab_dim_generica;
    bk_dim_report tab_dim_generica;
    bk_dim_anlyrefmd tab_dim_generica;
    bk_dim_cookext tab_dim_generica;
    bk_dim_gender tab_dim_generica;
    bk_dim_gen tab_dim_generica;
    bk_dim_ingred tab_dim_generica;
    bk_dim_legis tab_dim_generica;
    bk_dim_packformat tab_dim_generica;
    bk_dim_packmat tab_dim_generica;
    bk_dim_part_nature tab_dim_generica;
    bk_dim_partconsumed tab_dim_generica;
    bk_dim_place tab_dim_generica;
    bk_dim_proces tab_dim_generica;
    bk_dim_production_method tab_dim_generica;
    bk_dim_use tab_dim_generica;
    bk_dim_qualinfo tab_dim_generica;
    bk_dim_reproductive tab_dim_generica;
    bk_dim_yesno tab_dim_generica;
    bk_dim_fararea tab_dim_generica;
    bk_dim_source tab_dim_generica;
    bk_dim_source_com tab_dim_generica;
    bk_dim_target tab_dim_generica;
    bk_dim_progid tab_dim_generica;
    bk_dim_tem tab_dim_generica;
    bk_dim_param tab_dim_generica;
    bk_dim_param_ita tab_dim_generica;
    bk_dim_param_vmpr tab_dim_generica;
    bk_dim_labacc tab_dim_generica;
   --
   --
   type r_rel_generica is record  (
                                       id           number,
                                       chiave_ricerca    varchar2(4000)
                                     );
   rel_generica  r_rel_generica;
   TYPE tab_rel_generica IS TABLE OF rel_generica%type index by varchar2(4000);
   type tab_indice_rel_generica is table of rel_generica%type index by binary_integer;
   tmp_rel_GEN  tab_indice_rel_generica;
   BK_dim_REL_EVALCODE_SMPASSESS            tab_rel_generica;





   desc_errore     VARCHAR2(4000) := NULL; -- descrizione interna dell'Errore (descrizione STEP)
   errore          EXCEPTION;
   errore_update   EXCEPTION;
   erroreZero          EXCEPTION;





 PROCEDURE PRC_INS_TAB_LOG_ETL(
                  P_IN_TYP_LOG   TAB_LOG_ERR.TIPO_LOG%TYPE,
                  P_IN_COD_LOG   TAB_LOG_ERR.COD_ERR%TYPE,
                  P_IN_MSG_LOG   TAB_LOG_ERR.DES_LOG%TYPE,
                  P_IN_COD_LOG_ORA   TAB_LOG_ERR.COD_ERR_ORA%TYPE,
                  P_IN_MSG_LOG_ORA   TAB_LOG_ERR.DES_ERR_ORA%TYPE--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  ) AS
  PRAGMA AUTONOMOUS_TRANSACTION;

  C_MSG_LOG TAB_LOG_ERR.DES_LOG%TYPE;
 BEGIN
  /* ==============================
    Alessandro Fanti, 21/09/2015
    processo di inserimento dei log
    ============================== */

  C_MSG_LOG := P_IN_MSG_LOG;--SUBSTRB(P_IN_MSG_LOG, 1, 2000);


  INSERT INTO TAB_LOG_ERR (ID_LOG,             TIPO_LOG,     COD_ERR,      DES_LOG,   COD_ERR_ORA,      DES_ERR_ORA,      DAT)
                   VALUES (SEQ_ID_LOG.NEXTVAL, P_IN_TYP_LOG, P_IN_COD_LOG, C_MSG_LOG, P_IN_COD_LOG_ORA, P_IN_MSG_LOG_ORA, SYSTIMESTAMP);

  --P_OUT_ERR      := NULL;
  --P_OUT_DESC_ERR := NULL;

  COMMIT;
 EXCEPTION
  WHEN OTHERS THEN
   ROLLBACK;
   Raise_Application_Error (-20500, 'ERRORE DELLA PROCEDURA DI INSERIMENTO LOG');
   --P_OUT_ERR      := SQLCODE;
   --P_OUT_DESC_ERR := SQLERRM;
 END PRC_INS_TAB_LOG_ETL;



  FUNCTION stacco_sk ( sk in number, k in number) return number is

  ret_val NUMBER;

BEGIN
if k = 1 and sk = -1 then
 ret_val := 1;
elsif k = 2 and sk = -1 then
 ret_val := 2;
elsif k = 1 and sk != -1 then
 ret_val := sk+1;
elsif k = 2 and sk != -1 then
 ret_val := sk+2;
end if;
return ret_val;
END ;




  procedure prc_dim_GRP_ACTION_REG (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from dim_GRP_ACTION_REG where sk_GRP_ACTION_REG < 0;
    if n_dummy = 0 then
        insert into dim_GRP_ACTION_REG
        ( sk_GRP_ACTION_REG, DES_GRP_ACTION_REG, DUP_TEC, NUP_TEC, DCR_TEC, PCR_TEC)
        (select
             -1,  'ND', null, 0,  adesso , 'PKG_DWH_DET_FSALM.prc_dim_GRP_ACTION_REG'
         from dual
         union
         select
             -2,  'ER', null, 0,  adesso , 'PKG_DWH_DET_FSALM.prc_dim_GRP_ACTION_REG'
         from dual
         );
    end if;

    --controllo
/*    select (SELECT count( distinct listagg (
                                            b.TERM_EXTENDED_NAME || ' - ' || c.TERM_EXTENDED_NAME,
                                            ',')
                                            WITHIN GROUP (ORDER BY c.COD_REG)) num_r_ana
              FROM ACTTAKENCODE a, ACTION b, REGIONI c
              WHERE a.ID_ACTION = b.ID(+) AND a.id_regione = c.id_regione(+)
              --ID_VLD = mdfch.tec_key_rec
              GROUP BY ID_VLD)
              -
              (select count(1) num_r_dim from dim_GRP_ACTION_REG where sk_GRP_ACTION_REG > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;*/

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_GRP_ACTION_REG'||' - '||'dovuto al controllo finale',1,4000);
        raise;

when errore_update then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_GRP_ACTION_REG'||' - '||'dovuto a un numero di righe aggiornate eccessivo',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_REG'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_GRP_ACTION_REG;

--dim_reg: occorre fare l'integrazione con le dimensioni condivise?
-- id_regione ¿ PK sull'anagrafica


 procedure prc_dim_reg (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from dim_reg where sk_reg < 0;
    if n_dummy = 0 then
        insert into dim_reg
        ( sk_ACT_REG, sk_reg, id_regione, cod_reg, TERM_EXTENDED_NAME, valid_from, valid_to, dat_ini_vld_tec)
        (select
                  -1, -1, -1, '-1', 'ND', null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select id_regione --chiave tecnica gestionale
                     from dim_reg where dat_fin_vld_tec is null and sk_reg > 0
                     minus
                     select id_regione
                     from regioni
                  )
    loop

    update dim_reg
    set dat_fin_vld_tec = adesso
    where id_regione = cnclzn.id_regione
      and sk_reg > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select id_regione, trim(cod_reg) cod_reg, trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME, valid_from, valid_to --tutti i campi della tebella del gestionale
                     from regioni
                     minus
                     select id_regione, cod_reg, TERM_EXTENDED_NAME, valid_from, valid_to
                     from dim_reg where dat_fin_vld_tec is null and sk_reg > 0
                  )
    loop

    update dim_reg
    set dat_fin_vld_tec = adesso
    where id_regione = mdfch.id_regione
      and sk_reg > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;



         IF var_rows > 1 THEN

    raise errore_update;

ELSIF var_rows = 1  THEN

    select sk_ACT_reg into sk_ACT
                     from dim_reg
                     where dat_fin_vld_tec = adesso and sk_reg > 0
                       and id_regione  = mdfch.id_regione;

    --select seq_dim_reg.nextval into sk from dual;
    select stacco_sk(max(sk_reg), 1)  into sk from dim_reg;

ELSE

    --select seq_dim_reg.nextval into sk_ACT from dual;
    --select seq_dim_reg.nextval into sk from dual;
    select stacco_sk(max(sk_reg), 1)  into sk_ACT from dim_reg;
    select stacco_sk(max(sk_reg), 2)  into sk from dim_reg;


END IF;


    insert into dim_reg
    ( sk_ACT_reg, sk_reg, id_regione, cod_reg, TERM_EXTENDED_NAME, valid_from, valid_to, dat_ini_vld_tec)
    values
    (sk_ACT, sk, mdfch.id_regione, mdfch.cod_reg, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from regioni) - (select count(1) num_r_dim from dim_reg where dat_fin_vld_tec is null and sk_reg > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_REG'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_REG'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_reg;


--dim_tipocampo:
-- id ¿ PK sull'anagrafica
  procedure prc_dim_tipocampo (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from dim_tipocampo where sk_tipocampo < 0;
    if n_dummy = 0 then
        insert into dim_tipocampo
        ( sk_act_tipocampo, sk_tipocampo, id, term_code, TERM_DESCRIPTION, VALID_FROM, VALID_TO, dat_ini_vld_tec)
        (select
                  -1, -1, -1, '-1', 'ND', null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, adesso
         from dual);
    end if;


    --cancellazioni
    for cnclzn in (  select id --chiave tecnica gestionale
                     from dim_tipocampo where dat_fin_vld_tec is null and sk_tipocampo > 0
                     minus
                     select id
                     from tipocampo
                  )
    loop

    update dim_tipocampo
    set dat_fin_vld_tec = adesso
    where id = cnclzn.id
       and sk_tipocampo > 0
      --and term_code = cnclzn.term_code
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select id, trim(term_code) term_code, TRIM(TERM_DESCRIPTION) TERM_DESCRIPTION, VALID_FROM, VALID_TO--tutti i campi della tebella del gestionale
                     from tipocampo
                     minus
                    select id, term_code, TERM_DESCRIPTION, VALID_FROM, VALID_TO
                     from dim_tipocampo where dat_fin_vld_tec is null and sk_tipocampo > 0
                  )
    loop

    update dim_tipocampo
    set dat_fin_vld_tec = adesso
    where id = mdfch.id
      and term_code = mdfch.term_code
      and dat_fin_vld_tec is null
       and sk_tipocampo > 0;


    var_rows := SQL%ROWCOUNT;



            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select sk_ACT_TIPOCAMPO into sk_ACT
                                 from dim_tipocampo
                                 where dat_fin_vld_tec = adesso and sk_tipocampo > 0
                                   and ID  = mdfch.ID;

                 select stacco_sk(max(sk_tipocampo), 1)  into sk from dim_tipocampo;

            ELSE


                select stacco_sk(max(sk_tipocampo), 1)  into sk_ACT from dim_tipocampo;
                select stacco_sk(max(sk_tipocampo), 2)  into sk from dim_tipocampo;


            END IF;

    insert into dim_tipocampo
    ( sk_act_tipocampo, sk_tipocampo, id, term_code, TERM_DESCRIPTION, VALID_FROM, VALID_TO, dat_ini_vld_tec)
    values
    ( sk_act, sk, mdfch.id, mdfch.term_code, mdfch.TERM_DESCRIPTION, mdfch.VALID_FROM, mdfch.VALID_TO, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from tipocampo) - (select count(1) num_r_dim from dim_tipocampo where dat_fin_vld_tec is null and sk_tipocampo > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    commit;
EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_TIPOCAMPO'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_TIPOCAMPO'||' - '||sqlerrm,1,4000);
        raise;

  end prc_dim_tipocampo;

  procedure prc_dim_anagrafica_animal_age (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from dim_anagrafica_animal_age where sk_animal_age < 0;
    if n_dummy = 0 then
        insert into dim_anagrafica_animal_age
        ( sk_act_animal_age, sk_animal_age,  termcode, TERMEXTENDEDNAME, VALIDFROM, VALIDTO, dat_ini_vld_tec)
        (select
                  -1, -1,  '-1', 'ND', null, null, adesso
         from dual
         union
         select
                  -2, -2,  '-2', 'ER', null, null, adesso
         from dual);
    end if;


    --cancellazioni
    for cnclzn in (  select termcode --chiave tecnica gestionale
                     from dim_anagrafica_animal_age where dat_fin_vld_tec is null and sk_animal_age > 0
                     minus
                     select termcode
                     from anagrafica_animal_age
                  )
    loop

    update dim_anagrafica_animal_age
    set dat_fin_vld_tec = adesso
    where --termcode = cnclzn.termocde
        sk_animal_age > 0
      and termcode = cnclzn.termcode
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in ( SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       TRIM (VALIDFROM_OLD) VALIDFROM_OLD,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
  FROM anagrafica_animal_age
MINUS
SELECT TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDFROM_OLD,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
  FROM dim_anagrafica_animal_age
 WHERE dat_fin_vld_tec IS NULL AND sk_animal_age > 0 )
    loop

    update dim_anagrafica_animal_age
    set dat_fin_vld_tec = adesso
    where   sk_animal_age > 0 --id = mdfch.id
       AND termcode = mdfch.termcode
       AND dat_fin_vld_tec is null;
       --and sk_animal_age > 0;


    var_rows := SQL%ROWCOUNT;



            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select sk_act_animal_age into sk_ACT
                                 from dim_anagrafica_animal_age
                                 where dat_fin_vld_tec = adesso
                                 and sk_animal_age > 0
                                 AND TERMCODE = MDFCH.TERMCODE;
                                   --and ID  = mdfch.ID;

                 select stacco_sk(max(sk_animal_age), 1)  into sk from dim_anagrafica_animal_age;

            ELSE


                select stacco_sk(max(sk_animal_age), 1)  into sk_ACT from dim_anagrafica_animal_age;
                select stacco_sk(max(sk_animal_age), 2)  into sk from dim_anagrafica_animal_age;


            END IF;

    insert into dim_anagrafica_animal_age
    ( SK_ANIMAL_AGE,
       SK_ACT_ANIMAL_AGE,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDFROM_OLD,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC)
    values
    ( SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDFROM_OLD,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO );

    end loop;

    --controllo
    select (select count(1) num_r_ana from ANAGRAFICA_ANIMAL_AGE) - (select count(1) num_r_dim from dim_anagrafica_animal_age where dat_fin_vld_tec is null and sk_animal_age > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    commit;
    
EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'dim_anagrafica_animal_age'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'dim_anagrafica_animal_age'||' - '||sqlerrm,1,4000);
        raise;

  end prc_dim_anagrafica_animal_age;




  procedure prc_dim_anagrafica_cookext (Param in varchar2) is

  begin
    --dummy
    select count(1) into n_dummy from dim_anagrafica_cookext where sk_sampmatcode_cookext < 0;
    if n_dummy = 0 then
        insert into dim_anagrafica_cookext
        ( sk_act_sampmatcode_cookext, sk_sampmatcode_cookext,termcode, TERMEXTENDEDNAME, VALIDFROM, VALIDTO, dat_ini_vld_tec)
        (select
                  -1, -1,  '-1', 'ND', null, null, adesso
         from dual
         union
         select
                  -2, -2,  '-2', 'ER', null, null, adesso
         from dual);
    end if;


    --cancellazioni
    for cnclzn in (  select TERMCODE --chiave tecnica gestionale
                     from dim_anagrafica_cookext where dat_fin_vld_tec is null and sk_sampmatcode_cookext > 0
                     minus
                     select TERMCODE
                     from anagrafica_cookext
                  )
    loop

    update dim_anagrafica_cookext
    set dat_fin_vld_tec = adesso
    where --id = cnclzn.id
        sk_sampmatcode_cookext > 0
      and termcode = cnclzn.termcode
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in ( SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       TRIM (VALIDFROM_OLD) VALIDFROM_OLD,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
  FROM anagrafica_cookext
MINUS
SELECT TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDFROM_OLD,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
  FROM dim_anagrafica_cookext
 WHERE dat_fin_vld_tec IS NULL AND sk_sampmatcode_cookext > 0 )
    loop

    update dim_anagrafica_cookext
    set dat_fin_vld_tec = adesso
    where --id = mdfch.id
       termcode = mdfch.termcode
       AND dat_fin_vld_tec is null
       and sk_sampmatcode_cookext > 0;


    var_rows := SQL%ROWCOUNT;



            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select sk_act_sampmatcode_cookext into sk_ACT
                                 from dim_anagrafica_cookext
                                 where dat_fin_vld_tec = adesso
                                 and sk_sampmatcode_cookext > 0
                                 AND TERMCODE = MDFCH.TERMCODE;
                                   --and ID  = mdfch.ID;

                 select stacco_sk(max(sk_sampmatcode_cookext), 1)  into sk from dim_anagrafica_cookext;

            ELSE


                select stacco_sk(max(sk_sampmatcode_cookext), 1)  into sk_ACT from dim_anagrafica_cookext;
                select stacco_sk(max(sk_sampmatcode_cookext), 2)  into sk from dim_anagrafica_cookext;


            END IF;

    insert into dim_anagrafica_cookext
    ( SK_SAMPMATCODE_COOKEXT,
       SK_ACT_SAMPMATCODE_COOKEXT,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDFROM_OLD,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC)
    values
    (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDFROM_OLD,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO );

    end loop;

    --controllo
    select (select count(1) num_r_ana from ANAGRAFICA_COOKEXT) - (select count(1) num_r_dim from dim_anagrafica_cookext where dat_fin_vld_tec is null and sk_sampmatcode_cookext > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    commit;
    
EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'dim_anagrafica_cookext'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'dim_anagrafica_cookext'||' - '||sqlerrm,1,4000);
        raise;

  end prc_dim_anagrafica_cookext;





PROCEDURE prc_dim_anagrafica_gen (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_gen
    WHERE sk_sampmatcode_gen < 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_gen (sk_act_sampmatcode_gen,
                                          sk_sampmatcode_gen,
                                          termcode,
                                          TERMEXTENDEDNAME,
                                          VALIDFROM,
                                          VALIDTO,
                                          dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn
      IN (SELECT TERMCODE                                --chiave tecnica gestionale
            FROM dim_anagrafica_gen
           WHERE dat_fin_vld_tec IS NULL AND sk_sampmatcode_gen > 0
          MINUS
          SELECT TERMCODE FROM anagrafica_gen)
   LOOP
      UPDATE dim_anagrafica_gen
         SET dat_fin_vld_tec = adesso
       WHERE-- id = cnclzn.id
      sk_sampmatcode_gen > 0
      and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch
      IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       TRIM(FLG_GEN_ITA) FLG_GEN_ITA
            FROM anagrafica_gen
          MINUS
          SELECT TERMCODE,
                 TERMEXTENDEDNAME,
                 TERMSHORTNAME,
                 VERSION,
                 LASTUPDATE,
                 VALIDTO,
                 STATUS,
                 DEPRECATED,
                 SCIENTIFICNAMES,
                 COMMONNAMES,
                 ALLFACETS,
                 ISSCAAP,
                 TAXONOMICCODE,
                 ALPHA3CODE,
                 GEMSCODE,
                 MATRIXCODE,
                 LANGUALCODE,
                 FOODEXOLDCODE,
                 IMPLICITFACETS,
                 DETAILLEVEL,
                 TERMTYPE,
                 PRODTREAT,
                 PRODMETH,
                 PRODPACK,
                 EURINGSCODE,
                 IFNCODE,
                 EUFEEDREG,
                 MASTERFLAG,
                 MASTERPARENTCODE,
                 MASTERORDER,
                 MASTERREPORTABLE,
                 MASTERHIERARCHYCODE,
                 REPORTFLAG,
                 REPORTPARENTCODE,
                 REPORTORDER,
                 REPORTREPORTABLE,
                 REPORTHIERARCHYCODE,
                 PESTFLAG,
                 PESTPARENTCODE,
                 PESTORDER,
                 PESTREPORTABLE,
                 PESTHIERARCHYCODE,
                 BIOMOFLAG,
                 BIOMOPARENTCODE,
                 BIOMOORDER,
                 BIOMOREPORTABLE,
                 BIOMOHIERARCHYCODE,
                 FEEDFLAG,
                 FEEDPARENTCODE,
                 FEEDORDER,
                 FEEDREPORTABLE,
                 FEEDHIERARCHYCODE,
                 EXPOFLAG,
                 EXPOPARENTCODE,
                 EXPOORDER,
                 EXPOREPORTABLE,
                 EXPOHIERARCHYCODE,
                 VETDRUGFLAG,
                 VETDRUGPARENTCODE,
                 VETDRUGORDER,
                 VETDRUGREPORTABLE,
                 VETDRUGHIERARCHYCODE,
                 BOTANICFLAG,
                 BOTANICPARENTCODE,
                 BOTANICORDER,
                 BOTANICREPORTABLE,
                 BOTANICHIERARCHYCODE,
                 PARTFLAG,
                 PARTPARENTCODE,
                 PARTORDER,
                 PARTREPORTABLE,
                 PARTHIERARCHYCODE,
                 SOURCEFLAG,
                 SOURCEPARENTCODE,
                 SOURCEORDER,
                 SOURCEREPORTABLE,
                 SOURCEHIERARCHYCODE,
                 RACSOURCEFLAG,
                 RACSOURCEPARENTCODE,
                 RACSOURCEORDER,
                 RACSOURCEREPORTABLE,
                 RACSOURCEHIERARCHYCODE,
                 PROCESSFLAG,
                 PROCESSPARENTCODE,
                 PROCESSORDER,
                 PROCESSREPORTABLE,
                 PROCESSHIERARCHYCODE,
                 INGREDFLAG,
                 INGREDPARENTCODE,
                 INGREDORDER,
                 INGREDREPORTABLE,
                 INGREDHIERARCHYCODE,
                 MEDIUMFLAG,
                 MEDIUMPARENTCODE,
                 MEDIUMORDER,
                 MEDIUMREPORTABLE,
                 MEDIUMHIERARCHYCODE,
                 SWEETFLAG,
                 SWEETPARENTCODE,
                 SWEETORDER,
                 SWEETREPORTABLE,
                 SWEETHIERARCHYCODE,
                 FORTFLAG,
                 FORTPARENTCODE,
                 FORTORDER,
                 FORTREPORTABLE,
                 FORTHIERARCHYCODE,
                 QUALFLAG,
                 QUALPARENTCODE,
                 QUALORDER,
                 QUALREPORTABLE,
                 QUALHIERARCHYCODE,
                 COOKEXTFLAG,
                 COOKEXTPARENTCODE,
                 COOKEXTORDER,
                 COOKEXTREPORTABLE,
                 COOKEXTHIERARCHYCODE,
                 GENFLAG,
                 GENPARENTCODE,
                 GENORDER,
                 GENREPORTABLE,
                 GENHIERARCHYCODE,
                 PRODFLAG,
                 PRODPARENTCODE,
                 PRODORDER,
                 PRODREPORTABLE,
                 PRODHIERARCHYCODE,
                 PACKFORMATFLAG,
                 PACKFORMATPARENTCODE,
                 PACKFORMATORDER,
                 PACKFORMATREPORTABLE,
                 PACKFORMATHIERARCHYCODE,
                 PACKMATFLAG,
                 PACKMATPARENTCODE,
                 PACKMATORDER,
                 PACKMATREPORTABLE,
                 PACKMATHIERARCHYCODE,
                 STATEFLAG,
                 STATEPARENTCODE,
                 STATEORDER,
                 STATEREPORTABLE,
                 STATEHIERARCHYCODE,
                 FATFLAG,
                 FATPARENTCODE,
                 FATORDER,
                 FATREPORTABLE,
                 FATHIERARCHYCODE,
                 ALCOHOLFLAG,
                 ALCOHOLPARENTCODE,
                 ALCOHOLORDER,
                 ALCOHOLREPORTABLE,
                 ALCOHOLHIERARCHYCODE,
                 DOUGHFLAG,
                 DOUGHPARENTCODE,
                 DOUGHORDER,
                 DOUGHREPORTABLE,
                 DOUGHHIERARCHYCODE,
                 PARTCONFLAG,
                 PARTCONPARENTCODE,
                 PARTCONORDER,
                 PARTCONREPORTABLE,
                 PARTCONHIERARCHYCODE,
                 PLACEFLAG,
                 PLACEPARENTCODE,
                 PLACEORDER,
                 PLACEREPORTABLE,
                 PLACEHIERARCHYCODE,
                 TARGCONFLAG,
                 TARGCONPARENTCODE,
                 TARGCONORDER,
                 TARGCONREPORTABLE,
                 TARGCONHIERARCHYCODE,
                 USEFLAG,
                 USEPARENTCODE,
                 USEORDER,
                 USEREPORTABLE,
                 USEHIERARCHYCODE,
                 RISKINGREDFLAG,
                 RISKINGREDPARENTCODE,
                 RISKINGREDORDER,
                 RISKINGREDREPORTABLE,
                 RISKINGREDHIERARCHYCODE,
                 FPURPOSEFLAG,
                 FPURPOSEPARENTCODE,
                 FPURPOSEORDER,
                 FPURPOSEREPORTABLE,
                 FPURPOSEHIERARCHYCODE,
                 REPLEVFLAG,
                 REPLEVPARENTCODE,
                 REPLEVORDER,
                 REPLEVREPORTABLE,
                 REPLEVHIERARCHYCODE,
                 ANIMAGEFLAG,
                 ANIMAGEPARENTCODE,
                 ANIMAGEORDER,
                 ANIMAGEREPORTABLE,
                 ANIMAGEHIERARCHYCODE,
                 GENDERFLAG,
                 GENDERPARENTCODE,
                 GENDERORDER,
                 GENDERREPORTABLE,
                 GENDERHIERARCHYCODE,
                 LEGISFLAG,
                 LEGISPARENTCODE,
                 LEGISORDER,
                 LEGISREPORTABLE,
                 LEGISHIERARCHYCODE,
                 FEEDADDEXPOFLAG,
                 FEEDADDEXPOPARENTCODE,
                 FEEDADDEXPOORDER,
                 FEEDADDEXPOREPORTABLE,
                 FEEDADDEXPOHIERARCHYCODE,
                 VALIDFROM,
                 FLG_GEN_ITA
            FROM dim_anagrafica_gen
           WHERE dat_fin_vld_tec IS NULL AND sk_sampmatcode_gen > 0)
   LOOP
      UPDATE dim_anagrafica_gen
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
              termcode = mdfch.termcode
              AND dat_fin_vld_tec IS NULL
             AND sk_sampmatcode_gen > 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_sampmatcode_gen
           INTO sk_ACT
           FROM dim_anagrafica_gen
          WHERE     dat_fin_vld_tec = adesso
                AND sk_sampmatcode_gen > 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_sampmatcode_gen), 1)
           INTO sk
           FROM dim_anagrafica_gen;
      ELSE
         SELECT stacco_sk (MAX (sk_sampmatcode_gen), 1)
           INTO sk_ACT
           FROM dim_anagrafica_gen;

         SELECT stacco_sk (MAX (sk_sampmatcode_gen), 2)
           INTO sk
           FROM dim_anagrafica_gen;
      END IF;

      INSERT INTO dim_anagrafica_gen (SK_SAMPMATCODE_GEN,
       SK_ACT_SAMPMATCODE_GEN,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       FLG_GEN_ITA,
       DAT_INI_VLD_TEC)
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       mdfch.FLG_GEN_ITA,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM ANAGRAFICA_GEN)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_gen
              WHERE dat_fin_vld_tec IS NULL AND sk_sampmatcode_gen > 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_gen'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_gen'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_gen;




PROCEDURE prc_dim_anagrafica_gender (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_gender
    WHERE sk_sampmatcode_gender < 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_gender (sk_act_sampmatcode_gender,
                                          sk_sampmatcode_gender,
                                          termcode,
                                          TERMEXTENDEDNAME,
                                          VALIDFROM,
                                          VALIDTO,
                                          dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn
      IN (SELECT TERMCODE                           --chiave tecnica gestionale
            FROM dim_anagrafica_gender
           WHERE dat_fin_vld_tec IS NULL AND sk_sampmatcode_gender > 0
          MINUS
          SELECT TERMCODE FROM anagrafica_gender)
   LOOP
      UPDATE dim_anagrafica_gender
         SET dat_fin_vld_tec = adesso
       WHERE --id = cnclzn.id
         sk_sampmatcode_gender > 0 and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch
      IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       TRIM (VALIDFROM_OLD) VALIDFROM_OLD,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
            FROM anagrafica_gender
          MINUS
          SELECT TERMCODE,
                 TERMEXTENDEDNAME,
                 TERMSHORTNAME,
                 VERSION,
                 LASTUPDATE,
                 VALIDFROM_OLD,
                 VALIDTO,
                 STATUS,
                 DEPRECATED,
                 SCIENTIFICNAMES,
                 COMMONNAMES,
                 ALLFACETS,
                 ISSCAAP,
                 TAXONOMICCODE,
                 ALPHA3CODE,
                 GEMSCODE,
                 MATRIXCODE,
                 LANGUALCODE,
                 FOODEXOLDCODE,
                 IMPLICITFACETS,
                 DETAILLEVEL,
                 TERMTYPE,
                 PRODTREAT,
                 PRODMETH,
                 PRODPACK,
                 EURINGSCODE,
                 IFNCODE,
                 EUFEEDREG,
                 MASTERFLAG,
                 MASTERPARENTCODE,
                 MASTERORDER,
                 MASTERREPORTABLE,
                 MASTERHIERARCHYCODE,
                 REPORTFLAG,
                 REPORTPARENTCODE,
                 REPORTORDER,
                 REPORTREPORTABLE,
                 REPORTHIERARCHYCODE,
                 PESTFLAG,
                 PESTPARENTCODE,
                 PESTORDER,
                 PESTREPORTABLE,
                 PESTHIERARCHYCODE,
                 BIOMOFLAG,
                 BIOMOPARENTCODE,
                 BIOMOORDER,
                 BIOMOREPORTABLE,
                 BIOMOHIERARCHYCODE,
                 FEEDFLAG,
                 FEEDPARENTCODE,
                 FEEDORDER,
                 FEEDREPORTABLE,
                 FEEDHIERARCHYCODE,
                 EXPOFLAG,
                 EXPOPARENTCODE,
                 EXPOORDER,
                 EXPOREPORTABLE,
                 EXPOHIERARCHYCODE,
                 VETDRUGFLAG,
                 VETDRUGPARENTCODE,
                 VETDRUGORDER,
                 VETDRUGREPORTABLE,
                 VETDRUGHIERARCHYCODE,
                 BOTANICFLAG,
                 BOTANICPARENTCODE,
                 BOTANICORDER,
                 BOTANICREPORTABLE,
                 BOTANICHIERARCHYCODE,
                 PARTFLAG,
                 PARTPARENTCODE,
                 PARTORDER,
                 PARTREPORTABLE,
                 PARTHIERARCHYCODE,
                 SOURCEFLAG,
                 SOURCEPARENTCODE,
                 SOURCEORDER,
                 SOURCEREPORTABLE,
                 SOURCEHIERARCHYCODE,
                 RACSOURCEFLAG,
                 RACSOURCEPARENTCODE,
                 RACSOURCEORDER,
                 RACSOURCEREPORTABLE,
                 RACSOURCEHIERARCHYCODE,
                 PROCESSFLAG,
                 PROCESSPARENTCODE,
                 PROCESSORDER,
                 PROCESSREPORTABLE,
                 PROCESSHIERARCHYCODE,
                 INGREDFLAG,
                 INGREDPARENTCODE,
                 INGREDORDER,
                 INGREDREPORTABLE,
                 INGREDHIERARCHYCODE,
                 MEDIUMFLAG,
                 MEDIUMPARENTCODE,
                 MEDIUMORDER,
                 MEDIUMREPORTABLE,
                 MEDIUMHIERARCHYCODE,
                 SWEETFLAG,
                 SWEETPARENTCODE,
                 SWEETORDER,
                 SWEETREPORTABLE,
                 SWEETHIERARCHYCODE,
                 FORTFLAG,
                 FORTPARENTCODE,
                 FORTORDER,
                 FORTREPORTABLE,
                 FORTHIERARCHYCODE,
                 QUALFLAG,
                 QUALPARENTCODE,
                 QUALORDER,
                 QUALREPORTABLE,
                 QUALHIERARCHYCODE,
                 COOKEXTFLAG,
                 COOKEXTPARENTCODE,
                 COOKEXTORDER,
                 COOKEXTREPORTABLE,
                 COOKEXTHIERARCHYCODE,
                 GENFLAG,
                 GENPARENTCODE,
                 GENORDER,
                 GENREPORTABLE,
                 GENHIERARCHYCODE,
                 PRODFLAG,
                 PRODPARENTCODE,
                 PRODORDER,
                 PRODREPORTABLE,
                 PRODHIERARCHYCODE,
                 PACKFORMATFLAG,
                 PACKFORMATPARENTCODE,
                 PACKFORMATORDER,
                 PACKFORMATREPORTABLE,
                 PACKFORMATHIERARCHYCODE,
                 PACKMATFLAG,
                 PACKMATPARENTCODE,
                 PACKMATORDER,
                 PACKMATREPORTABLE,
                 PACKMATHIERARCHYCODE,
                 STATEFLAG,
                 STATEPARENTCODE,
                 STATEORDER,
                 STATEREPORTABLE,
                 STATEHIERARCHYCODE,
                 FATFLAG,
                 FATPARENTCODE,
                 FATORDER,
                 FATREPORTABLE,
                 FATHIERARCHYCODE,
                 ALCOHOLFLAG,
                 ALCOHOLPARENTCODE,
                 ALCOHOLORDER,
                 ALCOHOLREPORTABLE,
                 ALCOHOLHIERARCHYCODE,
                 DOUGHFLAG,
                 DOUGHPARENTCODE,
                 DOUGHORDER,
                 DOUGHREPORTABLE,
                 DOUGHHIERARCHYCODE,
                 PARTCONFLAG,
                 PARTCONPARENTCODE,
                 PARTCONORDER,
                 PARTCONREPORTABLE,
                 PARTCONHIERARCHYCODE,
                 PLACEFLAG,
                 PLACEPARENTCODE,
                 PLACEORDER,
                 PLACEREPORTABLE,
                 PLACEHIERARCHYCODE,
                 TARGCONFLAG,
                 TARGCONPARENTCODE,
                 TARGCONORDER,
                 TARGCONREPORTABLE,
                 TARGCONHIERARCHYCODE,
                 USEFLAG,
                 USEPARENTCODE,
                 USEORDER,
                 USEREPORTABLE,
                 USEHIERARCHYCODE,
                 RISKINGREDFLAG,
                 RISKINGREDPARENTCODE,
                 RISKINGREDORDER,
                 RISKINGREDREPORTABLE,
                 RISKINGREDHIERARCHYCODE,
                 FPURPOSEFLAG,
                 FPURPOSEPARENTCODE,
                 FPURPOSEORDER,
                 FPURPOSEREPORTABLE,
                 FPURPOSEHIERARCHYCODE,
                 REPLEVFLAG,
                 REPLEVPARENTCODE,
                 REPLEVORDER,
                 REPLEVREPORTABLE,
                 REPLEVHIERARCHYCODE,
                 ANIMAGEFLAG,
                 ANIMAGEPARENTCODE,
                 ANIMAGEORDER,
                 ANIMAGEREPORTABLE,
                 ANIMAGEHIERARCHYCODE,
                 GENDERFLAG,
                 GENDERPARENTCODE,
                 GENDERORDER,
                 GENDERREPORTABLE,
                 GENDERHIERARCHYCODE,
                 LEGISFLAG,
                 LEGISPARENTCODE,
                 LEGISORDER,
                 LEGISREPORTABLE,
                 LEGISHIERARCHYCODE,
                 FEEDADDEXPOFLAG,
                 FEEDADDEXPOPARENTCODE,
                 FEEDADDEXPOORDER,
                 FEEDADDEXPOREPORTABLE,
                 FEEDADDEXPOHIERARCHYCODE,
                 VALIDFROM
            FROM dim_anagrafica_gender
           WHERE dat_fin_vld_tec IS NULL AND sk_sampmatcode_gender > 0)
   LOOP
      UPDATE dim_anagrafica_gender
         SET dat_fin_vld_tec = adesso
       WHERE    -- id = mdfch.id
              termcode = mdfch.termcode
              AND dat_fin_vld_tec IS NULL
             AND sk_sampmatcode_gender > 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_sampmatcode_gender
           INTO sk_ACT
           FROM dim_anagrafica_gender
          WHERE     dat_fin_vld_tec = adesso
                AND sk_sampmatcode_gender > 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_sampmatcode_gender), 1)
           INTO sk
           FROM dim_anagrafica_gender;
      ELSE
         SELECT stacco_sk (MAX (sk_sampmatcode_gender), 1)
           INTO sk_ACT
           FROM dim_anagrafica_gender;

         SELECT stacco_sk (MAX (sk_sampmatcode_gender), 2)
           INTO sk
           FROM dim_anagrafica_gender;
      END IF;

      INSERT INTO dim_anagrafica_gender (       SK_SAMPMATCODE_GENDER,
       SK_ACT_SAMPMATCODE_GENDER,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDFROM_OLD,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC)
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDFROM_OLD,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM ANAGRAFICA_GENDER)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_gender
              WHERE dat_fin_vld_tec IS NULL AND sk_sampmatcode_gender > 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_gender'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_gender'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_gender;


PROCEDURE prc_dim_anagrafica_ingred (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_ingred
    WHERE sk_ingred < 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_ingred (sk_act_ingred,
                                          sk_ingred,
                                          termcode,
                                          TERMEXTENDEDNAME,
                                          VALIDFROM,
                                          VALIDTO,
                                          dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn
      IN (SELECT TERMCODE                                --chiave tecnica gestionale
            FROM dim_anagrafica_ingred
           WHERE dat_fin_vld_tec IS NULL AND sk_ingred > 0
          MINUS
          SELECT TERMCODE FROM anagrafica_ingred)
   LOOP
      UPDATE dim_anagrafica_ingred
         SET dat_fin_vld_tec = adesso
       WHERE --id = cnclzn.id
        sk_ingred > 0 and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch
      IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
            FROM anagrafica_ingred
          MINUS
          SELECT TERMCODE,
                 TERMEXTENDEDNAME,
                 TERMSHORTNAME,
                 VERSION,
                 LASTUPDATE,
                 VALIDTO,
                 STATUS,
                 DEPRECATED,
                 SCIENTIFICNAMES,
                 COMMONNAMES,
                 ALLFACETS,
                 ISSCAAP,
                 TAXONOMICCODE,
                 ALPHA3CODE,
                 GEMSCODE,
                 MATRIXCODE,
                 LANGUALCODE,
                 FOODEXOLDCODE,
                 IMPLICITFACETS,
                 DETAILLEVEL,
                 TERMTYPE,
                 PRODTREAT,
                 PRODMETH,
                 PRODPACK,
                 EURINGSCODE,
                 IFNCODE,
                 EUFEEDREG,
                 MASTERFLAG,
                 MASTERPARENTCODE,
                 MASTERORDER,
                 MASTERREPORTABLE,
                 MASTERHIERARCHYCODE,
                 REPORTFLAG,
                 REPORTPARENTCODE,
                 REPORTORDER,
                 REPORTREPORTABLE,
                 REPORTHIERARCHYCODE,
                 PESTFLAG,
                 PESTPARENTCODE,
                 PESTORDER,
                 PESTREPORTABLE,
                 PESTHIERARCHYCODE,
                 BIOMOFLAG,
                 BIOMOPARENTCODE,
                 BIOMOORDER,
                 BIOMOREPORTABLE,
                 BIOMOHIERARCHYCODE,
                 FEEDFLAG,
                 FEEDPARENTCODE,
                 FEEDORDER,
                 FEEDREPORTABLE,
                 FEEDHIERARCHYCODE,
                 EXPOFLAG,
                 EXPOPARENTCODE,
                 EXPOORDER,
                 EXPOREPORTABLE,
                 EXPOHIERARCHYCODE,
                 VETDRUGFLAG,
                 VETDRUGPARENTCODE,
                 VETDRUGORDER,
                 VETDRUGREPORTABLE,
                 VETDRUGHIERARCHYCODE,
                 BOTANICFLAG,
                 BOTANICPARENTCODE,
                 BOTANICORDER,
                 BOTANICREPORTABLE,
                 BOTANICHIERARCHYCODE,
                 PARTFLAG,
                 PARTPARENTCODE,
                 PARTORDER,
                 PARTREPORTABLE,
                 PARTHIERARCHYCODE,
                 SOURCEFLAG,
                 SOURCEPARENTCODE,
                 SOURCEORDER,
                 SOURCEREPORTABLE,
                 SOURCEHIERARCHYCODE,
                 RACSOURCEFLAG,
                 RACSOURCEPARENTCODE,
                 RACSOURCEORDER,
                 RACSOURCEREPORTABLE,
                 RACSOURCEHIERARCHYCODE,
                 PROCESSFLAG,
                 PROCESSPARENTCODE,
                 PROCESSORDER,
                 PROCESSREPORTABLE,
                 PROCESSHIERARCHYCODE,
                 INGREDFLAG,
                 INGREDPARENTCODE,
                 INGREDORDER,
                 INGREDREPORTABLE,
                 INGREDHIERARCHYCODE,
                 MEDIUMFLAG,
                 MEDIUMPARENTCODE,
                 MEDIUMORDER,
                 MEDIUMREPORTABLE,
                 MEDIUMHIERARCHYCODE,
                 SWEETFLAG,
                 SWEETPARENTCODE,
                 SWEETORDER,
                 SWEETREPORTABLE,
                 SWEETHIERARCHYCODE,
                 FORTFLAG,
                 FORTPARENTCODE,
                 FORTORDER,
                 FORTREPORTABLE,
                 FORTHIERARCHYCODE,
                 QUALFLAG,
                 QUALPARENTCODE,
                 QUALORDER,
                 QUALREPORTABLE,
                 QUALHIERARCHYCODE,
                 COOKEXTFLAG,
                 COOKEXTPARENTCODE,
                 COOKEXTORDER,
                 COOKEXTREPORTABLE,
                 COOKEXTHIERARCHYCODE,
                 GENFLAG,
                 GENPARENTCODE,
                 GENORDER,
                 GENREPORTABLE,
                 GENHIERARCHYCODE,
                 PRODFLAG,
                 PRODPARENTCODE,
                 PRODORDER,
                 PRODREPORTABLE,
                 PRODHIERARCHYCODE,
                 PACKFORMATFLAG,
                 PACKFORMATPARENTCODE,
                 PACKFORMATORDER,
                 PACKFORMATREPORTABLE,
                 PACKFORMATHIERARCHYCODE,
                 PACKMATFLAG,
                 PACKMATPARENTCODE,
                 PACKMATORDER,
                 PACKMATREPORTABLE,
                 PACKMATHIERARCHYCODE,
                 STATEFLAG,
                 STATEPARENTCODE,
                 STATEORDER,
                 STATEREPORTABLE,
                 STATEHIERARCHYCODE,
                 FATFLAG,
                 FATPARENTCODE,
                 FATORDER,
                 FATREPORTABLE,
                 FATHIERARCHYCODE,
                 ALCOHOLFLAG,
                 ALCOHOLPARENTCODE,
                 ALCOHOLORDER,
                 ALCOHOLREPORTABLE,
                 ALCOHOLHIERARCHYCODE,
                 DOUGHFLAG,
                 DOUGHPARENTCODE,
                 DOUGHORDER,
                 DOUGHREPORTABLE,
                 DOUGHHIERARCHYCODE,
                 PARTCONFLAG,
                 PARTCONPARENTCODE,
                 PARTCONORDER,
                 PARTCONREPORTABLE,
                 PARTCONHIERARCHYCODE,
                 PLACEFLAG,
                 PLACEPARENTCODE,
                 PLACEORDER,
                 PLACEREPORTABLE,
                 PLACEHIERARCHYCODE,
                 TARGCONFLAG,
                 TARGCONPARENTCODE,
                 TARGCONORDER,
                 TARGCONREPORTABLE,
                 TARGCONHIERARCHYCODE,
                 USEFLAG,
                 USEPARENTCODE,
                 USEORDER,
                 USEREPORTABLE,
                 USEHIERARCHYCODE,
                 RISKINGREDFLAG,
                 RISKINGREDPARENTCODE,
                 RISKINGREDORDER,
                 RISKINGREDREPORTABLE,
                 RISKINGREDHIERARCHYCODE,
                 FPURPOSEFLAG,
                 FPURPOSEPARENTCODE,
                 FPURPOSEORDER,
                 FPURPOSEREPORTABLE,
                 FPURPOSEHIERARCHYCODE,
                 REPLEVFLAG,
                 REPLEVPARENTCODE,
                 REPLEVORDER,
                 REPLEVREPORTABLE,
                 REPLEVHIERARCHYCODE,
                 ANIMAGEFLAG,
                 ANIMAGEPARENTCODE,
                 ANIMAGEORDER,
                 ANIMAGEREPORTABLE,
                 ANIMAGEHIERARCHYCODE,
                 GENDERFLAG,
                 GENDERPARENTCODE,
                 GENDERORDER,
                 GENDERREPORTABLE,
                 GENDERHIERARCHYCODE,
                 LEGISFLAG,
                 LEGISPARENTCODE,
                 LEGISORDER,
                 LEGISREPORTABLE,
                 LEGISHIERARCHYCODE,
                 FEEDADDEXPOFLAG,
                 FEEDADDEXPOPARENTCODE,
                 FEEDADDEXPOORDER,
                 FEEDADDEXPOREPORTABLE,
                 FEEDADDEXPOHIERARCHYCODE,
                 VALIDFROM
            FROM dim_anagrafica_ingred
           WHERE dat_fin_vld_tec IS NULL AND sk_ingred > 0)
   LOOP
      UPDATE dim_anagrafica_ingred
         SET dat_fin_vld_tec = adesso
       WHERE    -- id = mdfch.id
              termcode = mdfch.termcode
              AND dat_fin_vld_tec IS NULL
             AND sk_ingred > 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_ingred
           INTO sk_ACT
           FROM dim_anagrafica_ingred
          WHERE     dat_fin_vld_tec = adesso
                AND sk_ingred > 0
                AND TERMCODE = MDFCH.TERMCODE;
               -- AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_ingred), 1)
           INTO sk
           FROM dim_anagrafica_ingred;
      ELSE
         SELECT stacco_sk (MAX (sk_ingred), 1)
           INTO sk_ACT
           FROM dim_anagrafica_ingred;

         SELECT stacco_sk (MAX (sk_ingred), 2)
           INTO sk
           FROM dim_anagrafica_ingred;
      END IF;

      INSERT INTO dim_anagrafica_ingred (       SK_INGRED,
       SK_ACT_INGRED,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC)
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_ingred)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_ingred
              WHERE dat_fin_vld_tec IS NULL AND sk_ingred > 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_ingred'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_ingred'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_ingred;



PROCEDURE prc_dim_anagrafica_legis (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_legis
    WHERE sk_legis < 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_legis (sk_act_legis,
                                          sk_legis,
                                          termcode,
                                          TERMEXTENDEDNAME,
                                          VALIDFROM,
                                          VALIDTO,
                                          dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn
      IN (SELECT TERMCODE                                --chiave tecnica gestionale
            FROM dim_anagrafica_legis
           WHERE dat_fin_vld_tec IS NULL AND sk_legis > 0
          MINUS
          SELECT TERMCODE FROM anagrafica_legis)
   LOOP
      UPDATE dim_anagrafica_legis
         SET dat_fin_vld_tec = adesso
       WHERE --id = cnclzn.id
         sk_legis > 0 and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   for mdfch in ( SELECT
   TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       FLAG_BR206
  FROM anagrafica_legis
MINUS
SELECT TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       FLAG_BR206
  FROM dim_anagrafica_legis
 WHERE dat_fin_vld_tec IS NULL AND sk_legis > 0)
   LOOP
      UPDATE dim_anagrafica_legis
         SET dat_fin_vld_tec = adesso
       WHERE    -- id = mdfch.id
              termcode = mdfch.termcode
              AND dat_fin_vld_tec IS NULL
             AND sk_legis > 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_legis
           INTO sk_ACT
           FROM dim_anagrafica_legis
          WHERE     dat_fin_vld_tec = adesso
                AND sk_legis > 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_legis), 1)
           INTO sk
           FROM dim_anagrafica_legis;
      ELSE
         SELECT stacco_sk (MAX (sk_legis), 1)
           INTO sk_ACT
           FROM dim_anagrafica_legis;

         SELECT stacco_sk (MAX (sk_legis), 2)
           INTO sk
           FROM dim_anagrafica_legis;
      END IF;

      INSERT INTO dim_anagrafica_legis (       SK_LEGIS,
       SK_ACT_LEGIS,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       FLAG_BR206,
       DAT_INI_VLD_TEC )
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       mdfch.FLAG_BR206,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_legis)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_legis
              WHERE dat_fin_vld_tec IS NULL AND sk_legis > 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_legis'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_legis'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_legis;



/* Formatted on 06/06/2022 17:23:57 (QP5 v5.139.911.3011) */
PROCEDURE prc_dim_anagrafica_packformat (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_packformat
    WHERE sk_packformat < 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_packformat (sk_act_packformat,
                                             sk_packformat,
                                             termcode,
                                             TERMEXTENDEDNAME,
                                             VALIDFROM,
                                             VALIDTO,
                                             dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERMCODE                  --chiave tecnica gestionale
                    FROM dim_anagrafica_packformat
                   WHERE dat_fin_vld_tec IS NULL AND sk_packformat > 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_packformat)
   LOOP
      UPDATE dim_anagrafica_packformat
         SET dat_fin_vld_tec = adesso
       WHERE                                                  --id = cnclzn.id
            sk_packformat > 0
             AND termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (ALLFACETS) ALLFACETS,
                        TRIM (IFNCODE) IFNCODE,
                        TRIM (GEMSCODE) GEMSCODE,
                        TRIM (EUFEEDREG) EUFEEDREG,
                        TRIM (TERMSHORTNAME) TERMSHORTNAME,
                        TRIM (IMPLICITFACETS) IMPLICITFACETS,
                        TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
                        TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
                        TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
                        TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
                        TRIM (TERMCODE) TERMCODE,
                        TRIM (PRODTREAT) PRODTREAT,
                        TRIM (PRODMETH) PRODMETH,
                        TRIM (PRODPACK) PRODPACK,
                        TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
                        TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
                        TRIM (PESTPARENTCODE) PESTPARENTCODE,
                        TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
                        TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
                        TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
                        TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
                        TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
                        TRIM (PARTPARENTCODE) PARTPARENTCODE,
                        TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
                        TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
                        TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
                        TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
                        TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
                        TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
                        TRIM (FORTPARENTCODE) FORTPARENTCODE,
                        TRIM (QUALPARENTCODE) QUALPARENTCODE,
                        TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
                        TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
                        TRIM (PRODPARENTCODE) PRODPARENTCODE,
                        TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
                        TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
                        TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
                        TRIM (FPURPOSEPARENTCODE)FPURPOSEPARENTCODE ,
                        TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
                        TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
                        TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
                        TRIM (ISSCAAP) ISSCAAP,
                        TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
                        TRIM (GENPARENTCODE) GENPARENTCODE,
                        TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
                        TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
                        TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
                        TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
                        TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
                        TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
                        TRIM (ALPHA3CODE) ALPHA3CODE,
                        TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
                        TRIM (COMMONNAMES) COMMONNAMES,
                        TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
                        TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
                        TRIM (LANGUALCODE) LANGUALCODE,
                        TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
                        TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
                        TRIM (TAXONOMICCODE) TAXONOMICCODE,
                        TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
                        TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
                        TRIM (MATRIXCODE) MATRIXCODE,
                        TRIM (STATUS) STATUS,
                        TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
                        TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
                        TRIM (STATEPARENTCODE) STATEPARENTCODE,
                        TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
                        TRIM (FATPARENTCODE) FATPARENTCODE,
                        TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
                        TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
                        TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
                        TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
                        TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
                        TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
                        TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
                        TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
                        TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
                        TRIM (USEPARENTCODE) USEPARENTCODE,
                        TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
                        TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
                        TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
                        TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
                        TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
                        TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
                        TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
                        TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
                        TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
                        TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
                        TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
                        TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
                        TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
                        TRIM (LASTUPDATE) LASTUPDATE,
                        TRIM(PRODHIERARCHYCODE) PRODHIERARCHYCODE,
                        TRIM(QUALHIERARCHYCODE) QUALHIERARCHYCODE,
                        TRIM(MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
                        TRIM(TERMTYPE) TERMTYPE,
                        TRIM(DETAILLEVEL) DETAILLEVEL,
                        DEPRECATED,
                        EURINGSCODE,
                        MASTERFLAG,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        REPORTFLAG,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        PESTFLAG,
                        PESTORDER,
                        PESTREPORTABLE,
                        BIOMOFLAG,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        FEEDFLAG,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        EXPOFLAG,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        VETDRUGFLAG,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        BOTANICFLAG,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        PARTFLAG,
                        PARTORDER,
                        PARTREPORTABLE,
                        SOURCEFLAG,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        RACSOURCEFLAG,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        PROCESSFLAG,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        INGREDFLAG,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        MEDIUMFLAG,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        SWEETFLAG,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        FORTFLAG,
                        FORTORDER,
                        FORTREPORTABLE,
                        QUALFLAG,
                        QUALORDER,
                        QUALREPORTABLE,
                        COOKEXTFLAG,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        GENFLAG,
                        GENORDER,
                        GENREPORTABLE,
                        PRODFLAG,
                        PRODORDER,
                        PRODREPORTABLE,
                        PACKFORMATFLAG,
                        PACKFORMATORDER,
                        PACKFORMATREPORTABLE,
                        PACKMATFLAG,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        STATEFLAG,
                        STATEORDER,
                        STATEREPORTABLE,
                        FATFLAG,
                        FATORDER,
                        FATREPORTABLE,
                        ALCOHOLFLAG,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        DOUGHFLAG,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        PARTCONFLAG,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PLACEFLAG,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        TARGCONFLAG,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        USEFLAG,
                        USEORDER,
                        USEREPORTABLE,
                        RISKINGREDFLAG,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        FPURPOSEFLAG,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        REPLEVFLAG,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        ANIMAGEFLAG,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        GENDERFLAG,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        LEGISFLAG,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        VERSION,
                        VALIDTO,
                        VALIDFROM
                   FROM anagrafica_packformat
                 MINUS
                 SELECT ALLFACETS,
                        IFNCODE,
                        GEMSCODE,
                        EUFEEDREG,
                        TERMSHORTNAME,
                        IMPLICITFACETS,
                        ALCOHOLHIERARCHYCODE,
                        USEHIERARCHYCODE,
                        MASTERHIERARCHYCODE,
                        REPORTHIERARCHYCODE,
                        TERMCODE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        MASTERPARENTCODE,
                        REPORTPARENTCODE,
                        PESTPARENTCODE,
                        BIOMOPARENTCODE,
                        FEEDPARENTCODE,
                        EXPOPARENTCODE,
                        VETDRUGPARENTCODE,
                        BOTANICPARENTCODE,
                        PARTPARENTCODE,
                        SOURCEPARENTCODE,
                        RACSOURCEPARENTCODE,
                        PROCESSPARENTCODE,
                        INGREDPARENTCODE,
                        MEDIUMPARENTCODE,
                        SWEETPARENTCODE,
                        FORTPARENTCODE,
                        QUALPARENTCODE,
                        COOKEXTHIERARCHYCODE,
                        GENHIERARCHYCODE,
                        PRODPARENTCODE,
                        PACKFORMATHIERARCHYCODE,
                        PACKMATPARENTCODE,
                        FATHIERARCHYCODE,
                        FPURPOSEPARENTCODE,
                        BIOMOHIERARCHYCODE,
                        INGREDHIERARCHYCODE,
                        SOURCEHIERARCHYCODE,
                        ISSCAAP,
                        COOKEXTPARENTCODE,
                        GENPARENTCODE,
                        PACKFORMATPARENTCODE,
                        PESTHIERARCHYCODE,
                        EXPOHIERARCHYCODE,
                        VETDRUGHIERARCHYCODE,
                        RACSOURCEHIERARCHYCODE,
                        PARTHIERARCHYCODE,
                        ALPHA3CODE,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        SWEETHIERARCHYCODE,
                        TERMEXTENDEDNAME,
                        LANGUALCODE,
                        FEEDHIERARCHYCODE,
                        PROCESSHIERARCHYCODE,
                        TAXONOMICCODE,
                        BOTANICHIERARCHYCODE,
                        FORTHIERARCHYCODE,
                        MATRIXCODE,
                        STATUS,
                        FOODEXOLDCODE,
                        PACKMATHIERARCHYCODE,
                        STATEPARENTCODE,
                        STATEHIERARCHYCODE,
                        FATPARENTCODE,
                        ALCOHOLPARENTCODE,
                        DOUGHPARENTCODE,
                        DOUGHHIERARCHYCODE,
                        PARTCONPARENTCODE,
                        PARTCONHIERARCHYCODE,
                        PLACEPARENTCODE,
                        PLACEHIERARCHYCODE,
                        TARGCONPARENTCODE,
                        TARGCONHIERARCHYCODE,
                        USEPARENTCODE,
                        RISKINGREDPARENTCODE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVPARENTCODE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEPARENTCODE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERPARENTCODE VA,
                        GENDERHIERARCHYCODE VA,
                        LEGISPARENTCODE VARCHA,
                        LEGISHIERARCHYCODE VA,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOHIERARCHYCODE,
                        LASTUPDATE,
                        PRODHIERARCHYCODE,
                        QUALHIERARCHYCODE,
                        MEDIUMHIERARCHYCODE,
                        TERMTYPE,
                        DETAILLEVEL,
                        DEPRECATED,
                        EURINGSCODE,
                        MASTERFLAG,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        REPORTFLAG,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        PESTFLAG,
                        PESTORDER,
                        PESTREPORTABLE,
                        BIOMOFLAG,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        FEEDFLAG,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        EXPOFLAG,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        VETDRUGFLAG,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        BOTANICFLAG,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        PARTFLAG,
                        PARTORDER,
                        PARTREPORTABLE,
                        SOURCEFLAG,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        RACSOURCEFLAG,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        PROCESSFLAG,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        INGREDFLAG,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        MEDIUMFLAG,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        SWEETFLAG,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        FORTFLAG,
                        FORTORDER,
                        FORTREPORTABLE,
                        QUALFLAG,
                        QUALORDER,
                        QUALREPORTABLE,
                        COOKEXTFLAG,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        GENFLAG,
                        GENORDER,
                        GENREPORTABLE,
                        PRODFLAG,
                        PRODORDER,
                        PRODREPORTABLE,
                        PACKFORMATFLAG,
                        PACKFORMATORDER,
                        PACKFORMATREPORTABLE,
                        PACKMATFLAG,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        STATEFLAG,
                        STATEORDER,
                        STATEREPORTABLE,
                        FATFLAG,
                        FATORDER,
                        FATREPORTABLE,
                        ALCOHOLFLAG,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        DOUGHFLAG,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        PARTCONFLAG,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PLACEFLAG,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        TARGCONFLAG,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        USEFLAG,
                        USEORDER,
                        USEREPORTABLE,
                        RISKINGREDFLAG,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        FPURPOSEFLAG,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        REPLEVFLAG,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        ANIMAGEFLAG,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        GENDERFLAG,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        LEGISFLAG,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        VERSION,
                        VALIDTO,
                        VALIDFROM
                   FROM dim_anagrafica_packformat
                  WHERE dat_fin_vld_tec IS NULL AND sk_packformat > 0)
   LOOP
      UPDATE dim_anagrafica_packformat
         SET dat_fin_vld_tec = adesso
       WHERE                                                  -- id = mdfch.id
            termcode = mdfch.termcode
             AND dat_fin_vld_tec IS NULL
             AND sk_packformat > 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_packformat
           INTO sk_ACT
           FROM dim_anagrafica_packformat
          WHERE     dat_fin_vld_tec = adesso
                AND sk_packformat > 0
                AND TERMCODE = MDFCH.TERMCODE;

         --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_packformat), 1)
           INTO sk
           FROM dim_anagrafica_packformat;
      ELSE
         SELECT stacco_sk (MAX (sk_packformat), 1)
           INTO sk_ACT
           FROM dim_anagrafica_packformat;

         SELECT stacco_sk (MAX (sk_packformat), 2)
           INTO sk
           FROM dim_anagrafica_packformat;
      END IF;

      INSERT INTO dim_anagrafica_packformat (SK_PACKFORMAT,
                                             SK_ACT_PACKFORMAT,
                                             TERMCODE,
                                             TERMEXTENDEDNAME,
                                             TERMSHORTNAME,
                                             VERSION,
                                             LASTUPDATE,
                                             VALIDTO,
                                             STATUS,
                                             DEPRECATED,
                                             SCIENTIFICNAMES,
                                             COMMONNAMES,
                                             ALLFACETS,
                                             ISSCAAP,
                                             TAXONOMICCODE,
                                             ALPHA3CODE,
                                             GEMSCODE,
                                             MATRIXCODE,
                                             LANGUALCODE,
                                             FOODEXOLDCODE,
                                             IMPLICITFACETS,
                                             DETAILLEVEL,
                                             TERMTYPE,
                                             PRODTREAT,
                                             PRODMETH,
                                             PRODPACK,
                                             EURINGSCODE,
                                             IFNCODE,
                                             EUFEEDREG,
                                             MASTERFLAG,
                                             MASTERPARENTCODE,
                                             MASTERORDER,
                                             MASTERREPORTABLE,
                                             MASTERHIERARCHYCODE,
                                             REPORTFLAG,
                                             REPORTPARENTCODE,
                                             REPORTORDER,
                                             REPORTREPORTABLE,
                                             REPORTHIERARCHYCODE,
                                             PESTFLAG,
                                             PESTPARENTCODE,
                                             PESTORDER,
                                             PESTREPORTABLE,
                                             PESTHIERARCHYCODE,
                                             BIOMOFLAG,
                                             BIOMOPARENTCODE,
                                             BIOMOORDER,
                                             BIOMOREPORTABLE,
                                             BIOMOHIERARCHYCODE,
                                             FEEDFLAG,
                                             FEEDPARENTCODE,
                                             FEEDORDER,
                                             FEEDREPORTABLE,
                                             FEEDHIERARCHYCODE,
                                             EXPOFLAG,
                                             EXPOPARENTCODE,
                                             EXPOORDER,
                                             EXPOREPORTABLE,
                                             EXPOHIERARCHYCODE,
                                             VETDRUGFLAG,
                                             VETDRUGPARENTCODE,
                                             VETDRUGORDER,
                                             VETDRUGREPORTABLE,
                                             VETDRUGHIERARCHYCODE,
                                             BOTANICFLAG,
                                             BOTANICPARENTCODE,
                                             BOTANICORDER,
                                             BOTANICREPORTABLE,
                                             BOTANICHIERARCHYCODE,
                                             PARTFLAG,
                                             PARTPARENTCODE,
                                             PARTORDER,
                                             PARTREPORTABLE,
                                             PARTHIERARCHYCODE,
                                             SOURCEFLAG,
                                             SOURCEPARENTCODE,
                                             SOURCEORDER,
                                             SOURCEREPORTABLE,
                                             SOURCEHIERARCHYCODE,
                                             RACSOURCEFLAG,
                                             RACSOURCEPARENTCODE,
                                             RACSOURCEORDER,
                                             RACSOURCEREPORTABLE,
                                             RACSOURCEHIERARCHYCODE,
                                             PROCESSFLAG,
                                             PROCESSPARENTCODE,
                                             PROCESSORDER,
                                             PROCESSREPORTABLE,
                                             PROCESSHIERARCHYCODE,
                                             INGREDFLAG,
                                             INGREDPARENTCODE,
                                             INGREDORDER,
                                             INGREDREPORTABLE,
                                             INGREDHIERARCHYCODE,
                                             MEDIUMFLAG,
                                             MEDIUMPARENTCODE,
                                             MEDIUMORDER,
                                             MEDIUMREPORTABLE,
                                             MEDIUMHIERARCHYCODE,
                                             SWEETFLAG,
                                             SWEETPARENTCODE,
                                             SWEETORDER,
                                             SWEETREPORTABLE,
                                             SWEETHIERARCHYCODE,
                                             FORTFLAG,
                                             FORTPARENTCODE,
                                             FORTORDER,
                                             FORTREPORTABLE,
                                             FORTHIERARCHYCODE,
                                             QUALFLAG,
                                             QUALPARENTCODE,
                                             QUALORDER,
                                             QUALREPORTABLE,
                                             QUALHIERARCHYCODE,
                                             COOKEXTFLAG,
                                             COOKEXTPARENTCODE,
                                             COOKEXTORDER,
                                             COOKEXTREPORTABLE,
                                             COOKEXTHIERARCHYCODE,
                                             GENFLAG,
                                             GENPARENTCODE,
                                             GENORDER,
                                             GENREPORTABLE,
                                             GENHIERARCHYCODE,
                                             PRODFLAG,
                                             PRODPARENTCODE,
                                             PRODORDER,
                                             PRODREPORTABLE,
                                             PRODHIERARCHYCODE,
                                             PACKFORMATFLAG,
                                             PACKFORMATPARENTCODE,
                                             PACKFORMATORDER,
                                             PACKFORMATREPORTABLE,
                                             PACKFORMATHIERARCHYCODE,
                                             PACKMATFLAG,
                                             PACKMATPARENTCODE,
                                             PACKMATORDER,
                                             PACKMATREPORTABLE,
                                             PACKMATHIERARCHYCODE,
                                             STATEFLAG,
                                             STATEPARENTCODE,
                                             STATEORDER,
                                             STATEREPORTABLE,
                                             STATEHIERARCHYCODE,
                                             FATFLAG,
                                             FATPARENTCODE,
                                             FATORDER,
                                             FATREPORTABLE,
                                             FATHIERARCHYCODE,
                                             ALCOHOLFLAG,
                                             ALCOHOLPARENTCODE,
                                             ALCOHOLORDER,
                                             ALCOHOLREPORTABLE,
                                             ALCOHOLHIERARCHYCODE,
                                             DOUGHFLAG,
                                             DOUGHPARENTCODE,
                                             DOUGHORDER,
                                             DOUGHREPORTABLE,
                                             DOUGHHIERARCHYCODE,
                                             PARTCONFLAG,
                                             PARTCONPARENTCODE,
                                             PARTCONORDER,
                                             PARTCONREPORTABLE,
                                             PARTCONHIERARCHYCODE,
                                             PLACEFLAG,
                                             PLACEPARENTCODE,
                                             PLACEORDER,
                                             PLACEREPORTABLE,
                                             PLACEHIERARCHYCODE,
                                             TARGCONFLAG,
                                             TARGCONPARENTCODE,
                                             TARGCONORDER,
                                             TARGCONREPORTABLE,
                                             TARGCONHIERARCHYCODE,
                                             USEFLAG,
                                             USEPARENTCODE,
                                             USEORDER,
                                             USEREPORTABLE,
                                             USEHIERARCHYCODE,
                                             RISKINGREDFLAG,
                                             RISKINGREDPARENTCODE,
                                             RISKINGREDORDER,
                                             RISKINGREDREPORTABLE,
                                             RISKINGREDHIERARCHYCODE,
                                             FPURPOSEFLAG,
                                             FPURPOSEPARENTCODE,
                                             FPURPOSEORDER,
                                             FPURPOSEREPORTABLE,
                                             FPURPOSEHIERARCHYCODE,
                                             REPLEVFLAG,
                                             REPLEVPARENTCODE,
                                             REPLEVORDER,
                                             REPLEVREPORTABLE,
                                             REPLEVHIERARCHYCODE,
                                             ANIMAGEFLAG,
                                             ANIMAGEPARENTCODE,
                                             ANIMAGEORDER,
                                             ANIMAGEREPORTABLE,
                                             ANIMAGEHIERARCHYCODE,
                                             GENDERFLAG,
                                             GENDERPARENTCODE,
                                             GENDERORDER,
                                             GENDERREPORTABLE,
                                             GENDERHIERARCHYCODE,
                                             LEGISFLAG,
                                             LEGISPARENTCODE,
                                             LEGISORDER,
                                             LEGISREPORTABLE,
                                             LEGISHIERARCHYCODE,
                                             FEEDADDEXPOFLAG,
                                             FEEDADDEXPOPARENTCODE,
                                             FEEDADDEXPOORDER,
                                             FEEDADDEXPOREPORTABLE,
                                             FEEDADDEXPOHIERARCHYCODE,
                                             VALIDFROM,
                                             DAT_INI_VLD_TEC)
           VALUES (SK,
                   SK_ACT,
                   mdfch.TERMCODE,
                   mdfch.TERMEXTENDEDNAME,
                   mdfch.TERMSHORTNAME,
                   mdfch.VERSION,
                   mdfch.LASTUPDATE,
                   mdfch.VALIDTO,
                   mdfch.STATUS,
                   mdfch.DEPRECATED,
                   mdfch.SCIENTIFICNAMES,
                   mdfch.COMMONNAMES,
                   mdfch.ALLFACETS,
                   mdfch.ISSCAAP,
                   mdfch.TAXONOMICCODE,
                   mdfch.ALPHA3CODE,
                   mdfch.GEMSCODE,
                   mdfch.MATRIXCODE,
                   mdfch.LANGUALCODE,
                   mdfch.FOODEXOLDCODE,
                   mdfch.IMPLICITFACETS,
                   mdfch.DETAILLEVEL,
                   mdfch.TERMTYPE,
                   mdfch.PRODTREAT,
                   mdfch.PRODMETH,
                   mdfch.PRODPACK,
                   mdfch.EURINGSCODE,
                   mdfch.IFNCODE,
                   mdfch.EUFEEDREG,
                   mdfch.MASTERFLAG,
                   mdfch.MASTERPARENTCODE,
                   mdfch.MASTERORDER,
                   mdfch.MASTERREPORTABLE,
                   mdfch.MASTERHIERARCHYCODE,
                   mdfch.REPORTFLAG,
                   mdfch.REPORTPARENTCODE,
                   mdfch.REPORTORDER,
                   mdfch.REPORTREPORTABLE,
                   mdfch.REPORTHIERARCHYCODE,
                   mdfch.PESTFLAG,
                   mdfch.PESTPARENTCODE,
                   mdfch.PESTORDER,
                   mdfch.PESTREPORTABLE,
                   mdfch.PESTHIERARCHYCODE,
                   mdfch.BIOMOFLAG,
                   mdfch.BIOMOPARENTCODE,
                   mdfch.BIOMOORDER,
                   mdfch.BIOMOREPORTABLE,
                   mdfch.BIOMOHIERARCHYCODE,
                   mdfch.FEEDFLAG,
                   mdfch.FEEDPARENTCODE,
                   mdfch.FEEDORDER,
                   mdfch.FEEDREPORTABLE,
                   mdfch.FEEDHIERARCHYCODE,
                   mdfch.EXPOFLAG,
                   mdfch.EXPOPARENTCODE,
                   mdfch.EXPOORDER,
                   mdfch.EXPOREPORTABLE,
                   mdfch.EXPOHIERARCHYCODE,
                   mdfch.VETDRUGFLAG,
                   mdfch.VETDRUGPARENTCODE,
                   mdfch.VETDRUGORDER,
                   mdfch.VETDRUGREPORTABLE,
                   mdfch.VETDRUGHIERARCHYCODE,
                   mdfch.BOTANICFLAG,
                   mdfch.BOTANICPARENTCODE,
                   mdfch.BOTANICORDER,
                   mdfch.BOTANICREPORTABLE,
                   mdfch.BOTANICHIERARCHYCODE,
                   mdfch.PARTFLAG,
                   mdfch.PARTPARENTCODE,
                   mdfch.PARTORDER,
                   mdfch.PARTREPORTABLE,
                   mdfch.PARTHIERARCHYCODE,
                   mdfch.SOURCEFLAG,
                   mdfch.SOURCEPARENTCODE,
                   mdfch.SOURCEORDER,
                   mdfch.SOURCEREPORTABLE,
                   mdfch.SOURCEHIERARCHYCODE,
                   mdfch.RACSOURCEFLAG,
                   mdfch.RACSOURCEPARENTCODE,
                   mdfch.RACSOURCEORDER,
                   mdfch.RACSOURCEREPORTABLE,
                   mdfch.RACSOURCEHIERARCHYCODE,
                   mdfch.PROCESSFLAG,
                   mdfch.PROCESSPARENTCODE,
                   mdfch.PROCESSORDER,
                   mdfch.PROCESSREPORTABLE,
                   mdfch.PROCESSHIERARCHYCODE,
                   mdfch.INGREDFLAG,
                   mdfch.INGREDPARENTCODE,
                   mdfch.INGREDORDER,
                   mdfch.INGREDREPORTABLE,
                   mdfch.INGREDHIERARCHYCODE,
                   mdfch.MEDIUMFLAG,
                   mdfch.MEDIUMPARENTCODE,
                   mdfch.MEDIUMORDER,
                   mdfch.MEDIUMREPORTABLE,
                   mdfch.MEDIUMHIERARCHYCODE,
                   mdfch.SWEETFLAG,
                   mdfch.SWEETPARENTCODE,
                   mdfch.SWEETORDER,
                   mdfch.SWEETREPORTABLE,
                   mdfch.SWEETHIERARCHYCODE,
                   mdfch.FORTFLAG,
                   mdfch.FORTPARENTCODE,
                   mdfch.FORTORDER,
                   mdfch.FORTREPORTABLE,
                   mdfch.FORTHIERARCHYCODE,
                   mdfch.QUALFLAG,
                   mdfch.QUALPARENTCODE,
                   mdfch.QUALORDER,
                   mdfch.QUALREPORTABLE,
                   mdfch.QUALHIERARCHYCODE,
                   mdfch.COOKEXTFLAG,
                   mdfch.COOKEXTPARENTCODE,
                   mdfch.COOKEXTORDER,
                   mdfch.COOKEXTREPORTABLE,
                   mdfch.COOKEXTHIERARCHYCODE,
                   mdfch.GENFLAG,
                   mdfch.GENPARENTCODE,
                   mdfch.GENORDER,
                   mdfch.GENREPORTABLE,
                   mdfch.GENHIERARCHYCODE,
                   mdfch.PRODFLAG,
                   mdfch.PRODPARENTCODE,
                   mdfch.PRODORDER,
                   mdfch.PRODREPORTABLE,
                   mdfch.PRODHIERARCHYCODE,
                   mdfch.PACKFORMATFLAG,
                   mdfch.PACKFORMATPARENTCODE,
                   mdfch.PACKFORMATORDER,
                   mdfch.PACKFORMATREPORTABLE,
                   mdfch.PACKFORMATHIERARCHYCODE,
                   mdfch.PACKMATFLAG,
                   mdfch.PACKMATPARENTCODE,
                   mdfch.PACKMATORDER,
                   mdfch.PACKMATREPORTABLE,
                   mdfch.PACKMATHIERARCHYCODE,
                   mdfch.STATEFLAG,
                   mdfch.STATEPARENTCODE,
                   mdfch.STATEORDER,
                   mdfch.STATEREPORTABLE,
                   mdfch.STATEHIERARCHYCODE,
                   mdfch.FATFLAG,
                   mdfch.FATPARENTCODE,
                   mdfch.FATORDER,
                   mdfch.FATREPORTABLE,
                   mdfch.FATHIERARCHYCODE,
                   mdfch.ALCOHOLFLAG,
                   mdfch.ALCOHOLPARENTCODE,
                   mdfch.ALCOHOLORDER,
                   mdfch.ALCOHOLREPORTABLE,
                   mdfch.ALCOHOLHIERARCHYCODE,
                   mdfch.DOUGHFLAG,
                   mdfch.DOUGHPARENTCODE,
                   mdfch.DOUGHORDER,
                   mdfch.DOUGHREPORTABLE,
                   mdfch.DOUGHHIERARCHYCODE,
                   mdfch.PARTCONFLAG,
                   mdfch.PARTCONPARENTCODE,
                   mdfch.PARTCONORDER,
                   mdfch.PARTCONREPORTABLE,
                   mdfch.PARTCONHIERARCHYCODE,
                   mdfch.PLACEFLAG,
                   mdfch.PLACEPARENTCODE,
                   mdfch.PLACEORDER,
                   mdfch.PLACEREPORTABLE,
                   mdfch.PLACEHIERARCHYCODE,
                   mdfch.TARGCONFLAG,
                   mdfch.TARGCONPARENTCODE,
                   mdfch.TARGCONORDER,
                   mdfch.TARGCONREPORTABLE,
                   mdfch.TARGCONHIERARCHYCODE,
                   mdfch.USEFLAG,
                   mdfch.USEPARENTCODE,
                   mdfch.USEORDER,
                   mdfch.USEREPORTABLE,
                   mdfch.USEHIERARCHYCODE,
                   mdfch.RISKINGREDFLAG,
                   mdfch.RISKINGREDPARENTCODE,
                   mdfch.RISKINGREDORDER,
                   mdfch.RISKINGREDREPORTABLE,
                   mdfch.RISKINGREDHIERARCHYCODE,
                   mdfch.FPURPOSEFLAG,
                   mdfch.FPURPOSEPARENTCODE,
                   mdfch.FPURPOSEORDER,
                   mdfch.FPURPOSEREPORTABLE,
                   mdfch.FPURPOSEHIERARCHYCODE,
                   mdfch.REPLEVFLAG,
                   mdfch.REPLEVPARENTCODE,
                   mdfch.REPLEVORDER,
                   mdfch.REPLEVREPORTABLE,
                   mdfch.REPLEVHIERARCHYCODE,
                   mdfch.ANIMAGEFLAG,
                   mdfch.ANIMAGEPARENTCODE,
                   mdfch.ANIMAGEORDER,
                   mdfch.ANIMAGEREPORTABLE,
                   mdfch.ANIMAGEHIERARCHYCODE,
                   mdfch.GENDERFLAG,
                   mdfch.GENDERPARENTCODE,
                   mdfch.GENDERORDER,
                   mdfch.GENDERREPORTABLE,
                   mdfch.GENDERHIERARCHYCODE,
                   mdfch.LEGISFLAG,
                   mdfch.LEGISPARENTCODE,
                   mdfch.LEGISORDER,
                   mdfch.LEGISREPORTABLE,
                   mdfch.LEGISHIERARCHYCODE,
                   mdfch.FEEDADDEXPOFLAG,
                   mdfch.FEEDADDEXPOPARENTCODE,
                   mdfch.FEEDADDEXPOORDER,
                   mdfch.FEEDADDEXPOREPORTABLE,
                   mdfch.FEEDADDEXPOHIERARCHYCODE,
                   mdfch.VALIDFROM,
                   ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_packformat)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_packformat
              WHERE dat_fin_vld_tec IS NULL AND sk_packformat > 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_packformat'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_packformat'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_packformat;



PROCEDURE prc_dim_anagrafica_packmat (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_packmat
    WHERE sk_packmat < 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_packmat (sk_act_packmat,
                                             sk_packmat,
                                             termcode,
                                             TERMEXTENDEDNAME,
                                             VALIDFROM,
                                             VALIDTO,
                                             dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERMCODE                        --chiave tecnica gestionale
                    FROM dim_anagrafica_packmat
                   WHERE dat_fin_vld_tec IS NULL AND sk_packmat > 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_packmat)
   LOOP
      UPDATE dim_anagrafica_packmat
         SET dat_fin_vld_tec = adesso
       WHERE --id = cnclzn.id
        sk_packmat > 0 and termcode = cnclzn.termcode
                                                 AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
                   FROM anagrafica_packmat
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        VALIDTO,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
                        PACKFORMATPARENTCODE,
                        PACKFORMATORDER,
                        PACKFORMATREPORTABLE,
                        PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM
                   FROM dim_anagrafica_packmat
                  WHERE dat_fin_vld_tec IS NULL AND sk_packmat > 0)
   LOOP
      UPDATE dim_anagrafica_packmat
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
              termcode = mdfch.termcode
              AND dat_fin_vld_tec IS NULL
             AND sk_packmat > 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_packmat
           INTO sk_ACT
           FROM dim_anagrafica_packmat
          WHERE     dat_fin_vld_tec = adesso
                AND sk_packmat > 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_packmat), 1)
           INTO sk
           FROM dim_anagrafica_packmat;
      ELSE
         SELECT stacco_sk (MAX (sk_packmat), 1)
           INTO sk_ACT
           FROM dim_anagrafica_packmat;

         SELECT stacco_sk (MAX (sk_packmat), 2)
           INTO sk
           FROM dim_anagrafica_packmat;
      END IF;

      INSERT INTO dim_anagrafica_packmat (       SK_PACKMAT,
       SK_ACT_PACKMAT,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC
)
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_packmat)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_packmat
              WHERE dat_fin_vld_tec IS NULL AND sk_packmat > 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_packmat'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_packmat'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_packmat;


PROCEDURE prc_dim_anagrafica_part_nature (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_part_nature
    WHERE sk_part_nature < 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_part_nature (sk_act_part_nature,
                                             sk_part_nature,
                                             termcode,
                                             TERMEXTENDEDNAME,
                                             VALIDFROM,
                                             VALIDTO,
                                             dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERMCODE                        --chiave tecnica gestionale
                    FROM dim_anagrafica_part_nature
                   WHERE dat_fin_vld_tec IS NULL AND sk_part_nature > 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_part_nature)
   LOOP
      UPDATE dim_anagrafica_part_nature
         SET dat_fin_vld_tec = adesso
       WHERE --id = cnclzn.id
        sk_part_nature > 0 and termcode = cnclzn.termcode
                                                 AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
                   FROM anagrafica_part_nature
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        VALIDTO,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
                        PACKFORMATPARENTCODE,
                        PACKFORMATORDER,
                        PACKFORMATREPORTABLE,
                        PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM
                   FROM dim_anagrafica_part_nature
                  WHERE dat_fin_vld_tec IS NULL AND sk_part_nature > 0)
   LOOP
      UPDATE dim_anagrafica_part_nature
         SET dat_fin_vld_tec = adesso
       WHERE    -- id = mdfch.id
              termcode = mdfch.termcode
              AND dat_fin_vld_tec IS NULL
             AND sk_part_nature > 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_part_nature
           INTO sk_ACT
           FROM dim_anagrafica_part_nature
          WHERE     dat_fin_vld_tec = adesso
                AND sk_part_nature > 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_part_nature), 1)
           INTO sk
           FROM dim_anagrafica_part_nature;
      ELSE
         SELECT stacco_sk (MAX (sk_part_nature), 1)
           INTO sk_ACT
           FROM dim_anagrafica_part_nature;

         SELECT stacco_sk (MAX (sk_part_nature), 2)
           INTO sk
           FROM dim_anagrafica_part_nature;
      END IF;

      INSERT INTO dim_anagrafica_part_nature (       SK_PART_NATURE,
       SK_ACT_PART_NATURE,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC
)
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_part_nature)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_part_nature
              WHERE dat_fin_vld_tec IS NULL AND sk_part_nature > 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_part_nature'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_part_nature'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_part_nature;



PROCEDURE prc_dim_anagrafica_partconsum (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_partconsumed
    WHERE sk_partconsumed < 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_partconsumed (sk_act_partconsumed,
                                               sk_partconsumed,
                                               termcode,
                                               TERMEXTENDEDNAME,
                                               VALIDFROM,
                                               VALIDTO,
                                               dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERMCODE                        --chiave tecnica gestionale
                    FROM dim_anagrafica_partconsumed
                   WHERE dat_fin_vld_tec IS NULL AND sk_partconsumed > 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_partconsumed)
   LOOP
      UPDATE dim_anagrafica_partconsumed
         SET dat_fin_vld_tec = adesso
       WHERE     --id = cnclzn.id
              sk_partconsumed > 0     and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
                   FROM anagrafica_partconsumed
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        VALIDTO,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
                        PACKFORMATPARENTCODE,
                        PACKFORMATORDER,
                        PACKFORMATREPORTABLE,
                        PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM
                   FROM dim_anagrafica_partconsumed
                  WHERE dat_fin_vld_tec IS NULL AND sk_partconsumed > 0)
   LOOP
      UPDATE dim_anagrafica_partconsumed
         SET dat_fin_vld_tec = adesso
       WHERE     --ID = mdfch.id
              termcode = mdfch.termcode
              AND dat_fin_vld_tec IS NULL
             AND sk_partconsumed > 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_partconsumed
           INTO sk_ACT
           FROM dim_anagrafica_partconsumed
          WHERE     dat_fin_vld_tec = adesso
                AND sk_partconsumed > 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_partconsumed), 1)
           INTO sk
           FROM dim_anagrafica_partconsumed;
      ELSE
         SELECT stacco_sk (MAX (sk_partconsumed), 1)
           INTO sk_ACT
           FROM dim_anagrafica_partconsumed;

         SELECT stacco_sk (MAX (sk_partconsumed), 2)
           INTO sk
           FROM dim_anagrafica_partconsumed;
      END IF;

      INSERT INTO dim_anagrafica_partconsumed (       SK_PARTCONSUMED,
       SK_ACT_PARTCONSUMED,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC
)
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_partconsumed)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_partconsumed
              WHERE dat_fin_vld_tec IS NULL AND sk_partconsumed > 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_partconsumed'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_partconsumed'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_partconsum;




PROCEDURE prc_dim_anagrafica_place (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_place
    WHERE sk_place < 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_place (sk_act_place,
                                               sk_place,
                                               termcode,
                                               TERMEXTENDEDNAME,
                                               VALIDFROM,
                                               VALIDTO,
                                               dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERMCODE                        --chiave tecnica gestionale
                    FROM dim_anagrafica_place
                   WHERE dat_fin_vld_tec IS NULL AND sk_place > 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_place)
   LOOP
      UPDATE dim_anagrafica_place
         SET dat_fin_vld_tec = adesso
       WHERE     --id = cnclzn.id
              sk_place > 0      and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
                   FROM anagrafica_place
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        VALIDTO,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
                        PACKFORMATPARENTCODE,
                        PACKFORMATORDER,
                        PACKFORMATREPORTABLE,
                        PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM
                   FROM dim_anagrafica_place
                  WHERE dat_fin_vld_tec IS NULL AND sk_place > 0)
   LOOP
      UPDATE dim_anagrafica_place
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
              termcode = mdfch.termcode
              AND dat_fin_vld_tec IS NULL
             AND sk_place > 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_place
           INTO sk_ACT
           FROM dim_anagrafica_place
          WHERE     dat_fin_vld_tec = adesso
                AND sk_place > 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_place), 1)
           INTO sk
           FROM dim_anagrafica_place;
      ELSE
         SELECT stacco_sk (MAX (sk_place), 1)
           INTO sk_ACT
           FROM dim_anagrafica_place;

         SELECT stacco_sk (MAX (sk_place), 2)
           INTO sk
           FROM dim_anagrafica_place;
      END IF;

      INSERT INTO dim_anagrafica_place (       SK_PLACE,
       SK_ACT_PLACE,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC
)
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_place)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_place
              WHERE dat_fin_vld_tec IS NULL AND sk_place > 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_place'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_place'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_place;



PROCEDURE prc_dim_anagrafica_proces (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_proces
    WHERE sk_proces< 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_proces (sk_act_proces,
                                               sk_proces,
                                               termcode,
                                               TERMEXTENDEDNAME,
                                               VALIDFROM,
                                               VALIDTO,
                                               dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERMCODE                        --chiave tecnica gestionale
                    FROM dim_anagrafica_proces
                   WHERE dat_fin_vld_tec IS NULL AND sk_proces> 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_proces)
   LOOP
      UPDATE dim_anagrafica_proces
         SET dat_fin_vld_tec = adesso
       WHERE     --id = cnclzn.id
              sk_proces> 0       and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
                   FROM anagrafica_proces
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        VALIDTO,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
                        PACKFORMATPARENTCODE,
                        PACKFORMATORDER,
                        PACKFORMATREPORTABLE,
                        PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM
                   FROM dim_anagrafica_proces
                  WHERE dat_fin_vld_tec IS NULL AND sk_proces> 0)
   LOOP
      UPDATE dim_anagrafica_proces
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
              termcode = mdfch.termcode
             AND dat_fin_vld_tec IS NULL
             AND sk_proces> 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_proces
           INTO sk_ACT
           FROM dim_anagrafica_proces
          WHERE     dat_fin_vld_tec = adesso
                AND sk_proces> 0
                AND TERMCODE = MDFCH.TERMCODE;
               -- AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_proces), 1)
           INTO sk
           FROM dim_anagrafica_proces;
      ELSE
         SELECT stacco_sk (MAX (sk_proces), 1)
           INTO sk_ACT
           FROM dim_anagrafica_proces;

         SELECT stacco_sk (MAX (sk_proces), 2)
           INTO sk
           FROM dim_anagrafica_proces;
      END IF;

      insert into dim_anagrafica_proces
    ( SK_PROCES,
       SK_ACT_PROCES,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC)
    values
    ( SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO );
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_proces)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_proces
              WHERE dat_fin_vld_tec IS NULL AND sk_proces> 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_proces'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_proces'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_proces;



PROCEDURE prc_dim_anagrafica_prod_meth (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM DIM_ANAG_PRODUCTION_METHOD
    WHERE sk_production_method< 0;

   IF n_dummy = 0
   THEN
      INSERT INTO DIM_ANAG_PRODUCTION_METHOD (sk_act_production_method,
                                               sk_production_method,
                                               termcode,
                                               TERMEXTENDEDNAME,
                                               VALIDFROM,
                                               VALIDTO,
                                               dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERMCODE                        --chiave tecnica gestionale
                    FROM DIM_ANAG_PRODUCTION_METHOD
                   WHERE dat_fin_vld_tec IS NULL AND sk_production_method> 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_production_method)
   LOOP
      UPDATE DIM_ANAG_PRODUCTION_METHOD
         SET dat_fin_vld_tec = adesso
       WHERE    -- id = cnclzn.id
              sk_production_method> 0        and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       TRIM (VALIDFROM_OLD) VALIDFROM_OLD,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
                   FROM anagrafica_production_method
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        VALIDFROM_OLD,
                        VALIDTO,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
                        PACKFORMATPARENTCODE,
                        PACKFORMATORDER,
                        PACKFORMATREPORTABLE,
                        PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM
                   FROM DIM_ANAG_PRODUCTION_METHOD
                  WHERE dat_fin_vld_tec IS NULL AND sk_production_method> 0)
   LOOP
      UPDATE DIM_ANAG_PRODUCTION_METHOD
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
              termcode = mdfch.termcode
             AND dat_fin_vld_tec IS NULL
             AND sk_production_method> 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_production_method
           INTO sk_ACT
           FROM DIM_ANAG_PRODUCTION_METHOD
          WHERE     dat_fin_vld_tec = adesso
                AND sk_production_method> 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_production_method), 1)
           INTO sk
           FROM DIM_ANAG_PRODUCTION_METHOD;
      ELSE
         SELECT stacco_sk (MAX (sk_production_method), 1)
           INTO sk_ACT
           FROM DIM_ANAG_PRODUCTION_METHOD;

         SELECT stacco_sk (MAX (sk_production_method), 2)
           INTO sk
           FROM DIM_ANAG_PRODUCTION_METHOD;
      END IF;

      INSERT INTO DIM_ANAG_PRODUCTION_METHOD (       SK_PRODUCTION_METHOD,
       SK_ACT_PRODUCTION_METHOD,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDFROM_OLD,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC
)
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDFROM_OLD,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_production_method)
          - (SELECT COUNT (1) num_r_dim
               FROM DIM_ANAG_PRODUCTION_METHOD
              WHERE dat_fin_vld_tec IS NULL AND sk_production_method> 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'DIM_ANAG_PRODUCTION_METHOD'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'DIM_ANAG_PRODUCTION_METHOD'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_prod_meth;


PROCEDURE prc_dim_anagrafica_qualinfo (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_qualinfo
    WHERE sk_qualinfo< 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_qualinfo (sk_act_qualinfo,
                                               sk_qualinfo,
                                               termcode,
                                               TERMEXTENDEDNAME,
                                               VALIDFROM,
                                               VALIDTO,
                                               dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT termcode                        --chiave tecnica gestionale
                    FROM dim_anagrafica_qualinfo
                   WHERE dat_fin_vld_tec IS NULL AND sk_qualinfo> 0
                  MINUS
                  SELECT termcode FROM anagrafica_qualinfo)
   LOOP
      UPDATE dim_anagrafica_qualinfo
         SET dat_fin_vld_tec = adesso
       WHERE     --id = cnclzn.id
              sk_qualinfo> 0      and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       TRIM (VALIDFROM_OLD) VALIDFROM_OLD,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
                   FROM anagrafica_qualinfo
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        VALIDFROM_OLD,
                        VALIDTO,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
                        PACKFORMATPARENTCODE,
                        PACKFORMATORDER,
                        PACKFORMATREPORTABLE,
                        PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM
                   FROM dim_anagrafica_qualinfo
                  WHERE dat_fin_vld_tec IS NULL AND sk_qualinfo> 0)
   LOOP
      UPDATE dim_anagrafica_qualinfo
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
              termcode = mdfch.termcode
             AND dat_fin_vld_tec IS NULL
             AND sk_qualinfo> 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_qualinfo
           INTO sk_ACT
           FROM dim_anagrafica_qualinfo
          WHERE     dat_fin_vld_tec = adesso
                AND sk_qualinfo> 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_qualinfo), 1)
           INTO sk
           FROM dim_anagrafica_qualinfo;
      ELSE
         SELECT stacco_sk (MAX (sk_qualinfo), 1)
           INTO sk_ACT
           FROM dim_anagrafica_qualinfo;

         SELECT stacco_sk (MAX (sk_qualinfo), 2)
           INTO sk
           FROM dim_anagrafica_qualinfo;
      END IF;

      INSERT INTO dim_anagrafica_qualinfo (       SK_QUALINFO,
       SK_ACT_QUALINFO,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDFROM_OLD,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC
)
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDFROM_OLD,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_qualinfo)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_qualinfo
              WHERE dat_fin_vld_tec IS NULL AND sk_qualinfo> 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_qualinfo'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_qualinfo'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_qualinfo;



PROCEDURE prc_dim_anagrafica_report (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_report
    WHERE sk_anmatcode_building< 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_report (sk_act_anmatcode_building,
                                               sk_anmatcode_building,
                                               termcode,
                                               TERMEXTENDEDNAME,
                                               VALIDFROM,
                                               VALIDTO,
                                               dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERMCODE                        --chiave tecnica gestionale
                    FROM dim_anagrafica_report
                   WHERE dat_fin_vld_tec IS NULL AND sk_anmatcode_building> 0
                  MINUS
                  SELECT TERMCODE FROM v_anagrafica_report)
   LOOP
      UPDATE dim_anagrafica_report
         SET dat_fin_vld_tec = adesso
       WHERE     --id = cnclzn.id
              sk_anmatcode_building> 0
              and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (
SELECT VALIDTO,
       VALIDFROM,
       DEPRECATED,
       EURINGSCODE,
       MASTERFLAG,
       MASTERORDER,
       MASTERREPORTABLE,
       REPORTFLAG,
       REPORTORDER,
       REPORTREPORTABLE,
       PESTFLAG,
       PESTORDER,
       PESTREPORTABLE,
       BIOMOFLAG,
       BIOMOORDER,
       BIOMOREPORTABLE,
       FEEDFLAG,
       FEEDORDER,
       FEEDREPORTABLE,
       EXPOFLAG,
       EXPOORDER,
       EXPOREPORTABLE,
       VETDRUGFLAG,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       BOTANICFLAG,
       BOTANICORDER,
       BOTANICREPORTABLE,
       PARTFLAG,
       PARTORDER,
       PARTREPORTABLE,
       SOURCEFLAG,
       SOURCEORDER,
       SOURCEREPORTABLE,
       RACSOURCEFLAG,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       PROCESSFLAG,
       PROCESSORDER,
       PROCESSREPORTABLE,
       INGREDFLAG,
       INGREDORDER,
       INGREDREPORTABLE,
       MEDIUMFLAG,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       SWEETFLAG,
       SWEETORDER,
       SWEETREPORTABLE,
       FORTFLAG,
       FORTORDER,
       FORTREPORTABLE,
       QUALFLAG,
       QUALORDER,
       QUALREPORTABLE,
       COOKEXTFLAG,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       GENFLAG,
       GENORDER,
       GENREPORTABLE,
       PRODFLAG,
       PRODORDER,
       PRODREPORTABLE,
       PACKFORMATFLAG,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKMATFLAG,
       PACKMATORDER,
       PACKMATREPORTABLE,
       STATEFLAG,
       STATEORDER,
       STATEREPORTABLE,
       FATFLAG,
       FATORDER,
       FATREPORTABLE,
       ALCOHOLFLAG,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       DOUGHFLAG,
       DOUGHORDER,
       DOUGHREPORTABLE,
       PARTCONFLAG,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PLACEFLAG,
       PLACEORDER,
       PLACEREPORTABLE,
       TARGCONFLAG,
       TARGCONORDER,
       TARGCONREPORTABLE,
       USEFLAG,
       USEORDER,
       USEREPORTABLE,
       RISKINGREDFLAG,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       FPURPOSEFLAG,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       REPLEVFLAG,
       REPLEVORDER,
       REPLEVREPORTABLE,
       ANIMAGEFLAG,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       GENDERFLAG,
       GENDERORDER,
       GENDERREPORTABLE,
       LEGISFLAG,
       LEGISORDER,
       LEGISREPORTABLE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       VERSION,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (LASTUPDATE) LASTUPDATE,
       TRIM (VALIDFROM_VARCHAR) VALIDFROM_VARCHAR,
       TRIM (VALIDTO_VARCHAR) VALIDTO_VARCHAR,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       TRIM (QUALHIERARCHYCODE)QUALHIERARCHYCODE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       TRIM (STATUS) STATUS,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (TERMCODE) TERMCODE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       TRIM (FOODEX2_CODE) FOODEX2_CODE,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       TRIM (HIERARCY_CODE) HIERARCY_CODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       TRIM (IFNCODE) IFNCODE,
       TRIM (PROG_CODE) PROG_CODE,
       TRIM (ALLFACETS) ALLFACETS
  FROM v_anagrafica_report
MINUS
SELECT VALIDTO,
       VALIDFROM,
       DEPRECATED,
       EURINGSCODE,
       MASTERFLAG,
       MASTERORDER,
       MASTERREPORTABLE,
       REPORTFLAG,
       REPORTORDER,
       REPORTREPORTABLE,
       PESTFLAG,
       PESTORDER,
       PESTREPORTABLE,
       BIOMOFLAG,
       BIOMOORDER,
       BIOMOREPORTABLE,
       FEEDFLAG,
       FEEDORDER,
       FEEDREPORTABLE,
       EXPOFLAG,
       EXPOORDER,
       EXPOREPORTABLE,
       VETDRUGFLAG,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       BOTANICFLAG,
       BOTANICORDER,
       BOTANICREPORTABLE,
       PARTFLAG,
       PARTORDER,
       PARTREPORTABLE,
       SOURCEFLAG,
       SOURCEORDER,
       SOURCEREPORTABLE,
       RACSOURCEFLAG,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       PROCESSFLAG,
       PROCESSORDER,
       PROCESSREPORTABLE,
       INGREDFLAG,
       INGREDORDER,
       INGREDREPORTABLE,
       MEDIUMFLAG,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       SWEETFLAG,
       SWEETORDER,
       SWEETREPORTABLE,
       FORTFLAG,
       FORTORDER,
       FORTREPORTABLE,
       QUALFLAG,
       QUALORDER,
       QUALREPORTABLE,
       COOKEXTFLAG,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       GENFLAG,
       GENORDER,
       GENREPORTABLE,
       PRODFLAG,
       PRODORDER,
       PRODREPORTABLE,
       PACKFORMATFLAG,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKMATFLAG,
       PACKMATORDER,
       PACKMATREPORTABLE,
       STATEFLAG,
       STATEORDER,
       STATEREPORTABLE,
       FATFLAG,
       FATORDER,
       FATREPORTABLE,
       ALCOHOLFLAG,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       DOUGHFLAG,
       DOUGHORDER,
       DOUGHREPORTABLE,
       PARTCONFLAG,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PLACEFLAG,
       PLACEORDER,
       PLACEREPORTABLE,
       TARGCONFLAG,
       TARGCONORDER,
       TARGCONREPORTABLE,
       USEFLAG,
       USEORDER,
       USEREPORTABLE,
       RISKINGREDFLAG,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       FPURPOSEFLAG,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       REPLEVFLAG,
       REPLEVORDER,
       REPLEVREPORTABLE,
       ANIMAGEFLAG,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       GENDERFLAG,
       GENDERORDER,
       GENDERREPORTABLE,
       LEGISFLAG,
       LEGISORDER,
       LEGISREPORTABLE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       VERSION,
       DETAILLEVEL,
       TERMTYPE,
       LASTUPDATE,
       VALIDFROM_VARCHAR,
       VALIDTO_VARCHAR,
       MEDIUMHIERARCHYCODE,
       QUALHIERARCHYCODE,
       PRODHIERARCHYCODE,
       PACKMATHIERARCHYCODE,
       STATEPARENTCODE,
       STATEHIERARCHYCODE,
       FATPARENTCODE,
       ALCOHOLPARENTCODE,
       DOUGHPARENTCODE,
       DOUGHHIERARCHYCODE,
       PARTCONPARENTCODE,
       PARTCONHIERARCHYCODE,
       PLACEPARENTCODE,
       PLACEHIERARCHYCODE,
       TARGCONPARENTCODE,
       TARGCONHIERARCHYCODE,
       USEPARENTCODE,
       RISKINGREDPARENTCODE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEHIERARCHYCODE,
       REPLEVPARENTCODE,
       REPLEVHIERARCHYCODE,
       ANIMAGEPARENTCODE,
       ANIMAGEHIERARCHYCODE,
       GENDERPARENTCODE,
       GENDERHIERARCHYCODE,
       LEGISPARENTCODE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOHIERARCHYCODE,
       STATUS,
       FOODEXOLDCODE,
       MATRIXCODE,
       TERMCODE,
       BOTANICHIERARCHYCODE,
       FORTHIERARCHYCODE,
       FOODEX2_CODE,
       TAXONOMICCODE,
       FEEDHIERARCHYCODE,
       PROCESSHIERARCHYCODE,
       HIERARCY_CODE,
       LANGUALCODE,
       TERMEXTENDEDNAME,
       SWEETHIERARCHYCODE,
       COMMONNAMES,
       SCIENTIFICNAMES,
       ALPHA3CODE,
       PARTHIERARCHYCODE,
       PESTHIERARCHYCODE,
       EXPOHIERARCHYCODE,
       VETDRUGHIERARCHYCODE,
       RACSOURCEHIERARCHYCODE,
       ISSCAAP,
       COOKEXTPARENTCODE,
       GENPARENTCODE,
       PACKFORMATPARENTCODE,
       SOURCEHIERARCHYCODE,
       BIOMOHIERARCHYCODE,
       INGREDHIERARCHYCODE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       MASTERPARENTCODE,
       REPORTPARENTCODE,
       PESTPARENTCODE,
       BIOMOPARENTCODE,
       FEEDPARENTCODE,
       EXPOPARENTCODE,
       VETDRUGPARENTCODE,
       BOTANICPARENTCODE,
       PARTPARENTCODE,
       SOURCEPARENTCODE,
       RACSOURCEPARENTCODE,
       PROCESSPARENTCODE,
       INGREDPARENTCODE,
       MEDIUMPARENTCODE,
       SWEETPARENTCODE,
       FORTPARENTCODE,
       QUALPARENTCODE,
       COOKEXTHIERARCHYCODE,
       GENHIERARCHYCODE,
       PRODPARENTCODE,
       PACKFORMATHIERARCHYCODE,
       PACKMATPARENTCODE,
       FATHIERARCHYCODE,
       FPURPOSEPARENTCODE,
       REPORTHIERARCHYCODE,
       MASTERHIERARCHYCODE,
       IMPLICITFACETS,
       TERMSHORTNAME,
       GEMSCODE,
       EUFEEDREG,
       IFNCODE,
       PROG_CODE,
       ALLFACETS
                   FROM dim_anagrafica_report
                  WHERE dat_fin_vld_tec IS NULL AND sk_anmatcode_building> 0)
   LOOP
      UPDATE dim_anagrafica_report
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
             termcode = mdfch.termcode
             AND dat_fin_vld_tec IS NULL
             AND sk_anmatcode_building> 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_anmatcode_building
           INTO sk_ACT
           FROM dim_anagrafica_report
          WHERE     dat_fin_vld_tec = adesso
                AND sk_anmatcode_building> 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_anmatcode_building), 1)
           INTO sk
           FROM dim_anagrafica_report;
      ELSE
         SELECT stacco_sk (MAX (sk_anmatcode_building), 1)
           INTO sk_ACT
           FROM dim_anagrafica_report;

         SELECT stacco_sk (MAX (sk_anmatcode_building), 2)
           INTO sk
           FROM dim_anagrafica_report;
      END IF;

      INSERT INTO dim_anagrafica_report (       SK_ANMATCODE_BUILDING,
       SK_ACT_ANMATCODE_BUILDING,
       VALIDTO,
       VALIDFROM,
       DEPRECATED,
       EURINGSCODE,
       MASTERFLAG,
       MASTERORDER,
       MASTERREPORTABLE,
       REPORTFLAG,
       REPORTORDER,
       REPORTREPORTABLE,
       PESTFLAG,
       PESTORDER,
       PESTREPORTABLE,
       BIOMOFLAG,
       BIOMOORDER,
       BIOMOREPORTABLE,
       FEEDFLAG,
       FEEDORDER,
       FEEDREPORTABLE,
       EXPOFLAG,
       EXPOORDER,
       EXPOREPORTABLE,
       VETDRUGFLAG,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       BOTANICFLAG,
       BOTANICORDER,
       BOTANICREPORTABLE,
       PARTFLAG,
       PARTORDER,
       PARTREPORTABLE,
       SOURCEFLAG,
       SOURCEORDER,
       SOURCEREPORTABLE,
       RACSOURCEFLAG,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       PROCESSFLAG,
       PROCESSORDER,
       PROCESSREPORTABLE,
       INGREDFLAG,
       INGREDORDER,
       INGREDREPORTABLE,
       MEDIUMFLAG,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       SWEETFLAG,
       SWEETORDER,
       SWEETREPORTABLE,
       FORTFLAG,
       FORTORDER,
       FORTREPORTABLE,
       QUALFLAG,
       QUALORDER,
       QUALREPORTABLE,
       COOKEXTFLAG,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       GENFLAG,
       GENORDER,
       GENREPORTABLE,
       PRODFLAG,
       PRODORDER,
       PRODREPORTABLE,
       PACKFORMATFLAG,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKMATFLAG,
       PACKMATORDER,
       PACKMATREPORTABLE,
       STATEFLAG,
       STATEORDER,
       STATEREPORTABLE,
       FATFLAG,
       FATORDER,
       FATREPORTABLE,
       ALCOHOLFLAG,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       DOUGHFLAG,
       DOUGHORDER,
       DOUGHREPORTABLE,
       PARTCONFLAG,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PLACEFLAG,
       PLACEORDER,
       PLACEREPORTABLE,
       TARGCONFLAG,
       TARGCONORDER,
       TARGCONREPORTABLE,
       USEFLAG,
       USEORDER,
       USEREPORTABLE,
       RISKINGREDFLAG,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       FPURPOSEFLAG,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       REPLEVFLAG,
       REPLEVORDER,
       REPLEVREPORTABLE,
       ANIMAGEFLAG,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       GENDERFLAG,
       GENDERORDER,
       GENDERREPORTABLE,
       LEGISFLAG,
       LEGISORDER,
       LEGISREPORTABLE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       VERSION,
       DETAILLEVEL,
       TERMTYPE,
       LASTUPDATE,
       VALIDFROM_VARCHAR,
       VALIDTO_VARCHAR,
       MEDIUMHIERARCHYCODE,
       QUALHIERARCHYCODE,
       PRODHIERARCHYCODE,
       PACKMATHIERARCHYCODE,
       STATEPARENTCODE,
       STATEHIERARCHYCODE,
       FATPARENTCODE,
       ALCOHOLPARENTCODE,
       DOUGHPARENTCODE,
       DOUGHHIERARCHYCODE,
       PARTCONPARENTCODE,
       PARTCONHIERARCHYCODE,
       PLACEPARENTCODE,
       PLACEHIERARCHYCODE,
       TARGCONPARENTCODE,
       TARGCONHIERARCHYCODE,
       USEPARENTCODE,
       RISKINGREDPARENTCODE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEHIERARCHYCODE,
       REPLEVPARENTCODE,
       REPLEVHIERARCHYCODE,
       ANIMAGEPARENTCODE,
       ANIMAGEHIERARCHYCODE,
       GENDERPARENTCODE,
       GENDERHIERARCHYCODE,
       LEGISPARENTCODE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOHIERARCHYCODE,
       STATUS,
       FOODEXOLDCODE,
       MATRIXCODE,
       TERMCODE,
       BOTANICHIERARCHYCODE,
       FORTHIERARCHYCODE,
       FOODEX2_CODE,
       TAXONOMICCODE,
       FEEDHIERARCHYCODE,
       PROCESSHIERARCHYCODE,
       HIERARCY_CODE,
       LANGUALCODE,
       TERMEXTENDEDNAME,
       SWEETHIERARCHYCODE,
       COMMONNAMES,
       SCIENTIFICNAMES,
       ALPHA3CODE,
       PARTHIERARCHYCODE,
       PESTHIERARCHYCODE,
       EXPOHIERARCHYCODE,
       VETDRUGHIERARCHYCODE,
       RACSOURCEHIERARCHYCODE,
       ISSCAAP,
       COOKEXTPARENTCODE,
       GENPARENTCODE,
       PACKFORMATPARENTCODE,
       SOURCEHIERARCHYCODE,
       BIOMOHIERARCHYCODE,
       INGREDHIERARCHYCODE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       MASTERPARENTCODE,
       REPORTPARENTCODE,
       PESTPARENTCODE,
       BIOMOPARENTCODE,
       FEEDPARENTCODE,
       EXPOPARENTCODE,
       VETDRUGPARENTCODE,
       BOTANICPARENTCODE,
       PARTPARENTCODE,
       SOURCEPARENTCODE,
       RACSOURCEPARENTCODE,
       PROCESSPARENTCODE,
       INGREDPARENTCODE,
       MEDIUMPARENTCODE,
       SWEETPARENTCODE,
       FORTPARENTCODE,
       QUALPARENTCODE,
       COOKEXTHIERARCHYCODE,
       GENHIERARCHYCODE,
       PRODPARENTCODE,
       PACKFORMATHIERARCHYCODE,
       PACKMATPARENTCODE,
       FATHIERARCHYCODE,
       FPURPOSEPARENTCODE,
       REPORTHIERARCHYCODE,
       MASTERHIERARCHYCODE,
       IMPLICITFACETS,
       TERMSHORTNAME,
       GEMSCODE,
       EUFEEDREG,
       IFNCODE,
       PROG_CODE,
       ALLFACETS,
       DAT_INI_VLD_TEC)
           VALUES (       SK,
       SK_ACT,
       mdfch.VALIDTO,
       mdfch.VALIDFROM,
       mdfch.DEPRECATED,
       mdfch.EURINGSCODE,
       mdfch.MASTERFLAG,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.REPORTFLAG,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.PESTFLAG,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.FEEDFLAG,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.EXPOFLAG,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.PARTFLAG,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.INGREDFLAG,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.SWEETFLAG,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.FORTFLAG,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.QUALFLAG,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.GENFLAG,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.PRODFLAG,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.STATEFLAG,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.FATFLAG,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PLACEFLAG,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.USEFLAG,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.GENDERFLAG,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.LEGISFLAG,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.VERSION,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.LASTUPDATE,
       mdfch.VALIDFROM_VARCHAR,
       mdfch.VALIDTO_VARCHAR,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEPARENTCODE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATPARENTCODE,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEPARENTCODE,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.STATUS,
       mdfch.FOODEXOLDCODE,
       mdfch.MATRIXCODE,
       mdfch.TERMCODE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.FOODEX2_CODE,
       mdfch.TAXONOMICCODE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.HIERARCY_CODE,
       mdfch.LANGUALCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.COMMONNAMES,
       mdfch.SCIENTIFICNAMES,
       mdfch.ALPHA3CODE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.ISSCAAP,
       mdfch.COOKEXTPARENTCODE,
       mdfch.GENPARENTCODE,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.MASTERPARENTCODE,
       mdfch.REPORTPARENTCODE,
       mdfch.PESTPARENTCODE,
       mdfch.BIOMOPARENTCODE,
       mdfch.FEEDPARENTCODE,
       mdfch.EXPOPARENTCODE,
       mdfch.VETDRUGPARENTCODE,
       mdfch.BOTANICPARENTCODE,
       mdfch.PARTPARENTCODE,
       mdfch.SOURCEPARENTCODE,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.PROCESSPARENTCODE,
       mdfch.INGREDPARENTCODE,
       mdfch.MEDIUMPARENTCODE,
       mdfch.SWEETPARENTCODE,
       mdfch.FORTPARENTCODE,
       mdfch.QUALPARENTCODE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODPARENTCODE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATPARENTCODE,
       mdfch.FATHIERARCHYCODE,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.IMPLICITFACETS,
       mdfch.TERMSHORTNAME,
       mdfch.GEMSCODE,
       mdfch.EUFEEDREG,
       mdfch.IFNCODE,
       mdfch.PROG_CODE,
       mdfch.ALLFACETS,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM v_anagrafica_report)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_report
              WHERE dat_fin_vld_tec IS NULL AND sk_anmatcode_building> 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_report'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_report'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_report;



PROCEDURE prc_dim_anagrafica_reproductiv (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_reproductive
    WHERE sk_reproductive< 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_reproductive (sk_act_reproductive,
                                               sk_reproductive,
                                               termcode,
                                               TERMEXTENDEDNAME,
                                               VALIDFROM,
                                               VALIDTO,
                                               dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERMCODE                        --chiave tecnica gestionale
                    FROM dim_anagrafica_reproductive
                   WHERE dat_fin_vld_tec IS NULL AND sk_reproductive> 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_reproductive)
   LOOP
      UPDATE dim_anagrafica_reproductive
         SET dat_fin_vld_tec = adesso
       WHERE     --id = cnclzn.id
              sk_reproductive> 0        and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       TRIM (VALIDFROM_OLD) VALIDFROM_OLD,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
                   FROM anagrafica_reproductive
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        VALIDFROM_OLD,
                        VALIDTO,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
PACKFORMATPARENTCODE,
PACKFORMATORDER,
PACKFORMATREPORTABLE,
PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM
                   FROM dim_anagrafica_reproductive
                  WHERE dat_fin_vld_tec IS NULL AND sk_reproductive> 0)
   LOOP
      UPDATE dim_anagrafica_reproductive
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
              termcode = mdfch.termcode
             AND dat_fin_vld_tec IS NULL
             AND sk_reproductive> 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_reproductive
           INTO sk_ACT
           FROM dim_anagrafica_reproductive
          WHERE     dat_fin_vld_tec = adesso
                AND sk_reproductive> 0
                AND TERMCODE = MDFCH.TERMCODE;
               -- AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_reproductive), 1)
           INTO sk
           FROM dim_anagrafica_reproductive;
      ELSE
         SELECT stacco_sk (MAX (sk_reproductive), 1)
           INTO sk_ACT
           FROM dim_anagrafica_reproductive;

         SELECT stacco_sk (MAX (sk_reproductive), 2)
           INTO sk
           FROM dim_anagrafica_reproductive;
      END IF;

      INSERT INTO dim_anagrafica_reproductive (       SK_REPRODUCTIVE,
       SK_ACT_REPRODUCTIVE,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDFROM_OLD,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC)
        VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDFROM_OLD,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_reproductive)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_reproductive
              WHERE dat_fin_vld_tec IS NULL AND sk_reproductive> 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_reproductive'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_reproductive'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_reproductiv;



PROCEDURE prc_dim_anagrafica_source (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_source
    WHERE sk_source< 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_source (sk_act_source,
                                               sk_source,
                                               termcode,
                                               TERMEXTENDEDNAME,
                                               VALIDFROM,
                                               VALIDTO,
                                               dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERMCODE                        --chiave tecnica gestionale
                    FROM dim_anagrafica_source
                   WHERE dat_fin_vld_tec IS NULL AND sk_source> 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_source)
   LOOP
      UPDATE dim_anagrafica_source
         SET dat_fin_vld_tec = adesso
       WHERE     --id = cnclzn.id
             sk_source> 0      and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       TRIM (VALIDFROM_OLD) VALIDFROM_OLD,
       TRIM (VALIDTO_OLD) VALIDTO_OLD,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       VALIDTO
                   FROM anagrafica_source
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        VALIDFROM_OLD,
                        VALIDTO_OLD,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
PACKFORMATPARENTCODE,
PACKFORMATORDER,
PACKFORMATREPORTABLE,
PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM,
                        VALIDTO
                   FROM dim_anagrafica_source
                  WHERE dat_fin_vld_tec IS NULL AND sk_source> 0)
   LOOP
      UPDATE dim_anagrafica_source
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
             termcode = mdfch.termcode
             AND dat_fin_vld_tec IS NULL
             AND sk_source> 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_source
           INTO sk_ACT
           FROM dim_anagrafica_source
          WHERE     dat_fin_vld_tec = adesso
                AND sk_source> 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_source), 1)
           INTO sk
           FROM dim_anagrafica_source;
      ELSE
         SELECT stacco_sk (MAX (sk_source), 1)
           INTO sk_ACT
           FROM dim_anagrafica_source;

         SELECT stacco_sk (MAX (sk_source), 2)
           INTO sk
           FROM dim_anagrafica_source;
      END IF;

      insert into dim_anagrafica_source
    ( SK_SOURCE,
       SK_ACT_SOURCE,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDFROM_OLD,
       VALIDTO_OLD,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       VALIDTO,
       DAT_INI_VLD_TEC)
    values
    ( SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDFROM_OLD,
       mdfch.VALIDTO_OLD,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       mdfch.VALIDTO,
       ADESSO );
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_source)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_source
              WHERE dat_fin_vld_tec IS NULL AND sk_source> 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_source'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_source'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_source;


PROCEDURE prc_dim_anagrafica_source_com (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_source_com
    WHERE sk_source_com< 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_source_com (sk_act_source_com,
                                               sk_source_com,
                                               termcode,
                                               TERMEXTENDEDNAME,
                                               VALIDFROM,
                                               VALIDTO,
                                               dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERMCODE                        --chiave tecnica gestionale
                    FROM dim_anagrafica_source_com
                   WHERE dat_fin_vld_tec IS NULL AND sk_source_com> 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_source_com)
   LOOP
      UPDATE dim_anagrafica_source_com
         SET dat_fin_vld_tec = adesso
       WHERE     --id = cnclzn.id
             sk_source_com> 0      and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       VALIDTO
                   FROM anagrafica_source_com
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
                        PACKFORMATPARENTCODE,
                        PACKFORMATORDER,
                        PACKFORMATREPORTABLE,
                        PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM,
                        VALIDTO
                   FROM dim_anagrafica_source_com
                  WHERE dat_fin_vld_tec IS NULL AND sk_source_com> 0)
   LOOP
      UPDATE dim_anagrafica_source_com
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
             termcode = mdfch.termcode
             AND dat_fin_vld_tec IS NULL
             AND sk_source_com> 0;


      var_rows := SQL%ROWCOUNT;

      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_source_com
           INTO sk_ACT
           FROM dim_anagrafica_source_com
          WHERE     dat_fin_vld_tec = adesso
                AND sk_source_com> 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_source_com), 1)
           INTO sk
           FROM dim_anagrafica_source_com;
      ELSE
         SELECT stacco_sk (MAX (sk_source_com), 1)
           INTO sk_ACT
           FROM dim_anagrafica_source_com;

         SELECT stacco_sk (MAX (sk_source_com), 2)
           INTO sk
           FROM dim_anagrafica_source_com;
      END IF;

      insert into dim_anagrafica_source_com
    ( SK_SOURCE_COM,
       SK_ACT_SOURCE_COM,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       VALIDTO,
       DAT_INI_VLD_TEC)
    values
    ( SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       mdfch.VALIDTO,
       ADESSO );
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_source_com)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_source_com
              WHERE dat_fin_vld_tec IS NULL AND sk_source_com> 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_source_com'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_source_com'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_source_com;


PROCEDURE prc_dim_anagrafica_target (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_target
    WHERE sk_target< 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_target (sk_act_target,
                                               sk_target,
                                               termcode,
                                               TERMEXTENDEDNAME,
                                               VALIDFROM,
                                               VALIDTO,
                                               dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT termcode                        --chiave tecnica gestionale
                    FROM dim_anagrafica_target
                   WHERE dat_fin_vld_tec IS NULL AND sk_target> 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_target)
   LOOP
      UPDATE dim_anagrafica_target
         SET dat_fin_vld_tec = adesso
       WHERE     --id = cnclzn.id
              sk_target> 0        and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
                   FROM anagrafica_target
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        VALIDTO,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
PACKFORMATPARENTCODE,
PACKFORMATORDER,
PACKFORMATREPORTABLE,
PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM
                   FROM dim_anagrafica_target
                  WHERE dat_fin_vld_tec IS NULL AND sk_target> 0)
   LOOP
      UPDATE dim_anagrafica_target
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
             termcode = mdfch.termcode
             AND dat_fin_vld_tec IS NULL
             AND sk_target> 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_target
           INTO sk_ACT
           FROM dim_anagrafica_target
          WHERE     dat_fin_vld_tec = adesso
                AND sk_target> 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_target), 1)
           INTO sk
           FROM dim_anagrafica_target;
      ELSE
         SELECT stacco_sk (MAX (sk_target), 1)
           INTO sk_ACT
           FROM dim_anagrafica_target;

         SELECT stacco_sk (MAX (sk_target), 2)
           INTO sk
           FROM dim_anagrafica_target;
      END IF;

      INSERT INTO dim_anagrafica_target (       SK_TARGET,
       SK_ACT_TARGET,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC
)
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_target)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_target
              WHERE dat_fin_vld_tec IS NULL AND sk_target> 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_target'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_target'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_target;



PROCEDURE prc_dim_anagrafica_use (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_anagrafica_use
    WHERE sk_use< 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_anagrafica_use (sk_act_use,
                                               sk_use,
                                               termcode,
                                               TERMEXTENDEDNAME,
                                               VALIDFROM,
                                               VALIDTO,
                                               dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT termcode                        --chiave tecnica gestionale
                    FROM dim_anagrafica_use
                   WHERE dat_fin_vld_tec IS NULL AND sk_use> 0
                  MINUS
                  SELECT TERMCODE FROM anagrafica_use)
   LOOP
      UPDATE dim_anagrafica_use
         SET dat_fin_vld_tec = adesso
       WHERE     --id = cnclzn.id
              sk_use> 0       and termcode = cnclzn.termcode
             AND dat_fin_vld_tec IS NULL;
   END LOOP;

   --modifiche
   FOR mdfch IN (SELECT TRIM (TERMCODE) TERMCODE,
       TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
       TRIM (TERMSHORTNAME) TERMSHORTNAME,
       VERSION,
       TRIM (LASTUPDATE) LASTUPDATE,
       VALIDTO,
       TRIM (STATUS) STATUS,
       DEPRECATED,
       TRIM (SCIENTIFICNAMES) SCIENTIFICNAMES,
       TRIM (COMMONNAMES) COMMONNAMES,
       TRIM (ALLFACETS) ALLFACETS,
       TRIM (ISSCAAP) ISSCAAP,
       TRIM (TAXONOMICCODE) TAXONOMICCODE,
       TRIM (ALPHA3CODE) ALPHA3CODE,
       TRIM (GEMSCODE) GEMSCODE,
       TRIM (MATRIXCODE) MATRIXCODE,
       TRIM (LANGUALCODE) LANGUALCODE,
       TRIM (FOODEXOLDCODE) FOODEXOLDCODE,
       TRIM (IMPLICITFACETS) IMPLICITFACETS,
       TRIM (DETAILLEVEL) DETAILLEVEL,
       TRIM (TERMTYPE) TERMTYPE,
       TRIM (PRODTREAT) PRODTREAT,
       TRIM (PRODMETH) PRODMETH,
       TRIM (PRODPACK) PRODPACK,
       EURINGSCODE,
       TRIM (IFNCODE) IFNCODE,
       TRIM (EUFEEDREG) EUFEEDREG,
       MASTERFLAG,
       TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
       REPORTFLAG,
       TRIM (REPORTPARENTCODE) REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       TRIM (REPORTHIERARCHYCODE) REPORTHIERARCHYCODE,
       PESTFLAG,
       TRIM (PESTPARENTCODE) PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       TRIM (PESTHIERARCHYCODE) PESTHIERARCHYCODE,
       BIOMOFLAG,
       TRIM (BIOMOPARENTCODE) BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       TRIM (BIOMOHIERARCHYCODE) BIOMOHIERARCHYCODE,
       FEEDFLAG,
       TRIM (FEEDPARENTCODE) FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       TRIM (FEEDHIERARCHYCODE) FEEDHIERARCHYCODE,
       EXPOFLAG,
       TRIM (EXPOPARENTCODE) EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       TRIM (EXPOHIERARCHYCODE) EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       TRIM (VETDRUGPARENTCODE) VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       TRIM (VETDRUGHIERARCHYCODE) VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       TRIM (BOTANICPARENTCODE) BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       TRIM (BOTANICHIERARCHYCODE) BOTANICHIERARCHYCODE,
       PARTFLAG,
       TRIM (PARTPARENTCODE) PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       TRIM (PARTHIERARCHYCODE) PARTHIERARCHYCODE,
       SOURCEFLAG,
       TRIM (SOURCEPARENTCODE) SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       TRIM (SOURCEHIERARCHYCODE) SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       TRIM (RACSOURCEPARENTCODE) RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       TRIM (RACSOURCEHIERARCHYCODE) RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       TRIM (PROCESSPARENTCODE) PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       TRIM (PROCESSHIERARCHYCODE) PROCESSHIERARCHYCODE,
       INGREDFLAG,
       TRIM (INGREDPARENTCODE) INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       TRIM (INGREDHIERARCHYCODE) INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       TRIM (MEDIUMPARENTCODE) MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       TRIM (MEDIUMHIERARCHYCODE) MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       TRIM (SWEETPARENTCODE) SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       TRIM (SWEETHIERARCHYCODE) SWEETHIERARCHYCODE,
       FORTFLAG,
       TRIM (FORTPARENTCODE) FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       TRIM (FORTHIERARCHYCODE) FORTHIERARCHYCODE,
       QUALFLAG,
       TRIM (QUALPARENTCODE) QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       TRIM (QUALHIERARCHYCODE) QUALHIERARCHYCODE,
       COOKEXTFLAG,
       TRIM (COOKEXTPARENTCODE) COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       TRIM (COOKEXTHIERARCHYCODE) COOKEXTHIERARCHYCODE,
       GENFLAG,
       TRIM (GENPARENTCODE) GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       TRIM (GENHIERARCHYCODE) GENHIERARCHYCODE,
       PRODFLAG,
       TRIM (PRODPARENTCODE) PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       TRIM (PRODHIERARCHYCODE) PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       TRIM (PACKFORMATPARENTCODE) PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       TRIM (PACKFORMATHIERARCHYCODE) PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       TRIM (PACKMATPARENTCODE) PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       TRIM (PACKMATHIERARCHYCODE) PACKMATHIERARCHYCODE,
       STATEFLAG,
       TRIM (STATEPARENTCODE) STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       TRIM (STATEHIERARCHYCODE) STATEHIERARCHYCODE,
       FATFLAG,
       TRIM (FATPARENTCODE) FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       TRIM (FATHIERARCHYCODE) FATHIERARCHYCODE,
       ALCOHOLFLAG,
       TRIM (ALCOHOLPARENTCODE) ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       TRIM (ALCOHOLHIERARCHYCODE) ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       TRIM (DOUGHPARENTCODE) DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       TRIM (DOUGHHIERARCHYCODE) DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       TRIM (PARTCONPARENTCODE) PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       TRIM (PARTCONHIERARCHYCODE) PARTCONHIERARCHYCODE,
       PLACEFLAG,
       TRIM (PLACEPARENTCODE) PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       TRIM (PLACEHIERARCHYCODE) PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TRIM (TARGCONPARENTCODE) TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TRIM (TARGCONHIERARCHYCODE) TARGCONHIERARCHYCODE,
       USEFLAG,
       TRIM (USEPARENTCODE) USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       TRIM (USEHIERARCHYCODE) USEHIERARCHYCODE,
       RISKINGREDFLAG,
       TRIM (RISKINGREDPARENTCODE) RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       TRIM (RISKINGREDHIERARCHYCODE) RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       TRIM (FPURPOSEPARENTCODE) FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       TRIM (FPURPOSEHIERARCHYCODE) FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       TRIM (REPLEVPARENTCODE) REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       TRIM (REPLEVHIERARCHYCODE) REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       TRIM (ANIMAGEPARENTCODE) ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       TRIM (ANIMAGEHIERARCHYCODE) ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       TRIM (GENDERPARENTCODE) GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       TRIM (GENDERHIERARCHYCODE) GENDERHIERARCHYCODE,
       LEGISFLAG,
       TRIM (LEGISPARENTCODE) LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       TRIM (LEGISHIERARCHYCODE) LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       TRIM (FEEDADDEXPOPARENTCODE) FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       TRIM (FEEDADDEXPOHIERARCHYCODE) FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM
                   FROM anagrafica_use
                 MINUS
                 SELECT TERMCODE,
                        TERMEXTENDEDNAME,
                        TERMSHORTNAME,
                        VERSION,
                        LASTUPDATE,
                        VALIDTO,
                        STATUS,
                        DEPRECATED,
                        SCIENTIFICNAMES,
                        COMMONNAMES,
                        ALLFACETS,
                        ISSCAAP,
                        TAXONOMICCODE,
                        ALPHA3CODE,
                        GEMSCODE,
                        MATRIXCODE,
                        LANGUALCODE,
                        FOODEXOLDCODE,
                        IMPLICITFACETS,
                        DETAILLEVEL,
                        TERMTYPE,
                        PRODTREAT,
                        PRODMETH,
                        PRODPACK,
                        EURINGSCODE,
                        IFNCODE,
                        EUFEEDREG,
                        MASTERFLAG,
                        MASTERPARENTCODE,
                        MASTERORDER,
                        MASTERREPORTABLE,
                        MASTERHIERARCHYCODE,
                        REPORTFLAG,
                        REPORTPARENTCODE,
                        REPORTORDER,
                        REPORTREPORTABLE,
                        REPORTHIERARCHYCODE,
                        PESTFLAG,
                        PESTPARENTCODE,
                        PESTORDER,
                        PESTREPORTABLE,
                        PESTHIERARCHYCODE,
                        BIOMOFLAG,
                        BIOMOPARENTCODE,
                        BIOMOORDER,
                        BIOMOREPORTABLE,
                        BIOMOHIERARCHYCODE,
                        FEEDFLAG,
                        FEEDPARENTCODE,
                        FEEDORDER,
                        FEEDREPORTABLE,
                        FEEDHIERARCHYCODE,
                        EXPOFLAG,
                        EXPOPARENTCODE,
                        EXPOORDER,
                        EXPOREPORTABLE,
                        EXPOHIERARCHYCODE,
                        VETDRUGFLAG,
                        VETDRUGPARENTCODE,
                        VETDRUGORDER,
                        VETDRUGREPORTABLE,
                        VETDRUGHIERARCHYCODE,
                        BOTANICFLAG,
                        BOTANICPARENTCODE,
                        BOTANICORDER,
                        BOTANICREPORTABLE,
                        BOTANICHIERARCHYCODE,
                        PARTFLAG,
                        PARTPARENTCODE,
                        PARTORDER,
                        PARTREPORTABLE,
                        PARTHIERARCHYCODE,
                        SOURCEFLAG,
                        SOURCEPARENTCODE,
                        SOURCEORDER,
                        SOURCEREPORTABLE,
                        SOURCEHIERARCHYCODE,
                        RACSOURCEFLAG,
                        RACSOURCEPARENTCODE,
                        RACSOURCEORDER,
                        RACSOURCEREPORTABLE,
                        RACSOURCEHIERARCHYCODE,
                        PROCESSFLAG,
                        PROCESSPARENTCODE,
                        PROCESSORDER,
                        PROCESSREPORTABLE,
                        PROCESSHIERARCHYCODE,
                        INGREDFLAG,
                        INGREDPARENTCODE,
                        INGREDORDER,
                        INGREDREPORTABLE,
                        INGREDHIERARCHYCODE,
                        MEDIUMFLAG,
                        MEDIUMPARENTCODE,
                        MEDIUMORDER,
                        MEDIUMREPORTABLE,
                        MEDIUMHIERARCHYCODE,
                        SWEETFLAG,
                        SWEETPARENTCODE,
                        SWEETORDER,
                        SWEETREPORTABLE,
                        SWEETHIERARCHYCODE,
                        FORTFLAG,
                        FORTPARENTCODE,
                        FORTORDER,
                        FORTREPORTABLE,
                        FORTHIERARCHYCODE,
                        QUALFLAG,
                        QUALPARENTCODE,
                        QUALORDER,
                        QUALREPORTABLE,
                        QUALHIERARCHYCODE,
                        COOKEXTFLAG,
                        COOKEXTPARENTCODE,
                        COOKEXTORDER,
                        COOKEXTREPORTABLE,
                        COOKEXTHIERARCHYCODE,
                        GENFLAG,
                        GENPARENTCODE,
                        GENORDER,
                        GENREPORTABLE,
                        GENHIERARCHYCODE,
                        PRODFLAG,
                        PRODPARENTCODE,
                        PRODORDER,
                        PRODREPORTABLE,
                        PRODHIERARCHYCODE,
                        PACKFORMATFLAG,
PACKFORMATPARENTCODE,
PACKFORMATORDER,
PACKFORMATREPORTABLE,
PACKFORMATHIERARCHYCODE,
                        PACKMATFLAG,
                        PACKMATPARENTCODE,
                        PACKMATORDER,
                        PACKMATREPORTABLE,
                        PACKMATHIERARCHYCODE,
                        STATEFLAG,
                        STATEPARENTCODE,
                        STATEORDER,
                        STATEREPORTABLE,
                        STATEHIERARCHYCODE,
                        FATFLAG,
                        FATPARENTCODE,
                        FATORDER,
                        FATREPORTABLE,
                        FATHIERARCHYCODE,
                        ALCOHOLFLAG,
                        ALCOHOLPARENTCODE,
                        ALCOHOLORDER,
                        ALCOHOLREPORTABLE,
                        ALCOHOLHIERARCHYCODE,
                        DOUGHFLAG,
                        DOUGHPARENTCODE,
                        DOUGHORDER,
                        DOUGHREPORTABLE,
                        DOUGHHIERARCHYCODE,
                        PARTCONFLAG,
                        PARTCONPARENTCODE,
                        PARTCONORDER,
                        PARTCONREPORTABLE,
                        PARTCONHIERARCHYCODE,
                        PLACEFLAG,
                        PLACEPARENTCODE,
                        PLACEORDER,
                        PLACEREPORTABLE,
                        PLACEHIERARCHYCODE,
                        TARGCONFLAG,
                        TARGCONPARENTCODE,
                        TARGCONORDER,
                        TARGCONREPORTABLE,
                        TARGCONHIERARCHYCODE,
                        USEFLAG,
                        USEPARENTCODE,
                        USEORDER,
                        USEREPORTABLE,
                        USEHIERARCHYCODE,
                        RISKINGREDFLAG,
                        RISKINGREDPARENTCODE,
                        RISKINGREDORDER,
                        RISKINGREDREPORTABLE,
                        RISKINGREDHIERARCHYCODE,
                        FPURPOSEFLAG,
                        FPURPOSEPARENTCODE,
                        FPURPOSEORDER,
                        FPURPOSEREPORTABLE,
                        FPURPOSEHIERARCHYCODE,
                        REPLEVFLAG,
                        REPLEVPARENTCODE,
                        REPLEVORDER,
                        REPLEVREPORTABLE,
                        REPLEVHIERARCHYCODE,
                        ANIMAGEFLAG,
                        ANIMAGEPARENTCODE,
                        ANIMAGEORDER,
                        ANIMAGEREPORTABLE,
                        ANIMAGEHIERARCHYCODE,
                        GENDERFLAG,
                        GENDERPARENTCODE,
                        GENDERORDER,
                        GENDERREPORTABLE,
                        GENDERHIERARCHYCODE,
                        LEGISFLAG,
                        LEGISPARENTCODE,
                        LEGISORDER,
                        LEGISREPORTABLE,
                        LEGISHIERARCHYCODE,
                        FEEDADDEXPOFLAG,
                        FEEDADDEXPOPARENTCODE,
                        FEEDADDEXPOORDER,
                        FEEDADDEXPOREPORTABLE,
                        FEEDADDEXPOHIERARCHYCODE,
                        VALIDFROM
                   FROM dim_anagrafica_use
                  WHERE dat_fin_vld_tec IS NULL AND sk_use> 0)
   LOOP
      UPDATE dim_anagrafica_use
         SET dat_fin_vld_tec = adesso
       WHERE     --id = mdfch.id
              termcode = mdfch.termcode
             AND dat_fin_vld_tec IS NULL
             AND sk_use> 0;


      var_rows := SQL%ROWCOUNT;



      IF var_rows > 1
      THEN
         RAISE errore_update;
      ELSIF var_rows = 1
      THEN
         SELECT sk_act_use
           INTO sk_ACT
           FROM dim_anagrafica_use
          WHERE     dat_fin_vld_tec = adesso
                AND sk_use> 0
                AND TERMCODE = MDFCH.TERMCODE;
                --AND ID = mdfch.ID;

         SELECT stacco_sk (MAX (sk_use), 1)
           INTO sk
           FROM dim_anagrafica_use;
      ELSE
         SELECT stacco_sk (MAX (sk_use), 1)
           INTO sk_ACT
           FROM dim_anagrafica_use;

         SELECT stacco_sk (MAX (sk_use), 2)
           INTO sk
           FROM dim_anagrafica_use;
      END IF;

      INSERT INTO dim_anagrafica_use (       SK_USE,
       SK_ACT_USE,
       TERMCODE,
       TERMEXTENDEDNAME,
       TERMSHORTNAME,
       VERSION,
       LASTUPDATE,
       VALIDTO,
       STATUS,
       DEPRECATED,
       SCIENTIFICNAMES,
       COMMONNAMES,
       ALLFACETS,
       ISSCAAP,
       TAXONOMICCODE,
       ALPHA3CODE,
       GEMSCODE,
       MATRIXCODE,
       LANGUALCODE,
       FOODEXOLDCODE,
       IMPLICITFACETS,
       DETAILLEVEL,
       TERMTYPE,
       PRODTREAT,
       PRODMETH,
       PRODPACK,
       EURINGSCODE,
       IFNCODE,
       EUFEEDREG,
       MASTERFLAG,
       MASTERPARENTCODE,
       MASTERORDER,
       MASTERREPORTABLE,
       MASTERHIERARCHYCODE,
       REPORTFLAG,
       REPORTPARENTCODE,
       REPORTORDER,
       REPORTREPORTABLE,
       REPORTHIERARCHYCODE,
       PESTFLAG,
       PESTPARENTCODE,
       PESTORDER,
       PESTREPORTABLE,
       PESTHIERARCHYCODE,
       BIOMOFLAG,
       BIOMOPARENTCODE,
       BIOMOORDER,
       BIOMOREPORTABLE,
       BIOMOHIERARCHYCODE,
       FEEDFLAG,
       FEEDPARENTCODE,
       FEEDORDER,
       FEEDREPORTABLE,
       FEEDHIERARCHYCODE,
       EXPOFLAG,
       EXPOPARENTCODE,
       EXPOORDER,
       EXPOREPORTABLE,
       EXPOHIERARCHYCODE,
       VETDRUGFLAG,
       VETDRUGPARENTCODE,
       VETDRUGORDER,
       VETDRUGREPORTABLE,
       VETDRUGHIERARCHYCODE,
       BOTANICFLAG,
       BOTANICPARENTCODE,
       BOTANICORDER,
       BOTANICREPORTABLE,
       BOTANICHIERARCHYCODE,
       PARTFLAG,
       PARTPARENTCODE,
       PARTORDER,
       PARTREPORTABLE,
       PARTHIERARCHYCODE,
       SOURCEFLAG,
       SOURCEPARENTCODE,
       SOURCEORDER,
       SOURCEREPORTABLE,
       SOURCEHIERARCHYCODE,
       RACSOURCEFLAG,
       RACSOURCEPARENTCODE,
       RACSOURCEORDER,
       RACSOURCEREPORTABLE,
       RACSOURCEHIERARCHYCODE,
       PROCESSFLAG,
       PROCESSPARENTCODE,
       PROCESSORDER,
       PROCESSREPORTABLE,
       PROCESSHIERARCHYCODE,
       INGREDFLAG,
       INGREDPARENTCODE,
       INGREDORDER,
       INGREDREPORTABLE,
       INGREDHIERARCHYCODE,
       MEDIUMFLAG,
       MEDIUMPARENTCODE,
       MEDIUMORDER,
       MEDIUMREPORTABLE,
       MEDIUMHIERARCHYCODE,
       SWEETFLAG,
       SWEETPARENTCODE,
       SWEETORDER,
       SWEETREPORTABLE,
       SWEETHIERARCHYCODE,
       FORTFLAG,
       FORTPARENTCODE,
       FORTORDER,
       FORTREPORTABLE,
       FORTHIERARCHYCODE,
       QUALFLAG,
       QUALPARENTCODE,
       QUALORDER,
       QUALREPORTABLE,
       QUALHIERARCHYCODE,
       COOKEXTFLAG,
       COOKEXTPARENTCODE,
       COOKEXTORDER,
       COOKEXTREPORTABLE,
       COOKEXTHIERARCHYCODE,
       GENFLAG,
       GENPARENTCODE,
       GENORDER,
       GENREPORTABLE,
       GENHIERARCHYCODE,
       PRODFLAG,
       PRODPARENTCODE,
       PRODORDER,
       PRODREPORTABLE,
       PRODHIERARCHYCODE,
       PACKFORMATFLAG,
       PACKFORMATPARENTCODE,
       PACKFORMATORDER,
       PACKFORMATREPORTABLE,
       PACKFORMATHIERARCHYCODE,
       PACKMATFLAG,
       PACKMATPARENTCODE,
       PACKMATORDER,
       PACKMATREPORTABLE,
       PACKMATHIERARCHYCODE,
       STATEFLAG,
       STATEPARENTCODE,
       STATEORDER,
       STATEREPORTABLE,
       STATEHIERARCHYCODE,
       FATFLAG,
       FATPARENTCODE,
       FATORDER,
       FATREPORTABLE,
       FATHIERARCHYCODE,
       ALCOHOLFLAG,
       ALCOHOLPARENTCODE,
       ALCOHOLORDER,
       ALCOHOLREPORTABLE,
       ALCOHOLHIERARCHYCODE,
       DOUGHFLAG,
       DOUGHPARENTCODE,
       DOUGHORDER,
       DOUGHREPORTABLE,
       DOUGHHIERARCHYCODE,
       PARTCONFLAG,
       PARTCONPARENTCODE,
       PARTCONORDER,
       PARTCONREPORTABLE,
       PARTCONHIERARCHYCODE,
       PLACEFLAG,
       PLACEPARENTCODE,
       PLACEORDER,
       PLACEREPORTABLE,
       PLACEHIERARCHYCODE,
       TARGCONFLAG,
       TARGCONPARENTCODE,
       TARGCONORDER,
       TARGCONREPORTABLE,
       TARGCONHIERARCHYCODE,
       USEFLAG,
       USEPARENTCODE,
       USEORDER,
       USEREPORTABLE,
       USEHIERARCHYCODE,
       RISKINGREDFLAG,
       RISKINGREDPARENTCODE,
       RISKINGREDORDER,
       RISKINGREDREPORTABLE,
       RISKINGREDHIERARCHYCODE,
       FPURPOSEFLAG,
       FPURPOSEPARENTCODE,
       FPURPOSEORDER,
       FPURPOSEREPORTABLE,
       FPURPOSEHIERARCHYCODE,
       REPLEVFLAG,
       REPLEVPARENTCODE,
       REPLEVORDER,
       REPLEVREPORTABLE,
       REPLEVHIERARCHYCODE,
       ANIMAGEFLAG,
       ANIMAGEPARENTCODE,
       ANIMAGEORDER,
       ANIMAGEREPORTABLE,
       ANIMAGEHIERARCHYCODE,
       GENDERFLAG,
       GENDERPARENTCODE,
       GENDERORDER,
       GENDERREPORTABLE,
       GENDERHIERARCHYCODE,
       LEGISFLAG,
       LEGISPARENTCODE,
       LEGISORDER,
       LEGISREPORTABLE,
       LEGISHIERARCHYCODE,
       FEEDADDEXPOFLAG,
       FEEDADDEXPOPARENTCODE,
       FEEDADDEXPOORDER,
       FEEDADDEXPOREPORTABLE,
       FEEDADDEXPOHIERARCHYCODE,
       VALIDFROM,
       DAT_INI_VLD_TEC
)
           VALUES (SK,
       SK_ACT,
       mdfch.TERMCODE,
       mdfch.TERMEXTENDEDNAME,
       mdfch.TERMSHORTNAME,
       mdfch.VERSION,
       mdfch.LASTUPDATE,
       mdfch.VALIDTO,
       mdfch.STATUS,
       mdfch.DEPRECATED,
       mdfch.SCIENTIFICNAMES,
       mdfch.COMMONNAMES,
       mdfch.ALLFACETS,
       mdfch.ISSCAAP,
       mdfch.TAXONOMICCODE,
       mdfch.ALPHA3CODE,
       mdfch.GEMSCODE,
       mdfch.MATRIXCODE,
       mdfch.LANGUALCODE,
       mdfch.FOODEXOLDCODE,
       mdfch.IMPLICITFACETS,
       mdfch.DETAILLEVEL,
       mdfch.TERMTYPE,
       mdfch.PRODTREAT,
       mdfch.PRODMETH,
       mdfch.PRODPACK,
       mdfch.EURINGSCODE,
       mdfch.IFNCODE,
       mdfch.EUFEEDREG,
       mdfch.MASTERFLAG,
       mdfch.MASTERPARENTCODE,
       mdfch.MASTERORDER,
       mdfch.MASTERREPORTABLE,
       mdfch.MASTERHIERARCHYCODE,
       mdfch.REPORTFLAG,
       mdfch.REPORTPARENTCODE,
       mdfch.REPORTORDER,
       mdfch.REPORTREPORTABLE,
       mdfch.REPORTHIERARCHYCODE,
       mdfch.PESTFLAG,
       mdfch.PESTPARENTCODE,
       mdfch.PESTORDER,
       mdfch.PESTREPORTABLE,
       mdfch.PESTHIERARCHYCODE,
       mdfch.BIOMOFLAG,
       mdfch.BIOMOPARENTCODE,
       mdfch.BIOMOORDER,
       mdfch.BIOMOREPORTABLE,
       mdfch.BIOMOHIERARCHYCODE,
       mdfch.FEEDFLAG,
       mdfch.FEEDPARENTCODE,
       mdfch.FEEDORDER,
       mdfch.FEEDREPORTABLE,
       mdfch.FEEDHIERARCHYCODE,
       mdfch.EXPOFLAG,
       mdfch.EXPOPARENTCODE,
       mdfch.EXPOORDER,
       mdfch.EXPOREPORTABLE,
       mdfch.EXPOHIERARCHYCODE,
       mdfch.VETDRUGFLAG,
       mdfch.VETDRUGPARENTCODE,
       mdfch.VETDRUGORDER,
       mdfch.VETDRUGREPORTABLE,
       mdfch.VETDRUGHIERARCHYCODE,
       mdfch.BOTANICFLAG,
       mdfch.BOTANICPARENTCODE,
       mdfch.BOTANICORDER,
       mdfch.BOTANICREPORTABLE,
       mdfch.BOTANICHIERARCHYCODE,
       mdfch.PARTFLAG,
       mdfch.PARTPARENTCODE,
       mdfch.PARTORDER,
       mdfch.PARTREPORTABLE,
       mdfch.PARTHIERARCHYCODE,
       mdfch.SOURCEFLAG,
       mdfch.SOURCEPARENTCODE,
       mdfch.SOURCEORDER,
       mdfch.SOURCEREPORTABLE,
       mdfch.SOURCEHIERARCHYCODE,
       mdfch.RACSOURCEFLAG,
       mdfch.RACSOURCEPARENTCODE,
       mdfch.RACSOURCEORDER,
       mdfch.RACSOURCEREPORTABLE,
       mdfch.RACSOURCEHIERARCHYCODE,
       mdfch.PROCESSFLAG,
       mdfch.PROCESSPARENTCODE,
       mdfch.PROCESSORDER,
       mdfch.PROCESSREPORTABLE,
       mdfch.PROCESSHIERARCHYCODE,
       mdfch.INGREDFLAG,
       mdfch.INGREDPARENTCODE,
       mdfch.INGREDORDER,
       mdfch.INGREDREPORTABLE,
       mdfch.INGREDHIERARCHYCODE,
       mdfch.MEDIUMFLAG,
       mdfch.MEDIUMPARENTCODE,
       mdfch.MEDIUMORDER,
       mdfch.MEDIUMREPORTABLE,
       mdfch.MEDIUMHIERARCHYCODE,
       mdfch.SWEETFLAG,
       mdfch.SWEETPARENTCODE,
       mdfch.SWEETORDER,
       mdfch.SWEETREPORTABLE,
       mdfch.SWEETHIERARCHYCODE,
       mdfch.FORTFLAG,
       mdfch.FORTPARENTCODE,
       mdfch.FORTORDER,
       mdfch.FORTREPORTABLE,
       mdfch.FORTHIERARCHYCODE,
       mdfch.QUALFLAG,
       mdfch.QUALPARENTCODE,
       mdfch.QUALORDER,
       mdfch.QUALREPORTABLE,
       mdfch.QUALHIERARCHYCODE,
       mdfch.COOKEXTFLAG,
       mdfch.COOKEXTPARENTCODE,
       mdfch.COOKEXTORDER,
       mdfch.COOKEXTREPORTABLE,
       mdfch.COOKEXTHIERARCHYCODE,
       mdfch.GENFLAG,
       mdfch.GENPARENTCODE,
       mdfch.GENORDER,
       mdfch.GENREPORTABLE,
       mdfch.GENHIERARCHYCODE,
       mdfch.PRODFLAG,
       mdfch.PRODPARENTCODE,
       mdfch.PRODORDER,
       mdfch.PRODREPORTABLE,
       mdfch.PRODHIERARCHYCODE,
       mdfch.PACKFORMATFLAG,
       mdfch.PACKFORMATPARENTCODE,
       mdfch.PACKFORMATORDER,
       mdfch.PACKFORMATREPORTABLE,
       mdfch.PACKFORMATHIERARCHYCODE,
       mdfch.PACKMATFLAG,
       mdfch.PACKMATPARENTCODE,
       mdfch.PACKMATORDER,
       mdfch.PACKMATREPORTABLE,
       mdfch.PACKMATHIERARCHYCODE,
       mdfch.STATEFLAG,
       mdfch.STATEPARENTCODE,
       mdfch.STATEORDER,
       mdfch.STATEREPORTABLE,
       mdfch.STATEHIERARCHYCODE,
       mdfch.FATFLAG,
       mdfch.FATPARENTCODE,
       mdfch.FATORDER,
       mdfch.FATREPORTABLE,
       mdfch.FATHIERARCHYCODE,
       mdfch.ALCOHOLFLAG,
       mdfch.ALCOHOLPARENTCODE,
       mdfch.ALCOHOLORDER,
       mdfch.ALCOHOLREPORTABLE,
       mdfch.ALCOHOLHIERARCHYCODE,
       mdfch.DOUGHFLAG,
       mdfch.DOUGHPARENTCODE,
       mdfch.DOUGHORDER,
       mdfch.DOUGHREPORTABLE,
       mdfch.DOUGHHIERARCHYCODE,
       mdfch.PARTCONFLAG,
       mdfch.PARTCONPARENTCODE,
       mdfch.PARTCONORDER,
       mdfch.PARTCONREPORTABLE,
       mdfch.PARTCONHIERARCHYCODE,
       mdfch.PLACEFLAG,
       mdfch.PLACEPARENTCODE,
       mdfch.PLACEORDER,
       mdfch.PLACEREPORTABLE,
       mdfch.PLACEHIERARCHYCODE,
       mdfch.TARGCONFLAG,
       mdfch.TARGCONPARENTCODE,
       mdfch.TARGCONORDER,
       mdfch.TARGCONREPORTABLE,
       mdfch.TARGCONHIERARCHYCODE,
       mdfch.USEFLAG,
       mdfch.USEPARENTCODE,
       mdfch.USEORDER,
       mdfch.USEREPORTABLE,
       mdfch.USEHIERARCHYCODE,
       mdfch.RISKINGREDFLAG,
       mdfch.RISKINGREDPARENTCODE,
       mdfch.RISKINGREDORDER,
       mdfch.RISKINGREDREPORTABLE,
       mdfch.RISKINGREDHIERARCHYCODE,
       mdfch.FPURPOSEFLAG,
       mdfch.FPURPOSEPARENTCODE,
       mdfch.FPURPOSEORDER,
       mdfch.FPURPOSEREPORTABLE,
       mdfch.FPURPOSEHIERARCHYCODE,
       mdfch.REPLEVFLAG,
       mdfch.REPLEVPARENTCODE,
       mdfch.REPLEVORDER,
       mdfch.REPLEVREPORTABLE,
       mdfch.REPLEVHIERARCHYCODE,
       mdfch.ANIMAGEFLAG,
       mdfch.ANIMAGEPARENTCODE,
       mdfch.ANIMAGEORDER,
       mdfch.ANIMAGEREPORTABLE,
       mdfch.ANIMAGEHIERARCHYCODE,
       mdfch.GENDERFLAG,
       mdfch.GENDERPARENTCODE,
       mdfch.GENDERORDER,
       mdfch.GENDERREPORTABLE,
       mdfch.GENDERHIERARCHYCODE,
       mdfch.LEGISFLAG,
       mdfch.LEGISPARENTCODE,
       mdfch.LEGISORDER,
       mdfch.LEGISREPORTABLE,
       mdfch.LEGISHIERARCHYCODE,
       mdfch.FEEDADDEXPOFLAG,
       mdfch.FEEDADDEXPOPARENTCODE,
       mdfch.FEEDADDEXPOORDER,
       mdfch.FEEDADDEXPOREPORTABLE,
       mdfch.FEEDADDEXPOHIERARCHYCODE,
       mdfch.VALIDFROM,
       ADESSO);
   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM anagrafica_use)
          - (SELECT COUNT (1) num_r_dim
               FROM dim_anagrafica_use
              WHERE dat_fin_vld_tec IS NULL AND sk_use> 0)
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_use'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;
   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_anagrafica_use'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_anagrafica_use;



PROCEDURE prc_dim_param (Param IN VARCHAR2)
IS
BEGIN
   --dummy
   SELECT COUNT (1)
     INTO n_dummy
     FROM dim_param
    WHERE sk_param < 0;

   IF n_dummy = 0
   THEN
      INSERT INTO dim_param (sk_act_param,
                             sk_param,
                             term_code,
                             TERMEXTENDEDNAME,
                             VALIDFROM,
                             VALIDTO,
                             dat_ini_vld_tec)
         (SELECT -1,
                 -1,
                 '-1',
                 'ND',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL
          UNION
          SELECT -2,
                 -2,
                 '-2',
                 'ER',
                 NULL,
                 NULL,
                 adesso
            FROM DUAL);
             COMMIT;
   END IF;


   --cancellazioni
   FOR cnclzn IN (SELECT TERM_CODE , NVL(PROVENIENZA, 'PARAM') PROVENIENZA            --chiave tecnica gestionale
                    FROM dim_param
                   WHERE dat_fin_vld_tec IS NULL
                   AND sk_param > 0
                  MINUS
                  SELECT TERM_CODE, NVL(PROVENIENZA, 'PARAM') PROVENIENZA
                  FROM v_param)
   LOOP
      UPDATE dim_param
         SET dat_fin_vld_tec = adesso
       WHERE                                                  --id = cnclzn.id
            sk_param > 0
             AND term_code = cnclzn.term_code
             AND NVL(PROVENIENZA, 'PARAM') = cnclzn.PROVENIENZA
             AND dat_fin_vld_tec IS NULL;
              COMMIT;
   END LOOP;

   --modifiche
   FOR mdfch
      IN (SELECT TRIM (TERM_CODE) TERM_CODE,
                 TRIM (TERMEXTENDEDNAME) TERMEXTENDEDNAME,
                 TRIM (TERMSHORTNAME) TERMSHORTNAME,
                 TRIM (TERMSCOPENOTE) TERMSCOPENOTE,
                 VERSION,
                 LASTUPDATE,
                 VALIDFROM,
                 VALIDTO,
                 TRIM (STATUS) STATUS,
                 DEPRECATED,
                 TRIM (OTHERNAMES) OTHERNAMES,
                 TRIM (COMMONNAMES) COMMONNAMES,
                 TRIM (FLAVISNUMBER) FLAVISNUMBER,
                 TRIM (COM_ECSUBINVENTENTRYREF) COM_ECSUBINVENTENTRYREF,
                 TRIM (IUPAC) IUPAC,
                 TRIM (CAS) CAS,
                 TRIM (MOLECULARFORMULA) MOLECULARFORMULA,
                 TRIM (SMILESNOTATION) SMILESNOTATION,
                 TRIM (INCHI) INCHI,
                 TRIM (TERMTYPE) TERMTYPE,
                 TRIM (ZOOLABEL) ZOOLABEL,
                 TRIM (DETAILLEVEL) DETAILLEVEL,
                 TRIM (DEPOSITIONNO) DEPOSITIONNO,
                 MASTERFLAG,
                 TRIM (MASTERPARENTCODE) MASTERPARENTCODE,
                 MASTERORDER,
                 MASTERREPORTABLE,
                 TRIM (MASTERHIERARCHYCODE) MASTERHIERARCHYCODE,
                 TRIM (PESTPARAMFLAG) PESTPARAMFLAG,
                 TRIM (PESTPARAMPARENTCODE) PESTPARAMPARENTCODE,
                 TRIM (PESTPARAMORDER) PESTPARAMORDER,
                 TRIM (PESTPARAMREPORTABLE) PESTPARAMREPORTABLE,
                 TRIM (PESTPARAMHIERARCHYCODE) PESTPARAMHIERARCHYCODE,
                 TRIM (MICROPARAMFLAG) MICROPARAMFLAG,
                 TRIM (MICROPARAMPARENTCODE) MICROPARAMPARENTCODE,
                 TRIM (MICROPARAMORDER) MICROPARAMORDER,
                 TRIM (MICROPARAMREPORTABLE) MICROPARAMREPORTABLE,
                 TRIM (MICROPARAMHIERARCHYCODE) MICROPARAMHIERARCHYCODE,
                 TRIM (SEROVARSFLAG) SEROVARSFLAG,
                 TRIM (SEROVARSPARENTCODE) SEROVARSPARENTCODE,
                 TRIM (SEROVARSORDER) SEROVARSORDER,
                 TRIM (SEROVARSREPORTABLE) SEROVARSREPORTABLE,
                 TRIM (SEROVARSHIERARCHYCODE) SEROVARSHIERARCHYCODE,
                 TRIM (FDBRNAGFLAG) FDBRNAGFLAG,
                 TRIM (FDBRNAGPARENTCODE) FDBRNAGPARENTCODE,
                 TRIM (FDBRNAGORDER) FDBRNAGORDER,
                 TRIM (FDBRNAGREPORTABLE) FDBRNAGREPORTABLE,
                 TRIM (FDBRNAGHIERARCHYCODE) FDBRNAGHIERARCHYCODE,
                 TRIM (FDBRNAGGRPFLAG) FDBRNAGGRPFLAG,
                 TRIM (FDBRNAGGRPPARENTCODE) FDBRNAGGRPPARENTCODE,
                 TRIM (FDBRNAGGRPORDER) FDBRNAGGRPORDER,
                 TRIM (FDBRNAGGRPREPORTABLE) FDBRNAGGRPREPORTABLE,
                 TRIM (FDBRNAGGRPHIERARCHYCODE) FDBRNAGGRPHIERARCHYCODE,
                 TRIM (AMRSUBFLAG) AMRSUBFLAG,
                 TRIM (AMRSUBPARENTCODE) AMRSUBPARENTCODE,
                 TRIM (AMRSUBORDER) AMRSUBORDER,
                 TRIM (AMRSUBREPORTABLE) AMRSUBREPORTABLE,
                 TRIM (AMRSUBHIERARCHYCODE) AMRSUBHIERARCHYCODE,
                 TRIM (OCCGRP1PARFLAG) OCCGRP1PARFLAG,
                 TRIM (OCCGRP1PARPARENTCODE) OCCGRP1PARPARENTCODE,
                 TRIM (OCCGRP1PARORDER) OCCGRP1PARORDER,
                 TRIM (OCCGRP1PARREPORTABLE) OCCGRP1PARREPORTABLE,
                 TRIM (OCCGRP1PARHIERARCHYCODE) OCCGRP1PARHIERARCHYCODE,
                 TRIM (OCCGRP2PARFLAG) OCCGRP2PARFLAG,
                 TRIM (OCCGRP2PARPARENTCODE) OCCGRP2PARPARENTCODE,
                 TRIM (OCCGRP2PARORDER) OCCGRP2PARORDER,
                 TRIM (OCCGRP2PARREPORTABLE) OCCGRP2PARREPORTABLE,
                 TRIM (OCCGRP2PARHIERARCHYCODE) OCCGRP2PARHIERARCHYCODE,
                 TRIM (OCCGRP3PARFLAG) OCCGRP3PARFLAG,
                 TRIM (OCCGRP3PARPARENTCODE) OCCGRP3PARPARENTCODE,
                 TRIM (OCCGRP3PARORDER) OCCGRP3PARORDER,
                 TRIM (OCCGRP3PARREPORTABLE) OCCGRP3PARREPORTABLE,
                 TRIM (OCCGRP3PARHIERARCHYCODE) OCCGRP3PARHIERARCHYCODE,
                 TRIM (OCCGRP4PARFLAG) OCCGRP4PARFLAG,
                 TRIM (OCCGRP4PARPARENTCODE) OCCGRP4PARPARENTCODE,
                 TRIM (OCCGRP4PARORDER) OCCGRP4PARORDER,
                 TRIM (OCCGRP4PARREPORTABLE) OCCGRP4PARREPORTABLE,
                 TRIM (OCCGRP4PARHIERARCHYCODE) OCCGRP4PARHIERARCHYCODE,
                 TRIM (OCCGRP5PARFLAG) OCCGRP5PARFLAG,
                 TRIM (OCCGRP5PARPARENTCODE) OCCGRP5PARPARENTCODE,
                 TRIM (OCCGRP5PARORDER) OCCGRP5PARORDER,
                 TRIM (OCCGRP5PARREPORTABLE) OCCGRP5PARREPORTABLE,
                 TRIM (OCCGRP5PARHIERARCHYCODE) OCCGRP5PARHIERARCHYCODE,
                 TRIM (OCCGRP6PARFLAG) OCCGRP6PARFLAG,
                 TRIM (OCCGRP6PARPARENTCODE) OCCGRP6PARPARENTCODE,
                 TRIM (OCCGRP6PARORDER) OCCGRP6PARORDER,
                 TRIM (OCCGRP6PARREPORTABLE) OCCGRP6PARREPORTABLE,
                 TRIM (OCCGRP6PARHIERARCHYCODE) OCCGRP6PARHIERARCHYCODE,
                 TRIM (CARBAFLAG) CARBAFLAG,
                 TRIM (CARBAPARENTCODE) CARBAPARENTCODE,
                 TRIM (CARBAORDER) CARBAORDER,
                 TRIM (CARBAREPORTABLE) CARBAREPORTABLE,
                 TRIM (CARBAHIERARCHYCODE) CARBAHIERARCHYCODE,
                 TRIM (ESBLFLAG) ESBLFLAG,
                 TRIM (ESBLPARENTCODE) ESBLPARENTCODE,
                 TRIM (ESBLORDER) ESBLORDER,
                 TRIM (ESBLREPORTABLE) ESBLREPORTABLE,
                 TRIM (ESBLHIERARCHYCODE) ESBLHIERARCHYCODE,
                 TRIM (AMPCFLAG) AMPCFLAG,
                 TRIM (AMPCPARENTCODE) AMPCPARENTCODE,
                 TRIM (AMPCORDER) AMPCORDER,
                 TRIM (AMPCREPORTABLE) AMPCREPORTABLE,
                 TRIM (AMPCHIERARCHYCODE) AMPCHIERARCHYCODE,
                 TRIM (CHEMOCCREPFLAG) CHEMOCCREPFLAG,
                 TRIM (CHEMOCCREPPARENTCODE) CHEMOCCREPPARENTCODE,
                 TRIM (CHEMOCCREPORDER) CHEMOCCREPORDER,
                 TRIM (CHEMOCCREPREPORTABLE) CHEMOCCREPREPORTABLE,
                 TRIM (CHEMOCCREPHIERARCHYCODE) CHEMOCCREPHIERARCHYCODE,
                 ANTHFLAG,
                 TRIM (ANTHPARENTCODE) ANTHPARENTCODE,
                 ANTHORDER,
                 ANTHREPORTABLE,
                 TRIM (ANTHHIERARCHYCODE) ANTHHIERARCHYCODE,
                 VTFLAG,
                 TRIM (VTPARENTCODE) VTPARENTCODE,
                 VTORDER,
                 VTREPORTABLE,
                 TRIM (VTHIERARCHYCODE) VTHIERARCHYCODE,
                 AGFLAG,
                 TRIM (AGPARENTCODE) AGPARENTCODE,
                 AGORDER,
                 AGREPORTABLE,
                 TRIM (AGHIERARCHYCODE) AGHIERARCHYCODE,
                 TRIM (DSTFLAG) DSTFLAG,
                 TRIM (DSTPARENTCODE) DSTPARENTCODE,
                 TRIM (DSTORDER) DSTORDER,
                 TRIM (DSTREPORTABLE) DSTREPORTABLE,
                 TRIM (DSTHIERARCHYCODE) DSTHIERARCHYCODE,
                 TRIM (SEROVARSAMRFLAG) SEROVARSAMRFLAG,
                 TRIM (SEROVARSAMRPARENTCODE) SEROVARSAMRPARENTCODE,
                 TRIM (SEROVARSAMRORDER) SEROVARSAMRORDER,
                 TRIM (SEROVARSAMRREPORTABLE) SEROVARSAMRREPORTABLE,
                 TRIM (SEROVARSAMRHIERARCHYCODE) SEROVARSAMRHIERARCHYCODE,
                 TRIM (ADDFLAG) ADDFLAG,
                 TRIM (ADDPARENTCODE) ADDPARENTCODE,
                 TRIM (ADDORDER) ADDORDER,
                 TRIM (ADDREPORTABLE) ADDREPORTABLE,
                 TRIM (ADDHIERARCHYCODE) ADDHIERARCHYCODE,
                 TRIM (VMPRFLAG) VMPRFLAG,
                 TRIM (VMPRPARENTCODE) VMPRPARENTCODE,
                 TRIM (VMPRORDER) VMPRORDER,
                 TRIM (VMPRREPORTABLE) VMPRREPORTABLE,
                 TRIM (VMPRHIERARCHYCODE) VMPRHIERARCHYCODE,
                 TRIM (FIPRONILFLAG) FIPRONILFLAG,
                 TRIM (FIPRONILPARENTCODE) FIPRONILPARENTCODE,
                 TRIM (FIPRONILORDER) FIPRONILORDER,
                 TRIM (FIPRONILREPORTABLE) FIPRONILREPORTABLE,
                 TRIM (FIPRONILHIERARCHYCODE) FIPRONILHIERARCHYCODE,
                 TRIM (VMPRANALYSISFLAG) VMPRANALYSISFLAG,
                 TRIM (VMPRANALYSISPARENTCODE) VMPRANALYSISPARENTCODE,
                 TRIM (VMPRANALYSISORDER) VMPRANALYSISORDER,
                 TRIM (VMPRANALYSISREPORTABLE) VMPRANALYSISREPORTABLE,
                 TRIM (VMPRANALYSISHIERARCHYCODE) VMPRANALYSISHIERARCHYCODE,
                 EXPTYPFLAG,
                 TRIM (EXPTYPPARENTCODE) EXPTYPPARENTCODE,
                 EXPTYPORDER,
                 EXPTYPREPORTABLE,
                 TRIM (EXPTYPHIERARCHYCODE) EXPTYPHIERARCHYCODE,
                 ALLELESFLAG,
                 TRIM (ALLELESPARENTCODE) ALLELESPARENTCODE,
                 ALLELESORDER,
                 ALLELESREPORTABLE,
                 TRIM (ALLELESHIERARCHYCODE) ALLELESHIERARCHYCODE,
                 TRIM (CHEMOCCANFLAG) CHEMOCCANFLAG,
                 TRIM (CHEMOCCANPARENTCODE) CHEMOCCANPARENTCODE,
                 TRIM (CHEMOCCANORDER) CHEMOCCANORDER,
                 TRIM (CHEMOCCANREPORTABLE) CHEMOCCANREPORTABLE,
                 TRIM (CHEMOCCANHIERARCHYCODE) CHEMOCCANHIERARCHYCODE,
                 TRIM (AMRSUBANFLAG) AMRSUBANFLAG,
                 TRIM (AMRSUBANPARENTCODE) AMRSUBANPARENTCODE,
                 TRIM (AMRSUBANORDER) AMRSUBANORDER,
                 TRIM (AMRSUBANREPORTABLE) AMRSUBANREPORTABLE,
                 TRIM (AMRSUBANHIERARCHYCODE) AMRSUBANHIERARCHYCODE,
                 ANTNFLAG,
                 TRIM (ANTNPARENTCODE) ANTNPARENTCODE,
                 ANTNORDER,
                 ANTNREPORTABLE,
                 TRIM (ANTNHIERARCHYCODE) ANTNHIERARCHYCODE,
                 TRIM (AIPARAMFLAG) AIPARAMFLAG,
                 TRIM (AIPARAMPARENTCODE) AIPARAMPARENTCODE,
                 TRIM (AIPARAMORDER) AIPARAMORDER,
                 TRIM (AIPARAMREPORTABLE) AIPARAMREPORTABLE,
                 TRIM (AIPARAMHIERARCHYCODE) AIPARAMHIERARCHYCODE,
                 TRIM (CHEMMONREPFLAG) CHEMMONREPFLAG,
                 TRIM (CHEMMONREPPARENTCODE) CHEMMONREPPARENTCODE,
                 TRIM (CHEMMONREPORDER) CHEMMONREPORDER,
                 TRIM (CHEMMONREPREPORTABLE) CHEMMONREPREPORTABLE,
                 TRIM (CHEMMONREPHIERARCHYCODE) CHEMMONREPHIERARCHYCODE,
                 TRIM (ADDANALYSISFLAG) ADDANALYSISFLAG,
                 TRIM (ADDANALYSISPARENTCODE) ADDANALYSISPARENTCODE,
                 TRIM (ADDANALYSISORDER) ADDANALYSISORDER,
                 TRIM (ADDANALYSISREPORTABLE) ADDANALYSISREPORTABLE,
                 TRIM (ADDANALYSISHIERARCHYCODE) ADDANALYSISHIERARCHYCODE,
                 TRIM (CHEMANALYSISFLAG) CHEMANALYSISFLAG,
                 TRIM (CHEMANALYSISPARENTCODE) CHEMANALYSISPARENTCODE,
                 TRIM (CHEMANALYSISORDER) CHEMANALYSISORDER,
                 TRIM (CHEMANALYSISREPORTABLE) CHEMANALYSISREPORTABLE,
                 TRIM (CHEMANALYSISHIERARCHYCODE) CHEMANALYSISHIERARCHYCODE,
                 TRIM (TYPHIANALYSISFLAG) TYPHIANALYSISFLAG,
                 TRIM (TYPHIANALYSISPARENTCODE) TYPHIANALYSISPARENTCODE,
                 TRIM (TYPHIANALYSISORDER) TYPHIANALYSISORDER,
                 TRIM (TYPHIANALYSISREPORTABLE) TYPHIANALYSISREPORTABLE,
                 TRIM (TYPHIANALYSISHIERARCHYCODE) TYPHIANALYSISHIERARCHYCODE,
                 TRIM (FDBRNANALYSISFLAG) FDBRNANALYSISFLAG,
                 TRIM (FDBRNANALYSISPARENTCODE) FDBRNANALYSISPARENTCODE,
                 TRIM (FDBRNANALYSISORDER) FDBRNANALYSISORDER,
                 TRIM (FDBRNANALYSISREPORTABLE) FDBRNANALYSISREPORTABLE,
                 TRIM (FDBRNANALYSISHIERARCHYCODE) FDBRNANALYSISHIERARCHYCODE,
                 ID_GRUPPO_MOLECOLE,
                 TRIM (ACRONYMOTHERNAME) ACRONYMOTHERNAME,
                 TRIM (HIERARCHYCODE) HIERARCHYCODE,
                 TRIM (PARENTCODE) PARENTCODE,
                 TRIM (PARAMETERTYPE) PARAMETERTYPE,
                 ID_GRUPPO_EFSA,
                 TRIM (NAME_ITA) NAME_ITA,
                 NVL(PROVENIENZA, 'PARAM') PROVENIENZA
            FROM v_param a
            WHERE  sysdate between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and nvl(a.validto, to_date('31124000','ddmmyyyy'))=
            (
            select min (nvl(c.validto, to_date('31124000','ddmmyyyy'))) valid_to
            FROM DWH_EDW_FSALM.v_param c where c.TERM_CODE=a.TERM_CODE 
            group by c.TERM_CODE
            )
            --WHERE PROVENIENZA IS NOT NULL
          MINUS
          SELECT TERM_CODE,
                 TERMEXTENDEDNAME,
                 TERMSHORTNAME,
                 TERMSCOPENOTE,
                 VERSION,
                 LASTUPDATE,
                 VALIDFROM,
                 VALIDTO,
                 STATUS,
                 DEPRECATED,
                 OTHERNAMES,
                 COMMONNAMES,
                 FLAVISNUMBER,
                 COM_ECSUBINVENTENTRYREF,
                 IUPAC,
                 CAS,
                 MOLECULARFORMULA,
                 SMILESNOTATION,
                 INCHI,
                 TERMTYPE,
                 ZOOLABEL,
                 DETAILLEVEL,
                 DEPOSITIONNO,
                 MASTERFLAG,
                 MASTERPARENTCODE,
                 MASTERORDER,
                 MASTERREPORTABLE,
                 MASTERHIERARCHYCODE,
                 PESTPARAMFLAG,
                 PESTPARAMPARENTCODE,
                 PESTPARAMORDER,
                 PESTPARAMREPORTABLE,
                 PESTPARAMHIERARCHYCODE,
                 MICROPARAMFLAG,
                 MICROPARAMPARENTCODE,
                 MICROPARAMORDER,
                 MICROPARAMREPORTABLE,
                 MICROPARAMHIERARCHYCODE,
                 SEROVARSFLAG,
                 SEROVARSPARENTCODE,
                 SEROVARSORDER,
                 SEROVARSREPORTABLE,
                 SEROVARSHIERARCHYCODE,
                 FDBRNAGFLAG,
                 FDBRNAGPARENTCODE,
                 FDBRNAGORDER,
                 FDBRNAGREPORTABLE,
                 FDBRNAGHIERARCHYCODE,
                 FDBRNAGGRPFLAG,
                 FDBRNAGGRPPARENTCODE,
                 FDBRNAGGRPORDER,
                 FDBRNAGGRPREPORTABLE,
                 FDBRNAGGRPHIERARCHYCODE,
                 AMRSUBFLAG,
                 AMRSUBPARENTCODE,
                 AMRSUBORDER,
                 AMRSUBREPORTABLE,
                 AMRSUBHIERARCHYCODE,
                 OCCGRP1PARFLAG,
                 OCCGRP1PARPARENTCODE,
                 OCCGRP1PARORDER,
                 OCCGRP1PARREPORTABLE,
                 OCCGRP1PARHIERARCHYCODE,
                 OCCGRP2PARFLAG,
                 OCCGRP2PARPARENTCODE,
                 OCCGRP2PARORDER,
                 OCCGRP2PARREPORTABLE,
                 OCCGRP2PARHIERARCHYCODE,
                 OCCGRP3PARFLAG,
                 OCCGRP3PARPARENTCODE,
                 OCCGRP3PARORDER,
                 OCCGRP3PARREPORTABLE,
                 OCCGRP3PARHIERARCHYCODE,
                 OCCGRP4PARFLAG,
                 OCCGRP4PARPARENTCODE,
                 OCCGRP4PARORDER,
                 OCCGRP4PARREPORTABLE,
                 OCCGRP4PARHIERARCHYCODE,
                 OCCGRP5PARFLAG,
                 OCCGRP5PARPARENTCODE,
                 OCCGRP5PARORDER,
                 OCCGRP5PARREPORTABLE,
                 OCCGRP5PARHIERARCHYCODE,
                 OCCGRP6PARFLAG,
                 OCCGRP6PARPARENTCODE,
                 OCCGRP6PARORDER,
                 OCCGRP6PARREPORTABLE,
                 OCCGRP6PARHIERARCHYCODE,
                 CARBAFLAG,
                 CARBAPARENTCODE,
                 CARBAORDER,
                 CARBAREPORTABLE,
                 CARBAHIERARCHYCODE,
                 ESBLFLAG,
                 ESBLPARENTCODE,
                 ESBLORDER,
                 ESBLREPORTABLE,
                 ESBLHIERARCHYCODE,
                 AMPCFLAG,
                 AMPCPARENTCODE,
                 AMPCORDER,
                 AMPCREPORTABLE,
                 AMPCHIERARCHYCODE,
                 CHEMOCCREPFLAG,
                 CHEMOCCREPPARENTCODE,
                 CHEMOCCREPORDER,
                 CHEMOCCREPREPORTABLE,
                 CHEMOCCREPHIERARCHYCODE,
                 ANTHFLAG,
                 ANTHPARENTCODE,
                 ANTHORDER,
                 ANTHREPORTABLE,
                 ANTHHIERARCHYCODE,
                 VTFLAG,
                 VTPARENTCODE,
                 VTORDER,
                 VTREPORTABLE,
                 VTHIERARCHYCODE,
                 AGFLAG,
                 AGPARENTCODE,
                 AGORDER,
                 AGREPORTABLE,
                 AGHIERARCHYCODE,
                 DSTFLAG,
                 DSTPARENTCODE,
                 DSTORDER,
                 DSTREPORTABLE,
                 DSTHIERARCHYCODE,
                 SEROVARSAMRFLAG,
                 SEROVARSAMRPARENTCODE,
                 SEROVARSAMRORDER,
                 SEROVARSAMRREPORTABLE,
                 SEROVARSAMRHIERARCHYCODE,
                 ADDFLAG,
                 ADDPARENTCODE,
                 ADDORDER,
                 ADDREPORTABLE,
                 ADDHIERARCHYCODE,
                 VMPRFLAG,
                 VMPRPARENTCODE,
                 VMPRORDER,
                 VMPRREPORTABLE,
                 VMPRHIERARCHYCODE,
                 FIPRONILFLAG,
                 FIPRONILPARENTCODE,
                 FIPRONILORDER,
                 FIPRONILREPORTABLE,
                 FIPRONILHIERARCHYCODE,
                 VMPRANALYSISFLAG,
                 VMPRANALYSISPARENTCODE,
                 VMPRANALYSISORDER,
                 VMPRANALYSISREPORTABLE,
                 VMPRANALYSISHIERARCHYCODE,
                 EXPTYPFLAG,
                 EXPTYPPARENTCODE,
                 EXPTYPORDER,
                 EXPTYPREPORTABLE,
                 EXPTYPHIERARCHYCODE,
                 ALLELESFLAG,
                 ALLELESPARENTCODE,
                 ALLELESORDER,
                 ALLELESREPORTABLE,
                 ALLELESHIERARCHYCODE,
                 CHEMOCCANFLAG,
                 CHEMOCCANPARENTCODE,
                 CHEMOCCANORDER,
                 CHEMOCCANREPORTABLE,
                 CHEMOCCANHIERARCHYCODE,
                 AMRSUBANFLAG,
                 AMRSUBANPARENTCODE,
                 AMRSUBANORDER,
                 AMRSUBANREPORTABLE,
                 AMRSUBANHIERARCHYCODE,
                 ANTNFLAG,
                 ANTNPARENTCODE,
                 ANTNORDER,
                 ANTNREPORTABLE,
                 ANTNHIERARCHYCODE,
                 AIPARAMFLAG,
                 AIPARAMPARENTCODE,
                 AIPARAMORDER,
                 AIPARAMREPORTABLE,
                 AIPARAMHIERARCHYCODE,
                 CHEMMONREPFLAG,
                 CHEMMONREPPARENTCODE,
                 CHEMMONREPORDER,
                 CHEMMONREPREPORTABLE,
                 CHEMMONREPHIERARCHYCODE,
                 ADDANALYSISFLAG,
                 ADDANALYSISPARENTCODE,
                 ADDANALYSISORDER,
                 ADDANALYSISREPORTABLE,
                 ADDANALYSISHIERARCHYCODE,
                 CHEMANALYSISFLAG,
                 CHEMANALYSISPARENTCODE,
                 CHEMANALYSISORDER,
                 CHEMANALYSISREPORTABLE,
                 CHEMANALYSISHIERARCHYCODE,
                 TYPHIANALYSISFLAG,
                 TYPHIANALYSISPARENTCODE,
                 TYPHIANALYSISORDER,
                 TYPHIANALYSISREPORTABLE,
                 TYPHIANALYSISHIERARCHYCODE,
                 FDBRNANALYSISFLAG,
                 FDBRNANALYSISPARENTCODE,
                 FDBRNANALYSISORDER,
                 FDBRNANALYSISREPORTABLE,
                 FDBRNANALYSISHIERARCHYCODE,
                 ID_GRUPPO_MOLECOLE,
                 ACRONYMOTHERNAME,
                 HIERARCHYCODE,
                 PARENTCODE,
                 PARAMETERTYPE,
                 ID_GRUPPO_EFSA,
                 NAME_ITA,
                 NVL(PROVENIENZA, 'PARAM') PROVENIENZA
            FROM dim_param
           WHERE dat_fin_vld_tec IS NULL AND sk_param > 0
          -- AND PROVENIENZA IS NOT NULL
           )
   LOOP
      UPDATE dim_PARAM
         SET dat_fin_vld_tec = adesso
       WHERE                                                   --ID = mdfch.id
            term_code = mdfch.term_code
             AND NVL(PROVENIENZA, 'PARAM') = mdfch.PROVENIENZA
             AND dat_fin_vld_tec IS NULL
             AND sk_param > 0;

        COMMIT;
      var_rows := SQL%ROWCOUNT;

      IF var_rows > 1
      THEN
         RAISE errore_update;


      ELSIF var_rows = 1
      THEN
         SELECT sk_act_param
           INTO sk_ACT
           FROM dim_param
          WHERE     dat_fin_vld_tec = adesso
                AND sk_param > 0
                AND TERM_CODE = MDFCH.TERM_CODE
                AND NVL(PROVENIENZA, 'PARAM') = mdfch.PROVENIENZA;

         --AND ID = mdfch.ID;
        SELECT stacco_sk (MAX (sk_param), 1) INTO sk FROM dim_param;

      ELSE
      SELECT stacco_sk (MAX (sk_param), 1) INTO sk_ACT FROM dim_param;

      SELECT stacco_sk (MAX (sk_param), 2) INTO sk FROM dim_param;
      END IF;

      INSERT INTO dim_param (SK_PARAM,
                             SK_ACT_PARAM,
                             TERM_CODE,
                             TERMEXTENDEDNAME,
                             TERMSHORTNAME,
                             TERMSCOPENOTE,
                             VERSION,
                             LASTUPDATE,
                             VALIDFROM,
                             VALIDTO,
                             STATUS,
                             DEPRECATED,
                             OTHERNAMES,
                             COMMONNAMES,
                             FLAVISNUMBER,
                             COM_ECSUBINVENTENTRYREF,
                             IUPAC,
                             CAS,
                             MOLECULARFORMULA,
                             SMILESNOTATION,
                             INCHI,
                             TERMTYPE,
                             ZOOLABEL,
                             DETAILLEVEL,
                             DEPOSITIONNO,
                             MASTERFLAG,
                             MASTERPARENTCODE,
                             MASTERORDER,
                             MASTERREPORTABLE,
                             MASTERHIERARCHYCODE,
                             PESTPARAMFLAG,
                             PESTPARAMPARENTCODE,
                             PESTPARAMORDER,
                             PESTPARAMREPORTABLE,
                             PESTPARAMHIERARCHYCODE,
                             MICROPARAMFLAG,
                             MICROPARAMPARENTCODE,
                             MICROPARAMORDER,
                             MICROPARAMREPORTABLE,
                             MICROPARAMHIERARCHYCODE,
                             SEROVARSFLAG,
                             SEROVARSPARENTCODE,
                             SEROVARSORDER,
                             SEROVARSREPORTABLE,
                             SEROVARSHIERARCHYCODE,
                             FDBRNAGFLAG,
                             FDBRNAGPARENTCODE,
                             FDBRNAGORDER,
                             FDBRNAGREPORTABLE,
                             FDBRNAGHIERARCHYCODE,
                             FDBRNAGGRPFLAG,
                             FDBRNAGGRPPARENTCODE,
                             FDBRNAGGRPORDER,
                             FDBRNAGGRPREPORTABLE,
                             FDBRNAGGRPHIERARCHYCODE,
                             AMRSUBFLAG,
                             AMRSUBPARENTCODE,
                             AMRSUBORDER,
                             AMRSUBREPORTABLE,
                             AMRSUBHIERARCHYCODE,
                             OCCGRP1PARFLAG,
                             OCCGRP1PARPARENTCODE,
                             OCCGRP1PARORDER,
                             OCCGRP1PARREPORTABLE,
                             OCCGRP1PARHIERARCHYCODE,
                             OCCGRP2PARFLAG,
                             OCCGRP2PARPARENTCODE,
                             OCCGRP2PARORDER,
                             OCCGRP2PARREPORTABLE,
                             OCCGRP2PARHIERARCHYCODE,
                             OCCGRP3PARFLAG,
                             OCCGRP3PARPARENTCODE,
                             OCCGRP3PARORDER,
                             OCCGRP3PARREPORTABLE,
                             OCCGRP3PARHIERARCHYCODE,
                             OCCGRP4PARFLAG,
                             OCCGRP4PARPARENTCODE,
                             OCCGRP4PARORDER,
                             OCCGRP4PARREPORTABLE,
                             OCCGRP4PARHIERARCHYCODE,
                             OCCGRP5PARFLAG,
                             OCCGRP5PARPARENTCODE,
                             OCCGRP5PARORDER,
                             OCCGRP5PARREPORTABLE,
                             OCCGRP5PARHIERARCHYCODE,
                             OCCGRP6PARFLAG,
                             OCCGRP6PARPARENTCODE,
                             OCCGRP6PARORDER,
                             OCCGRP6PARREPORTABLE,
                             OCCGRP6PARHIERARCHYCODE,
                             CARBAFLAG,
                             CARBAPARENTCODE,
                             CARBAORDER,
                             CARBAREPORTABLE,
                             CARBAHIERARCHYCODE,
                             ESBLFLAG,
                             ESBLPARENTCODE,
                             ESBLORDER,
                             ESBLREPORTABLE,
                             ESBLHIERARCHYCODE,
                             AMPCFLAG,
                             AMPCPARENTCODE,
                             AMPCORDER,
                             AMPCREPORTABLE,
                             AMPCHIERARCHYCODE,
                             CHEMOCCREPFLAG,
                             CHEMOCCREPPARENTCODE,
                             CHEMOCCREPORDER,
                             CHEMOCCREPREPORTABLE,
                             CHEMOCCREPHIERARCHYCODE,
                             ANTHFLAG,
                             ANTHPARENTCODE,
                             ANTHORDER,
                             ANTHREPORTABLE,
                             ANTHHIERARCHYCODE,
                             VTFLAG,
                             VTPARENTCODE,
                             VTORDER,
                             VTREPORTABLE,
                             VTHIERARCHYCODE,
                             AGFLAG,
                             AGPARENTCODE,
                             AGORDER,
                             AGREPORTABLE,
                             AGHIERARCHYCODE,
                             DSTFLAG,
                             DSTPARENTCODE,
                             DSTORDER,
                             DSTREPORTABLE,
                             DSTHIERARCHYCODE,
                             SEROVARSAMRFLAG,
                             SEROVARSAMRPARENTCODE,
                             SEROVARSAMRORDER,
                             SEROVARSAMRREPORTABLE,
                             SEROVARSAMRHIERARCHYCODE,
                             ADDFLAG,
                             ADDPARENTCODE,
                             ADDORDER,
                             ADDREPORTABLE,
                             ADDHIERARCHYCODE,
                             VMPRFLAG,
                             VMPRPARENTCODE,
                             VMPRORDER,
                             VMPRREPORTABLE,
                             VMPRHIERARCHYCODE,
                             FIPRONILFLAG,
                             FIPRONILPARENTCODE,
                             FIPRONILORDER,
                             FIPRONILREPORTABLE,
                             FIPRONILHIERARCHYCODE,
                             VMPRANALYSISFLAG,
                             VMPRANALYSISPARENTCODE,
                             VMPRANALYSISORDER,
                             VMPRANALYSISREPORTABLE,
                             VMPRANALYSISHIERARCHYCODE,
                             EXPTYPFLAG,
                             EXPTYPPARENTCODE,
                             EXPTYPORDER,
                             EXPTYPREPORTABLE,
                             EXPTYPHIERARCHYCODE,
                             ALLELESFLAG,
                             ALLELESPARENTCODE,
                             ALLELESORDER,
                             ALLELESREPORTABLE,
                             ALLELESHIERARCHYCODE,
                             CHEMOCCANFLAG,
                             CHEMOCCANPARENTCODE,
                             CHEMOCCANORDER,
                             CHEMOCCANREPORTABLE,
                             CHEMOCCANHIERARCHYCODE,
                             AMRSUBANFLAG,
                             AMRSUBANPARENTCODE,
                             AMRSUBANORDER,
                             AMRSUBANREPORTABLE,
                             AMRSUBANHIERARCHYCODE,
                             ANTNFLAG,
                             ANTNPARENTCODE,
                             ANTNORDER,
                             ANTNREPORTABLE,
                             ANTNHIERARCHYCODE,
                             AIPARAMFLAG,
                             AIPARAMPARENTCODE,
                             AIPARAMORDER,
                             AIPARAMREPORTABLE,
                             AIPARAMHIERARCHYCODE,
                             CHEMMONREPFLAG,
                             CHEMMONREPPARENTCODE,
                             CHEMMONREPORDER,
                             CHEMMONREPREPORTABLE,
                             CHEMMONREPHIERARCHYCODE,
                             ADDANALYSISFLAG,
                             ADDANALYSISPARENTCODE,
                             ADDANALYSISORDER,
                             ADDANALYSISREPORTABLE,
                             ADDANALYSISHIERARCHYCODE,
                             CHEMANALYSISFLAG,
                             CHEMANALYSISPARENTCODE,
                             CHEMANALYSISORDER,
                             CHEMANALYSISREPORTABLE,
                             CHEMANALYSISHIERARCHYCODE,
                             TYPHIANALYSISFLAG,
                             TYPHIANALYSISPARENTCODE,
                             TYPHIANALYSISORDER,
                             TYPHIANALYSISREPORTABLE,
                             TYPHIANALYSISHIERARCHYCODE,
                             FDBRNANALYSISFLAG,
                             FDBRNANALYSISPARENTCODE,
                             FDBRNANALYSISORDER,
                             FDBRNANALYSISREPORTABLE,
                             FDBRNANALYSISHIERARCHYCODE,
                             ID_GRUPPO_MOLECOLE,
                             ACRONYMOTHERNAME,
                             HIERARCHYCODE,
                             PARENTCODE,
                             PARAMETERTYPE,
                             ID_GRUPPO_EFSA,
                             NAME_ITA,
                             PROVENIENZA,
                             DAT_INI_VLD_TEC)
           VALUES (SK,
                   SK_ACT,
                   mdfch.TERM_CODE,
                   mdfch.TERMEXTENDEDNAME,
                   mdfch.TERMSHORTNAME,
                   mdfch.TERMSCOPENOTE,
                   mdfch.VERSION,
                   mdfch.LASTUPDATE,
                   mdfch.VALIDFROM,
                   mdfch.VALIDTO,
                   mdfch.STATUS,
                   mdfch.DEPRECATED,
                   mdfch.OTHERNAMES,
                   mdfch.COMMONNAMES,
                   mdfch.FLAVISNUMBER,
                   mdfch.COM_ECSUBINVENTENTRYREF,
                   mdfch.IUPAC,
                   mdfch.CAS,
                   mdfch.MOLECULARFORMULA,
                   mdfch.SMILESNOTATION,
                   mdfch.INCHI,
                   mdfch.TERMTYPE,
                   mdfch.ZOOLABEL,
                   mdfch.DETAILLEVEL,
                   mdfch.DEPOSITIONNO,
                   mdfch.MASTERFLAG,
                   mdfch.MASTERPARENTCODE,
                   mdfch.MASTERORDER,
                   mdfch.MASTERREPORTABLE,
                   mdfch.MASTERHIERARCHYCODE,
                   mdfch.PESTPARAMFLAG,
                   mdfch.PESTPARAMPARENTCODE,
                   mdfch.PESTPARAMORDER,
                   mdfch.PESTPARAMREPORTABLE,
                   mdfch.PESTPARAMHIERARCHYCODE,
                   mdfch.MICROPARAMFLAG,
                   mdfch.MICROPARAMPARENTCODE,
                   mdfch.MICROPARAMORDER,
                   mdfch.MICROPARAMREPORTABLE,
                   mdfch.MICROPARAMHIERARCHYCODE,
                   mdfch.SEROVARSFLAG,
                   mdfch.SEROVARSPARENTCODE,
                   mdfch.SEROVARSORDER,
                   mdfch.SEROVARSREPORTABLE,
                   mdfch.SEROVARSHIERARCHYCODE,
                   mdfch.FDBRNAGFLAG,
                   mdfch.FDBRNAGPARENTCODE,
                   mdfch.FDBRNAGORDER,
                   mdfch.FDBRNAGREPORTABLE,
                   mdfch.FDBRNAGHIERARCHYCODE,
                   mdfch.FDBRNAGGRPFLAG,
                   mdfch.FDBRNAGGRPPARENTCODE,
                   mdfch.FDBRNAGGRPORDER,
                   mdfch.FDBRNAGGRPREPORTABLE,
                   mdfch.FDBRNAGGRPHIERARCHYCODE,
                   mdfch.AMRSUBFLAG,
                   mdfch.AMRSUBPARENTCODE,
                   mdfch.AMRSUBORDER,
                   mdfch.AMRSUBREPORTABLE,
                   mdfch.AMRSUBHIERARCHYCODE,
                   mdfch.OCCGRP1PARFLAG,
                   mdfch.OCCGRP1PARPARENTCODE,
                   mdfch.OCCGRP1PARORDER,
                   mdfch.OCCGRP1PARREPORTABLE,
                   mdfch.OCCGRP1PARHIERARCHYCODE,
                   mdfch.OCCGRP2PARFLAG,
                   mdfch.OCCGRP2PARPARENTCODE,
                   mdfch.OCCGRP2PARORDER,
                   mdfch.OCCGRP2PARREPORTABLE,
                   mdfch.OCCGRP2PARHIERARCHYCODE,
                   mdfch.OCCGRP3PARFLAG,
                   mdfch.OCCGRP3PARPARENTCODE,
                   mdfch.OCCGRP3PARORDER,
                   mdfch.OCCGRP3PARREPORTABLE,
                   mdfch.OCCGRP3PARHIERARCHYCODE,
                   mdfch.OCCGRP4PARFLAG,
                   mdfch.OCCGRP4PARPARENTCODE,
                   mdfch.OCCGRP4PARORDER,
                   mdfch.OCCGRP4PARREPORTABLE,
                   mdfch.OCCGRP4PARHIERARCHYCODE,
                   mdfch.OCCGRP5PARFLAG,
                   mdfch.OCCGRP5PARPARENTCODE,
                   mdfch.OCCGRP5PARORDER,
                   mdfch.OCCGRP5PARREPORTABLE,
                   mdfch.OCCGRP5PARHIERARCHYCODE,
                   mdfch.OCCGRP6PARFLAG,
                   mdfch.OCCGRP6PARPARENTCODE,
                   mdfch.OCCGRP6PARORDER,
                   mdfch.OCCGRP6PARREPORTABLE,
                   mdfch.OCCGRP6PARHIERARCHYCODE,
                   mdfch.CARBAFLAG,
                   mdfch.CARBAPARENTCODE,
                   mdfch.CARBAORDER,
                   mdfch.CARBAREPORTABLE,
                   mdfch.CARBAHIERARCHYCODE,
                   mdfch.ESBLFLAG,
                   mdfch.ESBLPARENTCODE,
                   mdfch.ESBLORDER,
                   mdfch.ESBLREPORTABLE,
                   mdfch.ESBLHIERARCHYCODE,
                   mdfch.AMPCFLAG,
                   mdfch.AMPCPARENTCODE,
                   mdfch.AMPCORDER,
                   mdfch.AMPCREPORTABLE,
                   mdfch.AMPCHIERARCHYCODE,
                   mdfch.CHEMOCCREPFLAG,
                   mdfch.CHEMOCCREPPARENTCODE,
                   mdfch.CHEMOCCREPORDER,
                   mdfch.CHEMOCCREPREPORTABLE,
                   mdfch.CHEMOCCREPHIERARCHYCODE,
                   mdfch.ANTHFLAG,
                   mdfch.ANTHPARENTCODE,
                   mdfch.ANTHORDER,
                   mdfch.ANTHREPORTABLE,
                   mdfch.ANTHHIERARCHYCODE,
                   mdfch.VTFLAG,
                   mdfch.VTPARENTCODE,
                   mdfch.VTORDER,
                   mdfch.VTREPORTABLE,
                   mdfch.VTHIERARCHYCODE,
                   mdfch.AGFLAG,
                   mdfch.AGPARENTCODE,
                   mdfch.AGORDER,
                   mdfch.AGREPORTABLE,
                   mdfch.AGHIERARCHYCODE,
                   mdfch.DSTFLAG,
                   mdfch.DSTPARENTCODE,
                   mdfch.DSTORDER,
                   mdfch.DSTREPORTABLE,
                   mdfch.DSTHIERARCHYCODE,
                   mdfch.SEROVARSAMRFLAG,
                   mdfch.SEROVARSAMRPARENTCODE,
                   mdfch.SEROVARSAMRORDER,
                   mdfch.SEROVARSAMRREPORTABLE,
                   mdfch.SEROVARSAMRHIERARCHYCODE,
                   mdfch.ADDFLAG,
                   mdfch.ADDPARENTCODE,
                   mdfch.ADDORDER,
                   mdfch.ADDREPORTABLE,
                   mdfch.ADDHIERARCHYCODE,
                   mdfch.VMPRFLAG,
                   mdfch.VMPRPARENTCODE,
                   mdfch.VMPRORDER,
                   mdfch.VMPRREPORTABLE,
                   mdfch.VMPRHIERARCHYCODE,
                   mdfch.FIPRONILFLAG,
                   mdfch.FIPRONILPARENTCODE,
                   mdfch.FIPRONILORDER,
                   mdfch.FIPRONILREPORTABLE,
                   mdfch.FIPRONILHIERARCHYCODE,
                   mdfch.VMPRANALYSISFLAG,
                   mdfch.VMPRANALYSISPARENTCODE,
                   mdfch.VMPRANALYSISORDER,
                   mdfch.VMPRANALYSISREPORTABLE,
                   mdfch.VMPRANALYSISHIERARCHYCODE,
                   mdfch.EXPTYPFLAG,
                   mdfch.EXPTYPPARENTCODE,
                   mdfch.EXPTYPORDER,
                   mdfch.EXPTYPREPORTABLE,
                   mdfch.EXPTYPHIERARCHYCODE,
                   mdfch.ALLELESFLAG,
                   mdfch.ALLELESPARENTCODE,
                   mdfch.ALLELESORDER,
                   mdfch.ALLELESREPORTABLE,
                   mdfch.ALLELESHIERARCHYCODE,
                   mdfch.CHEMOCCANFLAG,
                   mdfch.CHEMOCCANPARENTCODE,
                   mdfch.CHEMOCCANORDER,
                   mdfch.CHEMOCCANREPORTABLE,
                   mdfch.CHEMOCCANHIERARCHYCODE,
                   mdfch.AMRSUBANFLAG,
                   mdfch.AMRSUBANPARENTCODE,
                   mdfch.AMRSUBANORDER,
                   mdfch.AMRSUBANREPORTABLE,
                   mdfch.AMRSUBANHIERARCHYCODE,
                   mdfch.ANTNFLAG,
                   mdfch.ANTNPARENTCODE,
                   mdfch.ANTNORDER,
                   mdfch.ANTNREPORTABLE,
                   mdfch.ANTNHIERARCHYCODE,
                   mdfch.AIPARAMFLAG,
                   mdfch.AIPARAMPARENTCODE,
                   mdfch.AIPARAMORDER,
                   mdfch.AIPARAMREPORTABLE,
                   mdfch.AIPARAMHIERARCHYCODE,
                   mdfch.CHEMMONREPFLAG,
                   mdfch.CHEMMONREPPARENTCODE,
                   mdfch.CHEMMONREPORDER,
                   mdfch.CHEMMONREPREPORTABLE,
                   mdfch.CHEMMONREPHIERARCHYCODE,
                   mdfch.ADDANALYSISFLAG,
                   mdfch.ADDANALYSISPARENTCODE,
                   mdfch.ADDANALYSISORDER,
                   mdfch.ADDANALYSISREPORTABLE,
                   mdfch.ADDANALYSISHIERARCHYCODE,
                   mdfch.CHEMANALYSISFLAG,
                   mdfch.CHEMANALYSISPARENTCODE,
                   mdfch.CHEMANALYSISORDER,
                   mdfch.CHEMANALYSISREPORTABLE,
                   mdfch.CHEMANALYSISHIERARCHYCODE,
                   mdfch.TYPHIANALYSISFLAG,
                   mdfch.TYPHIANALYSISPARENTCODE,
                   mdfch.TYPHIANALYSISORDER,
                   mdfch.TYPHIANALYSISREPORTABLE,
                   mdfch.TYPHIANALYSISHIERARCHYCODE,
                   mdfch.FDBRNANALYSISFLAG,
                   mdfch.FDBRNANALYSISPARENTCODE,
                   mdfch.FDBRNANALYSISORDER,
                   mdfch.FDBRNANALYSISREPORTABLE,
                   mdfch.FDBRNANALYSISHIERARCHYCODE,
                   mdfch.ID_GRUPPO_MOLECOLE,
                   mdfch.ACRONYMOTHERNAME,
                   mdfch.HIERARCHYCODE,
                   mdfch.PARENTCODE,
                   mdfch.PARAMETERTYPE,
                   mdfch.ID_GRUPPO_EFSA,
                   mdfch.NAME_ITA,
                   mdfch.PROVENIENZA,
                   ADESSO);

     commit;

   END LOOP;

   --controllo
   SELECT (SELECT COUNT (1) num_r_ana FROM v_param A 
                               WHERE  sysdate between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
                                and nvl(a.validto, to_date('31124000','ddmmyyyy'))=
                                (
                                select min (nvl(c.validto, to_date('31124000','ddmmyyyy'))) valid_to
                                FROM DWH_EDW_FSALM.v_param c where c.TERM_CODE=a.TERM_CODE 
                                group by c.TERM_CODE
                                )
                               
   )--WHERE A.PROVENIENZA IS NOT NULL
          - (SELECT COUNT (1) num_r_dim
               FROM dim_param B
              WHERE B.dat_fin_vld_tec IS NULL AND B.sk_param > 0 )--AND B.PROVENIENZA IS NOT NULL
     INTO differenza
     FROM DUAL;

   IF (differenza) <> 0
   THEN
      RAISE errore;
   END IF;
   
   commit;
   
EXCEPTION
   WHEN errore
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_param'
            || ' - '
            || 'dovuto al controllo finale',
            1,
            4000);
      RAISE;

      WHEN erroreZero
   THEN
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_param'
            || ' - '
            || 'dovuto update non fatto',
            1,
            4000);
      RAISE;


   WHEN OTHERS
   THEN
      --cod_errore  := '101';
      --cod_errore_ora := sqlcode;
      --desc_errore_ora := substr(sqlerrm,1,4000);
      desc_errore :=
         SUBSTR (
               'ERRORE Caricamento della dimensione : '
            || 'dim_param'
            || ' - '
            || SQLERRM,
            1,
            4000);
      RAISE;
END prc_dim_param;



 procedure prc_dim_asl (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from dim_asl where SK_ASL_SAMPORG < 0;
    if n_dummy = 0 then
        insert into dim_asl
        (SK_ACT_ASL, SK_ASL_SAMPORG, id, id_regione, COD_ASL, TERM_DESCRIPTION, DAT_INI_VLD, DAT_END_VLD, dat_ini_vld_tec)
        (select
                 -1, -1, -1,-1, '-1', 'ND', null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, -2, '-2', 'ER', null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select id --chiave tecnica gestionale
                     from dim_asl where dat_fin_vld_tec is null and SK_ASL_SAMPORG > 0
                     minus
                     select id
                     from asl
                  )
    loop

    update dim_asl
    set dat_fin_vld_tec = adesso
    where id = cnclzn.id
      and SK_ASL_SAMPORG > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select id, ID_REGIONE, trim(COD_ASL) COD_ASL, trim(TERM_DESCRIPTION) TERM_DESCRIPTION, DAT_INI_VLD, DAT_END_VLD --tutti i campi della tebella del gestionale
                     from asl
                     minus
                     select id, ID_REGIONE, COD_ASL, TERM_DESCRIPTION, DAT_INI_VLD, DAT_END_VLD
                     from dim_asl where dat_fin_vld_tec is null and SK_ASL_SAMPORG > 0
                  )
    loop

    update dim_asl
    set dat_fin_vld_tec = adesso
    where id = mdfch.id
      and SK_ASL_SAMPORG > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


    var_rows := SQL%ROWCOUNT;



            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select sk_ACT_ASL into sk_ACT
                                 from dim_asl
                                 where dat_fin_vld_tec = adesso and SK_ASL_SAMPORG > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_ASL_SAMPORG), 1)  into sk from dim_asl;

            ELSE

                select stacco_sk(max(SK_ASL_SAMPORG), 1)  into sk_ACT from dim_asl;
                select stacco_sk(max(SK_ASL_SAMPORG), 2)  into sk from dim_asl;

            END IF;


    insert into dim_asl
    ( SK_ACT_ASL, SK_ASL_SAMPORG, ID, ID_REGIONE, COD_ASL, TERM_DESCRIPTION, DAT_INI_VLD, DAT_END_VLD, dat_ini_vld_tec)
    values
    ( sk_act, sk, mdfch.id, mdfch.ID_REGIONE, mdfch.COD_ASL, mdfch.TERM_DESCRIPTION, mdfch.DAT_INI_VLD, mdfch.DAT_END_VLD, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from asl) - (select count(1) num_r_dim from dim_asl where dat_fin_vld_tec is null and SK_ASL_SAMPORG > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_ASL'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_ASL'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_asl;

procedure prc_dim_legref(Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_LEGREF where SK_LEGREF < 0;
    if n_dummy = 0 then
        insert into DIM_LEGREF
        ( SK_ACT_LEGREF, SK_LEGREF, ID, TERM_CODE, TERM_EXTENDED_NAME, VALID_FROM, VALID_TO, DAT_INI_VLD_TEC)
        (select
                 -1, -1, -1, '-1', 'ND', NULL, NULL, adesso
         from dual
         union
         select
                 -2, -2, -2, '-2', 'ER', NULL, NULL, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_LEGREF where dat_fin_vld_tec is null and SK_LEGREF > 0
                     minus
                     select ID
                     from LEGREF
                  )
    loop

    update DIM_LEGREF
    set DAT_FIN_VLD_TEC = adesso
    where ID = cnclzn.ID
      and SK_LEGREF > 0
      --and cod_reg = cnclzn.cod_reg
      and DAT_FIN_VLD_TEC is null;

    end loop;

    --modifiche
    for mdfch in (  select ID, trim(TERM_CODE) TERM_CODE,
                        trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME,
                        trim(LAST_UPDATE) LAST_UPDATE,
                        VALID_FROM,
                        to_date(VALID_TO) VALID_TO--tutti i campi della tebella del gestionale
                     from LEGREF
                     minus
                     select ID, TERM_CODE, TERM_EXTENDED_NAME, LAST_UPDATE, VALID_FROM, VALID_TO
                     from DIM_LEGREF where dat_fin_vld_tec is null and SK_LEGREF > 0
                  )
    loop

    update DIM_LEGREF
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_LEGREF > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


    var_rows := SQL%ROWCOUNT;


          IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select sk_ACT_LEGREF into sk_ACT
                                 from DIM_LEGREF
                                 where dat_fin_vld_tec = adesso and SK_LEGREF > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_LEGREF), 1)  into sk from DIM_LEGREF;

            ELSE

               select stacco_sk(max(SK_LEGREF), 1)  into sk_ACT from DIM_LEGREF;
               select stacco_sk(max(SK_LEGREF), 2)  into sk from DIM_LEGREF;


            END IF;

    insert into DIM_LEGREF
    ( SK_ACT_LEGREF, SK_LEGREF, ID, TERM_CODE, TERM_EXTENDED_NAME, LAST_UPDATE, VALID_FROM, VALID_TO, DAT_INI_VLD_TEC)
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.LAST_UPDATE, mdfch.VALID_FROM, mdfch.VALID_TO, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from LEGREF) - (select count(1) num_r_dim from DIM_LEGREF where dat_fin_vld_tec is null and SK_LEGREF > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    commit;
    
EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_LEGREF'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_LEGREF'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_legref;


 procedure prc_dim_sampstr (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_SAMPSTR where SK_SAMPSTR < 0;
    if n_dummy = 0 then
        insert into DIM_SAMPSTR
        ( SK_ACT_SAMPSTR, SK_SAMPSTR, ID, TERM_CODE, TERM_EXTENDED_NAME, valid_from, valid_to, dat_ini_vld_tec)
        (select
                 -1, -1, -1, '-1', 'ND', null, null, adesso
         from dual
         union
         select
                 -1, -2, -2, '-2', 'ER', null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_SAMPSTR where dat_fin_vld_tec is null and SK_SAMPSTR > 0
                     minus
                     select ID
                     from SAMPSTR
                  )
    loop

    update DIM_SAMPSTR
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_SAMPSTR > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID, trim(TERM_CODE) TERM_CODE, trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME, TERM_SCOPE_NOTE, valid_from, valid_to, TRIM(LAST_UPDATE) LAST_UPDATE --tutti i campi della tebella del gestionale
                     from SAMPSTR
                     minus
                     select ID, TERM_CODE, TERM_EXTENDED_NAME, TERM_SCOPE_NOTE, valid_from, valid_to, LAST_UPDATE
                     from DIM_SAMPSTR where dat_fin_vld_tec is null and SK_SAMPSTR > 0
                  )
    loop

    update DIM_SAMPSTR
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_SAMPSTR > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


    var_rows := SQL%ROWCOUNT;



          IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select sk_ACT_SAMPSTR into sk_ACT
                                 from DIM_SAMPSTR
                                 where dat_fin_vld_tec = adesso and SK_SAMPSTR > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_SAMPSTR), 1)  into sk from DIM_SAMPSTR;

            ELSE

               select stacco_sk(max(SK_SAMPSTR), 1)  into sk_ACT from DIM_SAMPSTR;
               select stacco_sk(max(SK_SAMPSTR), 2)  into sk from DIM_SAMPSTR;


            END IF;


    insert into DIM_SAMPSTR
    ( SK_ACT_SAMPSTR, SK_SAMPSTR, ID, TERM_CODE, TERM_EXTENDED_NAME,TERM_SCOPE_NOTE, valid_from, valid_to, dat_ini_vld_tec, LAST_UPDATE)
    values
    ( SK_ACT, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME,mdfch.TERM_SCOPE_NOTE, mdfch.valid_from, mdfch.valid_to, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from SAMPSTR) - (select count(1) num_r_dim from DIM_SAMPSTR where dat_fin_vld_tec is null and SK_SAMPSTR > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_SAMPSTR'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_SAMPSTR'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_sampstr;


procedure prc_dim_progtyp (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_PROGTYP where SK_PROGTYP < 0;
    if n_dummy = 0 then
        insert into DIM_PROGTYP
        (  SK_ACT_PROGTYP,
              SK_PROGTYP
              ,ID
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,LAST_UPDATE
              ,valid_from, valid_to
              ,DAT_INI_VLD_TEC  )
        (select
                  -1,-1, -1, '-1', 'ND', null, null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_PROGTYP where dat_fin_vld_tec is null and SK_PROGTYP > 0
                     minus
                     select ID
                     from PROGTYP
                  )
    loop

    update DIM_PROGTYP
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_PROGTYP > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  ID
                          ,TRIM(TERM_CODE) TERM_CODE
                          ,TRIM(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME
                          ,TRIM(LAST_UPDATE) LAST_UPDATE
                          ,valid_from, valid_to   --tutti i campi della tebella del gestionale
                     from PROGTYP
                     minus
                     select  ID
                          ,TERM_CODE
                          ,TERM_EXTENDED_NAME
                          ,LAST_UPDATE
                          ,valid_from, valid_to
                     from DIM_PROGTYP where dat_fin_vld_tec is null and SK_PROGTYP > 0
                  )
    loop

    update DIM_PROGTYP
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_PROGTYP > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select sk_ACT_PROGTYP into sk_ACT
                                 from DIM_PROGTYP
                                 where dat_fin_vld_tec = adesso and SK_PROGTYP > 0
                                   and ID  = mdfch.ID;

                    select stacco_sk(max(SK_PROGTYP), 1)  into sk from DIM_PROGTYP;

            ELSE

                    select stacco_sk(max(SK_PROGTYP), 1)  into sk_ACT from DIM_PROGTYP;
                    select stacco_sk(max(SK_PROGTYP), 2)  into sk from DIM_PROGTYP;


            END IF;


    insert into DIM_PROGTYP
    (  sk_ACT_PROGTYP,
          SK_PROGTYP
          ,ID
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,LAST_UPDATE
          ,valid_from, valid_to
          ,DAT_INI_VLD_TEC  )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.LAST_UPDATE, mdfch.valid_from, mdfch.valid_to, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from PROGTYP) - (select count(1) num_r_dim from DIM_PROGTYP where dat_fin_vld_tec is null and SK_PROGTYP > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PROGTYP'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PROGTYP'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_progtyp;



procedure prc_dim_sampmd(Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_SAMPMD where SK_SAMPMD < 0;
    if n_dummy = 0 then
        insert into DIM_SAMPMD
                (  SK_SAMPMD
                      ,ID
                      ,TERM_CODE
                      ,TERM_EXTENDED_NAME
                      ,VALID_FROM
                      ,VALID_TO
                      ,NOTE
                      ,DAT_INI_VLD_TEC   )
        (select
                  -1, -1, '-1', 'ND', null, null, null, adesso
         from dual
         union
         select
                  -2, -2, '-2', 'ER', null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_SAMPMD where dat_fin_vld_tec is null and SK_SAMPMD > 0
                     minus
                     select ID
                     from SAMPMD
                  )
    loop

    update DIM_SAMPMD
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_SAMPMD > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID
                              ,TRIM(TERM_CODE) TERM_CODE
                              ,TRIM(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME
                              ,VALID_FROM
                              ,VALID_TO
                              ,NOTE
                              ,TRIM(LAST_UPDATE) LAST_UPDATE      --tutti i campi della tebella del gestionale
                     from SAMPMD
                     minus
                     select
                             ID
                              ,TERM_CODE
                              ,TERM_EXTENDED_NAME
                              ,VALID_FROM
                              ,VALID_TO
                              ,NOTE
                              ,LAST_UPDATE
                     from DIM_SAMPMD where dat_fin_vld_tec is null and SK_SAMPMD > 0
                  )
    loop

    update DIM_SAMPMD
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_SAMPMD > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select sk_ACT_SAMPMD into sk_ACT
                                 from DIM_SAMPMD
                                 where dat_fin_vld_tec = adesso and sk_SAMPMD > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(sk_SAMPMD), 1)  into sk from DIM_SAMPMD;

            ELSE

                select stacco_sk(max(sk_SAMPMD), 1)  into sk_ACT from DIM_SAMPMD;
                select stacco_sk(max(sk_SAMPMD), 2)  into sk from DIM_SAMPMD;

            END IF;

    insert into DIM_SAMPMD
    ( sk_ACT_SAMPMD,
           SK_SAMPMD
          ,ID
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,NOTE
          ,DAT_INI_VLD_TEC
          ,LAST_UPDATE   )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.VALID_FROM, mdfch.VALID_TO, mdfch.NOTE, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from SAMPMD) - (select count(1) num_r_dim from DIM_SAMPMD where dat_fin_vld_tec is null and SK_SAMPMD > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_SAMPMD'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_SAMPMD'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_sampmd;




  procedure prc_dim_samplr(Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_SAMPLR where SK_SAMPLR < 0;
    if n_dummy = 0 then
        insert into DIM_SAMPLR
        ( SK_ACT_SAMPLR, SK_SAMPLR, ID, TERM_CODE, TERM_EXTENDED_NAME, TERM_SCOPE_NOTE,VALID_FROM, VALID_TO, STATUS, DAT_INI_VLD_TEC)
        (select
                  -1, -1, -1, '-1', 'ND', null, null, null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_SAMPLR where dat_fin_vld_tec is null and SK_SAMPLR > 0
                     minus
                     select ID
                     from SAMPLR
                  )
    loop

    update DIM_SAMPLR
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_SAMPLR > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID, trim(TERM_CODE) TERM_CODE, trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME, TERM_SCOPE_NOTE, valid_from, valid_to, STATUS --tutti i campi della tebella del gestionale
                     from SAMPLR
                     minus
                     select ID, TERM_CODE, TERM_EXTENDED_NAME, TERM_SCOPE_NOTE, valid_from, valid_to, STATUS
                     from DIM_SAMPLR where dat_fin_vld_tec is null and SK_SAMPLR > 0
                  )
    loop

    update DIM_SAMPLR
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_SAMPLR > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


    var_rows := SQL%ROWCOUNT;


            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_SAMPLR into sk_ACT
                                 from DIM_SAMPLR
                                 where dat_fin_vld_tec = adesso and SK_SAMPLR > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_SAMPLR), 1)  into sk from DIM_SAMPLR;

            ELSE

               select stacco_sk(max(SK_SAMPLR), 1)  into sk_ACT from DIM_SAMPLR;
               select stacco_sk(max(SK_SAMPLR), 2)  into sk from DIM_SAMPLR;


            END IF;


    insert into DIM_SAMPLR
    ( SK_ACT_SAMPLR, SK_SAMPLR, ID, TERM_CODE, TERM_EXTENDED_NAME, TERM_SCOPE_NOTE, valid_from, valid_to, STATUS, dat_ini_vld_tec)
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.TERM_SCOPE_NOTE, mdfch.valid_from, mdfch.valid_to, mdfch.STATUS, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from SAMPLR) - (select count(1) num_r_dim from DIM_SAMPLR where dat_fin_vld_tec is null and SK_SAMPLR > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_SAMPLR'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_SAMPLR'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_samplr;

procedure prc_dim_smpnt_ita(Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_SMPNT_ITA where SK_SMPNT_ITA < 0;
    if n_dummy = 0 then
        insert into DIM_SMPNT_ITA
        (  SK_ACT_SMPNT_ITA,
            SK_SMPNT_ITA,
            ID,
            CODE,
            NAME,
            HIERARCHYCODE,
            PARENTCODE,
            VALID_FROM,
            VALID_TO,
            DAT_INI_VLD_TEC,
            EFSACODE,
            EFSACODE_DESCRIPTION,
            PSD_AO,
            PSD_TRASF,FLG_BR205)
        (select
                 -1, -1, -1, '-1', 'ND', 'ND', 'ND', null,  null, adesso, 'ND', 'ND' , -1  , -1,NULL
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', 'ER', 'ER', null, null, adesso, 'ER', 'ER' ,  -2 , -2,NULL
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_SMPNT_ITA where dat_fin_vld_tec is null and SK_SMPNT_ITA > 0
                     minus
                     select ID
                     from SMPNT_ITA
                  )
    loop

    update DIM_SMPNT_ITA
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_SMPNT_ITA > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
   for mdfch in (  select
                     CODE
                    ,NAME
                    ,HIERARCHYCODE
                    ,PARENTCODE
                    ,VALID_FROM
                    ,VALID_TO
                    ,EFSACODE
                    ,EFSACODE_DESCRIPTION
                    ,PSD_AO
                    ,PSD_TRASF
                    ,ID,FLG_BR205
 --tutti i campi della tebella del gestionale
                     from SMPNT_ITA
                     minus
                     select
                        CODE
                        ,NAME
                        ,HIERARCHYCODE
                        ,PARENTCODE
                        ,VALID_FROM
                        ,VALID_TO
                        ,EFSACODE
                        ,EFSACODE_DESCRIPTION
                        ,PSD_AO
                        ,PSD_TRASF
                        ,ID,FLG_BR205
                     from DIM_SMPNT_ITA where dat_fin_vld_tec is null and SK_SMPNT_ITA > 0
                  )
    loop

    update DIM_SMPNT_ITA
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_SMPNT_ITA > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


    var_rows := SQL%ROWCOUNT;


              IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_SMPNT_ITA into sk_ACT
                                 from DIM_SMPNT_ITA
                                 where dat_fin_vld_tec = adesso and SK_SMPNT_ITA > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_SMPNT_ITA), 1)  into sk from DIM_SMPNT_ITA;

            ELSE

                   select stacco_sk(max(SK_SMPNT_ITA), 1)  into sk_ACT from DIM_SMPNT_ITA;
                    select stacco_sk(max(SK_SMPNT_ITA), 2)  into sk from DIM_SMPNT_ITA;


            END IF;


    insert into DIM_SMPNT_ITA
    ( SK_ACT_SMPNT_ITA,
            SK_SMPNT_ITA
            ,ID
            ,CODE
            ,NAME
            ,HIERARCHYCODE
            ,PARENTCODE
            ,VALID_FROM
            ,VALID_TO
            ,EFSACODE
            ,EFSACODE_DESCRIPTION
            ,PSD_AO
            ,PSD_TRASF
            ,DAT_INI_VLD_TEC,FLG_BR205)
    values
    ( sk_act,
    sk,
    mdfch.ID,
    mdfch.CODE,
    mdfch.NAME,
    mdfch.HIERARCHYCODE,
    mdfch.PARENTCODE,
    mdfch.valid_from,
    mdfch.valid_to,
    mdfch.EFSACODE,
    mdfch.EFSACODE_DESCRIPTION,
    mdfch.PSD_AO,
    mdfch.PSD_TRASF,
    adesso, mdfch.FLG_BR205 );

    end loop;

    --controllo
    select (select count(1) num_r_ana from SMPNT_ITA) - (select count(1) num_r_dim from DIM_SMPNT_ITA where dat_fin_vld_tec is null and SK_SMPNT_ITA > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_SMPNT_ITA'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_SMPNT_ITA'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_smpnt_ita;

procedure prc_dim_sampuntyp(Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_SAMPUNTYP where SK_SAMPUNTYP < 0;
    if n_dummy = 0 then
        insert into DIM_SAMPUNTYP
        (   SK_ACT_SAMPUNTYP,
               SK_SAMPUNTYP
             , ID
             , SAMPUNITTYPE
             , DESCRIZIONE
             , VALID_FROM
             , VALID_TO
             , DESCRIPTION
             , DAT_INI_VLD_TEC  )
        (select
                 -1,  -1, -1, '-1', 'ND', null, null, 'ND', adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, 'ER', adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_SAMPUNTYP where dat_fin_vld_tec is null and SK_SAMPUNTYP > 0
                     minus
                     select ID
                     from SAMPUNTYP
                  )
    loop

    update DIM_SAMPUNTYP
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_SAMPUNTYP > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID
                             , SAMPUNITTYPE
                             , DESCRIZIONE
                             , VALID_FROM
                             , VALID_TO
                             , DESCRIPTION
                             ,LAST_UPDATE   --tutti i campi della tebella del gestionale
                             from SAMPUNTYP
                             minus
                             select  ID
                             , SAMPUNITTYPE
                             , DESCRIZIONE
                             , VALID_FROM
                             , VALID_TO
                             , DESCRIPTION
                             ,LAST_UPDATE
                             from DIM_SAMPUNTYP where dat_fin_vld_tec is null and SK_SAMPUNTYP > 0
                  )
    loop

    update DIM_SAMPUNTYP
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_SAMPUNTYP > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


    var_rows := SQL%ROWCOUNT;


          IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_SAMPUNTYP into sk_ACT
                                 from DIM_SAMPUNTYP
                                 where dat_fin_vld_tec = adesso and SK_SAMPUNTYP > 0
                                   and ID  = mdfch.ID;

                 select stacco_sk(max(SK_SAMPUNTYP), 1)  into sk from DIM_SAMPUNTYP;

            ELSE

                select stacco_sk(max(SK_SAMPUNTYP), 1)  into sk_ACT from DIM_SAMPUNTYP;
                select stacco_sk(max(SK_SAMPUNTYP), 2)  into sk from DIM_SAMPUNTYP;


            END IF;


    insert into DIM_SAMPUNTYP
                (   SK_ACT_SAMPUNTYP,
                           SK_SAMPUNTYP
                         , ID
                         , SAMPUNITTYPE
                         , DESCRIZIONE
                         , VALID_FROM
                         , VALID_TO
                         , DESCRIPTION
                         , DAT_INI_VLD_TEC
                         , LAST_UPDATE
                          )
    values
    ( sk_act, sk, mdfch.ID, mdfch.SAMPUNITTYPE, mdfch.DESCRIZIONE, mdfch.VALID_FROM, mdfch.valid_to, mdfch.DESCRIPTION, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from SAMPUNTYP) - (select count(1) num_r_dim from DIM_SAMPUNTYP where dat_fin_vld_tec is null and SK_SAMPUNTYP > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;


EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_SAMPUNTYP'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_SAMPUNTYP'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_sampuntyp;

 procedure prc_dim_nonidon (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_NONIDON where SK_MOTIVONONIDONEO < 0;
    if n_dummy = 0 then
        insert into DIM_NONIDON
        (  SK_ACT_MOTIVONONIDONEO,
               SK_MOTIVONONIDONEO
              ,ID
              ,CODICE
              ,DESCRIZIONE
              ,VALID_FROM
              ,VALID_TO
              ,DAT_INI_VLD_TEC  )
        (select
                  -1, -1, -1, '-1', 'ND', null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_NONIDON where dat_fin_vld_tec is null and SK_MOTIVONONIDONEO > 0
                     minus
                     select ID
                     from NONIDON
                  )
    loop

    update DIM_NONIDON
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_MOTIVONONIDONEO > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  ID
                                      ,CODICE
                                      ,DESCRIZIONE
                                      ,VALID_FROM
                                      ,VALID_TO     --tutti i campi della tebella del gestionale
                     from NONIDON
                     minus
                     select ID
                                      ,CODICE
                                      ,DESCRIZIONE
                                      ,VALID_FROM
                                      ,VALID_TO
                     from DIM_NONIDON where dat_fin_vld_tec is null and SK_MOTIVONONIDONEO > 0
                  )
    loop

    update DIM_NONIDON
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_MOTIVONONIDONEO > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


          IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_MOTIVONONIDONEO into sk_ACT
                                 from DIM_NONIDON
                                 where dat_fin_vld_tec = adesso and SK_MOTIVONONIDONEO > 0
                                   and ID  = mdfch.ID;

                    select stacco_sk(max(SK_MOTIVONONIDONEO), 1)  into sk from DIM_NONIDON;

            ELSE

               select stacco_sk(max(SK_MOTIVONONIDONEO), 1)  into sk_ACT from DIM_NONIDON;
               select stacco_sk(max(SK_MOTIVONONIDONEO), 2)  into sk from DIM_NONIDON;


            END IF;


    insert into DIM_NONIDON
    ( SK_ACT_MOTIVONONIDONEO,
           SK_MOTIVONONIDONEO
          ,ID
          ,CODICE
          ,DESCRIZIONE
          ,VALID_FROM
          ,VALID_TO
          ,DAT_INI_VLD_TEC     )
    values
    ( sk_act, sk, mdfch.ID, mdfch.CODICE, mdfch.DESCRIZIONE, mdfch.VALID_FROM, mdfch.VALID_TO, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from NONIDON) - (select count(1) num_r_dim from DIM_NONIDON where dat_fin_vld_tec is null and SK_MOTIVONONIDONEO > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_NONIDON'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_NONIDON'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_nonidon;

 procedure prc_dim_modallev (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_MODALLEV where SK_MODALITALLEVAMENTO < 0;
    if n_dummy = 0 then
        insert into DIM_MODALLEV
        ( SK_ACT_MODALITALLEVAMENTO,
               SK_MODALITALLEVAMENTO
              ,ID
              ,CODICE
              ,DESCRIZIONE
              ,VALID_FROM
              ,VALID_TO
              ,DAT_INI_VLD_TEC )
        (select
                  -1, -1, -1, '-1', 'ND', null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_MODALLEV where dat_fin_vld_tec is null and SK_MODALITALLEVAMENTO > 0
                     minus
                     select ID
                     from MODALLEV
                  )
    loop

    update DIM_MODALLEV
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_MODALITALLEVAMENTO > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

     --modifiche
    for mdfch in (  select ID
                          ,trim(CODICE) CODICE
                          ,trim(DESCRIZIONE) DESCRIZIONE
                          ,VALID_FROM
                          ,VALID_TO     --tutti i campi della tebella del gestionale
                     from MODALLEV
                     minus
                     select ID
                      ,CODICE
                      ,DESCRIZIONE
                      ,VALID_FROM
                      ,VALID_TO
                     from DIM_MODALLEV where dat_fin_vld_tec is null and SK_MODALITALLEVAMENTO > 0
                  )

    loop

    update DIM_MODALLEV
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_MODALITALLEVAMENTO > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;



          IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_MODALITALLEVAMENTO into sk_ACT
                                 from DIM_MODALLEV
                                 where dat_fin_vld_tec = adesso and SK_MODALITALLEVAMENTO > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_MODALITALLEVAMENTO), 1)  into sk from DIM_MODALLEV;

            ELSE

              select stacco_sk(max(SK_MODALITALLEVAMENTO), 1)  into sk_ACT from DIM_MODALLEV;
              select stacco_sk(max(SK_MODALITALLEVAMENTO), 2)  into sk from DIM_MODALLEV;


            END IF;


    insert into DIM_MODALLEV
    (  SK_ACT_MODALITALLEVAMENTO,
          SK_MODALITALLEVAMENTO
          ,ID
          ,CODICE
          ,DESCRIZIONE
          ,VALID_FROM
          ,VALID_TO
          ,DAT_INI_VLD_TEC )
    values
    ( sk_act, sk, mdfch.ID, mdfch.CODICE, mdfch.DESCRIZIONE, mdfch.VALID_FROM, mdfch.VALID_TO, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from MODALLEV) - (select count(1) num_r_dim from DIM_MODALLEV where dat_fin_vld_tec is null and SK_MODALITALLEVAMENTO > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_MODALLEV'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_MODALLEV'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_modallev;

procedure prc_dim_mtxtyp (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_MTXTYP where SK_SAMPMATTYPE < 0;
    if n_dummy = 0 then
        insert into DIM_MTXTYP
        ( SK_ACT_SAMPMATTYPE,
           SK_SAMPMATTYPE
          ,ID
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,STATUS
          ,DAT_INI_VLD_TEC   )
        (select
                  -1, -1, -1, '-1', 'ND', null, null, null, adesso
         from dual
         union
         select
                 -2, -2, -2, '-2', 'ER', null, null, null,  adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_MTXTYP where dat_fin_vld_tec is null and SK_SAMPMATTYPE > 0
                     minus
                     select ID
                     from MTXTYP
                  )
    loop

    update DIM_MTXTYP
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_SAMPMATTYPE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  ID
                          ,TERM_CODE
                          ,TERM_EXTENDED_NAME
                          ,VALID_FROM
                          ,VALID_TO
                          ,STATUS
                          ,LAST_UPDATE
            from MTXTYP
                     minus
                     select ID
                          ,TERM_CODE
                          ,TERM_EXTENDED_NAME
                          ,VALID_FROM
                          ,VALID_TO
                          ,STATUS
                          ,LAST_UPDATE
                     from DIM_MTXTYP where dat_fin_vld_tec is null and SK_SAMPMATTYPE > 0
                  )
    loop

    update DIM_MTXTYP
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_SAMPMATTYPE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


    IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_SAMPMATTYPE into sk_ACT
                                 from DIM_MTXTYP
                                 where dat_fin_vld_tec = adesso and SK_SAMPMATTYPE > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_SAMPMATTYPE), 1)  into sk from DIM_MTXTYP;

            ELSE

              select stacco_sk(max(SK_SAMPMATTYPE), 1)  into sk_ACT from DIM_MTXTYP;
              select stacco_sk(max(SK_SAMPMATTYPE), 2)  into sk from DIM_MTXTYP;


            END IF;


    insert into DIM_MTXTYP
    ( SK_ACT_SAMPMATTYPE,
           SK_SAMPMATTYPE
          ,ID
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,STATUS
          ,DAT_INI_VLD_TEC
          ,LAST_UPDATE   )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, mdfch.STATUS, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from MTXTYP) - (select count(1) num_r_dim from DIM_MTXTYP where dat_fin_vld_tec is null and SK_SAMPMATTYPE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_MTXTYP'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_MTXTYP'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_mtxtyp;


procedure prc_dim_MTX_VMPR_IT (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from dim_MTX_VMPR_IT where SK_SAMPMATCODE < 0;
    if n_dummy = 0 then
        insert into dim_MTX_VMPR_IT
        ( SK_ACT_SAMPMATCODE
          ,SK_SAMPMATCODE
          ,ID
          ,FOOD_NON_FOOD
          ,I_LIVELLO_PER_PROGRAMMAZIONE
          ,ID_I_LIVELLO_PROGRAMMAZIONE
          ,II_LIVELLO_PER_PROGRAMMAZIONE
          ,ID_II_LIVELLO_PROGRAMMAZIONE
          ,SPECIE
          ,ID_SPECIE
          ,ANIMALE
          ,ID_ANIMALE
          ,MATRICE
          ,ID_MATRICE
          ,SAMP_POINT_1
          ,DESC_SAMP_POINT_1
          ,SAMP_POINT_2
          ,DESC_SAMP_POINT_2
          ,SAMP_POINT_3
          ,DESC_SAMP_POINT_3
          ,CODE
          ,F00_BUILDING
          ,FACET_1
          ,FACET_2
          ,FACET_3
          ,FACET_4
          ,VALID_FROM
          ,VALID_TO
          ,DAT_INI_VLD_TEC,
          SAMP_POINT_4,F00,F00_DESC,F01,F01_DESC,F02,F02_DESC,F21,F21_DESC,F30,F30_DESC,F31,F31_DESC,F32,F32_DESC,LAST_UPDATE
          )
        (select
                  -1, -1, -1, '-1', 'ND', -1, -1, -1, -1, null,
                  null, null, 'ND', -1, null,null, null, null, null, null,
                  null, null, null, null, null,null, null, null,
                   adesso,
                    null, null, null, null, null,null, null, null,
                     null, null, null, null, null,null, null, null
         from dual
         union
         select
                 -2, -2, -2, '-2', 'ER',  -2, -2, -2, -2, null,
                  null, null, 'ER', -2, null,null, null, null, null, null,
                  null, null, null, null, null,null, null, null,
                   adesso,
                   null, null, null, null, null,null, null, null,
                     null, null, null, null, null,null, null, null
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from dim_MTX_VMPR_IT where dat_fin_vld_tec is null and SK_SAMPMATCODE > 0
                     minus
                     select ID
                     from MTX_VMPR_IT
                  )
    loop

    update dim_MTX_VMPR_IT
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_SAMPMATCODE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  ID
          ,FOOD_NON_FOOD
          ,I_LIVELLO_PER_PROGRAMMAZIONE
          ,ID_I_LIVELLO_PROGRAMMAZIONE
          ,II_LIVELLO_PER_PROGRAMMAZIONE
          ,ID_II_LIVELLO_PROGRAMMAZIONE
          ,SPECIE
          ,ID_SPECIE
          ,ANIMALE
          ,ID_ANIMALE
          ,MATRICE
          ,ID_MATRICE
          ,SAMP_POINT_1
          ,DESC_SAMP_POINT_1
          ,SAMP_POINT_2
          ,DESC_SAMP_POINT_2
          ,SAMP_POINT_3
          ,DESC_SAMP_POINT_3
          ,CODE
          ,F00_BUILDING
          ,FACET_1
          ,FACET_2
          ,FACET_3
          ,FACET_4
          ,VALID_FROM
          ,VALID_TO
          ,SAMP_POINT_4,F00,F00_DESC,F01,F01_DESC,F02,F02_DESC,F21,F21_DESC,F30,F30_DESC,F31,F31_DESC,F32,F32_DESC,LAST_UPDATE
            from MTX_VMPR_IT --where VALID_TO is null
                     minus
                     select ID
          ,FOOD_NON_FOOD
          ,I_LIVELLO_PER_PROGRAMMAZIONE
          ,ID_I_LIVELLO_PROGRAMMAZIONE
          ,II_LIVELLO_PER_PROGRAMMAZIONE
          ,ID_II_LIVELLO_PROGRAMMAZIONE
          ,SPECIE
          ,ID_SPECIE
          ,ANIMALE
          ,ID_ANIMALE
          ,MATRICE
          ,ID_MATRICE
          ,SAMP_POINT_1
          ,DESC_SAMP_POINT_1
          ,SAMP_POINT_2
          ,DESC_SAMP_POINT_2
          ,SAMP_POINT_3
          ,DESC_SAMP_POINT_3
          ,CODE
          ,F00_BUILDING
          ,FACET_1
          ,FACET_2
          ,FACET_3
          ,FACET_4
          ,VALID_FROM
          ,VALID_TO
          ,SAMP_POINT_4,F00,F00_DESC,F01,F01_DESC,F02,F02_DESC,F21,F21_DESC,F30,F30_DESC,F31,F31_DESC,F32,F32_DESC,LAST_UPDATE
                     from dim_MTX_VMPR_IT where dat_fin_vld_tec is null and SK_SAMPMATCODE > 0
                  )
    loop

    update dim_MTX_VMPR_IT
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_SAMPMATCODE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


    IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_SAMPMATCODE into sk_ACT
                                 from dim_MTX_VMPR_IT
                                 where dat_fin_vld_tec = adesso and SK_SAMPMATCODE > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_SAMPMATCODE), 1)  into sk from dim_MTX_VMPR_IT;

            ELSE

              select stacco_sk(max(SK_SAMPMATCODE), 1)  into sk_ACT from dim_MTX_VMPR_IT;
              select stacco_sk(max(SK_SAMPMATCODE), 2)  into sk from dim_MTX_VMPR_IT;


            END IF;


    insert into dim_MTX_VMPR_IT
    ( SK_ACT_SAMPMATCODE
          ,SK_SAMPMATCODE
          ,ID
          ,FOOD_NON_FOOD
          ,I_LIVELLO_PER_PROGRAMMAZIONE
          ,ID_I_LIVELLO_PROGRAMMAZIONE
          ,II_LIVELLO_PER_PROGRAMMAZIONE
          ,ID_II_LIVELLO_PROGRAMMAZIONE
          ,SPECIE
          ,ID_SPECIE
          ,ANIMALE
          ,ID_ANIMALE
          ,MATRICE
          ,ID_MATRICE
          ,SAMP_POINT_1
          ,DESC_SAMP_POINT_1
          ,SAMP_POINT_2
          ,DESC_SAMP_POINT_2
          ,SAMP_POINT_3
          ,DESC_SAMP_POINT_3
          ,CODE
          ,F00_BUILDING
          ,FACET_1
          ,FACET_2
          ,FACET_3
          ,FACET_4
          ,VALID_FROM
          ,VALID_TO
          ,DAT_INI_VLD_TEC
          ,SAMP_POINT_4,F00,F00_DESC,F01,F01_DESC,F02,F02_DESC,F21,F21_DESC,F30,F30_DESC,F31,F31_DESC,F32,F32_DESC,LAST_UPDATE)
    values
    ( sk_act, sk,mdfch.ID
          ,mdfch.FOOD_NON_FOOD
          ,mdfch.I_LIVELLO_PER_PROGRAMMAZIONE
          ,mdfch.ID_I_LIVELLO_PROGRAMMAZIONE
          ,mdfch.II_LIVELLO_PER_PROGRAMMAZIONE
          ,mdfch.ID_II_LIVELLO_PROGRAMMAZIONE
          ,mdfch.SPECIE
          ,mdfch.ID_SPECIE
          ,mdfch.ANIMALE
          ,mdfch.ID_ANIMALE
          ,mdfch.MATRICE
          ,mdfch.ID_MATRICE
          ,mdfch.SAMP_POINT_1
          ,mdfch.DESC_SAMP_POINT_1
          ,mdfch.SAMP_POINT_2
          ,mdfch.DESC_SAMP_POINT_2
          ,mdfch.SAMP_POINT_3
          ,mdfch.DESC_SAMP_POINT_3
          ,mdfch.CODE
          ,mdfch.F00_BUILDING
          ,mdfch.FACET_1
          ,mdfch.FACET_2
          ,mdfch.FACET_3
          ,mdfch.FACET_4
          ,mdfch.VALID_FROM
          ,mdfch.VALID_TO
          , adesso
          ,mdfch.SAMP_POINT_4,
mdfch.F00,
mdfch.F00_DESC,
mdfch.F01,
mdfch.F01_DESC,
mdfch.F02,
mdfch.F02_DESC,
mdfch.F21,
mdfch.F21_DESC,
mdfch.F30,
mdfch.F30_DESC,
mdfch.F31,
mdfch.F31_DESC,
mdfch.F32,
mdfch.F32_DESC,
mdfch.LAST_UPDATE);

    end loop;

    --controllo
    select (select count(1) num_r_ana from MTX_VMPR_IT) - (select count(1) num_r_dim from dim_MTX_VMPR_IT where dat_fin_vld_tec is null and SK_SAMPMATCODE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'dim_MTX_VMPR_IT'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'dim_MTX_VMPR_IT'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_MTX_VMPR_IT;



procedure prc_dim_country (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_COUNTRY where SK_ORIGCOUNTRY < 0;
    if n_dummy = 0 then
        insert into DIM_COUNTRY
        (  SK_ACT_ORIGCOUNTRY,
           SK_ORIGCOUNTRY
          ,ID
          ,TERM_CODE
          ,TERM_SHORT_NAME
          ,TERM_EXTENDED_NAME
          ,TERM_SCOPE_NOTE
          ,VALID_FROM
          ,VALID_TO
          ,STATUS
          ,DAT_INI_VLD_TEC  )
        (select
                 -1, -1, -1, '-1', 'ND', 'ND', 'ND', null, null, null, adesso
         from dual
         union
         select
                 -1, -2, -2, '-2', 'ER', 'ER', 'ER', null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_COUNTRY where dat_fin_vld_tec is null and SK_ORIGCOUNTRY > 0
                     minus
                     select ID
                     from COUNTRY
                  )
    loop

    update DIM_COUNTRY
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_ORIGCOUNTRY > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  ID
                          ,TRIM(TERM_CODE)        TERM_CODE
                          ,TRIM(TERM_SHORT_NAME)     TERM_SHORT_NAME
                          ,TRIM(TERM_EXTENDED_NAME)  TERM_EXTENDED_NAME
                          ,TRIM(TERM_SCOPE_NOTE)     TERM_SCOPE_NOTE
                          ,VALID_FROM
                          ,VALID_TO
                          ,TRIM(STATUS)  STATUS--tutti i campi della tebella del gestionale
                     from COUNTRY
                     minus
                     select  ID
                          ,TERM_CODE
                          ,TERM_SHORT_NAME
                          ,TERM_EXTENDED_NAME
                          ,TERM_SCOPE_NOTE
                          ,VALID_FROM
                          ,VALID_TO
                          ,STATUS
                     from DIM_COUNTRY where dat_fin_vld_tec is null and SK_ORIGCOUNTRY > 0
                  )
    loop

    update DIM_COUNTRY
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_ORIGCOUNTRY > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


       IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_ORIGCOUNTRY into sk_ACT
                                 from DIM_COUNTRY
                                 where dat_fin_vld_tec = adesso and SK_ORIGCOUNTRY > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_ORIGCOUNTRY), 1)  into sk from DIM_COUNTRY;

            ELSE

               select stacco_sk(max(SK_ORIGCOUNTRY), 1)  into sk_ACT from DIM_COUNTRY;
               select stacco_sk(max(SK_ORIGCOUNTRY), 2)  into sk from DIM_COUNTRY;


            END IF;



    insert into DIM_COUNTRY
    (  SK_ACT_ORIGCOUNTRY,
           SK_ORIGCOUNTRY
          ,ID
          ,TERM_CODE
          ,TERM_SHORT_NAME
          ,TERM_EXTENDED_NAME
          ,TERM_SCOPE_NOTE
          ,VALID_FROM
          ,VALID_TO
          ,STATUS
          ,DAT_INI_VLD_TEC  )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_SHORT_NAME, mdfch.TERM_EXTENDED_NAME, mdfch.TERM_SCOPE_NOTE, mdfch.VALID_FROM, mdfch.VALID_TO, mdfch.STATUS, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from COUNTRY) - (select count(1) num_r_dim from DIM_COUNTRY where dat_fin_vld_tec is null and SK_ORIGCOUNTRY > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_COUNTRY'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_COUNTRY'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_country;


procedure prc_dim_laboratori (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_LABORATORI where SK_LABANALISI < 0;
    if n_dummy = 0 then
        insert into DIM_LABORATORI
        ( SK_ACT_LABANALISI,
           SK_LABANALISI
          ,ID
          ,TERM_CODE
          ,TERM_DESCRIPTION
          ,VALID_FROM
          ,VALID_TO
          ,UO_GAF
          ,DAT_INI_VLD_TEC )
        (select
                 -1, -1, -1, '-1', 'ND', null, null, null, adesso
         from dual
         union
         select
                 -2, -2, -2, '-2', 'ER', null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_LABORATORI where dat_fin_vld_tec is null and SK_LABANALISI > 0
                     minus
                     select ID
                     from LABORATORI
                  )
    loop

    update DIM_LABORATORI
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_LABANALISI > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select    ID
                                      ,trim(TERM_CODE) TERM_CODE
                                      ,trim(TERM_DESCRIPTION) TERM_DESCRIPTION
                                      ,VALID_FROM
                                      ,VALID_TO
                                      ,trim(UO_GAF) UO_GAF  --tutti i campi della tebella del gestionale
                     from LABORATORI
                     minus
                     select     ID
                                  ,TERM_CODE
                                  ,TERM_DESCRIPTION
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,UO_GAF
                     from DIM_LABORATORI where dat_fin_vld_tec is null and SK_LABANALISI > 0
                  )
    loop

    update DIM_LABORATORI
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_LABANALISI > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;

   IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_LABANALISI into sk_ACT
                                 from DIM_LABORATORI
                                 where dat_fin_vld_tec = adesso and SK_LABANALISI > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_LABANALISI), 1)  into sk from DIM_LABORATORI;

            ELSE

                select stacco_sk(max(SK_LABANALISI), 1)  into sk_ACT from DIM_LABORATORI;
                select stacco_sk(max(SK_LABANALISI), 2)  into sk from DIM_LABORATORI;


            END IF;


    insert into DIM_LABORATORI
    (    SK_ACT_LABANALISI,
           SK_LABANALISI
          ,ID
          ,TERM_CODE
          ,TERM_DESCRIPTION
          ,VALID_FROM
          ,VALID_TO
          ,UO_GAF
          ,DAT_INI_VLD_TEC   )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_DESCRIPTION, mdfch.valid_from, mdfch.valid_to, mdfch.UO_GAF, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from LABORATORI) - (select count(1) num_r_dim from DIM_LABORATORI where dat_fin_vld_tec is null and SK_LABANALISI > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_LABORATORI'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_LABORATORI'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_laboratori;

 procedure prc_dim_paramtyp (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_PARAMTYP where SK_PARAMTYPE < 0;
    if n_dummy = 0 then
        insert into DIM_PARAMTYP
        ( SK_ACT_PARAMTYPE,
               SK_PARAMTYPE
              ,ID
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,TERM_SCOPE_NOTE
              ,VALID_FROM
              ,VALID_TO
              ,STATUS
              ,DAT_INI_VLD_TEC )
        (select
                 -1,  -1, -1, '-1', 'ND', null, null, null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_PARAMTYP where dat_fin_vld_tec is null and SK_PARAMTYPE > 0
                     minus
                     select ID
                     from PARAMTYP
                  )
    loop

    update DIM_PARAMTYP
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_PARAMTYPE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID
                                  ,trim(TERM_CODE) TERM_CODE
                                  ,trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME
                                  ,trim(TERM_SCOPE_NOTE) TERM_SCOPE_NOTE
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,trim(STATUS) STATUS
                                  ,LAST_UPDATE   --tutti i campi della tebella del gestionale
                     from PARAMTYP
                     minus
                     select ID
                              ,TERM_CODE
                              ,TERM_EXTENDED_NAME
                              ,TERM_SCOPE_NOTE
                              ,VALID_FROM
                              ,VALID_TO
                              ,STATUS
                              ,LAST_UPDATE
                     from DIM_PARAMTYP where dat_fin_vld_tec is null and SK_PARAMTYPE > 0
                  )
    loop

    update DIM_PARAMTYP
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_PARAMTYPE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


   IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_PARAMTYPE into sk_ACT
                                 from DIM_PARAMTYP
                                 where dat_fin_vld_tec = adesso and SK_PARAMTYPE > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_PARAMTYPE), 1)  into sk from DIM_PARAMTYP;

            ELSE

              select stacco_sk(max(SK_PARAMTYPE), 1)  into sk_ACT from DIM_PARAMTYP;
              select stacco_sk(max(SK_PARAMTYPE), 2)  into sk from DIM_PARAMTYP;


            END IF;


    insert into DIM_PARAMTYP
    ( SK_ACT_PARAMTYPE,
           SK_PARAMTYPE
          ,ID
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,TERM_SCOPE_NOTE
          ,VALID_FROM
          ,VALID_TO
          ,STATUS
          ,DAT_INI_VLD_TEC
          ,LAST_UPDATE   )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.TERM_SCOPE_NOTE, mdfch.valid_from, mdfch.valid_to, mdfch.STATUS, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from PARAMTYP) - (select count(1) num_r_dim from DIM_PARAMTYP where dat_fin_vld_tec is null and SK_PARAMTYPE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PARAMTYP'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PARAMTYP'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_paramtyp;

procedure prc_DIM_PARAM_VMPR_IT (Param in varchar2) is

GRUPPO_MOLECOLA1 varchar2(4000):=null;
GRUPPO_MOLECOLA2 varchar2(4000):=null;
GRUPPO_MOLECOLA3 varchar2(4000):=null;
GRUPPO_MOLECOLA4 varchar2(4000):=null;

  begin

    --dummy
    select count(1) into n_dummy from DIM_PARAM_VMPR_IT where SK_ACT_PARAMCODE < 0;
    if n_dummy = 0 then
        insert into DIM_PARAM_VMPR_IT
        (SK_ACT_PARAMCODE
          ,SK_PARAMCODE
          ,ID_PARAM_VMPR_IT
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,NAME_ITA
          ,ID_GRUPPO_MOLECOLE
          ,ID_GRUPPO_EFSA
          ,DAT_INI_VLD_TEC    )
        (select
                 -1,  -1, -1, '-1', 'ND', null, null, null, null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID_PARAM_VMPR_IT --chiave tecnica gestionale
                     from DIM_PARAM_VMPR_IT where dat_fin_vld_tec is null and SK_PARAMCODE > 0
                     minus
                     select ID_PARAM_VMPR_IT
                     from PARAM_VMPR_IT
                  )
    loop

    update DIM_PARAM_VMPR_IT
    set dat_fin_vld_tec = adesso
    where ID_PARAM_VMPR_IT = cnclzn.ID_PARAM_VMPR_IT
      and SK_PARAMCODE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID_PARAM_VMPR_IT
                                  ,TERM_CODE
                                  ,TERM_EXTENDED_NAME
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,NAME_ITA
                                  ,ID_GRUPPO_MOLECOLE
                                  ,ID_GRUPPO_EFSA    --tutti i campi della tebella del gestionale
                     from PARAM_VMPR_IT
                     minus
                     select ID_PARAM_VMPR_IT
                              ,TERM_CODE
                              ,TERM_EXTENDED_NAME
                              ,VALID_FROM
                              ,VALID_TO
                              ,NAME_ITA
                              ,ID_GRUPPO_MOLECOLE
                              ,ID_GRUPPO_EFSA
                     from DIM_PARAM_VMPR_IT where dat_fin_vld_tec is null and SK_PARAMCODE > 0
                  )
    loop

    update DIM_PARAM_VMPR_IT
    set dat_fin_vld_tec = adesso
    where ID_PARAM_VMPR_IT = mdfch.ID_PARAM_VMPR_IT
      and SK_PARAMCODE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


   IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_PARAMCODE into sk_ACT
                                 from DIM_PARAM_VMPR_IT
                                 where dat_fin_vld_tec = adesso and SK_PARAMCODE > 0
                                   and ID_PARAM_VMPR_IT  = mdfch.ID_PARAM_VMPR_IT;

                select stacco_sk(max(SK_PARAMCODE), 1)  into sk from DIM_PARAM_VMPR_IT;

                /*
            select
            ID_GRUPPO_MOLECOLA1, ID_GRUPPO_MOLECOLA2, ID_GRUPPO_MOLECOLA3, ID_GRUPPO_MOLECOLA4
            into GRUPPO_MOLECOLA1, GRUPPO_MOLECOLA2, GRUPPO_MOLECOLA3, GRUPPO_MOLECOLA4
            from TROVA_LIVELLI_PARAM
            where ID_GRUPPO_MOLECOLA = mdfch.ID_GRUPPO_MOLECOLE
                            */

            ELSE

              select stacco_sk(max(SK_PARAMCODE), 1)  into sk_ACT from DIM_PARAM_VMPR_IT;
              select stacco_sk(max(SK_PARAMCODE), 2)  into sk from DIM_PARAM_VMPR_IT;

/*
              --introduzione riga sulla PARAM_GRUPPI
              insert into PARAM_GRUPPI
              (ID_PARAM_VMPR_IT,            TERM_CODE,                      TERM_EXTENDED_NAME,         NAME_ITA,                    ID_GRUPPO_MOLECOLE,
              ID_I_LIVELLO, ID_II_LIVELLO, ID_III_LIVELLO, ID_IV_LIVELLO,
              ID_GRUPPO_EFSA)
     (select mdfch.ID_PARAM_VMPR_IT,  mdfch.TERM_CODE,         mdfch.TERM_EXTENDED_NAME,    mdfch.NAME_ITA,     mdfch.ID_GRUPPO_MOLECOLE,
            ID_GRUPPO_MOLECOLA1, ID_GRUPPO_MOLECOLA2, ID_GRUPPO_MOLECOLA3, ID_GRUPPO_MOLECOLA4,
            mdfch.ID_GRUPPO_EFSA
            from TROVA_LIVELLI_PARAM
            where ID_GRUPPO_MOLECOLA = mdfch.ID_GRUPPO_MOLECOLE);
*/
            END IF;


    insert into DIM_PARAM_VMPR_IT
    ( SK_ACT_PARAMCODE
      ,SK_PARAMCODE
      ,ID_PARAM_VMPR_IT
      ,TERM_CODE
      ,TERM_EXTENDED_NAME
      ,VALID_FROM
      ,VALID_TO
      ,NAME_ITA
      ,ID_GRUPPO_MOLECOLE
      ,ID_GRUPPO_EFSA
      ,DAT_INI_VLD_TEC   )
    values
    ( sk_act, sk
      ,mdfch.ID_PARAM_VMPR_IT
      ,mdfch.TERM_CODE
      ,mdfch.TERM_EXTENDED_NAME
      ,mdfch.VALID_FROM
      ,mdfch.VALID_TO
      ,mdfch.NAME_ITA
      ,mdfch.ID_GRUPPO_MOLECOLE
      ,mdfch.ID_GRUPPO_EFSA
      ,adesso );

                /*
            update PARAM_GRUPPI
            ID_I_LIVELLO = ID_GRUPPO_MOLECOLA1,
            ID_II_LIVELLO = ID_GRUPPO_MOLECOLA2,
            ID_III_LIVELLO = ID_GRUPPO_MOLECOLA3,
            ID_IV_LIVELLO = ID_GRUPPO_MOLECOLA4,
            where ID_PARAM_VMPR_IT = mdfch.ID_PARAM_VMPR_IT
                            */



    end loop;

    --controllo
    select (select count(1) num_r_ana from PARAM_VMPR_IT) - (select count(1) num_r_dim from DIM_PARAM_VMPR_IT where dat_fin_vld_tec is null and SK_PARAMCODE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PARAM_VMPR_IT'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PARAM_VMPR_IT'||' - '||sqlerrm,1,4000);
        raise;

end prc_DIM_PARAM_VMPR_IT;




procedure prc_DIM_PARAM_VMPR_IT_OLD (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_PARAM_VMPR_IT where SK_ACT_PARAMCODE < 0;
    if n_dummy = 0 then
        insert into DIM_PARAM_VMPR_IT
        (SK_ACT_PARAMCODE
          ,SK_PARAMCODE
          ,ID_PARAM_VMPR_IT
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,NAME_ITA
          ,ID_GRUPPO_MOLECOLE
          ,ID_GRUPPO_EFSA
          ,DAT_INI_VLD_TEC    )
        (select
                 -1,  -1, -1, '-1', 'ND', null, null, null, null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID_PARAM_VMPR_IT --chiave tecnica gestionale
                     from DIM_PARAM_VMPR_IT where dat_fin_vld_tec is null and SK_PARAMCODE > 0
                     minus
                     select ID_PARAM_VMPR_IT
                     from PARAM_VMPR_IT
                  )
    loop

    update DIM_PARAM_VMPR_IT
    set dat_fin_vld_tec = adesso
    where ID_PARAM_VMPR_IT = cnclzn.ID_PARAM_VMPR_IT
      and SK_PARAMCODE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID_PARAM_VMPR_IT
                                  ,TERM_CODE
                                  ,TERM_EXTENDED_NAME
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,NAME_ITA
                                  ,ID_GRUPPO_MOLECOLE
                                  ,ID_GRUPPO_EFSA    --tutti i campi della tebella del gestionale
                     from PARAM_VMPR_IT
                     minus
                     select ID_PARAM_VMPR_IT
                              ,TERM_CODE
                              ,TERM_EXTENDED_NAME
                              ,VALID_FROM
                              ,VALID_TO
                              ,NAME_ITA
                              ,ID_GRUPPO_MOLECOLE
                              ,ID_GRUPPO_EFSA
                     from DIM_PARAM_VMPR_IT where dat_fin_vld_tec is null and SK_PARAMCODE > 0
                  )
    loop

    update DIM_PARAM_VMPR_IT
    set dat_fin_vld_tec = adesso
    where ID_PARAM_VMPR_IT = mdfch.ID_PARAM_VMPR_IT
      and SK_PARAMCODE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


   IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_PARAMCODE into sk_ACT
                                 from DIM_PARAM_VMPR_IT
                                 where dat_fin_vld_tec = adesso and SK_PARAMCODE > 0
                                   and ID_PARAM_VMPR_IT  = mdfch.ID_PARAM_VMPR_IT;

                select stacco_sk(max(SK_PARAMCODE), 1)  into sk from DIM_PARAM_VMPR_IT;

            ELSE

              select stacco_sk(max(SK_PARAMCODE), 1)  into sk_ACT from DIM_PARAM_VMPR_IT;
              select stacco_sk(max(SK_PARAMCODE), 2)  into sk from DIM_PARAM_VMPR_IT;


            END IF;


    insert into DIM_PARAM_VMPR_IT
    ( SK_ACT_PARAMCODE
      ,SK_PARAMCODE
      ,ID_PARAM_VMPR_IT
      ,TERM_CODE
      ,TERM_EXTENDED_NAME
      ,VALID_FROM
      ,VALID_TO
      ,NAME_ITA
      ,ID_GRUPPO_MOLECOLE
      ,ID_GRUPPO_EFSA
      ,DAT_INI_VLD_TEC   )
    values
    ( sk_act, sk
      ,mdfch.ID_PARAM_VMPR_IT
      ,mdfch.TERM_CODE
      ,mdfch.TERM_EXTENDED_NAME
      ,mdfch.VALID_FROM
      ,mdfch.VALID_TO
      ,mdfch.NAME_ITA
      ,mdfch.ID_GRUPPO_MOLECOLE
      ,mdfch.ID_GRUPPO_EFSA
      ,adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from PARAM_VMPR_IT) - (select count(1) num_r_dim from DIM_PARAM_VMPR_IT where dat_fin_vld_tec is null and SK_PARAMCODE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PARAM_VMPR_IT'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PARAM_VMPR_IT'||' - '||sqlerrm,1,4000);
        raise;

end;


procedure prc_DIM_PARAM_VMPR_IT_test (Param in varchar2) is

GRUPPO_MOLECOLA1 varchar2(4000):=null;
GRUPPO_MOLECOLA2 varchar2(4000):=null;
GRUPPO_MOLECOLA3 varchar2(4000):=null;
GRUPPO_MOLECOLA4 varchar2(4000):=null;

  begin

    --dummy
    select count(1) into n_dummy from DIM_PARAM_VMPR_IT where SK_ACT_PARAMCODE < 0;
    if n_dummy = 0 then
        insert into DIM_PARAM_VMPR_IT
        (SK_ACT_PARAMCODE
          ,SK_PARAMCODE
          ,ID_PARAM_VMPR_IT
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,NAME_ITA
          ,ID_GRUPPO_MOLECOLE
          ,ID_GRUPPO_EFSA
          ,DAT_INI_VLD_TEC    )
        (select
                 -1,  -1, -1, '-1', 'ND', null, null, null, null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID_PARAM_VMPR_IT --chiave tecnica gestionale
                     from DIM_PARAM_VMPR_IT where dat_fin_vld_tec is null and SK_PARAMCODE > 0
                     minus
                     select ID_PARAM_VMPR_IT
                     from PARAM_VMPR_IT
                  )
    loop

    update DIM_PARAM_VMPR_IT
    set dat_fin_vld_tec = adesso
    where ID_PARAM_VMPR_IT = cnclzn.ID_PARAM_VMPR_IT
      and SK_PARAMCODE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID_PARAM_VMPR_IT
                                  ,TERM_CODE
                                  ,TERM_EXTENDED_NAME
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,NAME_ITA
                                  ,ID_GRUPPO_MOLECOLE
                                  ,ID_GRUPPO_EFSA    --tutti i campi della tebella del gestionale
                     from PARAM_VMPR_IT
                     minus
                     select ID_PARAM_VMPR_IT
                              ,TERM_CODE
                              ,TERM_EXTENDED_NAME
                              ,VALID_FROM
                              ,VALID_TO
                              ,NAME_ITA
                              ,ID_GRUPPO_MOLECOLE
                              ,ID_GRUPPO_EFSA
                     from DIM_PARAM_VMPR_IT where dat_fin_vld_tec is null and SK_PARAMCODE > 0
                  )
    loop

    update DIM_PARAM_VMPR_IT
    set dat_fin_vld_tec = adesso
    where ID_PARAM_VMPR_IT = mdfch.ID_PARAM_VMPR_IT
      and SK_PARAMCODE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


   IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_PARAMCODE into sk_ACT
                                 from DIM_PARAM_VMPR_IT
                                 where dat_fin_vld_tec = adesso and SK_PARAMCODE > 0
                                   and ID_PARAM_VMPR_IT  = mdfch.ID_PARAM_VMPR_IT;

                select stacco_sk(max(SK_PARAMCODE), 1)  into sk from DIM_PARAM_VMPR_IT;

                /*
            select
            ID_GRUPPO_MOLECOLA1, ID_GRUPPO_MOLECOLA2, ID_GRUPPO_MOLECOLA3, ID_GRUPPO_MOLECOLA4
            into GRUPPO_MOLECOLA1, GRUPPO_MOLECOLA2, GRUPPO_MOLECOLA3, GRUPPO_MOLECOLA4
            from TROVA_LIVELLI_PARAM
            where ID_GRUPPO_MOLECOLA = mdfch.ID_GRUPPO_MOLECOLE
                            */

            ELSE

              select stacco_sk(max(SK_PARAMCODE), 1)  into sk_ACT from DIM_PARAM_VMPR_IT;
              select stacco_sk(max(SK_PARAMCODE), 2)  into sk from DIM_PARAM_VMPR_IT;

/*
              --introduzione riga sulla PARAM_GRUPPI
              insert into PARAM_GRUPPI
              (ID_PARAM_VMPR_IT,            TERM_CODE,                      TERM_EXTENDED_NAME,         NAME_ITA,                    ID_GRUPPO_MOLECOLE,
              ID_I_LIVELLO, ID_II_LIVELLO, ID_III_LIVELLO, ID_IV_LIVELLO,
              ID_GRUPPO_EFSA)
     (select mdfch.ID_PARAM_VMPR_IT,  mdfch.TERM_CODE,         mdfch.TERM_EXTENDED_NAME,    mdfch.NAME_ITA,     mdfch.ID_GRUPPO_MOLECOLE,
            ID_GRUPPO_MOLECOLA1, ID_GRUPPO_MOLECOLA2, ID_GRUPPO_MOLECOLA3, ID_GRUPPO_MOLECOLA4,
            mdfch.ID_GRUPPO_EFSA
            from TROVA_LIVELLI_PARAM
            where ID_GRUPPO_MOLECOLA = mdfch.ID_GRUPPO_MOLECOLE);
*/
            END IF;


    insert into DIM_PARAM_VMPR_IT
    ( SK_ACT_PARAMCODE
      ,SK_PARAMCODE
      ,ID_PARAM_VMPR_IT
      ,TERM_CODE
      ,TERM_EXTENDED_NAME
      ,VALID_FROM
      ,VALID_TO
      ,NAME_ITA
      ,ID_GRUPPO_MOLECOLE
      ,ID_GRUPPO_EFSA
      ,DAT_INI_VLD_TEC   )
    values
    ( sk_act, sk
      ,mdfch.ID_PARAM_VMPR_IT
      ,mdfch.TERM_CODE
      ,mdfch.TERM_EXTENDED_NAME
      ,mdfch.VALID_FROM
      ,mdfch.VALID_TO
      ,mdfch.NAME_ITA
      ,mdfch.ID_GRUPPO_MOLECOLE
      ,mdfch.ID_GRUPPO_EFSA
      ,adesso );

                /*
            update PARAM_GRUPPI
            ID_I_LIVELLO = ID_GRUPPO_MOLECOLA1,
            ID_II_LIVELLO = ID_GRUPPO_MOLECOLA2,
            ID_III_LIVELLO = ID_GRUPPO_MOLECOLA3,
            ID_IV_LIVELLO = ID_GRUPPO_MOLECOLA4,
            where ID_PARAM_VMPR_IT = mdfch.ID_PARAM_VMPR_IT
                            */



    end loop;

    --controllo
    select (select count(1) num_r_ana from PARAM_VMPR_IT) - (select count(1) num_r_dim from DIM_PARAM_VMPR_IT where dat_fin_vld_tec is null and SK_PARAMCODE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PARAM_VMPR_IT'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PARAM_VMPR_IT'||' - '||sqlerrm,1,4000);
        raise;

end prc_DIM_PARAM_VMPR_IT_test;


procedure prc_DIM_POSNEG (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_POSNEG where SK_ACT_RESQUALVALUE < 0;
    if n_dummy = 0 then
         insert into DIM_POSNEG
        (SK_ACT_RESQUALVALUE
          ,SK_RESQUALVALUE
          ,ID
          ,TERM_CODE
          ,VALID_FROM
          ,VALID_TO
          ,DAT_INI_VLD_TEC
  )
        (select
                 -1,  -1, -1, 'ND', null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, 'ER', null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_POSNEG where dat_fin_vld_tec is null and SK_RESQUALVALUE > 0
                     minus
                     select ID
                     from POSNEG
                  )
    loop

    update DIM_POSNEG
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_RESQUALVALUE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select
                                ID
                                  ,TERM_CODE
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,LAST_UPDATE
                             --tutti i campi della tebella del gestionale
                     from POSNEG
                     minus
                     select   ID
                                  ,TERM_CODE
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,LAST_UPDATE
                     from DIM_POSNEG where dat_fin_vld_tec is null and SK_RESQUALVALUE > 0
                  )
    loop

    update DIM_POSNEG
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_RESQUALVALUE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


   IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_RESQUALVALUE into sk_ACT
                                 from DIM_POSNEG
                                 where dat_fin_vld_tec = adesso and SK_RESQUALVALUE > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_RESQUALVALUE), 1)  into sk from DIM_POSNEG;

            ELSE

              select stacco_sk(max(SK_RESQUALVALUE), 1)  into sk_ACT from DIM_POSNEG;
              select stacco_sk(max(SK_RESQUALVALUE), 2)  into sk from DIM_POSNEG;


            END IF;


    insert into DIM_POSNEG
    ( SK_ACT_RESQUALVALUE ,
       SK_RESQUALVALUE
      ,ID
      ,TERM_CODE
      ,VALID_FROM
      ,VALID_TO
      ,DAT_INI_VLD_TEC
      ,LAST_UPDATE
      )
    values
    ( sk_act, sk
      ,mdfch.ID
          ,mdfch.TERM_CODE
          ,mdfch.VALID_FROM
          ,mdfch.VALID_TO
      ,adesso
      ,MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from POSNEG) - (select count(1) num_r_dim from DIM_POSNEG where dat_fin_vld_tec is null and SK_RESQUALVALUE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_POSNEG'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_POSNEG'||' - '||sqlerrm,1,4000);
        raise;

end prc_DIM_POSNEG;


 procedure prc_dim_anlytyp (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_ANLYTYP where SK_ANMETHTYPE < 0;
    if n_dummy = 0 then
        insert into DIM_ANLYTYP
        (  SK_ACT_ANMETHTYPE,
               SK_ANMETHTYPE
              ,ID
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,VALID_FROM
              ,VALID_TO
              ,STATUS    )
        (select
                  -1, -1, -1, '-1', 'ND', null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_ANLYTYP where dat_fin_vld_tec is null and SK_ANMETHTYPE > 0
                     minus
                     select ID
                     from ANLYTYP
                  )
    loop

    update DIM_ANLYTYP
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_ANMETHTYPE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  ID
                                      ,trim(TERM_CODE) TERM_CODE
                                      ,trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME
                                      ,VALID_FROM
                                      ,VALID_TO
                                      ,trim(STATUS) STATUS
                                      ,TRIM(LAST_UPDATE) LAST_UPDATE    --tutti i campi della tebella del gestionale
                     from ANLYTYP
                     minus
                     select ID
                              ,TERM_CODE
                              ,TERM_EXTENDED_NAME
                              ,VALID_FROM
                              ,VALID_TO
                              ,STATUS
                              ,LAST_UPDATE
                     from DIM_ANLYTYP where dat_fin_vld_tec is null and SK_ANMETHTYPE > 0
                  )
    loop

    update DIM_ANLYTYP
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_ANMETHTYPE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


        IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_ANMETHTYPE into sk_ACT
                                 from DIM_ANLYTYP
                                 where dat_fin_vld_tec = adesso and SK_ANMETHTYPE > 0
                                   and ID  = mdfch.ID;

               select stacco_sk(max(SK_ANMETHTYPE), 1)  into sk from DIM_ANLYTYP;

            ELSE

              select stacco_sk(max(SK_ANMETHTYPE), 1)  into sk_ACT from DIM_ANLYTYP;
              select stacco_sk(max(SK_ANMETHTYPE), 2)  into sk from DIM_ANLYTYP;


            END IF;

    insert into DIM_ANLYTYP
    ( SK_ACT_ANMETHTYPE,
       SK_ANMETHTYPE
      ,ID
      ,TERM_CODE
      ,TERM_EXTENDED_NAME
      ,VALID_FROM
      ,VALID_TO
      ,STATUS
      ,DAT_INI_VLD_TEC
      ,LAST_UPDATE  )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, mdfch.STATUS, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from ANLYTYP) - (select count(1) num_r_dim from DIM_ANLYTYP where dat_fin_vld_tec is null and SK_ANMETHTYPE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_ANLYTYP'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_ANLYTYP'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_anlytyp;

procedure prc_dim_anlymd (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_ANLYMD where SK_ANMETHCODE < 0;
    if n_dummy = 0 then
        insert into DIM_ANLYMD
        (  SK_ACT_ANMETHCODE,
               SK_ANMETHCODE
              ,ID
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,VALID_FROM
              ,VALID_TO
              ,DAT_INI_VLD_TEC,TERM_SCOPE_NOTE  )
        (select
                 -1, -1, -1, '-1', 'ND', null, null, adesso,NULL
         from dual
         union
         select
                 -2, -2, -2, '-2', 'ER', null, null, adesso,NULL
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_ANLYMD where dat_fin_vld_tec is null and SK_ANMETHCODE > 0
                     minus
                     select ID
                     from ANLYMD
                  )
    loop

    update DIM_ANLYMD
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_ANMETHCODE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  ID
                                  ,trim(TERM_CODE) TERM_CODE
                                  ,trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,TRIM(LAST_UPDATE) LAST_UPDATE,TRIM(TERM_SCOPE_NOTE)TERM_SCOPE_NOTE --tutti i campi della tebella del gestionale
                     from ANLYMD
                     minus
                     select ID
                              ,TERM_CODE
                              ,TERM_EXTENDED_NAME
                              ,VALID_FROM
                              ,VALID_TO
                              ,LAST_UPDATE,TERM_SCOPE_NOTE
                     from DIM_ANLYMD where dat_fin_vld_tec is null and SK_ANMETHCODE > 0
                  )
    loop

    update DIM_ANLYMD
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_ANMETHCODE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


             IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_ANMETHCODE into sk_ACT
                                 from DIM_ANLYMD
                                 where dat_fin_vld_tec = adesso and SK_ANMETHCODE > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_ANMETHCODE), 1)  into sk from DIM_ANLYMD;

            ELSE

              select stacco_sk(max(SK_ANMETHCODE), 1)  into sk_ACT from DIM_ANLYMD;
              select stacco_sk(max(SK_ANMETHCODE), 2)  into sk from DIM_ANLYMD;


            END IF;



    insert into DIM_ANLYMD
    (  SK_ACT_ANMETHCODE,
           SK_ANMETHCODE
          ,ID
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,DAT_INI_VLD_TEC
          ,LAST_UPDATE ,TERM_SCOPE_NOTE )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, adesso, MDFCH.LAST_UPDATE ,MDFCH.TERM_SCOPE_NOTE);

    end loop;

    --controllo
    select (select count(1) num_r_ana from ANLYMD) - (select count(1) num_r_dim from DIM_ANLYMD where dat_fin_vld_tec is null and SK_ANMETHCODE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_ANLYMD'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_ANLYMD'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_anlymd;

procedure prc_dim_mdacc (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_MDACC where SK_ACCREDPROC < 0;
    if n_dummy = 0 then
        insert into DIM_MDACC
        ( SK_ACT_ACCREDPROC,
               SK_ACCREDPROC
              ,ID
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,DAT_INI_VLD_TEC
              ,valid_from
              ,valid_to  )
        (select
                  -1, -1, -1, '-1', 'ND', adesso, null, null
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', adesso, null, null
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_MDACC where dat_fin_vld_tec is null and SK_ACCREDPROC > 0
                     minus
                     select ID
                     from MDACC
                  )
    loop

    update DIM_MDACC
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_ACCREDPROC > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID
                                      ,trim(TERM_CODE)   TERM_CODE
                                      ,trim(TERM_EXTENDED_NAME)  TERM_EXTENDED_NAME
                                      ,valid_from
                                      ,valid_to
                                      ,TRIM(LAST_UPDATE) LAST_UPDATE--tutti i campi della tebella del gestionale
                     from MDACC
                     minus
                     select ID
                              ,TERM_CODE
                              ,TERM_EXTENDED_NAME
                              ,valid_from
                              ,valid_to
                              ,LAST_UPDATE
                     from DIM_MDACC where dat_fin_vld_tec is null and SK_ACCREDPROC > 0
                  )
    loop

    update DIM_MDACC
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_ACCREDPROC > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_ACCREDPROC into sk_ACT
                                 from DIM_MDACC
                                 where dat_fin_vld_tec = adesso and SK_ACCREDPROC > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_ACCREDPROC), 1)  into sk from DIM_MDACC;

            ELSE

               select stacco_sk(max(SK_ACCREDPROC), 1)  into sk_ACT from DIM_MDACC;
               select stacco_sk(max(SK_ACCREDPROC), 2)  into sk from DIM_MDACC;


            END IF;



    insert into DIM_MDACC
    ( SK_ACT_ACCREDPROC,
       SK_ACCREDPROC
      ,ID
      ,TERM_CODE
      ,TERM_EXTENDED_NAME
      ,valid_from
      ,valid_to
      ,DAT_INI_VLD_TEC
      ,LAST_UPDATE   )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from MDACC) - (select count(1) num_r_dim from DIM_MDACC where dat_fin_vld_tec is null and SK_ACCREDPROC > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_MDACC'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_MDACC'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_mdacc;

procedure prc_dim_unit (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_UNIT where SK_RESUNIT < 0;
    if n_dummy = 0 then
        insert into DIM_UNIT
        (   SK_ACT_RESUNIT,
        SK_RESUNIT ,
        ID
        ,TERM_CODE
        ,TERM_SHORT_NAME
        ,TERM_EXTENDED_NAME
        ,VALID_FROM
        ,STATUS
        ,VALID_TO
        ,DAT_INI_VLD_TEC    )
        (select
                 -1,  -1, -1, '-1', 'ND', 'ND', null, null, null,  adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', 'ER', null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_UNIT where dat_fin_vld_tec is null and SK_RESUNIT > 0
                     minus
                     select ID
                     from UNIT
                  )
    loop

    update DIM_UNIT
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_RESUNIT > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID ,trim(TERM_CODE) TERM_CODE ,trim(TERM_SHORT_NAME)  TERM_SHORT_NAME ,trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME,VALID_FROM ,STATUS ,VALID_TO, TRIM(LAST_UPDATE) LAST_UPDATE  --tutti i campi della tebella del gestionale
                     from UNIT
                     minus
                     select ID ,TERM_CODE ,TERM_SHORT_NAME  ,TERM_EXTENDED_NAME ,VALID_FROM ,STATUS ,VALID_TO, LAST_UPDATE
                     from DIM_UNIT where dat_fin_vld_tec is null and SK_RESUNIT > 0
                  )
    loop

    update DIM_UNIT
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_RESUNIT > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;



            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_RESUNIT into sk_ACT
                                 from DIM_UNIT
                                 where dat_fin_vld_tec = adesso and SK_RESUNIT > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_RESUNIT), 1)  into sk from DIM_UNIT;

            ELSE

                select stacco_sk(max(SK_RESUNIT), 1)  into sk_ACT from DIM_UNIT;
                select stacco_sk(max(SK_RESUNIT), 2)  into sk from DIM_UNIT;


            END IF;



    insert into DIM_UNIT
    (  SK_ACT_RESUNIT, SK_RESUNIT ,ID ,TERM_CODE ,TERM_SHORT_NAME  ,TERM_EXTENDED_NAME,VALID_FROM ,STATUS ,VALID_TO,  DAT_INI_VLD_TEC, LAST_UPDATE     )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_SHORT_NAME, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.STATUS, mdfch.valid_to, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from UNIT) - (select count(1) num_r_dim from DIM_UNIT where dat_fin_vld_tec is null and SK_RESUNIT > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_UNIT'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_UNIT'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_unit;


procedure prc_DIM_LABACC(Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_LABACC where SK_LABACC < 0;
    if n_dummy = 0 then

    /* TERM_CODE, TERM_EXTENDED_NAME, VALID_FROM, VALID_TO, STATUS,
PCR_TEC, DCR_TEC, PUP_TEC, DUP_TEC, LAST_UPDATE,
DAT_INI_VLD_TEC, DAT_FIN_VLD_TEC, SK_LABACC, SK_ACT_LABACC */


        insert into DIM_LABACC

        (   SK_LABACC,
            SK_ACT_LABACC,
            TERM_CODE,
            TERM_EXTENDED_NAME,
            VALID_FROM,
            VALID_TO,
            STATUS,
            PCR_TEC,
            DCR_TEC,
            PUP_TEC,
            DUP_TEC,
            DAT_INI_VLD_TEC,
            DAT_FIN_VLD_TEC
)
        (select
                 -1,  -1, '-1', 'ND', null, null, null, null, null, null, null, adesso,null
         from dual
         union
         select
                  -2, -2, '-2', 'ER', null, null, null, null, null, null,null,  adesso,null
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select TERM_CODE --chiave tecnica gestionale
                     from DIM_LABACC where dat_fin_vld_tec is null and SK_LABACC > 0
                     minus
                     select TERM_CODE
                     from LABACC
                  )
    loop

    update DIM_LABACC
    set dat_fin_vld_tec = adesso
    where TERM_CODE = cnclzn.TERM_CODE
      and SK_LABACC > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select trim(TERM_CODE) TERM_CODE ,trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME,VALID_FROM ,STATUS ,VALID_TO --tutti i campi della tebella del gestionale
                     from LABACC
                     minus
                     select TERM_CODE ,TERM_EXTENDED_NAME ,VALID_FROM ,STATUS ,VALID_TO
                     from DIM_LABACC where dat_fin_vld_tec is null and SK_LABACC > 0
                  )
    loop

    update DIM_LABACC
    set dat_fin_vld_tec = adesso
    where TERM_CODE = mdfch.TERM_CODE
      and SK_LABACC > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;



            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_LABACC into sk_ACT
                                 from DIM_LABACC
                                 where dat_fin_vld_tec = adesso and SK_LABACC > 0
                                   and TERM_CODE  = mdfch.TERM_CODE;

                select stacco_sk(max(SK_LABACC), 1)  into sk from DIM_LABACC;

            ELSE

                select stacco_sk(max(SK_LABACC), 1)  into sk_ACT from DIM_LABACC;
                select stacco_sk(max(SK_LABACC), 2)  into sk from DIM_LABACC;


            END IF;



    insert into DIM_LABACC
    (  SK_LABACC, TERM_CODE, TERM_EXTENDED_NAME, VALID_FROM, VALID_TO, STATUS,
    PCR_TEC, DCR_TEC, PUP_TEC, DUP_TEC,
    DAT_INI_VLD_TEC, DAT_FIN_VLD_TEC, SK_ACT_LABACC )
    values
    (  sk,  mdfch.TERM_CODE,  mdfch.TERM_EXTENDED_NAME, mdfch.valid_from,  mdfch.valid_to, mdfch.STATUS,
    null, null, null, null,
    adesso,NULL, sk_act);

    end loop;

    --controllo
    select (select count(1) num_r_ana from LABACC) - (select count(1) num_r_dim from DIM_LABACC where dat_fin_vld_tec is null and SK_LABACC > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_LABACC'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_LABACC'||' - '||sqlerrm,1,4000);
        raise;

end prc_DIM_LABACC;



procedure prc_DIM_YESNO(Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_YESNO where SK_YESNO < 0;
    if n_dummy = 0 then
        insert into DIM_YESNO

        (   SK_YESNO,
            SK_ACT_YESNO,
            TERM_CODE,
            TERM_EXTENDED_NAME,
            VALID_FROM,
            VALID_TO,
            STATUS,
            PCR_TEC,
            DCR_TEC,
            PUP_TEC,
            DUP_TEC,
            DAT_INI_VLD_TEC,
            DAT_FIN_VLD_TEC
)
        (select
                 -1,  -1, '-1', 'ND', null, null, null, null, null, null, null, adesso,null
         from dual
         union
         select
                  -2, -2, '-2', 'ER', null, null, null, null, null, null,null,  adesso,null
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select TERM_CODE --chiave tecnica gestionale
                     from DIM_YESNO where dat_fin_vld_tec is null and SK_YESNO > 0
                     minus
                     select TERM_CODE
                     from YESNO
                  )
    loop

    update DIM_YESNO
    set dat_fin_vld_tec = adesso
    where TERM_CODE = cnclzn.TERM_CODE
      and SK_YESNO > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select trim(TERM_CODE) TERM_CODE ,trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME,VALID_FROM ,STATUS ,VALID_TO --tutti i campi della tebella del gestionale
                     from YESNO
                     minus
                     select TERM_CODE ,TERM_EXTENDED_NAME ,VALID_FROM ,STATUS ,VALID_TO
                     from DIM_YESNO where dat_fin_vld_tec is null and SK_YESNO > 0
                  )
    loop

    update DIM_YESNO
    set dat_fin_vld_tec = adesso
    where TERM_CODE = mdfch.TERM_CODE
      and SK_YESNO > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;



            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_YESNO into sk_ACT
                                 from DIM_YESNO
                                 where dat_fin_vld_tec = adesso and SK_YESNO > 0
                                   and TERM_CODE  = mdfch.TERM_CODE;

                select stacco_sk(max(SK_YESNO), 1)  into sk from DIM_YESNO;

            ELSE

                select stacco_sk(max(SK_YESNO), 1)  into sk_ACT from DIM_YESNO;
                select stacco_sk(max(SK_YESNO), 2)  into sk from DIM_YESNO;


            END IF;



    insert into DIM_YESNO
    (  SK_YESNO, TERM_CODE, TERM_EXTENDED_NAME, VALID_FROM, VALID_TO, STATUS,
    PCR_TEC, DCR_TEC, PUP_TEC, DUP_TEC,
    DAT_INI_VLD_TEC, DAT_FIN_VLD_TEC, SK_ACT_YESNO )
    values
    (  sk,  mdfch.TERM_CODE,  mdfch.TERM_EXTENDED_NAME, mdfch.valid_from,  mdfch.valid_to, mdfch.STATUS,
    null, null, null, null,
    adesso,NULL, sk_act);

    end loop;

    --controllo
    select (select count(1) num_r_ana from YESNO) - (select count(1) num_r_dim from DIM_YESNO where dat_fin_vld_tec is null and SK_YESNO > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_YESNO'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_YESNO'||' - '||sqlerrm,1,4000);
        raise;

end prc_DIM_YESNO;


procedure PRC_DIM_PROGID (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_PROGID where SK_PROGID < 0;
    if n_dummy = 0 then
        insert into DIM_PROGID
        (  SK_ACT_PROGID,
               SK_PROGID
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,VALID_FROM
              ,VALID_TO
              ,dat_ini_vld_tec    )
        (select
                   -1, -1, '-1', 'ND', null, null, adesso
         from dual
         union
         select
                   -2, -2, '-2', 'ER', null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select TERM_CODE --chiave tecnica gestionale
                     from DIM_PROGID where dat_fin_vld_tec is null and SK_PROGID > 0
                     minus
                     select TERM_CODE
                     from PROGID
                  )
    loop

    update DIM_PROGID
    set dat_fin_vld_tec = adesso
    where TERM_CODE = cnclzn.TERM_CODE
      and SK_PROGID > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select trim(TERM_CODE) TERM_CODE
                                      ,trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME
                                      ,VALID_FROM
                                      ,VALID_TO
                                      ,LAST_UPDATE LAST_UPDATE    --tutti i campi della tebella del gestionale
                     from PROGID
                     minus
                     select
                              TERM_CODE
                              ,TERM_EXTENDED_NAME
                              ,VALID_FROM
                              ,VALID_TO
                              ,LAST_UPDATE
                     from DIM_PROGID where dat_fin_vld_tec is null and SK_PROGID > 0
                  )
    loop

    update DIM_PROGID
    set dat_fin_vld_tec = adesso
    where TERM_CODE = mdfch.TERM_CODE
      and SK_PROGID > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


        IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_PROGID into sk_ACT
                                 from DIM_PROGID
                                 where dat_fin_vld_tec = adesso and SK_PROGID > 0
                                   and TERM_CODE  = mdfch.TERM_CODE;

               select stacco_sk(max(SK_PROGID), 1)  into sk from DIM_PROGID;

            ELSE

              select stacco_sk(max(SK_PROGID), 1)  into sk_ACT from DIM_PROGID;
              select stacco_sk(max(SK_PROGID), 2)  into sk from DIM_PROGID;


            END IF;

    insert into DIM_PROGID
    ( SK_ACT_PROGID,
       SK_PROGID
      ,TERM_CODE
      ,TERM_EXTENDED_NAME
      ,LAST_UPDATE
      ,VALID_FROM
      ,VALID_TO
      ,DAT_INI_VLD_TEC
 )
    values
    ( sk_act, sk,  mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, MDFCH.LAST_UPDATE, mdfch.valid_from, mdfch.valid_to, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from PROGID) - (select count(1) num_r_dim from DIM_PROGID where dat_fin_vld_tec is null and SK_PROGID > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PROGID'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_PROGID'||' - '||sqlerrm,1,4000);
        raise;

end PRC_DIM_PROGID;


procedure PRC_DIM_ANLYREFMD (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_ANLYREFMD where SK_ANMETHREFCODE < 0;
    if n_dummy = 0 then
        insert into DIM_ANLYREFMD
        (  SK_ACT_ANMETHREFCODE,
               SK_ANMETHREFCODE
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,VALID_FROM
              ,VALID_TO
              ,dat_ini_vld_tec    )
        (select
                   -1, -1, '-1', 'ND', null, null, adesso
         from dual
         union
         select
                   -2, -2, '-2', 'ER', null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select TERM_CODE --chiave tecnica gestionale
                     from DIM_ANLYREFMD where dat_fin_vld_tec is null and SK_ANMETHREFCODE > 0
                     minus
                     select TERM_CODE
                     from ANLYREFMD
                  )
    loop

    update DIM_ANLYREFMD
    set dat_fin_vld_tec = adesso
    where TERM_CODE = cnclzn.TERM_CODE
      and SK_ANMETHREFCODE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  trim(TERM_CODE) TERM_CODE
                                      ,trim(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME
                                      ,VALID_FROM
                                      ,VALID_TO
                                      ,trim(STATUS) STATUS
                                      ,trim(LAST_UPDATE) LAST_UPDATE    --tutti i campi della tebella del gestionale
                     from ANLYREFMD
                     minus
                     select TERM_CODE
                              ,TERM_EXTENDED_NAME
                              ,VALID_FROM
                              ,VALID_TO
                              ,STATUS
                              ,LAST_UPDATE
                     from DIM_ANLYREFMD where dat_fin_vld_tec is null and SK_ANMETHREFCODE > 0
                  )
    loop

    update DIM_ANLYREFMD
    set dat_fin_vld_tec = adesso
    where TERM_CODE = mdfch.TERM_CODE
      and SK_ANMETHREFCODE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


        IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_ANMETHREFCODE into sk_ACT
                                 from DIM_ANLYREFMD
                                 where dat_fin_vld_tec = adesso and SK_ANMETHREFCODE > 0
                                   and TERM_CODE  = mdfch.TERM_CODE;

               select stacco_sk(max(SK_ANMETHREFCODE), 1)  into sk from DIM_ANLYREFMD;

            ELSE

              select stacco_sk(max(SK_ANMETHREFCODE), 1)  into sk_ACT from DIM_ANLYREFMD;
              select stacco_sk(max(SK_ANMETHREFCODE), 2)  into sk from DIM_ANLYREFMD;


            END IF;

    insert into DIM_ANLYREFMD
    ( SK_ACT_ANMETHREFCODE,
       SK_ANMETHREFCODE
      ,TERM_CODE
      ,TERM_EXTENDED_NAME
      ,VALID_FROM
      ,VALID_TO
      ,STATUS
      ,DAT_INI_VLD_TEC
      ,LAST_UPDATE  )
    values
    ( sk_act, sk,  mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, mdfch.STATUS, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from ANLYREFMD) - (select count(1) num_r_dim from DIM_ANLYREFMD where dat_fin_vld_tec is null and SK_ANMETHREFCODE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_ANLYREFMD'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_ANLYREFMD'||' - '||sqlerrm,1,4000);
        raise;

end PRC_DIM_ANLYREFMD;





 procedure prc_dim_exprres (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_EXPRRES where SK_EXPRRESTYPE < 0;
    if n_dummy = 0 then
        insert into DIM_EXPRRES
        (    SK_ACT_EXPRRESTYPE,
               SK_EXPRRESTYPE
              ,ID
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,VALID_FROM
              ,VALID_TO
              ,STATUS
              ,DAT_INI_VLD_TEC   )
        (select
                  -1, -1, -1, '-1', 'ND', null, null, null,  adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_EXPRRES where dat_fin_vld_tec is null and SK_EXPRRESTYPE > 0
                     minus
                     select ID
                     from EXPRRES
                  )
    loop

    update DIM_EXPRRES
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_EXPRRESTYPE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID
                                      ,trim(TERM_CODE)    TERM_CODE
                                      ,trim(TERM_EXTENDED_NAME)  TERM_EXTENDED_NAME
                                      ,VALID_FROM
                                      ,VALID_TO
                                      ,STATUS
                                      ,TRIM(LAST_UPDATE) LAST_UPDATE
                       from EXPRRES
                     minus
                     select  ID
                                      ,TERM_CODE
                                      ,TERM_EXTENDED_NAME
                                      ,VALID_FROM
                                      ,VALID_TO
                                      ,STATUS
                                      ,LAST_UPDATE
                     from DIM_EXPRRES where dat_fin_vld_tec is null and SK_EXPRRESTYPE > 0
                  )
    loop

    update DIM_EXPRRES
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_EXPRRESTYPE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;



            IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_EXPRRESTYPE into sk_ACT
                                 from DIM_EXPRRES
                                 where dat_fin_vld_tec = adesso and SK_EXPRRESTYPE > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_EXPRRESTYPE), 1)  into sk from DIM_EXPRRES;

            ELSE

               select stacco_sk(max(SK_EXPRRESTYPE), 1)  into sk_ACT from DIM_EXPRRES;
               select stacco_sk(max(SK_EXPRRESTYPE), 2)  into sk from DIM_EXPRRES;


            END IF;




    insert into DIM_EXPRRES
    ( SK_ACT_EXPRRESTYPE,
           SK_EXPRRESTYPE
          ,ID
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,STATUS
          ,DAT_INI_VLD_TEC
          ,LAST_UPDATE   )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, mdfch.STATUS, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from EXPRRES) - (select count(1) num_r_dim from DIM_EXPRRES where dat_fin_vld_tec is null and SK_EXPRRESTYPE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_EXPRRES'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_EXPRRES'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_exprres;

procedure prc_DIM_FARAREA (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_FARAREA where SK_FARAREA < 0;
    if n_dummy = 0 then
        insert into DIM_FARAREA
        (  SK_ACT_FARAREA,
               SK_FARAREA
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,VALID_FROM
              ,VALID_TO
              ,DAT_INI_VLD_TEC     )
        (select
                  -1, -1,  '-1', 'ND', null, null,  adesso
         from dual
         union
         select
                 -2, -2,  '-2', 'ER', null, null,  adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select TERM_CODE --chiave tecnica gestionale
                     from DIM_FARAREA where dat_fin_vld_tec is null and SK_FARAREA > 0
                     minus
                     select TERM_CODE
                     from FARAREA
                  )
    loop

    update DIM_FARAREA
    set dat_fin_vld_tec = adesso
    where TERM_CODE = cnclzn.TERM_CODE
      and SK_FARAREA > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  TRIM(TERM_CODE) TERM_CODE
                                      ,TRIM(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME
                                      ,VALID_FROM
                                      ,VALID_TO             --tutti i campi della tebella del gestionale
                                      ,TRIM(STATUS) STATUS
                                      ,TRIM(PARENT_CODE) PARENT_CODE
                                      ,TRIM(LAST_UPDATE) LAST_UPDATE
                     from FARAREA
                     minus
                     select  TERM_CODE
                                  ,TERM_EXTENDED_NAME
                                  ,VALID_FROM
                                  ,VALID_TO
                                   ,STATUS
                                   ,PARENT_CODE
                                   ,LAST_UPDATE
                     from DIM_FARAREA where dat_fin_vld_tec is null and SK_FARAREA > 0
                  )
    loop

    update DIM_FARAREA
    set dat_fin_vld_tec = adesso
    where TERM_CODE = mdfch.TERM_CODE
      and SK_FARAREA > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


         IF var_rows > 1 THEN

                        raise errore_update;

                    ELSIF var_rows = 1  THEN

                        select SK_ACT_FARAREA into sk_ACT
                                         from DIM_FARAREA
                                         where dat_fin_vld_tec = adesso and SK_FARAREA > 0
                                           and TERM_CODE  = mdfch.TERM_CODE;

                        --select SEQ_DIM_FARAREA.nextval into sk from dual;
                        select stacco_sk(max(SK_FARAREA), 1)  into sk from DIM_FARAREA;

                    ELSE

                        --select SEQ_DIM_FARAREA.nextval into sk_ACT from dual;
                        select stacco_sk(max(SK_FARAREA), 1)  into sk_ACT from DIM_FARAREA;
                        --select SEQ_DIM_FARAREA.nextval into sk from dual;
                        select stacco_sk(max(SK_FARAREA), 2)  into sk from DIM_FARAREA;


                    END IF;



    insert into DIM_FARAREA
    (     SK_ACT_FARAREA,
           SK_FARAREA
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
           ,STATUS
           ,PARENT_CODE
          ,DAT_INI_VLD_TEC
          ,LAST_UPDATE     )
    values
    ( sk_act, sk, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to,mdfch.status, mdfch.parent_code, adesso, mdfch.last_update );

    end loop;

    --controllo
    select (select count(1) num_r_ana from FARAREA) - (select count(1) num_r_dim from DIM_FARAREA where dat_fin_vld_tec is null and SK_FARAREA > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_FARAREA'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_FARAREA'||' - '||sqlerrm,1,4000);
        raise;

end prc_DIM_FARAREA;


 procedure prc_dim_valtyp (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_VALTYP where SK_RESTYPE < 0;
    if n_dummy = 0 then
        insert into DIM_VALTYP
        ( SK_ACT_RESTYPE,
           SK_RESTYPE
          ,ID
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,STATUS
          ,DAT_INI_VLD_TEC   )
        (select
                  -1, -1, -1, '-1', 'ND', null, null, null, adesso
         from dual
         union
         select
                  -2, -2, -2, '-2', 'ER', null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_VALTYP where dat_fin_vld_tec is null and SK_RESTYPE > 0
                     minus
                     select ID
                     from VALTYP
                  )
    loop

    update DIM_VALTYP
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_RESTYPE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID
                                  ,TRIM(TERM_CODE)     TERM_CODE
                                  ,TRIM(TERM_EXTENDED_NAME)  TERM_EXTENDED_NAME
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,TRIM(STATUS)    STATUS
                                  ,TRIM(LAST_UPDATE) LAST_UPDATE
                     from VALTYP
                     minus
                     select ID
                              ,TERM_CODE
                              ,TERM_EXTENDED_NAME
                              ,VALID_FROM
                              ,VALID_TO
                              ,STATUS
                              ,LAST_UPDATE
                     from DIM_VALTYP where dat_fin_vld_tec is null and SK_RESTYPE > 0
                  )
    loop

    update DIM_VALTYP
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_RESTYPE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


         IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_RESTYPE into sk_ACT
                                 from DIM_VALTYP
                                 where dat_fin_vld_tec = adesso and SK_RESTYPE > 0
                                   and ID  = mdfch.ID;

                select stacco_sk(max(SK_RESTYPE), 1)  into sk from DIM_VALTYP;

            ELSE

                select stacco_sk(max(SK_RESTYPE), 1)  into sk_ACT from DIM_VALTYP;
                select stacco_sk(max(SK_RESTYPE), 2)  into sk from DIM_VALTYP;


            END IF;


    insert into DIM_VALTYP
    ( SK_ACT_RESTYPE,
       SK_RESTYPE
      ,ID
      ,TERM_CODE
      ,TERM_EXTENDED_NAME
      ,VALID_FROM
      ,VALID_TO
      ,STATUS
      ,DAT_INI_VLD_TEC
      , LAST_UPDATE    )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, mdfch.status, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from VALTYP) - (select count(1) num_r_dim from DIM_VALTYP where dat_fin_vld_tec is null and SK_RESTYPE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_VALTYP'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_VALTYP'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_valtyp;

 procedure prc_dim_lmttyp (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_LMTTYP where SK_EVALLIMITTYPE < 0;
    if n_dummy = 0 then
        insert into DIM_LMTTYP
        ( SK_ACT_EVALLIMITTYPE,
           SK_EVALLIMITTYPE
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,STATUS
          ,DEF
          ,DAT_INI_VLD_TEC     )
        (select
                 -1, -1, '-1', 'ND', null, null, null, null, adesso
         from dual
         union
         select
                  -2, -2, '-2', 'ER', null, null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select TERM_CODE --chiave tecnica gestionale
                     from DIM_LMTTYP where dat_fin_vld_tec is null and  SK_EVALLIMITTYPE> 0
                     minus
                     select TERM_CODE
                     from LMTTYP
                  )
    loop

    update DIM_LMTTYP
    set dat_fin_vld_tec = adesso
    where TERM_CODE = cnclzn.TERM_CODE
      and SK_EVALLIMITTYPE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select
                                      trim(TERM_CODE)           TERM_CODE
                                      ,trim(TERM_EXTENDED_NAME)  TERM_EXTENDED_NAME
                                      ,VALID_FROM
                                      ,VALID_TO
                                      ,TRIM(LAST_UPDATE) LAST_UPDATE --tutti i campi della tebella del gestionale
                     from LMTTYP
                     minus
                     select
                                      TERM_CODE
                                      ,TERM_EXTENDED_NAME
                                      ,VALID_FROM
                                      ,VALID_TO
                                      ,LAST_UPDATE
                     from DIM_LMTTYP where dat_fin_vld_tec is null and SK_EVALLIMITTYPE > 0
                  )
    loop

    update DIM_LMTTYP
    set dat_fin_vld_tec = adesso
    where TERM_CODE = mdfch.TERM_CODE
      and SK_EVALLIMITTYPE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;

  IF var_rows > 1 THEN

                raise errore_update;

            ELSIF var_rows = 1  THEN

                select SK_ACT_EVALLIMITTYPE into sk_ACT
                                 from DIM_LMTTYP
                                 where dat_fin_vld_tec = adesso and SK_EVALLIMITTYPE > 0
                                   and TERM_CODE  = mdfch.TERM_CODE;

                select stacco_sk(max(SK_EVALLIMITTYPE), 1)  into sk from DIM_LMTTYP;

            ELSE

                select stacco_sk(max(SK_EVALLIMITTYPE), 1)  into sk_ACT from DIM_LMTTYP;
                select stacco_sk(max(SK_EVALLIMITTYPE), 2)  into sk from DIM_LMTTYP;


            END IF;




    insert into DIM_LMTTYP
    (  SK_ACT_EVALLIMITTYPE,
          SK_EVALLIMITTYPE,
          TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,DAT_INI_VLD_TEC
          ,LAST_UPDATE )
    values
    ( sk_act, sk, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from LMTTYP) - (select count(1) num_r_dim from DIM_LMTTYP where dat_fin_vld_tec is null and SK_EVALLIMITTYPE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_LMTTYP'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_LMTTYP'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_lmttyp;

 procedure prc_dim_reseval (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_RESEVAL where SK_EVALCODE < 0;
    if n_dummy = 0 then
        insert into DIM_RESEVAL
        (  SK_ACT_EVALCODE,
               SK_EVALCODE
              ,ID
              ,CODE
              ,NAME
              ,VALID_FROM
              ,VALID_TO
              ,STATUS
              ,FLG_EVALCODE
              ,DAT_INI_VLD_TEC    )
        (select
                 -1, -1, -1, '-1', 'ND', null, null, null, null, adesso
         from dual
         union
         select
                 -2, -2, -2, '-2', 'ER', null, null, null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_RESEVAL where dat_fin_vld_tec is null and SK_EVALCODE > 0
                     minus
                     select ID
                     from RESEVAL
                  )
    loop

    update DIM_RESEVAL
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_EVALCODE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select ID
                                  ,trim(CODE)         CODE
                                  ,trim(NAME)          NAME
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,trim(STATUS)       STATUS
                                  ,FLG_EVALCODE
                                  ,TRIM(LAST_UPDATE) LAST_UPDATE   --tutti i campi della tebella del gestionale
                     from RESEVAL
                     minus
                     select ID
                                  ,CODE
                                  ,NAME
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,STATUS
                                  ,FLG_EVALCODE
                                  ,LAST_UPDATE
                     from DIM_RESEVAL where dat_fin_vld_tec is null and SK_EVALCODE > 0
                  )
    loop

    update DIM_RESEVAL
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_EVALCODE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


         IF var_rows > 1 THEN

                        raise errore_update;

                    ELSIF var_rows = 1  THEN

                        select SK_ACT_EVALCODE into sk_ACT
                                         from DIM_RESEVAL
                                         where dat_fin_vld_tec = adesso and SK_EVALCODE > 0
                                           and ID  = mdfch.ID;

                        --select SEQ_DIM_RESEVAL.nextval into sk from dual;
                        select stacco_sk(max(SK_EVALCODE), 1)  into sk from DIM_RESEVAL;

                    ELSE

                        --select SEQ_DIM_RESEVAL.nextval into sk_ACT from dual;
                        select stacco_sk(max(SK_EVALCODE), 1)  into sk_ACT from DIM_RESEVAL;
                        --select SEQ_DIM_RESEVAL.nextval into sk from dual;
                        select stacco_sk(max(SK_EVALCODE), 2)  into sk from DIM_RESEVAL;


                    END IF;



    insert into DIM_RESEVAL
    ( SK_ACT_EVALCODE,
       SK_EVALCODE
      ,ID
      ,CODE
      ,NAME
      ,VALID_FROM
      ,VALID_TO
      ,STATUS
      ,FLG_EVALCODE
      ,DAT_INI_VLD_TEC
      ,LAST_UPDATE  )
    values
    ( sk_act, sk, mdfch.ID, mdfch.CODE, mdfch.NAME, mdfch.valid_from, mdfch.valid_to, mdfch.STATUS, mdfch.FLG_EVALCODE, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from RESEVAL) - (select count(1) num_r_dim from DIM_RESEVAL where dat_fin_vld_tec is null and SK_EVALCODE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_RESEVAL'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_RESEVAL'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_reseval;

procedure prc_DIM_CONCLUS(Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_CONCLUS where SK_EVALINFO_CONCLUSION < 0;
    if n_dummy = 0 then
        insert into DIM_CONCLUS
        (  SK_ACT_EVALINFO_CONCLUSION,
               SK_EVALINFO_CONCLUSION
              ,ID
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,VALID_FROM
              ,VALID_TO
              ,DAT_INI_VLD_TEC     )
        (select
                  -1, -1,-1, '-1', 'ND', null, null,   adesso
         from dual
         union
         select
                 -2, -2,-2, '-2', 'ER', null, null,  adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_CONCLUS where dat_fin_vld_tec is null and SK_EVALINFO_CONCLUSION > 0
                     minus
                     select ID
                     from CONCLUS
                  )
    loop

    update DIM_CONCLUS
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_EVALINFO_CONCLUSION > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  ID
                                      ,TERM_CODE
                                      ,TERM_EXTENDED_NAME
                                      ,VALID_FROM
                                      ,VALID_TO
                                      ,LAST_UPDATE             --tutti i campi della tebella del gestionale
                     from CONCLUS
                     minus
                     select ID
                                  ,TERM_CODE
                                  ,TERM_EXTENDED_NAME
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,LAST_UPDATE
                     from DIM_CONCLUS where dat_fin_vld_tec is null and SK_EVALINFO_CONCLUSION > 0
                  )
    loop

    update DIM_CONCLUS
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_EVALINFO_CONCLUSION > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


         IF var_rows > 1 THEN

                        raise errore_update;

                    ELSIF var_rows = 1  THEN

                        select SK_ACT_EVALINFO_CONCLUSION into sk_ACT
                                         from DIM_CONCLUS
                                         where dat_fin_vld_tec = adesso and SK_EVALINFO_CONCLUSION > 0
                                           and ID  = mdfch.ID;

                        --select SEQ_DIM_CONCLUS.nextval into sk from dual;
                        select stacco_sk(max(SK_EVALINFO_CONCLUSION), 1)  into sk from DIM_CONCLUS;

                    ELSE

                        --select SEQ_DIM_CONCLUS.nextval into sk_ACT from dual;
                        select stacco_sk(max(SK_EVALINFO_CONCLUSION), 1)  into sk_ACT from DIM_CONCLUS;
                        --select SEQ_DIM_CONCLUS.nextval into sk from dual;
                        select stacco_sk(max(SK_EVALINFO_CONCLUSION), 2)  into sk from DIM_CONCLUS;


                    END IF;



    insert into DIM_CONCLUS
    (     SK_ACT_EVALINFO_CONCLUSION,
           SK_EVALINFO_CONCLUSION
          ,ID
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,DAT_INI_VLD_TEC
          ,LAST_UPDATE     )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from CONCLUS) - (select count(1) num_r_dim from DIM_CONCLUS where dat_fin_vld_tec is null and SK_EVALINFO_CONCLUSION > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;
    
    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_CONCLUS'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_CONCLUS'||' - '||sqlerrm,1,4000);
        raise;

end prc_DIM_CONCLUS;

procedure prc_DIM_AETATE (Param in varchar2) is

  begin

    --dummy
    select count(1) into n_dummy from DIM_AETATE where SK_AETATE < 0;
    if n_dummy = 0 then
        insert into DIM_AETATE
        (  SK_ACT_AETATE,
               SK_AETATE
              ,ID
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,VALID_FROM
              ,VALID_TO
              ,DAT_INI_VLD_TEC     )
        (select
                  -1, -1,-1,  '-1', 'ND', null, null,  adesso
         from dual
         union
         select
                 -2, -2,-2,  '-2', 'ER', null, null,  adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_AETATE where dat_fin_vld_tec is null and SK_AETATE > 0
                     minus
                     select ID
                     from AETATE
                  )
    loop

    update DIM_AETATE
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_AETATE > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  ID
                                      ,TERM_CODE
                                      ,TERM_EXTENDED_NAME
                                      ,VALID_FROM
                                      ,VALID_TO             --tutti i campi della tebella del gestionale
                     from AETATE
                     minus
                     select ID
                                  ,TERM_CODE
                                  ,TERM_EXTENDED_NAME
                                  ,VALID_FROM
                                  ,VALID_TO
                     from DIM_AETATE where dat_fin_vld_tec is null and SK_AETATE > 0
                  )
    loop

    update DIM_AETATE
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_AETATE > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


         IF var_rows > 1 THEN

                        raise errore_update;

                    ELSIF var_rows = 1  THEN

                        select SK_ACT_AETATE into sk_ACT
                                         from DIM_AETATE
                                         where dat_fin_vld_tec = adesso and SK_AETATE > 0
                                           and ID  = mdfch.ID;

                        --select SEQ_DIM_AETATE.nextval into sk from dual;
                        select stacco_sk(max(SK_AETATE), 1)  into sk from DIM_AETATE;

                    ELSE

                        --select SEQ_DIM_AETATE.nextval into sk_ACT from dual;
                        select stacco_sk(max(SK_AETATE), 1)  into sk_ACT from DIM_AETATE;
                        --select SEQ_DIM_AETATE.nextval into sk from dual;
                        select stacco_sk(max(SK_AETATE), 2)  into sk from DIM_AETATE;


                    END IF;



    insert into DIM_AETATE
    (     SK_ACT_AETATE,
           SK_AETATE
          ,ID
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,DAT_INI_VLD_TEC     )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, adesso );

    end loop;

    --controllo
    select (select count(1) num_r_ana from AETATE) - (select count(1) num_r_dim from DIM_AETATE where dat_fin_vld_tec is null and SK_AETATE > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_CONCLUS'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_CONCLUS'||' - '||sqlerrm,1,4000);
        raise;

end prc_DIM_AETATE;

procedure prc_DIM_ACTION (Param in varchar2) is     -- 

  begin

    --dummy
    select count(1) into n_dummy from DIM_ACTION where SK_ACTION < 0;
    if n_dummy = 0 then
        insert into DIM_ACTION
        (  SK_ACT_ACTION,
               SK_ACTION
              ,ID
              ,TERM_CODE
              ,TERM_EXTENDED_NAME
              ,VALID_FROM
              ,VALID_TO
              ,DAT_INI_VLD_TEC     )
        (select
                  -1, -1, -1, '-1', 'ND', null, null,  adesso
         from dual
         union
         select
                 -2, -2,  -2, '-2', 'ER', null, null, adesso
         from dual
         );
    end if;


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_ACTION where dat_fin_vld_tec is null and SK_ACTION > 0
                     minus
                     select ID
                     from ACTION
                  )
    loop

    update DIM_ACTION
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_ACTION > 0
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    --modifiche
    for mdfch in (  select  ID
                                      ,TRIM(TERM_CODE) TERM_CODE
                                      ,TRIM(TERM_EXTENDED_NAME) TERM_EXTENDED_NAME
                                      ,VALID_FROM
                                      ,VALID_TO
                                      ,TRIM(LAST_UPDATE) LAST_UPDATE             --tutti i campi della tebella del gestionale
                     from ACTION
                     minus
                     select ID
                                  ,TERM_CODE
                                  ,TERM_EXTENDED_NAME
                                  ,VALID_FROM
                                  ,VALID_TO
                                  ,LAST_UPDATE
                     from DIM_ACTION where dat_fin_vld_tec is null and SK_ACTION > 0
                  )
    loop

    update DIM_ACTION
    set dat_fin_vld_tec = adesso
    where ID = mdfch.ID
      and SK_ACTION > 0
      --and cod_reg = mdfch.cod_reg
      and dat_fin_vld_tec is null;


      var_rows := SQL%ROWCOUNT;


         IF var_rows > 1 THEN

                        raise errore_update;

                    ELSIF var_rows = 1  THEN

                        select SK_ACT_ACTION into sk_ACT
                                         from DIM_ACTION
                                         where dat_fin_vld_tec = adesso and SK_ACTION > 0
                                           and ID  = mdfch.ID;

                        select stacco_sk(max(SK_ACTION), 1)  into sk from DIM_ACTION;

                    ELSE

                      select stacco_sk(max(SK_ACTION), 1)  into sk_ACT from DIM_ACTION;
                      select stacco_sk(max(SK_ACTION), 2)  into sk from DIM_ACTION;


                    END IF;



    insert into DIM_ACTION
    (     SK_ACT_ACTION,
           SK_ACTION
          ,ID
          ,TERM_CODE
          ,TERM_EXTENDED_NAME
          ,VALID_FROM
          ,VALID_TO
          ,DAT_INI_VLD_TEC
          ,LAST_UPDATE     )
    values
    ( sk_act, sk, mdfch.ID, mdfch.TERM_CODE, mdfch.TERM_EXTENDED_NAME, mdfch.valid_from, mdfch.valid_to, adesso, MDFCH.LAST_UPDATE );

    end loop;

    --controllo
    select (select count(1) num_r_ana from ACTION) - (select count(1) num_r_dim from DIM_ACTION where dat_fin_vld_tec is null and SK_ACTION > 0) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;

EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_ACTION'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_ACTION'||' - '||sqlerrm,1,4000);
        raise;

end prc_DIM_ACTION;
      -- 

procedure prc_dim_azienda (Param in varchar2) is
 max_sk integer;
 var_rows1 integer;
  begin





--
--  PKG_DWH_DET_PNR.PRC_INS_TAB_LOG_ETL(
--                  'LOG',
--                  null,
--                  'INIZIO DIM_AZIENDE_NEW',
--                  null,
--                  null--,
--                  --P_OUT_ERR      OUT VARCHAR2,
--                  --P_OUT_DESC_ERR OUT VARCHAR2
--                  );
--



    --dummy
    select count(1) into n_dummy from DIM_AZIENDA where SK_AZIENDA < 0;
    if n_dummy = 0 then
        insert into DIM_AZIENDA
        (  SK_ACT_AZIENDA,
             SK_AZIENDA
              ,ID
              ,PROVENIENZA
              ,APN_N_REGISTRAZIONE
              ,RAGSOC
              ,COM_COD_ISTAT
              ,VIA_PIAZ
              ,CITTA
              ,PROVINCIA
              ,LONGITUDINE
              ,LATITUDINE
              ,CAP
              ,PART_IVA
              ,COD_FSC
              ,DAT_INI_VLD_TEC       )
        (select
                 -1, -1, -1, 'ND', '-1', 'ND', null, null, null, null, null, null, null, null, null,  adesso
         from dual
         union
         select
                 -2, -2, -1, 'ER', '-2', 'ER', null, null, null,  null, null, null, null, null, null, adesso
         from dual
         );
    end if;

--  PKG_DWH_DET_PNR.PRC_INS_TAB_LOG_ETL(
--                  'LOG',
--                  null,
--                  'INIZIO REFRESH SNAPSHOT',
--                  null,
--                  null--,
--                  --P_OUT_ERR      OUT VARCHAR2,
--                  --P_OUT_DESC_ERR OUT VARCHAR2
--                  );


--
 /* DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.anagrafica_aziende'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);*/ -- 

--
--   PKG_DWH_DET_PNR.PRC_INS_TAB_LOG_ETL(
--                  'LOG',
--                  null,
--                  'FINE REFRESH SNAPSHOT',
--                  null,
--                  null--,
--                  --P_OUT_ERR      OUT VARCHAR2,
--                  --P_OUT_DESC_ERR OUT VARCHAR2
--                  );
--
--

 MERGE INTO DIM_AZIENDA TARGET
    USING ( select  ID,
                                        PROVENIENZA
                                      ,APN_N_REGISTRAZIONE
                                      ,RAGSOC
                                      ,COM_COD_ISTAT
                                      ,VIA_PIAZ
                                      ,CITTA
                                      ,PROVINCIA
                                      ,LONGITUDINE
                                      ,LATITUDINE
                                      ,CAP
                                      ,PART_IVA
                                      ,COD_FSC
                     from anagrafica_aziende
                     minus
                     select ID,
                               PROVENIENZA
                              ,APN_N_REGISTRAZIONE
                              ,RAGSOC
                              ,COM_COD_ISTAT
                              ,VIA_PIAZ
                              ,CITTA
                              ,PROVINCIA
                              ,LONGITUDINE
                              ,LATITUDINE
                              ,CAP
                              ,PART_IVA
                              ,COD_FSC
                     from DIM_AZIENDA ) SOURCE
    ON (  (SOURCE.APN_N_REGISTRAZIONE = TARGET.APN_N_REGISTRAZIONE)     AND     (SOURCE.PROVENIENZA = TARGET.PROVENIENZA)
          )
    WHEN MATCHED THEN
      UPDATE set

                                     target.ID = SOURCE.ID,
                                     --target.PROVENIENZA = SOURCE.PROVENIENZA,
                                     --target.APN_N_REGISTRAZIONE   = SOURCE.APN_N_REGISTRAZIONE,
                                      target.RAGSOC    = SOURCE.RAGSOC,
                                      target.COM_COD_ISTAT    = SOURCE.COM_COD_ISTAT,
                                      target.VIA_PIAZ       = SOURCE.VIA_PIAZ,
                                      target.CITTA          = SOURCE.CITTA,
                                      target.PROVINCIA   = SOURCE.PROVINCIA,
                                      target.LONGITUDINE   = SOURCE.LONGITUDINE,
                                      target.LATITUDINE     = SOURCE.LATITUDINE,
                                      target.CAP                 = SOURCE.CAP,
                                      target.PART_IVA       =  SOURCE.PART_IVA,
                                      target.COD_FSC       =   SOURCE.COD_FSC,
                                      target.DUP_TEC        =   adesso


   WHEN NOT MATCHED THEN
      INSERT values (
        DWH_EDW_FSALM.SEQ_DIM_AZIENDA.nextval
        ,SOURCE.PROVENIENZA
        ,SOURCE.APN_N_REGISTRAZIONE
        ,SOURCE.RAGSOC
        ,SOURCE.COM_COD_ISTAT
        ,SOURCE.VIA_PIAZ
        ,SOURCE.CITTA
        ,SOURCE.PROVINCIA
        ,SOURCE.LONGITUDINE
        ,SOURCE.LATITUDINE
        ,SOURCE.CAP
        ,SOURCE.PART_IVA
        ,SOURCE.COD_FSC
        ,TRUNC(SYSDATE)
        ,NULL
        ,DWH_EDW_FSALM.SEQ_DIM_AZIENDA.CURRVAL
        ,SOURCE.ID
        ,adesso  );
--CONTROLLO

select count(1) into differenza  from (
select ID,
PROVENIENZA
,APN_N_REGISTRAZIONE
from  ANAGRAFICA_AZIENDE
minus
select ID,
PROVENIENZA
,APN_N_REGISTRAZIONE
from DIM_AZIENDA);

    if (differenza) <> 0 then
    raise errore;
    end if;


select nvl(sum(doppi),0) into differenza  from (
select count(1) doppi,
PROVENIENZA
,APN_N_REGISTRAZIONE
from DIM_AZIENDA
where DAT_FIN_VLD_TEC is null
group by PROVENIENZA
,APN_N_REGISTRAZIONE
having count(1) > 1);

    if (differenza) <> 0 then
    raise errore;
    end if;


commit;
--
--    --controllo
--    select (select count(1) num_r_ana from ANAGRAFICA_AZIENDE) - (select count(1) num_r_dim from DIM_AZIENDA_NEW where dat_fin_vld_tec is null and SK_AZIENDA > 0
--                     and provenienza in ('Numero di Registrazione','Approval number')) into differenza from dual;
--
--    if (differenza) <> 0 then
--    raise errore;
--    end if;


--  PKG_DWH_DET_PNR.PRC_INS_TAB_LOG_ETL(
--                  'LOG',
--                  null,
--                  'FINE DIM_AZIENDE',
--                  null,
--                  null--,
--                  --P_OUT_ERR      OUT VARCHAR2,
--                  --P_OUT_DESC_ERR OUT VARCHAR2
--                  );


EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_AZIENDA'||' - '||'dovuto al controllo finale',1,4000);
        --raise;
          PKG_DWH_DET_FSALM.PRC_INS_TAB_LOG_ETL(
                  'ERRORE',
                  null,
                  desc_errore,
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_AZIENDA'||' - '||sqlerrm,1,4000);
        --raise;
                  PKG_DWH_DET_FSALM.PRC_INS_TAB_LOG_ETL(
                  'ERRORE',
                  null,
                  desc_errore,
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

end prc_dim_azienda;



procedure prc_dim_azienda_PLUS (Param in varchar2) is
max_sk integer;
var_rows1 integer;
  begin

    --dummy
    select count(1) into n_dummy from DIM_AZIENDA where SK_AZIENDA < 0;
    if n_dummy = 0 then
        insert into DIM_AZIENDA
        (  SK_ACT_AZIENDA,
             SK_AZIENDA
              ,ID
              ,PROVENIENZA
              ,APN_N_REGISTRAZIONE
              ,RAGSOC
              ,COM_COD_ISTAT
              ,VIA_PIAZ
              ,CITTA
              ,PROVINCIA
              ,LONGITUDINE
              ,LATITUDINE
              ,CAP
              ,PART_IVA
              ,COD_FSC
              ,DAT_INI_VLD_TEC       )
        (select
                 -1, -1, -1, 'ND', '-1', 'ND', null, null, null, null, null, null, null, null, null,  adesso
         from dual
         union
         select
                 -2, -2, -1, 'ER', '-2', 'ER', null, null, null,  null, null, null, null, null, null, adesso
         from dual
         );
    end if;

  DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.anagrafica_aziende'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);


    --cancellazioni
    for cnclzn in (  select ID --chiave tecnica gestionale
                     from DIM_AZIENDA where dat_fin_vld_tec is null and SK_AZIENDA > 0
                     and provenienza in ('Numero di Registrazione','Approval number')
                     minus
                     select ID
                     from ANAGRAFICA_AZIENDE

                  )
    loop

    update DIM_AZIENDA
    set dat_fin_vld_tec = adesso
    where ID = cnclzn.ID
      and SK_AZIENDA > 0
                     and provenienza in ('Numero di Registrazione','Approval number')
      --and cod_reg = cnclzn.cod_reg
      and dat_fin_vld_tec is null;

    end loop;

    select stacco_sk(max(SK_AZIENDA), 1)  into sk_ACT from DIM_AZIENDA;

    --modifiche
    for mdfch in (  select  ID,
                                        PROVENIENZA
                                      ,APN_N_REGISTRAZIONE
                                      ,RAGSOC
                                      ,COM_COD_ISTAT
                                      ,VIA_PIAZ
                                      ,CITTA
                                      ,PROVINCIA
                                      ,LONGITUDINE
                                      ,LATITUDINE
                                      ,CAP
                                      ,PART_IVA
                                      ,COD_FSC              --tutti i campi della tebella del gestionale
                     from ANAGRAFICA_AZIENDE
                     --order by PROVENIENZA desc
                     --where rownum < 100000
                     minus
                     select ID,
                               PROVENIENZA
                              ,APN_N_REGISTRAZIONE
                              ,RAGSOC
                              ,COM_COD_ISTAT
                              ,VIA_PIAZ
                              ,CITTA
                              ,PROVINCIA
                              ,LONGITUDINE
                              ,LATITUDINE
                              ,CAP
                              ,PART_IVA
                              ,COD_FSC
                     from DIM_AZIENDA where dat_fin_vld_tec is null and SK_AZIENDA > 0
                     and provenienza in ('Numero di Registrazione','Approval number')
                  )
    loop


      update DIM_AZIENDA
      set VIA_PIAZ = mdfch.VIA_PIAZ ,
          CITTA = mdfch.CITTA ,
          PROVINCIA = mdfch.PROVINCIA ,
          LONGITUDINE = mdfch.LONGITUDINE ,
          LATITUDINE = mdfch.LATITUDINE ,
          CAP = mdfch.CAP ,
          PART_IVA = mdfch.PART_IVA ,
          COD_FSC = mdfch.COD_FSC
      where ID = mdfch.ID
        and SK_AZIENDA > 0
        and provenienza in ('Numero di Registrazione','Approval number')
        --and cod_reg = mdfch.cod_reg
        --and dat_fin_vld_tec is null
        and APN_N_REGISTRAZIONE = mdfch.APN_N_REGISTRAZIONE
        and RAGSOC = mdfch.RAGSOC
        and COM_COD_ISTAT = mdfch.COM_COD_ISTAT;

      var_rows1 := SQL%ROWCOUNT;

      IF var_rows1 > 1 THEN

        raise errore_update;

      ELSIF var_rows1 = 1  THEN

        null;

      ELSE

        update DIM_AZIENDA
        set dat_fin_vld_tec = adesso
        where ID = mdfch.ID
          and SK_AZIENDA > 0
          and provenienza in ('Numero di Registrazione','Approval number')
          --and cod_reg = mdfch.cod_reg
          and dat_fin_vld_tec is null
          and ( APN_N_REGISTRAZIONE <> mdfch.APN_N_REGISTRAZIONE
          or RAGSOC <> mdfch.RAGSOC
          or COM_COD_ISTAT <> mdfch.COM_COD_ISTAT);


         var_rows := SQL%ROWCOUNT;


             IF var_rows > 1 THEN

                            raise errore_update;

             ELSIF var_rows = 1  THEN

                            select distinct SK_ACT_AZIENDA into sk_ACT
                                             from DIM_AZIENDA
                                             where dat_fin_vld_tec = adesso and SK_AZIENDA > 0
                                               and ID  = mdfch.ID
                                               and provenienza in ('Numero di Registrazione','Approval number')
                                               --and PROVENIENZA  = mdfch.PROVENIENZA
                                               ;


                        --select seq_dim_azienda.nextval into sk from dual;

                        --select stacco_sk(max(SK_AZIENDA), 1)  into sk from DIM_AZIENDA; max_sk
                        --select stacco_sk(max_sk, 1)  into sk from dual;
                        --max_sk := sk;
                        sk := max_sk;
                        max_sk := sk + 1;


             ELSE
                        --select seq_dim_azienda.nextval into sk_ACT from dual;
                        --select seq_dim_azienda.nextval into sk from dual;

                        --select stacco_sk(max(SK_AZIENDA), 1)  into sk_ACT from DIM_AZIENDA;
                        --select stacco_sk(max(SK_AZIENDA), 2)  into sk from DIM_AZIENDA;
                        --select stacco_sk(max_sk, 1)  into sk_ACT from dual;
                        --select stacco_sk(max_sk, 2)  into sk from dual;
                        --max_sk := sk;
                        sk_ACT := max_sk;
                        max_sk := sk + 1;
                        sk := max_sk;
                        max_sk := sk + 1;

             END IF;



        insert into DIM_AZIENDA
        (        SK_ACT_AZIENDA
                  ,SK_AZIENDA
                  ,ID
                  ,PROVENIENZA
                  ,APN_N_REGISTRAZIONE
                  ,RAGSOC
                  ,COM_COD_ISTAT
                  ,VIA_PIAZ
                  ,CITTA
                  ,PROVINCIA
                  ,LONGITUDINE
                  ,LATITUDINE
                  ,CAP
                  ,PART_IVA
                  ,COD_FSC
                  ,DAT_INI_VLD_TEC    )
        values
        ( sk_act, sk, mdfch.ID, mdfch.PROVENIENZA, mdfch.APN_N_REGISTRAZIONE, mdfch.RAGSOC, mdfch.COM_COD_ISTAT, mdfch.VIA_PIAZ,
        mdfch.CITTA, mdfch.PROVINCIA, mdfch.LONGITUDINE, mdfch.LATITUDINE, mdfch.CAP, mdfch.PART_IVA, mdfch.COD_FSC, adesso );

      END IF;

    end loop;

    --controllo
    select (select count(1) num_r_ana from ANAGRAFICA_AZIENDE) - (select count(1) num_r_dim from DIM_AZIENDA where dat_fin_vld_tec is null and SK_AZIENDA > 0
                     and provenienza in ('Numero di Registrazione','Approval number')) into differenza from dual;

    if (differenza) <> 0 then
    raise errore;
    end if;

    commit;


EXCEPTION
when errore then
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_AZIENDA'||' - '||'dovuto al controllo finale',1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_AZIENDA'||' - '||sqlerrm,1,4000);
        raise;

end prc_dim_azienda_PLUS;




PROCEDURE PRC_CAR_BK_REL_GENERICA(
                                  TMP_rel           IN OUT tab_indice_rel_generica ,  --- BLK da SELECT
                                  BK_rel            OUT tab_rel_generica ,            --- BLK output
                                  nome_dimensione   VARCHAR2
                                  ) IS

  K_rel_GEN  varchar2(1000);

BEGIN

K_rel_GEN := NULL;

BK_rel.DELETE; --- svuotamento struttura da riempimento elaborazione precedente

            -- Riempimento della matrice dati da Storicizzare
           for i in  1..TMP_rel.count
             loop

                 K_rel_GEN := TMP_rel(I).chiave_ricerca; --- CODICE UNIVOCO (UNICO IN BLK SELECT)

                      if BK_rel.exists(K_rel_GEN) then -- Controllo se la chiave naturale non sia gia presente

                              --cod_errore  := '100';
                              --cod_errore_ora := null;
                              --desc_errore_ora :='CHIAVE Surrogata Duplicata per la dimensione: '||nome_dimensione;
                              desc_errore := 'CHIAVE Surrogata Duplicata per la relazionale:  '||nome_dimensione||'  per il valore:'|| TMP_rel(I).chiave_ricerca;
                              raise errore;

                      end if;

                 BK_rel(K_rel_GEN).ID                  := TMP_rel(I).ID ;
                 --BK_DIM(K_dim_GEN).SK_STR              := TMP_DIM(I).SK_STR ;
                 BK_rel(K_rel_GEN).chiave_ricerca      := TMP_rel(I).chiave_ricerca ;

             end loop;

TMP_rel.delete; --- svuotamento struttura (select) da riempimento elaborazione precedente

EXCEPTION
when errore then
        desc_errore := substr(sqlerrm,1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento BULK della relazionale : '||nome_dimensione||' - '||sqlerrm,1,4000);
        raise;

END PRC_CAR_BK_rel_GENERICA ;


PROCEDURE PRC_CAR_BK_DIM_GENERICA(
                                  TMP_DIM           IN OUT tab_indice_dim_generica ,  --- BLK da SELECT
                                  BK_DIM            OUT tab_dim_generica ,            --- BLK output
                                  nome_dimensione   VARCHAR2
                                  ) IS

  K_dim_GEN  varchar2(1000);

BEGIN

K_dim_GEN := NULL;

BK_DIM.DELETE; --- svuotamento struttura da riempimento elaborazione precedente

            -- Riempimento della matrice dati da Storicizzare
           for i in  1..TMP_DIM.count
             loop

                 K_dim_GEN := TMP_DIM(I).chiave_ricerca; --- CODICE UNIVOCO (UNICO IN BLK SELECT)

                      if BK_DIM.exists(K_dim_GEN) then -- Controllo se la chiave naturale non sia gia presente

                              --cod_errore  := '100';
                              --cod_errore_ora := null;
                              --desc_errore_ora :='CHIAVE Surrogata Duplicata per la dimensione: '||nome_dimensione;
                              desc_errore := 'CHIAVE Surrogata Duplicata per la dimensione:  '||nome_dimensione||'  per il valore:'|| TMP_DIM(I).chiave_ricerca;
                              PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  desc_errore,
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );


                              raise errore;

                      end if;

                 BK_DIM(K_dim_GEN).SK                  := TMP_DIM(I).SK ;
                 BK_DIM(K_dim_GEN).SK_ACT              := TMP_DIM(I).SK_ACT ;
                 BK_DIM(K_dim_GEN).chiave_ricerca      := TMP_DIM(I).chiave_ricerca ;

             end loop;

TMP_DIM.delete; --- svuotamento struttura (select) da riempimento elaborazione precedente

EXCEPTION
when errore then
        desc_errore := substr(sqlerrm,1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr('ERRORE Caricamento BULK della dimensione : '||nome_dimensione||' - '||sqlerrm,1,4000);
        raise;

END PRC_CAR_BK_DIM_GENERICA ;



PROCEDURE CARICAMENTO_BULK_REL(Param in varchar2)   is

      desc_rel varchar2(200);

      BEGIN

          /*PKG_FRM_TRA_WFW.PRC_LOG_ERR('BRE',
                                      p_id_flu,
                                      'PKG_FT_BRE_DET_ANM_LD.PRC_FT_BRE_DET_ANM',
                                      '2 - PROCEDURE CARICAMENTO_BULK',
                                      sysdate,
                                      null,
                                      null,
                                      null,
                                      null,
                                      null,
                                      null);
          commit;*/


          desc_rel := 'REL_EVALCODE_SMPASSESS';

          SELECT a.id, a.EVALCODE||' - '||a.SAMPTKASSESS
          BULK COLLECT INTO tmp_rel_GEN
          FROM REL_EVALCODE_SMPASSESS a
          ;

          PRC_CAR_BK_REL_GENERICA (  tmp_rel_GEN , BK_dim_REL_EVALCODE_SMPASSESS, desc_rel  );

/*
          desc_dim := 'DIM_TIPOCAMPO';

          SELECT a.sk_tipocampo, a.term_code||' - '||to_char(b.sampdate,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_TIPOCAMPO a, SN_vld_delta_SAMPDATE b
          where b.sampdate between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_dim_TIPOCAMPO, desc_dim  );

*/--
--





      exception
        when others then
              --cod_errore      := '104';
              desc_errore     := substr('ERRORE Caricamento della dimensione : '||desc_rel||' - '||sqlerrm,1,4000);
              --'ERRORE Caricamento TABELLE Bulk dimensione: '||desc_dim;
              --cod_errore_ora  := sqlcode;
              --desc_errore_ora := substr(sqlerrm,1,4000);
              raise;

END CARICAMENTO_BULK_REL;


/*Procedura di caricamento in memoria di tutte le BULK dalle dimensioni*/
PROCEDURE CARICAMENTO_BULK_SAMPDATE(Param in varchar2)   is

      desc_dim varchar2(200);

      BEGIN

          /*PKG_FRM_TRA_WFW.PRC_LOG_ERR('BRE',
                                      p_id_flu,
                                      'PKG_FT_BRE_DET_ANM_LD.PRC_FT_BRE_DET_ANM',
                                      '2 - PROCEDURE CARICAMENTO_BULK',
                                      sysdate,
                                      null,
                                      null,
                                      null,
                                      null,
                                      null,
                                      null);
          commit;*/


          desc_dim := 'DIM_REG';

          SELECT a.sk_reg, a.sk_act_reg, a.cod_reg||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_REG a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;

          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_dim_REG, desc_dim  );


          SELECT a.sk_reg, a.sk_act_reg, a.id_regione--||' - '||to_char(b.sampdate,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_REG a--, SN_vld_delta_SAMPDATE b
          where
          --b.sampdate between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            --and
            a.dat_fin_vld_tec is null
            ;

          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_dim_REG_ID, desc_dim  );



          desc_dim := 'DIM_TIPOCAMPO';

          SELECT a.sk_tipocampo, a.sk_act_tipocampo, a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_TIPOCAMPO a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_dim_TIPOCAMPO, desc_dim  );



           desc_dim := 'DIM_ANLYMD';

          SELECT a.SK_ANMETHCODE, a.SK_ACT_ANMETHCODE, a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANLYMD a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_ANLYMD, desc_dim  );



          desc_dim := 'DIM_ANLYTYP';

          SELECT a.SK_ANMETHTYPE, a.SK_ACT_ANMETHTYPE, a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANLYTYP a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_ANLYTYP, desc_dim  );


           desc_dim := 'DIM_ASL';

          SELECT a.SK_ASL_SAMPORG, a.SK_ACT_ASL, a.cod_asl||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ASL a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.DAT_INI_VLD and nvl(a.DAT_END_VLD, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;



          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_ASL, desc_dim  );


           desc_dim := 'DIM_CONCLUS';

          SELECT a.SK_EVALINFO_CONCLUSION, a.SK_ACT_EVALINFO_CONCLUSION, a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_CONCLUS a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_CONCLUS, desc_dim  );


            desc_dim := 'DIM_COUNTRY';

          SELECT a.SK_ORIGCOUNTRY, a.SK_ACT_ORIGCOUNTRY, a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_COUNTRY a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_COUNTRY, desc_dim  );



            desc_dim := 'DIM_EXPRRES';

          SELECT a.SK_EXPRRESTYPE, a.SK_ACT_EXPRRESTYPE, a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_EXPRRES a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_EXPRRES, desc_dim  );


          desc_dim := 'DIM_LABORATORI';

          SELECT a.SK_LABANALISI, a.SK_ACT_LABANALISI, a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_LABORATORI a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_LABORATORI, desc_dim  );



          desc_dim := 'DIM_LEGREF';

          SELECT a.SK_LEGREF, a.SK_ACT_LEGREF, a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_LEGREF a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_LEGREF, desc_dim  );


            desc_dim := 'DIM_LMTTYP';

          SELECT a.SK_EVALLIMITTYPE, a.SK_ACT_EVALLIMITTYPE, a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_LMTTYP a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_LMTTYP, desc_dim  );


          desc_dim := 'DIM_MDACC';

          SELECT a.SK_ACCREDPROC, a.SK_ACT_ACCREDPROC , a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_MDACC a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_MDACC, desc_dim  );


           desc_dim := 'DIM_MODALLEV';

          SELECT a.SK_MODALITALLEVAMENTO, a.SK_ACT_MODALITALLEVAMENTO    , a.CODICE||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_MODALLEV a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_MODALLEV, desc_dim  );


          desc_dim := 'DIM_MTX_VMPR_IT';

          SELECT a.SK_SAMPMATCODE, a.SK_ACT_SAMPMATCODE, a.CODE||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_MTX_VMPR_IT a, SN_vld_delta_SAMPDATE b
          where
          --MODIFICA DEL 10/04/2019
          --b.sampdate between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
          a.SK_SAMPMATCODE > 0
          --MODIFICA DEL 10/04/2019
          and a.dat_fin_vld_tec is null
          AND A.VALID_TO IS NULL;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_MTX_VMPR_IT, desc_dim  );


            desc_dim := 'DIM_MTXTYP';

          SELECT a.SK_SAMPMATTYPE, a.SK_ACT_SAMPMATTYPE, a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_MTXTYP a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_MTXTYP, desc_dim  );


            desc_dim := 'DIM_NONIDON';

          SELECT a.SK_MOTIVONONIDONEO, a.SK_ACT_MOTIVONONIDONEO, a.CODICE||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_NONIDON a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_NONIDON, desc_dim  );
/*

          desc_dim := 'DIM_PARAM_VMPR_IT';

          SELECT a.SK_PARAMCODE, a.SK_ACT_PARAMCODE, a.term_code||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_PARAM_VMPR_IT a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PARAM_VMPR_IT, desc_dim  );

*/
           desc_dim := 'DIM_PARAMTYP';

          SELECT a.SK_PARAMTYPE, a.SK_ACT_PARAMTYPE, a.TERM_CODE||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_PARAMTYP a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PARAMTYP, desc_dim  );


            desc_dim := 'DIM_POSNEG';

          SELECT a.SK_RESQUALVALUE, a.SK_ACT_RESQUALVALUE, a.TERM_CODE||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_POSNEG a, SN_vld_delta_SAMPDATE b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_POSNEG, desc_dim  );


           desc_dim := 'DIM_PROGTYP';

          SELECT a.SK_PROGTYP, a.SK_ACT_PROGTYP, a.TERM_CODE||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_PROGTYP a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PROGTYP, desc_dim  );


          desc_dim := 'DIM_RESEVAL';

          SELECT a.SK_EVALCODE, a.SK_ACT_EVALCODE, a.CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_RESEVAL a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_RESEVAL, desc_dim  );


           desc_dim := 'DIM_SAMPLR';

          SELECT a.SK_SAMPLR, a.SK_ACT_SAMPLR, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_SAMPLR a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_SAMPLR, desc_dim  );


          desc_dim := 'DIM_SAMPMD';

          SELECT a.SK_SAMPMD, a.SK_ACT_SAMPMD, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_SAMPMD a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_SAMPMD, desc_dim  );


          desc_dim := 'DIM_SAMPSTR';

          SELECT a.SK_SAMPSTR, a.SK_ACT_SAMPSTR, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_SAMPSTR a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_SAMPSTR, desc_dim  );


          desc_dim := 'DIM_SAMPUNTYP';

          SELECT a.SK_SAMPUNTYP, a.SK_ACT_SAMPUNTYP, a.SAMPUNITTYPE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_SAMPUNTYP a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_SAMPUNTYP, desc_dim  );


          desc_dim := 'DIM_SMPNT_ITA';

          SELECT a.SK_SMPNT_ITA, a.SK_ACT_SMPNT_ITA, a.CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_SMPNT_ITA a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_SMPNT_ITA, desc_dim  );


          desc_dim := 'DIM_TIPOCAMPO';

          SELECT a.SK_TIPOCAMPO, a.SK_ACT_TIPOCAMPO, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_TIPOCAMPO a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_TIPOCAMPO, desc_dim  );


          desc_dim := 'DIM_UNIT';

          SELECT a.SK_RESUNIT, a.SK_ACT_RESUNIT, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_UNIT a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_UNIT, desc_dim  );


          desc_dim := 'DIM_VALTYP';

          SELECT a.SK_RESTYPE, a.SK_ACT_RESTYPE, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_VALTYP a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_VALTYP, desc_dim  );


          desc_dim := 'DIM_AETATE';

          SELECT a.SK_AETATE, a.SK_ACT_AETATE, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_AETATE a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_AETATE, desc_dim  );


           desc_dim := 'DIM_ACTION';


          SELECT a.SK_ACTION, a.SK_ACT_ACTION, a.ID||' - '||to_char(b.samp_date,'yyyymmdd')                 -- 
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ACTION a, SN_vld_delta_sampdate b
          where
          b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;

          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_ACTION, desc_dim  );

          --     GRANT SELECT ON DIM_TEM TO EDW_DWH_FSALM per la DIM_TEM


              desc_dim := 'DIM_TEM';

          SELECT distinct a.SK_TEM, NULL, to_char(nvl(a.DAT,to_date('01011900','ddmmyyyy')),'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_TEM a
          where a.COD_LVL = 6;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_TEM, desc_dim  );




          desc_dim := 'DIM_AZIENDA';

          SELECT a.SK_AZIENDA, a.SK_ACT_AZIENDA, a.APN_N_REGISTRAZIONE||' - '||a.provenienza--||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_AZIENDA a--, SN_vld_delta_samp_date b
        --  where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            WHERE a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_AZIENDA, desc_dim  );

          desc_dim := 'DIM_ANAGRAFICA_ANIMAL_AGE';

          SELECT a.SK_ANIMAL_AGE, a.SK_ACT_ANIMAL_AGE, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_ANIMAL_AGE a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_ANIMAL_AGE, desc_dim  );



          desc_dim := 'DIM_ANAGRAFICA_REPORT';

          SELECT a.SK_ANMATCODE_BUILDING, a.SK_ACT_ANMATCODE_BUILDING, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_REPORT a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_REPORT, desc_dim  );


          desc_dim := 'DIM_ANLYREFMD';

          SELECT a.SK_ANMETHREFCODE, a.SK_ACT_ANMETHREFCODE, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANLYREFMD a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_ANLYREFMD, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_COOKEXT';

          SELECT a.SK_SAMPMATCODE_COOKEXT, a.SK_ACT_SAMPMATCODE_COOKEXT, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_COOKEXT a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_COOKEXT, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_GENDER';

          SELECT a.SK_SAMPMATCODE_GENDER, a.SK_ACT_SAMPMATCODE_GENDER, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_GENDER a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_GENDER, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_GEN';

          SELECT a.SK_SAMPMATCODE_GEN, a.SK_ACT_SAMPMATCODE_GEN, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_GEN a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_GEN, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_INGRED';

          SELECT a.SK_INGRED, a.SK_ACT_INGRED, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_INGRED a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_INGRED, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_LEGIS';

          SELECT a.SK_LEGIS, a.SK_ACT_LEGIS, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_LEGIS a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_LEGIS, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_PACKFORMAT';

          SELECT a.SK_PACKFORMAT, a.SK_ACT_PACKFORMAT, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_PACKFORMAT a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PACKFORMAT, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_PACKMAT';

          SELECT a.SK_PACKMAT, a.SK_ACT_PACKMAT, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_PACKMAT a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PACKMAT, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_PART_NATURE';

          SELECT a.SK_PART_NATURE, a.SK_ACT_PART_NATURE, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_PART_NATURE a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PART_NATURE, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_PARTCONSUMED';

          SELECT a.SK_PARTCONSUMED, a.SK_ACT_PARTCONSUMED, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_PARTCONSUMED a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PARTCONSUMED, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_PLACE';

          SELECT a.SK_PLACE, a.SK_ACT_PLACE, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_PLACE a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PLACE, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_PROCES';

          SELECT a.SK_PROCES, a.SK_ACT_PROCES, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_PROCES a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PROCES, desc_dim  );


          desc_dim := 'DIM_ANAG_PRODUCTION_METHOD';

          SELECT a.SK_PRODUCTION_METHOD, a.SK_ACT_PRODUCTION_METHOD, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAG_PRODUCTION_METHOD a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PRODUCTION_METHOD, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_SOURCE';

          SELECT a.SK_SOURCE, a.SK_ACT_SOURCE, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_SOURCE a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_SOURCE, desc_dim  );

            desc_dim := 'DIM_ANAGRAFICA_SOURCE_COM';

          SELECT a.SK_SOURCE_COM, a.SK_ACT_SOURCE_COM, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_SOURCE_COM a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_SOURCE_COM, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_USE';

          SELECT a.SK_USE, a.SK_ACT_USE, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_USE a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_USE, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_QUALINFO';

          SELECT a.SK_QUALINFO, a.SK_ACT_QUALINFO, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_QUALINFO a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_QUALINFO, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_REPRODUCTIVE';

          SELECT a.SK_REPRODUCTIVE, a.SK_ACT_REPRODUCTIVE, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_REPRODUCTIVE a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_REPRODUCTIVE, desc_dim  );


          desc_dim := 'DIM_YESNO';

          SELECT a.SK_YESNO, a.SK_ACT_YESNO, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_YESNO a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_YESNO, desc_dim  );


          desc_dim := 'DIM_FARAREA';

          SELECT a.SK_FARAREA, a.SK_ACT_FARAREA, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_FARAREA a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_FARAREA, desc_dim  );


          desc_dim := 'DIM_ANAGRAFICA_TARGET';

          SELECT a.SK_TARGET, a.SK_ACT_TARGET, a.TERMCODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_ANAGRAFICA_TARGET a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_TARGET, desc_dim  );


          desc_dim := 'DIM_PROGID';

          SELECT a.SK_PROGID, a.SK_ACT_PROGID, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_PROGID a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PROGID, desc_dim  );

            desc_dim := 'DIM_LABACC';

          SELECT a.SK_LABACC, a.SK_ACT_LABACC, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_LABACC a, SN_vld_delta_sampdate b
          where b.samp_date between a.valid_from and nvl(a.valid_to, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_LABACC, desc_dim  );


           desc_dim := 'DIM_PARAM';

          SELECT a.SK_PARAM, a.SK_ACT_PARAM, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_PARAM a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null
            AND (a.PROVENIENZA IS NULL OR a.PROVENIENZA='PARAM') ;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PARAM, desc_dim  );

          desc_dim := 'DIM_PARAM_ITA';

          SELECT a.SK_PARAM, a.SK_ACT_PARAM, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_PARAM a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null
            AND A.PROVENIENZA = 'ITA';


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PARAM_ITA, desc_dim  );


          desc_dim := 'DIM_PARAM_VMPR';

          SELECT a.SK_PARAM, a.SK_ACT_PARAM, a.TERM_CODE ||' - '||to_char(b.samp_date,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_PARAM a, SN_vld_delta_sampdate b
          where b.samp_date between a.validfrom and nvl(a.validto, to_date('31124000','ddmmyyyy'))
            and a.dat_fin_vld_tec is null
            AND A.PROVENIENZA = 'VMPR';


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_DIM_PARAM_VMPR, desc_dim  );


      exception
        when others then
              --cod_errore      := '104';
              desc_errore     := substr('ERRORE Caricamento della dimensione : '||desc_dim||' - '||sqlerrm,1,4000);
              --'ERRORE Caricamento TABELLE Bulk dimensione: '||desc_dim;
              --cod_errore_ora  := sqlcode;
              --desc_errore_ora := substr(sqlerrm,1,4000);
              raise;

END CARICAMENTO_BULK_sampdate;

PROCEDURE CARICAMENTO_BULK_DAT_UPLOAD(Param in varchar2)   is

      desc_dim varchar2(200);

      BEGIN

          /*PKG_FRM_TRA_WFW.PRC_LOG_ERR('BRE',
                                      p_id_flu,
                                      'PKG_FT_BRE_DET_ANM_LD.PRC_FT_BRE_DET_ANM',
                                      '2 - PROCEDURE CARICAMENTO_BULK',
                                      sysdate,
                                      null,
                                      null,
                                      null,
                                      null,
                                      null,
                                      null);
          commit;*/


          desc_dim := 'DIM_REG';

          SELECT a.sk_reg, a.sk_act_reg, a.cod_reg||' - '||to_char(b.dat_upload,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_REG a, SN_vld_delta_DAT_UPLOAD b
          where b.DAT_UPLOAD between a.dat_ini_vld_tec and nvl(a.dat_fin_vld_tec, to_date('31124000','ddmmyyyy'))
            ;

          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_dim_REG, desc_dim  );

/*
          desc_dim := 'DIM_TIPOCAMPO';

          SELECT a.sk_tipocampo, a.term_code||' - '||to_char(b.dat_upload,'yyyymmdd')
          BULK COLLECT INTO tmp_dim_GEN
          FROM DIM_TIPOCAMPO a, SN_vld_delta_DAT_UPLOAD b
          where b.DAT_UPLOAD between a.dat_ini_vld_tec and nvl(a.dat_fin_vld_tec, to_date('31124000','ddmmyyyy'))
            ;


          PRC_CAR_BK_DIM_GENERICA (  tmp_dim_GEN , BK_dim_TIPOCAMPO, desc_dim  );

*/--
--





      exception
        when others then
              --cod_errore      := '104';
              desc_errore     := substr('ERRORE Caricamento della dimensione : '||desc_dim||' - '||sqlerrm,1,4000);
              --'ERRORE Caricamento TABELLE Bulk dimensione: '||desc_dim;
              --cod_errore_ora  := sqlcode;
              --desc_errore_ora := substr(sqlerrm,1,4000);
              raise;

END CARICAMENTO_BULK_DAT_UPLOAD;

FUNCTION FNC_GET_rel_GENERICA ( BK_rel_GENERICA    in tab_rel_generica,
                                      chiave_ricerca            in VARCHAR2,
                                      nome_campo                in VARCHAR2
                                    ) return number is

  ret_val NUMBER;

BEGIN

  ret_val := 0;
  if chiave_ricerca is null
  then ret_val := -1;
  else
        ret_val := BK_rel_GENERICA(chiave_ricerca).id;
  end if;
  return ret_val;
  EXCEPTION
  when no_data_found then
       ret_val := -2;           --- SK del codice errato non presente nella BULK
       return ret_val;

  WHEN OTHERS THEN
          --cod_errore  := '107';
          --cod_errore_ora := sqlcode;
          --desc_errore_ora := substr(sqlerrm,1,4000);
          desc_errore := substr('ERRORE GENERICO ricerca ID per il campo:'||nome_campo||' con valore: '||chiave_ricerca||' - '||sqlerrm,1,4000);
          raise;

END FNC_GET_rel_GENERICA;


--- ************************************************************************************************
--- FUNZIONE DI INTERROGAZIONE BULK PER LA RICERCA DELLE SK
--- *************************************************************************************************
FUNCTION FNC_GET_SK_GENERICA ( BK_DIM_GENERICA    in tab_dim_generica,
                                      codice            in VARCHAR2,
                                      chiave_ricerca            in VARCHAR2,
                                      nome_campo                in VARCHAR2
                                    ) return number is

  ret_val NUMBER;

BEGIN

  ret_val := 0;
  if (codice is null or codice = '-1')
  then ret_val := -1;
  else
        ret_val := BK_DIM_GENERICA(chiave_ricerca).sk;
  end if;
  return ret_val;
  EXCEPTION
  when no_data_found then
       ret_val := -2;           --- SK del codice errato non presente nella BULK
       return ret_val;

  WHEN OTHERS THEN
          --cod_errore  := '107';
          --cod_errore_ora := sqlcode;
          --desc_errore_ora := substr(sqlerrm,1,4000);
          desc_errore := substr('ERRORE GENERICO ricerca SK per il campo:'||nome_campo||' con valore: '||chiave_ricerca||' - '||sqlerrm,1,4000);
          raise;

END FNC_GET_SK_GENERICA;

FUNCTION FNC_GET_SK_ACT_GENERICA ( BK_DIM_GENERICA    in tab_dim_generica,
                                      codice            in VARCHAR2,
                                      chiave_ricerca            in VARCHAR2,
                                      nome_campo                in VARCHAR2
                                    ) return number is

  ret_val NUMBER;

BEGIN

  ret_val := 0;
  if (codice is null or codice = '-1')
  then ret_val := -1;
  else
        ret_val := BK_DIM_GENERICA(chiave_ricerca).sk_ACT;
  end if;
  return ret_val;
  EXCEPTION
  when no_data_found then
       ret_val := -2;           --- SK del codice errato non presente nella BULK
       return ret_val;

  WHEN OTHERS THEN
          --cod_errore  := '107';
          --cod_errore_ora := sqlcode;
          --desc_errore_ora := substr(sqlerrm,1,4000);
          desc_errore := substr('ERRORE GENERICO ricerca SK per il campo:'||nome_campo||' con valore: '||chiave_ricerca||' - '||sqlerrm,1,4000);
          raise;

END FNC_GET_SK_ACT_GENERICA;

FUNCTION FNC_GET_SK_AZIENDA_GENERICA ( da    in dim_azienda.provenienza%type,
                                      rec_az_vld in r_dim_azienda,
                                      sk_find out number,
                                      sk_act_find out number
                                    ) return number is

  ret_val NUMBER;
  APPO_CITTA VARCHAR2(80);

  begin


           if rec_az_vld.CITTA is not NULL THEN

           begin
           select comuni.DESCRIZIONE_COMUNE into APPO_CITTA from comuni where CODICE_COMUNE=rec_az_vld.CITTA ;
           exception
           when no_data_found  then
            desc_errore := substr('ERRORE Ricerca Anagrafica  : '||'COMUNI'||' - '||SQLERRM,1,4000);
            raise errore;
           end;

           else

           APPO_CITTA := 'ND';

           END IF;





        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
        from dim_azienda
        where apn_n_registrazione = rec_az_vld.APN_N_REGISTRAZIONE--mdfch.SAMPUNIT_SAMPHOLDINGID
        and provenienza = da--'acquacoltura'
        and  DAT_FIN_VLD_TEC is null;




            if rec_azienda.RAGSOC = upper(rec_az_vld.RAGSOC)
            and rec_azienda.VIA_PIAZ = upper(rec_az_vld.VIA_PIAZ)
            and rec_azienda.CITTA = upper(APPO_CITTA)
            and rec_azienda.PROVINCIA = upper(rec_az_vld.PROVINCIA) then

              sk_find := rec_azienda.sk_azienda; --ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := rec_azienda.sk_azienda;
              sk_act_find := rec_azienda.sk_act_azienda; --ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := rec_azienda.sk_act_azienda;

            else
            --update dell'ultimo in dimensione
                update dim_azienda
                set dat_fin_vld_tec = adesso
                where sk_azienda = rec_azienda.sk_azienda;
             --e inserimento del nuovo

                --select seq_dim_azienda.nextval into sk_ACT from dual;
                select seq_dim_azienda.nextval into sk from dual;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                values (sk , rec_azienda.sk_act_azienda, da, rec_az_vld.APN_N_REGISTRAZIONE, rec_az_vld.RAGSOC,  rec_az_vld.VIA_PIAZ, APPO_CITTA, rec_az_vld.PROVINCIA, adesso)
                ;
              sk_find := sk; --ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := sk;
              sk_act_find := rec_azienda.sk_act_azienda; --ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := rec_azienda.sk_act_azienda;

            end if;
ret_val := 1;
return ret_val;

        exception
        when no_data_found then
        --inserire nuovo
                select seq_dim_azienda.nextval into sk_ACT from dual;
                select seq_dim_azienda.nextval into sk from dual;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                values (sk , sk_ACT, da, rec_az_vld.APN_N_REGISTRAZIONE, rec_az_vld.RAGSOC,  rec_az_vld.VIA_PIAZ, APPO_CITTA, rec_az_vld.PROVINCIA, adesso)
                ;
              sk_find := sk;
              sk_act_find := sk_ACT;
ret_val := 1;
return ret_val;
        when others then
      desc_errore := substr('ERRORE Aggiornamento dimensione : '||'DIM_AZIENDA'||' - '||SQLERRM,1,4000);
      raise errore;
return ret_val;


END FNC_GET_SK_AZIENDA_GENERICA;


/*PROCEDURE PRC_GET_SK_AZIENDA( SAMPPOINT in varchar2,
                              /*SAMPUNIT_SAMPHOLDINGID in varchar2,
                              SAMPUNIT_SLAUGHTERHOUSEID  in varchar2,
                              SAMPUNIT_SAMPPLANTID  in varchar2,*/      -- 
                              --rec_az_vld in r_dim_azienda,
      /*                        OSAID in VARCHAR2,
                              RAGSOC in varchar2,
                              VIA_PIAZ in varchar2,
                              CITTA in varchar2,
                              PROVINCIA in varchar2,
                                  nome_dimensione   VARCHAR2
                                  ) IS
    rec_az_vld_in r_dim_azienda;
    sk_trovata integer;
    APPO_CITTA VARCHAR2(80);
BEGIN

           if CITTA is not  NULL THEN

           begin
           select comuni.DESCRIZIONE_COMUNE into APPO_CITTA from comuni where CODICE_COMUNE=CITTA ;
           exception
           when no_data_found  then
            desc_errore := substr('ERRORE Ricerca Anagrafica  : '||'COMUNI'||' - '||SQLERRM,1,4000);
            raise errore;
           end;

           else

           APPO_CITTA := 'ND';

           END IF;


--ricerca nell'anagrafica aziende x SAMPUNIT_SAMPHOLDINGID

      --
      if SAMPPOINT = 'MS.040.720' and OSAID is not null--SAMPUNIT_SAMPHOLDINGID is not null    
      then--acquacoltura
      --ricerca fra le aziende di acquacoltura
        begin
        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
        from dim_azienda
        where apn_n_registrazione = OSAID --SAMPUNIT_SAMPHOLDINGID
        and provenienza = 'acquacoltura'
        and  DAT_FIN_VLD_TEC is null;



            if rec_azienda.RAGSOC = upper(RAGSOC)
                and rec_azienda.VIA_PIAZ = upper(VIA_PIAZ)
                and rec_azienda.CITTA = upper(APPO_CITTA)
                and rec_azienda.PROVINCIA = upper(PROVINCIA) THEN NULL; --THEN

                ft_pnr.SK_OSAID := sk;
                    ft_pnr.SK_ACT_OSAID := sk_ACT;

            else
            --update dell'ultimo in dimensione
                update dim_azienda
                set dat_fin_vld_tec = adesso
                where sk_azienda = rec_azienda.sk_azienda;
             --e inserimento del nuovo

                --select seq_dim_azienda.nextval into sk_ACT from dual;
                select seq_dim_azienda.nextval into sk from dual;
                --select stacco_sk(max(SK_AZIENDA), 1)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                values (sk , rec_azienda.sk_act_azienda, 'acquacoltura',OSAID, RAGSOC,  VIA_PIAZ, APPO_CITTA, PROVINCIA, adesso) --SAMPUNIT_SAMPHOLDINGID
                ;
              ft_pnr.SK_OSAID := sk;
              ft_pnr.SK_ACT_OSAID := rec_azienda.sk_act_azienda;

            end if;
        exception
        when no_data_found then
        --inserire nuovo
                select seq_dim_azienda.nextval into sk_ACT from dual;
                select seq_dim_azienda.nextval into sk from dual;
                --select stacco_sk(max(SK_AZIENDA), 1)  into sk_ACT from DIM_AZIENDA;
                --select stacco_sk(max(SK_AZIENDA), 2)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                values (sk , sk_ACT, 'acquacoltura', OSAID, RAGSOC,  VIA_PIAZ, APPO_CITTA, PROVINCIA, adesso) --SAMPUNIT_SAMPHOLDINGID
                ;
              ft_pnr.SK_OSAID := sk;
              ft_pnr.SK_ACT_OSAID := rec_azienda.sk_act_azienda;


        end;

      elsif SAMPPOINT = 'MS.040.720' and OSAID IS NOT NULL  --SAMPUNIT_SAMPHOLDINGID is null
      then
      desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_AZIENDA'||' - '||'SAMPUNIT_SAMPHOLDINGID is null',1,4000);
      raise errore;

      elsif (SAMPPOINT = 'MS.040.710' or SAMPPOINT= 'MS.060.400')  --allevamento o distributori di latte crudo
      then

      ft_pnr.SK_OSAID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, OSAID,-- SAMPUNIT_SAMPHOLDINGID, SK_SAMPUNIT_SAMPHOLDINGID
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          OSAID||' - '||'Numero di Registrazione', --SAMPUNIT_SAMPHOLDINGID
                          'SAMPUNIT_SAMPHOLDINGID'
                         );
      ft_pnr.SK_ACT_OSAID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, OSAID, --SAMPUNIT_SAMPHOLDINGID,
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          OSAID||' - '||'Numero di Registrazione', --SAMPUNIT_SAMPHOLDINGID
                          'SAMPUNIT_SAMPHOLDINGID'
                         );


      else--altro

        if nvl(length(OSAID),0) > 6 then --SAMPUNIT_SAMPHOLDINGID

        ft_pnr.SK_OSAID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, OSAID, --SAMPUNIT_SAMPHOLDINGID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            trim(substr(OSAID,7)) --SAMPUNIT_SAMPHOLDINGID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );
        ft_pnr.SK_ACT_OSAID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, OSAID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            trim(substr(OSAID,7))
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );

        else

        ft_pnr.SK_OSAID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, OSAID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            OSAID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );
        ft_pnr.SK_ACT_OSAID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA,OSAID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            OSAID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );

        end if;
      end if;
*/























/*--ricerca nell'anagrafica aziende x SAMPUNIT_SLAUGHTERHOUSEID
        if nvl(length(SAMPUNIT_SLAUGHTERHOUSEID),0) > 6 then

        ft_pnr.sk_SAMPUNIT_SLAUGHTERHOUSEID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SLAUGHTERHOUSEID,1,6))
                            trim(substr(SAMPUNIT_SLAUGHTERHOUSEID,7))
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SLAUGHTERHOUSEID'
                           );
        ft_pnr.sk_ACT_SAMPUN_SLAUGHTERHOUSEID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SLAUGHTERHOUSEID,1,6))
                            trim(substr(SAMPUNIT_SLAUGHTERHOUSEID,7))
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                           'SAMPUNIT_SLAUGHTERHOUSEID'
                           );


        else

        ft_pnr.sk_SAMPUNIT_SLAUGHTERHOUSEID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            SAMPUNIT_SLAUGHTERHOUSEID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SLAUGHTERHOUSEID'
                           );
        ft_pnr.sk_ACT_SAMPUN_SLAUGHTERHOUSEID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            SAMPUNIT_SLAUGHTERHOUSEID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SLAUGHTERHOUSEID'
                           );

        end if;


















--ricerca nell'anagrafica aziende x SAMPUNIT_SAMPPLANTID

      --
      if SAMPPOINT = 'MS.040.500' and SAMPUNIT_SAMPPLANTID is not null
      then--smielatura
      rec_az_vld_in.APN_N_REGISTRAZIONE := SAMPUNIT_SAMPPLANTID;
      rec_az_vld_in.RAGSOC := RAGSOC;
      rec_az_vld_in.VIA_PIAZ := VIA_PIAZ;
      rec_az_vld_in.CITTA := CITTA;
      rec_az_vld_in.PROVINCIA := PROVINCIA;

      sk_trovata:= FNC_GET_SK_AZIENDA_GENERICA ( 'smielatura',
                                      rec_az_vld_in,
                                      ft_pnr.sk_SAMPUNIT_SAMPPLANTID ,
                                      ft_pnr.sk_act_SAMPUNIT_SAMPPLANTID
                                    );



      elsif SAMPPOINT = 'MS.040.720' and SAMPUNIT_SAMPPLANTID is null
      then
      desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_AZIENDA'||' - '||'SAMPUNIT_SAMPPLANTID is null',1,4000);
      raise errore;

      else--altro

        if nvl(length(SAMPUNIT_SAMPPLANTID),0) > 6 then

        ft_pnr.sk_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            trim(substr(SAMPUNIT_SAMPPLANTID,7))
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPPLANTID'
                           );
        ft_pnr.sk_ACT_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPPLANTID,1,6))
                            trim(substr(SAMPUNIT_SAMPPLANTID,7))
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                           'SAMPUNIT_SAMPPLANTID'
                           );



        else

        ft_pnr.sk_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            SAMPUNIT_SAMPPLANTID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPPLANTID'
                           );
        ft_pnr.sk_ACT_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            SAMPUNIT_SAMPPLANTID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPPLANTID'
                           );

        end if;

      end if;

*/

PROCEDURE PRC_GET_SK_AZIENDA( SAMPPOINT in varchar2,
                              /*SAMPUNIT_SAMPHOLDINGID in varchar2,
                              SAMPUNIT_SLAUGHTERHOUSEID  in varchar2,
                              SAMPUNIT_SAMPPLANTID  in varchar2,*/      -- 
                              --rec_az_vld in r_dim_azienda,
                              OSAID in VARCHAR2,
                              RAGSOC in varchar2,
                              VIA_PIAZ in varchar2,
                              CITTA in varchar2,
                              PROVINCIA in varchar2,
                                  nome_dimensione   VARCHAR2
                                  ) IS
    rec_az_vld_in r_dim_azienda;
    sk_trovata integer;
    APPO_CITTA VARCHAR2(80);
    OSAID_OK VARCHAR2(50);

BEGIN

            OSAID_OK:=ELAB_OSAID(OSAID);

--            IF OSAID IS NULL THEN
--                desc_errore := ('ERRORE OSAID is null');
--                RAISE ERRORE;
--            END IF;

           if CITTA is not  NULL THEN

               begin
               select comuni.DESCRIZIONE_COMUNE into APPO_CITTA from comuni where CODICE_COMUNE=CITTA ;
               exception
               when no_data_found  then
                desc_errore := substr('ERRORE Ricerca Anagrafica  : '||'COMUNI'||' - '||SQLERRM,1,4000);
                raise errore;
               end;

           else

                APPO_CITTA := 'ND';

           END IF;


--ricerca nell'anagrafica aziende


     IF SAMPPOINT = 'MS.040.720' or SAMPPOINT = 'MS.040.710' or SAMPPOINT = 'MS.060.400'  and OSAID_OK is not null
            then--Numero di Registrazione
            begin
            select sk_azienda , sk_act_azienda, RAGSOC,VIA_PIAZ,CITTA,PROVINCIA-- upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
            into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
            from dim_azienda
            where apn_n_registrazione = OSAID_OK
            and provenienza = 'Numero di Registrazione'
            and  DAT_FIN_VLD_TEC is null;

            --DBMS_OUTPUT.PUT_LINE('CASO 1: '||SAMPPOINT);

           /* if rec_azienda.RAGSOC = upper(RAGSOC)
                and rec_azienda.VIA_PIAZ = upper(VIA_PIAZ)
                and rec_azienda.CITTA = upper(APPO_CITTA)
                and rec_azienda.PROVINCIA = upper(PROVINCIA) THEN NULL; --THEN*/

                ft_pnr.SK_OSAID := rec_azienda.sk_azienda;
                ft_pnr.SK_ACT_OSAID := rec_azienda.sk_act_azienda;

            /*else
            --update dell'ultimo in dimensione
                update dim_azienda
                set dat_fin_vld_tec = adesso
                where sk_azienda = rec_azienda.sk_azienda;
             --e inserimento del nuovo*/

                --select seq_dim_azienda.nextval into sk_ACT from dual;
                --select seq_dim_azienda.nextval into sk from dual;
                --select stacco_sk(max(SK_AZIENDA), 1)  into sk from DIM_AZIENDA;

                /*insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                values (sk , rec_azienda.sk_act_azienda, 'Numero di Registrazione',OSAID, RAGSOC,  VIA_PIAZ, APPO_CITTA, PROVINCIA, adesso) --SAMPUNIT_SAMPHOLDINGID
                ;*/
              --ft_pnr.SK_OSAID := sk;
              --ft_pnr.SK_ACT_OSAID := rec_azienda.sk_act_azienda;

        exception
         when no_data_found then
        --inserire nuovo

                --select seq_dim_azienda.nextval into sk_ACT from dual;
                --select seq_dim_azienda.nextval into sk from dual;
                --select stacco_sk(max(SK_AZIENDA), 1)  into sk_ACT from DIM_AZIENDA;
                --select stacco_sk(max(SK_AZIENDA), 2)  into sk from DIM_AZIENDA;

                --insert into dim_azienda
                --(sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                --values (sk , sk_ACT, 'Numero di Registrazione', OSAID, RAGSOC,  VIA_PIAZ, APPO_CITTA, PROVINCIA, adesso) --SAMPUNIT_SAMPHOLDINGID
               ft_pnr.SK_OSAID := -2;
               ft_pnr.SK_ACT_OSAID := -2;


        end;


     ELSif SAMPPOINT = 'MS.B10.100' or SAMPPOINT = 'MS.B20.100' or SAMPPOINT = 'MS.B30.100'
            OR SAMPPOINT = 'MS.B40.200' or SAMPPOINT = 'MS.040.500' or SAMPPOINT = 'MS.BA0.100'
            OR SAMPPOINT = 'MS.BA0.300' or SAMPPOINT = 'MS.B80.500' or SAMPPOINT = 'MS.B90.400'
            OR SAMPPOINT = 'MS.B80.600'  and OSAID_OK is not null
      then--Approval Number

        --DBMS_OUTPUT.PUT_LINE('CASO 2: '||SAMPPOINT);

        begin
        select sk_azienda , sk_act_azienda, RAGSOC,VIA_PIAZ,CITTA,PROVINCIA--  upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
        from dim_azienda
        where apn_n_registrazione = OSAID_OK
        and provenienza = 'Approval number'   --APN DI SINTESI
        and  DAT_FIN_VLD_TEC is null;

--                ft_pnr.SK_OSAID := sk;
--                ft_pnr.SK_ACT_OSAID := sk_ACT;
                ft_pnr.SK_OSAID := rec_azienda.sk_azienda;
                ft_pnr.SK_ACT_OSAID := rec_azienda.sk_act_azienda;
           /* if rec_azienda.RAGSOC = upper(RAGSOC)
                and rec_azienda.VIA_PIAZ = upper(VIA_PIAZ)
                and rec_azienda.CITTA = upper(APPO_CITTA)
                and rec_azienda.PROVINCIA = upper(PROVINCIA) THEN NULL; --THEN



            else
            --update dell'ultimo in dimensione
                update dim_azienda
                set dat_fin_vld_tec = adesso
                where sk_azienda = rec_azienda.sk_azienda;
             --e inserimento del nuovo

                --select seq_dim_azienda.nextval into sk_ACT from dual;
                select seq_dim_azienda.nextval into sk from dual;
                --select stacco_sk(max(SK_AZIENDA), 1)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                values (sk , rec_azienda.sk_act_azienda, 'Approval Number', OSAID, RAGSOC, VIA_PIAZ, APPO_CITTA, PROVINCIA, adesso) --SAMPUNIT_SAMPHOLDINGID
                ;
              ft_pnr.SK_OSAID := sk;
              ft_pnr.SK_ACT_OSAID := rec_azienda.sk_act_azienda;*/

        exception
        when no_data_found then
        --inserire nuovo
                /*select seq_dim_azienda.nextval into sk_ACT from dual;
                select seq_dim_azienda.nextval into sk from dual;
                --select stacco_sk(max(SK_AZIENDA), 1)  into sk_ACT from DIM_AZIENDA;
                --select stacco_sk(max(SK_AZIENDA), 2)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                values (sk , sk_ACT, 'Approval Number', OSAID, RAGSOC,  VIA_PIAZ, APPO_CITTA, PROVINCIA, adesso) --SAMPUNIT_SAMPHOLDINGID
                ;*/
              ft_pnr.SK_OSAID := -2;
              ft_pnr.SK_ACT_OSAID := -2;

        end;

     else
      --SAMPOINT non riconosciuto
      --DBMS_OUTPUT.PUT_LINE(SAMPPOINT);
        begin
         select sk_azienda , sk_act_azienda, RAGSOC,VIA_PIAZ,CITTA,PROVINCIA--  upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
         into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
         from dim_azienda
         where apn_n_registrazione = OSAID_OK
         and provenienza = 'SAMPOINT' --????????????
         and  DAT_FIN_VLD_TEC is null;

             if upper(rec_azienda.RAGSOC) = upper(RAGSOC)
                and upper(rec_azienda.VIA_PIAZ) = upper(VIA_PIAZ)
                and upper(rec_azienda.CITTA) = upper(APPO_CITTA)
                and upper(rec_azienda.PROVINCIA) = upper(PROVINCIA) THEN

                 ft_pnr.SK_OSAID := rec_azienda.sk_azienda;
                 ft_pnr.SK_ACT_OSAID := rec_azienda.sk_act_azienda;
                    --DBMS_OUTPUT.PUT_LINE('AZIENDA TROVATA');

              else
                 --update dell'ultimo in dimensione
                    update dim_azienda
                    set dat_fin_vld_tec = adesso
                    where
                    --apn_n_registrazione = OSAID_OK;
                    sk_azienda = rec_azienda.sk_azienda;

                    commit;
                    --DBMS_OUTPUT.PUT_LINE('CHIUSURA RECORD AZIENDA');
                    --select seq_dim_azienda.nextval into sk_ACT from dual;
                    select seq_dim_azienda.nextval into sk from dual;
                    --select stacco_sk(max(SK_AZIENDA), 1)  into sk from DIM_AZIENDA;

                    insert into dim_azienda
                    (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                    values (sk , rec_azienda.sk_act_azienda, 'SAMPOINT', OSAID_OK, RAGSOC, VIA_PIAZ, APPO_CITTA, PROVINCIA, adesso)
                    ;

                     commit;
                     --DBMS_OUTPUT.PUT_LINE('APERTURA RECORD AZIENDA');
                  ft_pnr.SK_OSAID := sk;
                  ft_pnr.SK_ACT_OSAID := rec_azienda.sk_act_azienda;

            end if;

        exception
        when no_data_found then
        --inserire nuovo
                select seq_dim_azienda.nextval into sk_ACT from dual;
                select seq_dim_azienda.nextval into sk from dual;
                --select stacco_sk(max(SK_AZIENDA), 1)  into sk_ACT from DIM_AZIENDA;
                --select stacco_sk(max(SK_AZIENDA), 2)  into sk from DIM_AZIENDA;
--                update dim_azienda
--                set dat_fin_vld_tec = adesso
--                where apn_n_registrazione = OSAID_OK;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                values (sk , sk_ACT, 'SAMPOINT', OSAID_OK, RAGSOC,  VIA_PIAZ, APPO_CITTA, PROVINCIA, adesso)
                ;
                commit;
                --DBMS_OUTPUT.PUT_LINE('INSERIMENTO NUOVO RECORD AZIENDA');
              ft_pnr.SK_OSAID := sk;
              ft_pnr.SK_ACT_OSAID := sk_ACT;

           end;


end if;

/*
      elsif (SAMPPOINT = 'MS.040.710' or SAMPPOINT= 'MS.060.400')  --allevamento o distributori di latte crudo
      then

      ft_pnr.SK_OSAID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, OSAID,-- SAMPUNIT_SAMPHOLDINGID, SK_SAMPUNIT_SAMPHOLDINGID
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          OSAID||' - '||'Numero di Registrazione', --SAMPUNIT_SAMPHOLDINGID
                          'SAMPUNIT_SAMPHOLDINGID'
                         );
      ft_pnr.SK_ACT_OSAID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, OSAID, --SAMPUNIT_SAMPHOLDINGID,
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          OSAID||' - '||'Numero di Registrazione', --SAMPUNIT_SAMPHOLDINGID
                          'SAMPUNIT_SAMPHOLDINGID'
                         );


      else--altro

        if nvl(length(OSAID),0) > 6 then --SAMPUNIT_SAMPHOLDINGID

        ft_pnr.SK_OSAID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, OSAID, --SAMPUNIT_SAMPHOLDINGID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            trim(substr(OSAID,7)) --SAMPUNIT_SAMPHOLDINGID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );
        ft_pnr.SK_ACT_OSAID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, OSAID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            trim(substr(OSAID,7))
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );

        else

        ft_pnr.SK_OSAID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, OSAID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            OSAID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );
        ft_pnr.SK_ACT_OSAID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA,OSAID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            OSAID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );
*/

      --end if;


EXCEPTION
when errore then
        --desc_errore := substr(sqlerrm,1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := desc_errore || substr('ERRORE ricerca sulla dimensione : '||nome_dimensione||' - '||sqlerrm,1,4000);
        raise;

END PRC_GET_SK_AZIENDA ;


FUNCTION ELAB_OSAID (OSAID_IN IN varchar2)return varchar2 is

  OSAID_OUT varchar2(50);

BEGIN

    OSAID_OUT:='';

    IF OSAID_IN IS NULL or trim(OSAID_IN) is null THEN
                desc_errore := ('ERRORE OSAID is null');
                RAISE ERRORE;
    END IF;


    SELECT CASE

        WHEN LENGTH(OSAID_IN) > 6 AND INSTR(SUBSTR(OSAID_IN,0,6), 'CE IT ', 1) > 0 THEN

             SUBSTR(OSAID_IN,7)

        WHEN LENGTH(OSAID_IN) > 4 AND INSTR(SUBSTR(OSAID_IN,0,4), 'ABP ', 1) > 0 THEN

             SUBSTR(OSAID_IN,5)

        ELSE

            OSAID_IN

     END

     INTO OSAID_OUT

     FROM DUAL;

  RETURN  OSAID_OUT;

EXCEPTION
when errore then
        --desc_errore := substr(sqlerrm,1,4000);
        raise;
WHEN OTHERS THEN

        desc_errore := desc_errore || substr('ERRORE ELABORAZIONE OSAID: '||OSAID_IN||' - '||sqlerrm,1,4000);
        raise;

END ELAB_OSAID;



PROCEDURE PRC_GET_SK_CODAZALLORIG( SAMPPOINT in varchar2,
                              /*SAMPUNIT_SAMPHOLDINGID in varchar2,
                              SAMPUNIT_SLAUGHTERHOUSEID  in varchar2,
                              SAMPUNIT_SAMPPLANTID  in varchar2,*/      -- 
                              --rec_az_vld in r_dim_azienda,
                              CodAzAllOrig in VARCHAR2,
                              RAGSOC in varchar2,
                              VIA_PIAZ in varchar2,
                              CITTA in varchar2,
                              PROVINCIA in varchar2,
                              nome_dimensione   VARCHAR2) IS
    rec_az_vld_in r_dim_azienda;
    sk_trovata integer;
    APPO_CITTA VARCHAR2(80);
    BEGIN

  IF CodAzAllOrig IS NULL THEN
            ft_pnr.SK_CodAzAllOrig := -1;
            ft_pnr.SK_ACT_CodAzAllOrig := -1;
  else

           if CITTA is not  NULL THEN

           begin
           select comuni.DESCRIZIONE_COMUNE into APPO_CITTA from comuni where CODICE_COMUNE=CITTA ;
           exception
           when no_data_found  then
            desc_errore := substr('ERRORE Ricerca Anagrafica  : '||'COMUNI'||' - '||SQLERRM,1,4000);
            raise errore;
           end;

           else

           APPO_CITTA := 'ND';

           END IF;


   --ricerca nell'anagrafica aziende


     IF SAMPPOINT = 'MS.B10.100' or SAMPPOINT = 'MS.B20.100' or SAMPPOINT = 'MS.B30.100'
            then--MACELLO
            begin
            select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)   --tenuti perchè non mi ricordo se bisogna toglierli o meno
            into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
            from dim_azienda
            where apn_n_registrazione = CodAzAllOrig
            and provenienza = 'Approval Number'
            and  DAT_FIN_VLD_TEC is null;

                ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;


        exception
         when no_data_found then

               ft_pnr.SK_CodAzAllOrig := -2;
               ft_pnr.SK_ACT_CodAzAllOrig := -2;


        end;


     ELSif SAMPPOINT = 'MS.BA0.100'
      then--CENTRO IMBALLAGGIO UOVA
        begin
        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
        from dim_azienda
        where apn_n_registrazione = CodAzAllOrig
        and provenienza = 'Approval Number'
        and  DAT_FIN_VLD_TEC is null;

                ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;

        exception
        when no_data_found then
              ft_pnr.SK_CodAzAllOrig := -2;
              ft_pnr.SK_ACT_CodAzAllOrig := -2;

        end;


     ELSif SAMPPOINT = 'MS.BA0.300'
      then--TRASFORMAZIONE OVOPRODOTTI
        begin
        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
        from dim_azienda
        where apn_n_registrazione = CodAzAllOrig
        and provenienza = 'Approval Number'
        and  DAT_FIN_VLD_TEC is null;

               ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;

        exception
        when no_data_found then
              ft_pnr.SK_CodAzAllOrig := -2;
              ft_pnr.SK_ACT_CodAzAllOrig := -2;

        end;



     ELSif SAMPPOINT = 'MS.B90.400'
      then--TRASFORMAZIONE LATTA E PRODOTTI A BASE DI LATTE
        begin
        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
        from dim_azienda
        where apn_n_registrazione = CodAzAllOrig
        and provenienza = 'Approval Number'
        and  DAT_FIN_VLD_TEC is null;

               ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;

        exception
        when no_data_found then
              ft_pnr.SK_CodAzAllOrig := -2;
              ft_pnr.SK_ACT_CodAzAllOrig := -2;

        end;


     ELSif SAMPPOINT = 'MS.060.400'
      then--DISTRIBUTORI LATTE CRUDO
        begin
        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
        from dim_azienda
        where apn_n_registrazione = CodAzAllOrig
        and provenienza = 'Approval Number'
        and  DAT_FIN_VLD_TEC is null;

                ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;

        exception
        when no_data_found then
              ft_pnr.SK_CodAzAllOrig := -2;
              ft_pnr.SK_ACT_CodAzAllOrig := -2;

        end;


     ELSif SAMPPOINT = 'MS.B80.600'
      then--MERCATO ITTICO
        begin
        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
        from dim_azienda
        where apn_n_registrazione = CodAzAllOrig
        and provenienza = 'Approval Number'
        and  DAT_FIN_VLD_TEC is null;

               ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;

        exception
        when no_data_found then
              ft_pnr.SK_CodAzAllOrig := -2;
              ft_pnr.SK_ACT_CodAzAllOrig := -2;

        end;


     ELSif SAMPPOINT = 'MS.B80.500'
      then--IMPIANTO TRASFORMAZIONE PRODOTTI PESCA
        begin
        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
        from dim_azienda
        where apn_n_registrazione = CodAzAllOrig
        and provenienza = 'Approval Number'
        and  DAT_FIN_VLD_TEC is null;

               ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;

        exception
        when no_data_found then
              ft_pnr.SK_CodAzAllOrig := -2;
              ft_pnr.SK_ACT_CodAzAllOrig := -2;

        end;


     else
      --SAMPPOINT non riconosciuto
        begin
         select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
         into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
         from dim_azienda
         where apn_n_registrazione = CodAzAllOrig
         and provenienza = 'SAMPPOINT' --????????????
         and  DAT_FIN_VLD_TEC is null;


             if rec_azienda.RAGSOC = upper(RAGSOC)
                and rec_azienda.VIA_PIAZ = upper(VIA_PIAZ)
                and rec_azienda.CITTA = upper(APPO_CITTA)
                and rec_azienda.PROVINCIA = upper(PROVINCIA) THEN

                    ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
                    ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;

              else
             --update dell'ultimo in dimensione
                update dim_azienda
                set dat_fin_vld_tec = adesso
                where sk_azienda = rec_azienda.sk_azienda;
             --e inserimento del nuovo

                --select seq_dim_azienda.nextval into sk_ACT from dual;
                select seq_dim_azienda.nextval into sk from dual;
                --select stacco_sk(max(SK_AZIENDA), 1)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, dat_ini_vld_tec)--, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                values (sk , rec_azienda.sk_act_azienda, 'SAMPOINT', CodAzAllOrig, adesso)-- RAGSOC, VIA_PIAZ, APPO_CITTA, PROVINCIA, adesso)
                ;
              ft_pnr.SK_CodAzAllOrig := sk;
              ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
              end if;



        exception
        when no_data_found then
        --inserire nuovo
                select seq_dim_azienda.nextval into sk_ACT from dual;
                select seq_dim_azienda.nextval into sk from dual;
                --select stacco_sk(max(SK_AZIENDA), 1)  into sk_ACT from DIM_AZIENDA;
                --select stacco_sk(max(SK_AZIENDA), 2)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, dat_ini_vld_tec)-- RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_ini_vld_tec)
                values (sk , sk_ACT, 'SAMPOINT', CodAzAllOrig, adesso)-- RAGSOC,  VIA_PIAZ, APPO_CITTA, PROVINCIA, adesso)
                ;
              ft_pnr.SK_CodAzAllOrig := sk;
              ft_pnr.SK_ACT_CodAzAllOrig := sk_ACT;

           end;

     end if;

  END IF;

EXCEPTION
when errore then
        --desc_errore := substr(sqlerrm,1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := desc_errore || substr('ERRORE ricerca sulla dimensione : '||nome_dimensione||' - '||sqlerrm,1,4000);
        raise;

END PRC_GET_SK_CODAZALLORIG;



PROCEDURE PRC_GET_SK_CODAZALLORIG_NEW( SAMPPOINT in varchar2,

                              CodAzAllOrig in VARCHAR2,
                              RAGSOC in varchar2,
                              VIA_PIAZ in varchar2,
                              CITTA in varchar2,
                              PROVINCIA in varchar2,
                              nome_dimensione   VARCHAR2) IS

    rec_az_vld_in r_dim_azienda;
    sk_trovata integer;
    APPO_CITTA VARCHAR2(80);
    checkOrigine number:=0;

    BEGIN

  IF CodAzAllOrig IS NULL THEN
            ft_pnr.SK_CodAzAllOrig := -1;
            ft_pnr.SK_ACT_CodAzAllOrig := -1;
  else

           if CITTA is not  NULL THEN

                begin
                   select comuni.DESCRIZIONE_COMUNE into APPO_CITTA from comuni where CODICE_COMUNE=CITTA ;
                exception
                   when no_data_found  then
                    desc_errore := substr('ERRORE Ricerca Anagrafica  : '||'COMUNI'||' - '||SQLERRM,1,4000);
                    raise errore;
               end;

           else

                APPO_CITTA := 'ND';

           END IF;


   --ricerca nell'anagrafica aziende


     IF SAMPPOINT = 'MS.B10.100' or SAMPPOINT = 'MS.B20.100' or SAMPPOINT = 'MS.B30.100'
     or SAMPPOINT = 'MS.BA0.100' or SAMPPOINT = 'MS.BA0.300' or SAMPPOINT = 'MS.B90.400'
     or SAMPPOINT = 'MS.060.400' or SAMPPOINT = 'MS.B80.600'  or SAMPPOINT = 'MS.B80.500'
            then

            begin
                select sk_azienda , sk_act_azienda, RAGSOC,VIA_PIAZ,CITTA,PROVINCIA--  upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)   --tenuti perchè non mi ricordo se bisogna toglierli o meno
                into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
                from dim_azienda
                where apn_n_registrazione = CodAzAllOrig
                and provenienza = 'Approval number'
                and  DAT_FIN_VLD_TEC is null;

                ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;


        exception
         when no_data_found then

             select COUNT(1)
             into checkOrigine
                from dim_azienda
                where apn_n_registrazione = CodAzAllOrig
                and provenienza = 'Numero di Registrazione'
                and  DAT_FIN_VLD_TEC is null;

            if checkOrigine>0 then

                select sk_azienda , sk_act_azienda,  RAGSOC,VIA_PIAZ,CITTA,PROVINCIA-- upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
                    into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
                    from dim_azienda
                    where apn_n_registrazione = CodAzAllOrig
                    and provenienza = 'Numero di Registrazione'
                    and  DAT_FIN_VLD_TEC is null;

                    ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
                    ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;

            else
                   ft_pnr.SK_CodAzAllOrig := -2;
                   ft_pnr.SK_ACT_CodAzAllOrig := -2;
            end if;

        end;


--     ELSif SAMPPOINT = 'MS.BA0.100'
--      then--CENTRO IMBALLAGGIO UOVA
--        begin
--        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--        from dim_azienda
--        where apn_n_registrazione = CodAzAllOrig
--        and provenienza = 'Approval Number'
--        and  DAT_FIN_VLD_TEC is null;
--
--                ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--       exception
--         when no_data_found then
--
--             select COUNT(1)
--             into checkOrigine
--                from dim_azienda
--                where apn_n_registrazione = CodAzAllOrig
--                and provenienza = 'Numero di Registrazione'
--                and  DAT_FIN_VLD_TEC is null;
--
--            if checkOrigine>0 then
--
--                select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--                    into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--                    from dim_azienda
--                    where apn_n_registrazione = CodAzAllOrig
--                    and provenienza = 'Numero di Registrazione'
--                    and  DAT_FIN_VLD_TEC is null;
--
--                    ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--                    ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--            else
--                   ft_pnr.SK_CodAzAllOrig := -2;
--                   ft_pnr.SK_ACT_CodAzAllOrig := -2;
--            end if;
--
--        end;


--     ELSif SAMPPOINT = 'MS.BA0.300'
--      then--TRASFORMAZIONE OVOPRODOTTI
--        begin
--        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--        from dim_azienda
--        where apn_n_registrazione = CodAzAllOrig
--        and provenienza = 'Approval Number'
--        and  DAT_FIN_VLD_TEC is null;
--
--               ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--               ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--       exception
--         when no_data_found then
--
--             select COUNT(1)
--             into checkOrigine
--                from dim_azienda
--                where apn_n_registrazione = CodAzAllOrig
--                and provenienza = 'Numero di Registrazione'
--                and  DAT_FIN_VLD_TEC is null;
--
--            if checkOrigine>0 then
--
--                select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--                    into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--                    from dim_azienda
--                    where apn_n_registrazione = CodAzAllOrig
--                    and provenienza = 'Numero di Registrazione'
--                    and  DAT_FIN_VLD_TEC is null;
--
--                    ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--                    ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--            else
--                   ft_pnr.SK_CodAzAllOrig := -2;
--                   ft_pnr.SK_ACT_CodAzAllOrig := -2;
--            end if;
--
--        end;
--


--     ELSif SAMPPOINT = 'MS.B90.400'
--      then--TRASFORMAZIONE LATTA E PRODOTTI A BASE DI LATTE
--        begin
--        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--        from dim_azienda
--        where apn_n_registrazione = CodAzAllOrig
--        and provenienza = 'Approval Number'
--        and  DAT_FIN_VLD_TEC is null;
--
--               ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--        exception
--         when no_data_found then
--
--             select COUNT(1)
--             into checkOrigine
--                from dim_azienda
--                where apn_n_registrazione = CodAzAllOrig
--                and provenienza = 'Numero di Registrazione'
--                and  DAT_FIN_VLD_TEC is null;
--
--            if checkOrigine>0 then
--
--                select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--                    into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--                    from dim_azienda
--                    where apn_n_registrazione = CodAzAllOrig
--                    and provenienza = 'Numero di Registrazione'
--                    and  DAT_FIN_VLD_TEC is null;
--
--                    ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--                    ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--            else
--                   ft_pnr.SK_CodAzAllOrig := -2;
--                   ft_pnr.SK_ACT_CodAzAllOrig := -2;
--            end if;
--
--        end;
--
--
--     ELSif SAMPPOINT = 'MS.060.400'
--      then--DISTRIBUTORI LATTE CRUDO
--        begin
--        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--        from dim_azienda
--        where apn_n_registrazione = CodAzAllOrig
--        and provenienza = 'Approval Number'
--        and  DAT_FIN_VLD_TEC is null;
--
--                ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--        exception
--         when no_data_found then
--
--             select COUNT(1)
--             into checkOrigine
--                from dim_azienda
--                where apn_n_registrazione = CodAzAllOrig
--                and provenienza = 'Numero di Registrazione'
--                and  DAT_FIN_VLD_TEC is null;
--
--            if checkOrigine>0 then
--
--                select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--                    into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--                    from dim_azienda
--                    where apn_n_registrazione = CodAzAllOrig
--                    and provenienza = 'Numero di Registrazione'
--                    and  DAT_FIN_VLD_TEC is null;
--
--                    ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--                    ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--            else
--                   ft_pnr.SK_CodAzAllOrig := -2;
--                   ft_pnr.SK_ACT_CodAzAllOrig := -2;
--            end if;
--
--        end;
--
--     ELSif SAMPPOINT = 'MS.B80.600'
--      then--MERCATO ITTICO
--        begin
--        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--        from dim_azienda
--        where apn_n_registrazione = CodAzAllOrig
--        and provenienza = 'Approval Number'
--        and  DAT_FIN_VLD_TEC is null;
--
--               ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--       exception
--         when no_data_found then
--
--             select COUNT(1)
--             into checkOrigine
--                from dim_azienda
--                where apn_n_registrazione = CodAzAllOrig
--                and provenienza = 'Numero di Registrazione'
--                and  DAT_FIN_VLD_TEC is null;
--
--            if checkOrigine>0 then
--
--                select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--                    into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--                    from dim_azienda
--                    where apn_n_registrazione = CodAzAllOrig
--                    and provenienza = 'Numero di Registrazione'
--                    and  DAT_FIN_VLD_TEC is null;
--
--                    ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--                    ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--            else
--                   ft_pnr.SK_CodAzAllOrig := -2;
--                   ft_pnr.SK_ACT_CodAzAllOrig := -2;
--            end if;
--
--        end;
--
--
--     ELSif SAMPPOINT = 'MS.B80.500'
--      then--IMPIANTO TRASFORMAZIONE PRODOTTI PESCA
--        begin
--        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--        from dim_azienda
--        where apn_n_registrazione = CodAzAllOrig
--        and provenienza = 'Approval Number'
--        and  DAT_FIN_VLD_TEC is null;
--
--               ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--                ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--        exception
--         when no_data_found then
--
--             select COUNT(1)
--             into checkOrigine
--                from dim_azienda
--                where apn_n_registrazione = CodAzAllOrig
--                and provenienza = 'Numero di Registrazione'
--                and  DAT_FIN_VLD_TEC is null;
--
--            if checkOrigine>0 then
--
--                select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
--                    into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
--                    from dim_azienda
--                    where apn_n_registrazione = CodAzAllOrig
--                    and provenienza = 'Numero di Registrazione'
--                    and  DAT_FIN_VLD_TEC is null;
--
--                    ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
--                    ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
--
--            else
--                   ft_pnr.SK_CodAzAllOrig := -2;
--                   ft_pnr.SK_ACT_CodAzAllOrig := -2;
--            end if;
--
--        end;


     else
      --SAMPPOINT non riconosciuto
        begin
         select sk_azienda , sk_act_azienda, RAGSOC,VIA_PIAZ,CITTA,PROVINCIA--  upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
         into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
         from dim_azienda
         where apn_n_registrazione = CodAzAllOrig
         and provenienza = 'SAMPOINT' --????????????
         and  DAT_FIN_VLD_TEC is null;


             if upper(rec_azienda.RAGSOC) = upper(RAGSOC)
                and upper(rec_azienda.VIA_PIAZ) = upper(VIA_PIAZ)
                and upper(rec_azienda.CITTA) = upper(APPO_CITTA)
                and upper(rec_azienda.PROVINCIA) = upper(PROVINCIA) THEN

                    ft_pnr.SK_CodAzAllOrig := rec_azienda.sk_azienda;
                    ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
                     --ft_pnr.SK_CodAzAllOrig := -2;
                     --ft_pnr.SK_ACT_CodAzAllOrig := -2;
              else
             --update dell'ultimo in dimensione
                update dim_azienda
                set dat_fin_vld_tec = adesso
                where sk_azienda = rec_azienda.sk_azienda;

                commit;
             --e inserimento del nuovo

                --select seq_dim_azienda.nextval into sk_ACT from dual;
                select seq_dim_azienda.nextval into sk from dual;
                --select stacco_sk(max(SK_AZIENDA), 1)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, dat_ini_vld_tec, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA)
                values (sk , rec_azienda.sk_act_azienda, 'SAMPOINT', CodAzAllOrig, adesso,RAGSOC, VIA_PIAZ, APPO_CITTA, PROVINCIA)
                ;

                commit;
              ft_pnr.SK_CodAzAllOrig := sk;
              ft_pnr.SK_ACT_CodAzAllOrig := rec_azienda.sk_act_azienda;
               --ft_pnr.SK_CodAzAllOrig := -2;
               --ft_pnr.SK_ACT_CodAzAllOrig := -2;

              end if;

        exception
        when no_data_found then
        --inserire nuovo
                select seq_dim_azienda.nextval into sk_ACT from dual;
                select seq_dim_azienda.nextval into sk from dual;
                --select stacco_sk(max(SK_AZIENDA), 1)  into sk_ACT from DIM_AZIENDA;
                --select stacco_sk(max(SK_AZIENDA), 2)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, dat_ini_vld_tec, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA)
                values (sk , sk_ACT, 'SAMPOINT', CodAzAllOrig, adesso, RAGSOC,  VIA_PIAZ, APPO_CITTA, PROVINCIA)
                ;

                commit;

              ft_pnr.SK_CodAzAllOrig := sk;
              ft_pnr.SK_ACT_CodAzAllOrig := sk_ACT;

--              ft_pnr.SK_CodAzAllOrig := -2;
--              ft_pnr.SK_ACT_CodAzAllOrig := -2;

           end;

     end if;

  END IF;

EXCEPTION
when errore then
        --desc_errore := substr(sqlerrm,1,4000);
        raise;

WHEN OTHERS THEN
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := desc_errore || substr('ERRORE ricerca sulla dimensione : '||nome_dimensione||' - '||sqlerrm,1,4000);
        raise;

END PRC_GET_SK_CODAZALLORIG_NEW;



FUNCTION FNC_GET_SK_GRP_ACTION_REG (  conc in varchar2--,
                                      --sk_find out number
                                    ) return number is

  ret_val NUMBER;


begin
if conc is not null then
    begin
    --ricerco campo_conc nella dimensione
    --se la trovo tiro fuori la sk relativa
    select SK_GRP_ACTION_REG into ret_val from dim_GRP_ACTION_REG
    where DES_GRP_ACTION_REG = CONC;
    --se non la trovo inserisco il nuovo valore di campo_conc in dimensione e tiro fuori la sk relativa

    return ret_val;
    exception
    when no_data_found then
    --select seq_dim_GRP_ACTION_REG.nextval into ret_val from dual;
    select stacco_sk(max(SK_GRP_ACTION_REG), 1)  into ret_val from dim_GRP_ACTION_REG;

    insert into dim_GRP_ACTION_REG
    (SK_GRP_ACTION_REG, DES_GRP_ACTION_REG, DUP_TEC, NUP_TEC, DCR_TEC, PCR_TEC)
    values(ret_val, CONC, null, 0, adesso, 'PKG_DWH_DET_FSALM.FNC_GET_SK_GRP_ACTION_REG');
    --ft_pnr.SK_GRP_ACTION_REG := sk;

    return ret_val;

    end;
else
ret_val := -1 ;
 return ret_val;
end if;

exception
when others then
      desc_errore := substr('ERRORE Aggiornamento dimensione : '||'DIM_GRP_ACTION_REG'||' - '||SQLERRM,1,4000);
      raise errore;

END FNC_GET_SK_GRP_ACTION_REG;



procedure prc_dim(Param in varchar2) is
begin
    prc_dim_anlymd            (null);
    prc_dim_anlytyp            (null);
    prc_dim_asl             (null);
    prc_dim_azienda         (null);
    prc_DIM_CONCLUS         (null);
    prc_dim_country         (null);
    prc_dim_exprres         (null);
    prc_dim_laboratori      (null);

    commit;

    prc_dim_legref          (null);
    prc_dim_lmttyp          (null);
    prc_dim_mdacc           (null);
    prc_dim_modallev        (null);
    prc_dim_MTX_VMPR_IT     (null);
    prc_dim_mtxtyp          (null);
    prc_dim_nonidon         (null);
    prc_DIM_PARAM_VMPR_IT   (null);

    commit;

    prc_dim_paramtyp        (null);
    prc_DIM_POSNEG          (null);
    prc_dim_progtyp         (null);
    prc_dim_reg             (null);
    prc_dim_reseval         (null);
    prc_dim_samplr          (null);
    prc_dim_sampmd          (null);
    prc_dim_sampstr         (null);

    commit;

    prc_dim_sampuntyp       (null);
    prc_DIM_SMPNT_ITA       (null);
    prc_dim_tipocampo       (null);
    prc_dim_unit            (null);
    prc_dim_valtyp          (null);
    prc_DIM_AETATE          (null);
    prc_DIM_ACTION          (null);

    commit;

    prc_dim_anagrafica_animal_age       (null);
    prc_dim_anagrafica_cookext            (null);
    prc_dim_anagrafica_gen          (null);
    prc_DIM_anagrafica_gender         (null);
    prc_DIM_anagrafica_ingred          (null);
    prc_dim_anagrafica_legis       (null);
    prc_dim_anagrafica_packformat            (null);
    prc_dim_anagrafica_packmat         (null);
    prc_DIM_anagrafica_part_nature          (null);
    prc_dim_anagrafica_partconsum          (null);
    prc_dim_anagrafica_place       (null);

    commit;

    prc_dim_anagrafica_proces           (null);
    prc_dim_anagrafica_prod_meth          (null);
    prc_DIM_anagrafica_qualinfo          (null);
    prc_DIM_anagrafica_report         (null);
    prc_dim_anagrafica_reproductiv      (null);
    prc_dim_anagrafica_source            (null);
    prc_dim_anagrafica_source_com            (null);
    prc_dim_anagrafica_target          (null);
    prc_DIM_anagrafica_use          (null);

    commit;

    prc_DIM_LABACC(NULL);
    PRC_DIM_PROGID(NULL);
    PRC_DIM_ANLYREFMD(NULL);
    prc_DIM_YESNO(NULL);
	prc_DIM_FARAREA(NULL);

    commit;

    PRC_DIM_PARAM           (NULL);
	commit;

PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'FINE CARICAMENTO DIMENSIONI',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );
exception
when others then
      desc_errore := substr('ERRORE Aggiornamento dimensioni - '||SQLERRM || '-' || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE() ,1,4000);
      raise errore;
end prc_dim;


--fatto di dettaglio esteso:
procedure prc_ft_esteso_det_pnr (TEC_KEY_REC_VLD in number, samp_date_VLD in date, VLD_FLG_VLD in varchar2, VALIDATO_VLD in varchar2, VALIDATO_SEMESTRALE_VLD in varchar2) is
  --primo_loop boolean;
  sk_trovata integer;
  --rec_az_vld_in r_dim_azienda;

  begin

    --
    --

/*
  PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'modifiche x action',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

*/
    --primo_loop := true;
    for mdfch in (  select
                    TEC_KEY_REC, ID_ACTION,
                    ID_VLD, NUMERO_UNITA, UNITA_DI_MISURA,
                    ID_REGIONE, samp_date_VLD samp_date
                    --VLD_FLG_VLD, VALIDATO_VLD,
                    --VALIDATO_SEMESTRALE_VLD
                    from ACTTAKENCODE
                    where id_vld = TEC_KEY_REC_VLD
                  )
    loop

      --ricavare le sk
      --if primo_loop = true then


      --refresh sn_vld
/*      DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.SN_vld_delta_action_samp_date'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE); */
/*     DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.SN_vld_delta_DAT_UPLOAD'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);       */


/*
  PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'CARICAMENTO_BULK x action',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );
 */
      --ACTION_BULK_samp_date(null);
      --CARICAMENTO_BULK_DAT_UPLOAD(null);



      --primo_loop := false;
      --end if;

ft_esteso_pnr.sk_reg := FNC_GET_SK_GENERICA ( BK_dim_reg_ID, mdfch.ID_REGIONE,
                          mdfch.ID_REGIONE
                          ,
                          'ID_REGIONE'
                         );

ft_esteso_pnr.sk_act_reg := FNC_GET_SK_act_GENERICA ( BK_dim_reg_ID, mdfch.ID_REGIONE,
                          mdfch.ID_REGIONE
                          ,
                          'ID_REGIONE'
                         );



ft_esteso_pnr.SK_ACTION := FNC_GET_SK_GENERICA ( BK_DIM_ACTION,
                                      mdfch.ID_ACTION,
                                      mdfch.ID_ACTION||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ID_ACTION'
                                    );


ft_esteso_pnr.SK_ACT_ACTION := FNC_GET_SK_act_GENERICA ( BK_DIM_ACTION,
                                      mdfch.ID_ACTION,
                                      mdfch.ID_ACTION||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ID_ACTION'
                                    );

/*      ft_pnr.sk_regcode := FNC_GET_SK_GENERICA ( BK_dim_reg,
                          mdfch.REGCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          'REGCODE'
                         );

      ft_pnr.sk_tipocampo := FNC_GET_SK_GENERICA ( BK_dim_tipocampo,
                          mdfch.TIPCAMP||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          'TIPCAMP'
                         );
 */
--
--









/*

--ricerco le tec_key rec che differiscono


for ext in (
select a.tec_key_rec,
a.ACTION, a.ID_VLD, a.NUMERO_UNITA, a.UNITA_DI_MISURA, a.COD_REG from ACTTAKENCODE a
--where a.ID_VLD = mdfch.tec_key_rec
minus
select ante.tec_key_rec,
ante.ACTION, ante.ID_VLD, ante.NUMERO_UNITA, ante.UNITA_DI_MISURA, ante.COD_REG from ACTTAKENCODE ante
)
--ricerco id_vld nel fatto esteso
--se lo trovo disabilito i record relativi e inserisco
loop
    update ft_esteso_action
    set vld_flg = 'U',
        DUP_TEC = adesso,
        NUP_TEC = nvl(NUP_TEC,0) + 1
    --
    --
    where ID_VLD = mdfch.TEC_KEY_REC
      and vld_flg not in('U','D');


--


end loop;
*/







insert into FT_ESTESO_ACTION
    ( TEC_KEY_REC, SK_ACTION, SK_ACT_ACTION,
    ID_VLD, M_NUMERO_UNITA, DG_UNITA_DI_MISURA,
    SK_REG, SK_ACT_REG,
    VLD_FLG, VALIDATO,
    DUP_TEC, NUP_TEC, DCR_TEC, PCR_TEC,
    VALIDATO_SEMESTRALE
    )
    values
    (
    mdfch.TEC_KEY_REC, ft_esteso_pnr.SK_ACTION, ft_esteso_pnr.SK_ACT_ACTION,
    TEC_KEY_REC_VLD, mdfch.NUMERO_UNITA, mdfch.UNITA_DI_MISURA,
    ft_esteso_pnr.sk_reg, ft_esteso_pnr.sk_act_reg,
    VLD_FLG_VLD, VALIDATO_VLD,
    null, null, adesso, 'PKG_DWH_DET_FSALM.prc_ft_esteso_det_pnr',
    VALIDATO_SEMESTRALE_VLD
    );




    end loop;




    --controllo
/*    select (select count(1) num_r_vld from vld a, ACTTAKENCODE b
            where a.vld_flg = '1'
              and a.tec_key_rec = b.id_vld(+)) -
           (select count(1) num_r_ft from ft_esteso_action where vld_flg = 'I') into differenza from dual;

    if (differenza) <> 0 then
    desc_errore := substr('ERRORE Caricamento del Fatto : '||'ft_esteso_action'||' - '||'dovuto al controllo finale',1,4000);
    raise errore;
    end if;*/


/*
  PRC_INS_TAB_LOG_ETL(
                  'LOG',
                  null,
                  'FINE OK',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );
*/

--begin
  -- Initialization
  --<Statement>;

EXCEPTION
when errore then
rollback;
  PRC_INS_TAB_LOG_ETL(
                  'ERRORE',
                  null,
                  desc_errore,
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );


WHEN OTHERS THEN
rollback;
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr(sqlerrm,1,4000);
  PRC_INS_TAB_LOG_ETL(
                  'ERRORE',
                  null,
                  null,
                  sqlcode,
                  desc_errore--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

  end prc_ft_esteso_det_pnr;



--fatto di dettaglio:
procedure prc_ft_det_pnr (Param in varchar2) is
  primo_loop boolean;
  sk_trovata integer;
  id_trovata integer;
  rec_az_vld_in r_dim_azienda;

  begin
  PRC_INS_TAB_LOG_ETL(
                  'LOG',
                  null,
                  'INIZIO',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );
  --refresh sn_vld



    --aggiornamento dimensioni
    PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'aggiornamento dimensioni',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );




    --
    --



    prc_dim_GRP_ACTION_REG (null);

    prc_dim(null);


    PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'INIZIO FATTI',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );


  DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.sn_vld'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);

  DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.sn_vld_delta'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);




  CARICAMENTO_BULK_REL(null);




---------------------------------------------------------------------------

    --cancellazioni
    PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'cancellazioni',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

    for cnclzn in (  select TEC_KEY_REC --chiave tecnica gestionale
                     from ft_det_vld where vld_flg not in('U','D')
                     minus
                     select TEC_KEY_REC
                     from sn_vld
                     --where -----------
                  )
    loop

    update ft_det_vld
    set vld_flg = 'D',
        DUP_TEC = adesso,
        NUP_TEC = nvl(NUP_TEC,0) + 1
    where TEC_KEY_REC = cnclzn.TEC_KEY_REC
      and vld_flg not in('U','D');



    update FT_ESTESO_ACTION
    set vld_flg = 'D',
        DUP_TEC = adesso,
        NUP_TEC = nvl(NUP_TEC,0) + 1
    where ID_VLD = cnclzn.TEC_KEY_REC
      and vld_flg not in('U','D');


    end loop;





    --modifiche







    PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'modifiche',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

    primo_loop := true;
    for mdfch in (  select * --tutti i campi della tebella
                     from sn_vld_delta order by DAT_UPLOAD,  ID_REC
                     --where -----------
                     --minus
                     --select *
                     --from sn_vld_ante
                  )
    loop

      --ricavare le sk
      if primo_loop = true then


      --refresh sn_vld
      DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.SN_vld_delta_sampdate'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);
/*     DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.SN_vld_delta_DAT_UPLOAD'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);       */



      PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'CARICAMENTO_BULK',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

      CARICAMENTO_BULK_sampdate(null);
      --CARICAMENTO_BULK_DAT_UPLOAD(null);



      primo_loop := false;
      end if;

---------------------------------------------------------------------------
-- controlli sulle REL per i valori interessati presenti su SN_VLD_DELTA
---------------------------------------------------------------------------

/*select EVALCODE||
SAMPTKASSESS from
REL_EVALCODE_SMPASSESS*/


/*

      id_trovata := FNC_GET_rel_GENERICA ( BK_dim_REL_EVALCODE_SMPASSESS,
                          mdfch.EVALCODE||' - '||mdfch.EVALINFO_SAMPTKASSES,
                          'REL_EVALCODE_SMPASSESS'
                         );
      if id_trovata < 0 then
       desc_errore := substr('ERRORE ricerca id nella relazionale : '||'REL_EVALCODE_SMPASSESS'||' per il valore '||mdfch.EVALCODE|| mdfch.EVALINFO_SAMPTKASSES,1,4000);
       raise errore;
      end if;


--
--






*/

      ft_pnr.TEC_KEY_REC := mdfch.TEC_KEY_REC;

      ft_pnr.ID_TRATTAMENTO := mdfch.ID_TRATTAMENTO;

      ft_pnr.ID_UPLOAD:= mdfch.ID_UPLOAD;

      ft_pnr.Y_RIF := mdfch.Y_RIF;

      ft_pnr.NOM_PERI := mdfch.NOM_PERI;

      ft_pnr.ID_MITTENTE := mdfch.ID_MITTENTE;

       ft_pnr.ANM := mdfch.ANM;

       ft_pnr.ID_REC := mdfch.ID_REC;

       ft_pnr.DAT_UPLOAD :=  mdfch.DAT_UPLOAD;

       ft_pnr.DG_NUMVERBALE :=  nvl(mdfch.NUMVERBALE,'ND');

       ft_pnr.SK_REGCODE := FNC_GET_SK_GENERICA ( BK_DIM_REG,
                                      mdfch.REGCODE,
                                      mdfch.REGCODE||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'REGCODE'
                                    );

       --ft_pnr.DG_FLTYPE := nvl(mdfch.FLTYPE,'ND');

       ft_pnr.DG_OPTYPE := nvl(mdfch.OPTYPE,'ND');

       ft_pnr.SK_TIPOCAMPO := FNC_GET_SK_GENERICA ( BK_DIM_TIPOCAMPO,
                                      mdfch.TIPCAMP,
                                      mdfch.TIPCAMP||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'TIPCAMP'
                                    );

       ft_pnr.SK_ASL_SAMPORG := FNC_GET_SK_GENERICA ( BK_DIM_ASL,
                                      mdfch.SAMPORG,
                                      mdfch.SAMPORG||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPORG'
                                    );

ft_pnr.SK_LEGREF := FNC_GET_SK_GENERICA ( BK_DIM_LEGREF,
                                      mdfch.PROGLEGALREF,
                                      mdfch.PROGLEGALREF||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PROGLEGALREF'
                                    );

ft_pnr.SK_SAMPSTR :=  FNC_GET_SK_GENERICA ( BK_DIM_SAMPSTR,
                                      mdfch.SAMPSTRATEGY,
                                      mdfch.SAMPSTRATEGY ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPSTRATEGY'
                                    );

ft_pnr.SK_PROGTYP :=  FNC_GET_SK_GENERICA ( BK_DIM_PROGTYP,
                                      mdfch.PROGTYPE,
                                      mdfch.PROGTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PROGTYPE'
                                    );

ft_pnr.SK_SAMPMD :=  FNC_GET_SK_GENERICA ( BK_DIM_SAMPMD,
                                      mdfch.SAMPMETHOD,
                                      mdfch.SAMPMETHOD ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMETHOD'
                                    );

ft_pnr.SK_SAMPLR :=  FNC_GET_SK_GENERICA ( BK_DIM_SAMPLR,
                                      mdfch.SAMPLER,
                                      mdfch.SAMPLER ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPLER'
                                    );

ft_pnr.SK_SMPNT_ITA :=  FNC_GET_SK_GENERICA ( BK_DIM_SMPNT_ITA,
                                      mdfch.SAMPPOINT,
                                      mdfch.SAMPPOINT ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'SAMPPOINT'
                                    );

ft_pnr.DG_PROGINFO_COM :=  nvl(mdfch.PROGINFO_COM,'ND');

ft_pnr.SK_SAMPUNTYP := FNC_GET_SK_GENERICA ( BK_DIM_SAMPUNTYP,
                                      mdfch.SAMPUNITTYPE,
                                      mdfch.SAMPUNITTYPE ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPUNITTYPE'
                                    );


ft_pnr.DG_SAMPUNIT_ANIMALID :=  nvl(mdfch.SAMPUNIT_ANIMALID,'ND');
--ft_pnr.FLG_SAMPEVENTINFO_COM :=  nvl(mdfch.SAMPEVENTINFO_COM,'ND');
--ft_pnr.DG_SAMPEVENTINFO_MEDICSTATUS := nvl(mdfch.SAMPEVENTINFO_MEDICSTATUS,'ND');

ft_pnr.SAMPID := mdfch.SAMPID;

ft_pnr.DG_SAMPINFO_ORIGSAMPID :=  nvl(mdfch.SAMPINFO_ORIGSAMPID,'ND');

ft_pnr.SK_ORIGREG := FNC_GET_SK_GENERICA ( BK_dim_REG,
                                      mdfch.ORIGREG,
                                      mdfch.ORIGREG||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ORIGREG'
                                    );

ft_pnr.DG_CODFISSAMPHOLDING := nvl(mdfch.CODFISSAMPHOLDING,'ND');

ft_pnr.DG_CODFISOWNER := nvl(mdfch.CODFISOWNER,'ND');

ft_pnr.FLG_SAMPIDONEO := nvl(mdfch.SAMPIDONEO,'ND');

ft_pnr.SK_MOTIVONONIDONEO := FNC_GET_SK_GENERICA ( BK_DIM_NONIDON,
                                      mdfch.MOTIVONONIDONEO,
                                      mdfch.MOTIVONONIDONEO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'MOTIVONONIDONEO'
                                    );

ft_pnr.DG_ALTROMOTIVONONIDONEO := nvl(mdfch.ALTROMOTIVONONIDONEO,'ND');

--ft_pnr.FLG_METODOPRODUZIONE := nvl(mdfch.METODOPRODUZIONE,'ND');

ft_pnr.SK_MODALITALLEVAMENTO :=  FNC_GET_SK_GENERICA ( BK_DIM_MODALLEV,
                                      mdfch.MODALITALLEVAMENTO,
                                      mdfch.MODALITALLEVAMENTO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'MODALITALLEVAMENTO'
                                    );

ft_pnr.SK_SAMPMATTYPE :=  FNC_GET_SK_GENERICA ( BK_DIM_MTXTYP,
                                      mdfch.SAMPMATTYPE,
                                      mdfch.SAMPMATTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATTYPE'
                                    );

ft_pnr.SK_SAMPMATCODE := FNC_GET_SK_GENERICA ( BK_DIM_REPORT,
                                      mdfch.SAMPMATCODE_BUILDING, --SAMPMATCODE
                                      mdfch.SAMPMATCODE_BUILDING||' - '||to_char(mdfch.samp_date,'yyyymmdd'),     --SAMPMATCODE
                                      'SAMPMATCODE'
                                    );

ft_pnr.DG_SAMPMATTEXT := nvl(mdfch.SAMPMATTEXT,'ND');

ft_pnr.SK_ORIGCOUNTRY := FNC_GET_SK_GENERICA ( BK_DIM_COUNTRY,
                                      mdfch.ORIGCOUNTRY,
                                      mdfch.ORIGCOUNTRY||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ORIGCOUNTRY'
                                    );

ft_pnr.SK_AETATE :=  FNC_GET_SK_GENERICA ( BK_DIM_AETATE,
                                      mdfch.AETATE,
                                      mdfch.AETATE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'AETATE'
                                    );

/*ft_pnr.SK_ANALYSISDATE :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.analysisdate,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.analysisdate,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'ANALYSISDATE'
                                    );   --DIM_TEMPO

ft_pnr.SK_SAMPAN_INFO_COMPDATE :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.SAMPAN_INFO_COMPDATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.SAMPAN_INFO_COMPDATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'SAMPAN_INFO_COMPDATE'
                                    );  --DIM_TEMPO*/

ft_pnr.DG_SAMPAN_INFO_COM :=   nvl(mdfch.SAMPAN_INFO_COM,'ND');

ft_pnr.SK_LABANALISI := FNC_GET_SK_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABANALISI,
                                      mdfch.LABANALISI||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABANALISI'
                                    );

/*ft_pnr.SK_LABID  := FNC_GET_SK_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABID,
                                      mdfch.LABID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABID'
                                    );  */

ft_pnr.SK_PARAMTYPE  := FNC_GET_SK_GENERICA ( BK_DIM_PARAMTYP,
                                      mdfch.PARAMTYPE,
                                      mdfch.PARAMTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PARAMTYPE'
                                    );






ft_pnr.SK_PARAMCODE := FNC_GET_SK_GENERICA ( BK_DIM_PARAM,
                                      mdfch.PARAMCODE,
                                      mdfch.PARAMCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PARAMCODE'
                                    );

ft_pnr.SK_ACT_PARAMCODE  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PARAM,
                                      mdfch.PARAMCODE,
                                      mdfch.PARAMCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PARAMCODE'
                                    );
                      IF ft_pnr.SK_PARAMCODE = -2
                      THEN

                                    ft_pnr.SK_PARAMCODE := FNC_GET_SK_GENERICA ( BK_DIM_PARAM_ITA,
                                         mdfch.PARAMCODE,
                                        mdfch.PARAMCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                        'PARAMCODE'
                                      );

                                    ft_pnr.SK_ACT_PARAMCODE  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PARAM_ITA,
                                        mdfch.PARAMCODE,
                                        mdfch.PARAMCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                         'PARAMCODE'
                                     );
                           IF ft_pnr.SK_PARAMCODE = -2
                           THEN

                                            ft_pnr.SK_PARAMCODE := FNC_GET_SK_GENERICA ( BK_DIM_PARAM_VMPR,
                                                mdfch.PARAMCODE,
                                                mdfch.PARAMCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                                'PARAMCODE'
                                            );

                                            ft_pnr.SK_ACT_PARAMCODE  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PARAM_VMPR,
                                                mdfch.PARAMCODE,
                                                mdfch.PARAMCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                                 'PARAMCODE'
                                            );

                           END IF;

                      END IF;







ft_pnr.DG_PARAMTEXT := nvl(mdfch.PARAMTEXT,'ND');

ft_pnr.SK_ANMETHTYPE := FNC_GET_SK_GENERICA ( BK_DIM_ANLYTYP,
                                      mdfch.ANMETHTYPE,
                                      mdfch.ANMETHTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMETHTYPE'
                                    );

ft_pnr.SK_ANMETHCODE := FNC_GET_SK_GENERICA ( BK_DIM_ANLYMD,
                                      mdfch.ANMETHCODE,
                                      mdfch.ANMETHCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMETHCODE'
                                    );

ft_pnr.DG_ANMETHTEXT := nvl(mdfch.ANMETHTEXT,'ND');

ft_pnr.SK_ACCREDPROC := FNC_GET_SK_GENERICA ( BK_DIM_MDACC,
                                      mdfch.ACCREDPROC,
                                      mdfch.ACCREDPROC||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ACCREDPROC'
                                    );

ft_pnr.SK_RESUNIT := FNC_GET_SK_GENERICA ( BK_DIM_UNIT,
                                      mdfch.RESUNIT,
                                      mdfch.RESUNIT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESUNIT'
                                    );

ft_pnr.M_RESLOD := mdfch.RESLOD; --MISURA

ft_pnr.M_RESLOQ := mdfch.RESLOQ; --MISURA

ft_pnr.M_CCALPHA := mdfch.CCALPHA; --MISURA

ft_pnr.M_CCBETA := mdfch.CCBETA; --MISURA

ft_pnr.M_RESVAL := mdfch.RESVAL;  --MISURA

ft_pnr.M_EXPRRESPERC_FATPERC := mdfch.EXPRRESPERC_FATPERC; --MISURA

ft_pnr.M_EXPRRESPERC_MOISTPERC := mdfch.EXPRRESPERC_MOISTPERC;  --MISURA

ft_pnr.M_EXPRRESPERC_ALCOHOLPERC := mdfch.EXPRRESPERC_ALCOHOLPERC;  --MISURA

ft_pnr.SK_EXPRRESTYPE := FNC_GET_SK_GENERICA ( BK_DIM_EXPRRES,
                                      mdfch.EXPRRESTYPE,
                                      mdfch.EXPRRESTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EXPRRESTYPE'
                                    );

ft_pnr.SK_RESQUALVALUE := FNC_GET_SK_GENERICA ( BK_DIM_POSNEG,
                                      mdfch.RESQUALVALUE,
                                      mdfch.RESQUALVALUE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESQUALVALUE'
                                    );

ft_pnr.SK_RESTYPE := FNC_GET_SK_GENERICA ( BK_DIM_VALTYP,
                                      mdfch.RESTYPE,
                                      mdfch.RESTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESTYPE'
                                    );

--ft_pnr.DG_RESINFO := nvl(mdfch.RESINFO,'ND');

ft_pnr.SK_RAPPROVADATE  :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.RAPPROVADATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.RAPPROVADATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'RAPPROVADATE'
                                    );  --DIM_TEMPO --DIM_TEMPO

ft_pnr.M_EVALLOWLIMIT := mdfch.EVALLOWLIMIT;

ft_pnr.SK_EVALLIMITTYPE := FNC_GET_SK_GENERICA ( BK_DIM_LMTTYP,
                                      mdfch.EVALLIMITTYPE,
                                      mdfch.EVALLIMITTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EVALLIMITTYPE'
                                    );

ft_pnr.SK_EVALCODE := FNC_GET_SK_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALCODE,
                                      mdfch.EVALCODE ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALCODE'
                                    );

ft_pnr.SK_EVALINFO_SAMPTKASSES := FNC_GET_SK_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALINFO_SAMPTKASSES,
                                      mdfch.EVALINFO_SAMPTKASSES ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALINFO_SAMPTKASSES'
                                    );

ft_pnr.SK_EVALINFO_CONCLUSION := FNC_GET_SK_GENERICA ( BK_DIM_CONCLUS,
                                      mdfch.EVALINFO_CONCLUSION,
                                      mdfch.EVALINFO_CONCLUSION ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALINFO_CONCLUSION'
                                    );

--ft_pnr.SK_GRP_ACTION_REG, --NON RIPORTATA ORIGINE SU EXCEL
ft_pnr.SK_ACT_REGCODE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_REG,
                                      mdfch.REGCODE,
                                      mdfch.REGCODE||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'REGCODE'
                                    );

ft_pnr.SK_ACT_TIPOCAMPO := FNC_GET_SK_ACT_GENERICA ( BK_DIM_TIPOCAMPO,
                                      mdfch.TIPCAMP,
                                      mdfch.TIPCAMP||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'TIPCAMP'
                                    );

ft_pnr.SK_ACT_ASL_SAMPORG := FNC_GET_SK_ACT_GENERICA ( BK_DIM_ASL,
                                      mdfch.SAMPORG,
                                      mdfch.SAMPORG||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'SAMPORG'
                                    );

ft_pnr.SK_ACT_LEGREF := FNC_GET_SK_ACT_GENERICA ( BK_DIM_LEGREF,
                                      mdfch.PROGLEGALREF,
                                      mdfch.PROGLEGALREF||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'PROGLEGALREF'
                                    );

ft_pnr.SK_ACT_SAMPSTR := FNC_GET_SK_ACT_GENERICA ( BK_DIM_SAMPSTR,
                                      mdfch.SAMPSTRATEGY,
                                      mdfch.SAMPSTRATEGY||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'SAMPSTRATEGY'
                                    );

ft_pnr.SK_ACT_PROGTYP := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PROGTYP,
                                      mdfch.PROGTYPE,
                                      mdfch.PROGTYPE||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'PROGTYPE'
                                    );

ft_pnr.SK_ACT_SAMPMD := FNC_GET_SK_ACT_GENERICA ( BK_DIM_SAMPMD,
                                      mdfch.SAMPMETHOD,
                                      mdfch.SAMPMETHOD||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMETHOD'
                                    );

ft_pnr.SK_ACT_SAMPLR := FNC_GET_SK_ACT_GENERICA ( BK_DIM_SAMPLR,
                                      mdfch.SAMPLER,
                                      mdfch.SAMPLER ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPLER'
                                    );

ft_pnr.SK_ACT_SMPNT_ITA :=  FNC_GET_SK_ACT_GENERICA ( BK_DIM_SMPNT_ITA,
                                      mdfch.SAMPPOINT,
                                      mdfch.SAMPPOINT ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'SAMPPOINT'
                                    );

ft_pnr.SK_ACT_SAMPUNTYP := FNC_GET_SK_ACT_GENERICA ( BK_DIM_SAMPUNTYP,
                                      mdfch.SAMPUNITTYPE,
                                      mdfch.SAMPUNITTYPE ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPUNITTYPE'
                                    );

ft_pnr.SK_ACT_ORIGREG := FNC_GET_SK_ACT_GENERICA ( BK_dim_REG,
                                      mdfch.ORIGREG,
                                      mdfch.ORIGREG||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ORIGREG'
                                    );

ft_pnr.SK_ACT_MOTIVONONIDONEO  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_NONIDON,
                                      mdfch.MOTIVONONIDONEO,
                                      mdfch.MOTIVONONIDONEO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'MOTIVONONIDONEO'
                                    );

ft_pnr.SK_ACT_MODALITALLEVAMENTO  :=  FNC_GET_SK_ACT_GENERICA ( BK_DIM_MODALLEV,
                                      mdfch.MODALITALLEVAMENTO,
                                      mdfch.MODALITALLEVAMENTO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'MODALITALLEVAMENTO'
                                    );

ft_pnr.SK_ACT_SAMPMATTYPE :=  FNC_GET_SK_ACT_GENERICA ( BK_DIM_MTXTYP,
                                      mdfch.SAMPMATTYPE,
                                      mdfch.SAMPMATTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATTYPE'
                                    );

ft_pnr.SK_ACT_SAMPMATCODE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_REPORT,
                                      mdfch.SAMPMATCODE_BUILDING, --SAMPMATCODE
                                      mdfch.SAMPMATCODE_BUILDING||' - '||to_char(mdfch.samp_date,'yyyymmdd'),     --SAMPMATCODE
                                      'SAMPMATCODE'
                                    );

ft_pnr.SK_ACT_ORIGCOUNTRY := FNC_GET_SK_ACT_GENERICA ( BK_DIM_COUNTRY,
                                      mdfch.ORIGCOUNTRY,
                                      mdfch.ORIGCOUNTRY||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ORIGCOUNTRY'
                                    );

ft_pnr.SK_ACT_AETATE  :=  FNC_GET_SK_ACT_GENERICA ( BK_DIM_AETATE,
                                      mdfch.AETATE,
                                      mdfch.AETATE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'AETATE'
                                    );

ft_pnr.SK_ACT_LABANALISI := FNC_GET_SK_ACT_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABANALISI,
                                      mdfch.LABANALISI||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABANALISI'
                                    );

/*ft_pnr.SK_ACT_LABID   := FNC_GET_SK_ACT_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABID,
                                      mdfch.LABID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABID'
                                    );  */

ft_pnr.SK_ACT_PARAMTYPE  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PARAMTYP,
                                      mdfch.PARAMTYPE,
                                      mdfch.PARAMTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PARAMTYPE'
                                    );

ft_pnr.SK_ACT_ANMETHTYPE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_ANLYTYP,
                                      mdfch.ANMETHTYPE,
                                      mdfch.ANMETHTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMETHTYPE'
                                    );

ft_pnr.SK_ACT_ANMETHCODE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_ANLYMD,
                                      mdfch.ANMETHCODE,
                                      mdfch.ANMETHCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMETHCODE'
                                    );

ft_pnr.SK_ACT_ACCREDPROC  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_MDACC,
                                      mdfch.ACCREDPROC,
                                      mdfch.ACCREDPROC||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ACCREDPROC'
                                    );

ft_pnr.SK_ACT_RESUNIT  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_UNIT,
                                      mdfch.RESUNIT,
                                      mdfch.RESUNIT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESUNIT'
                                    );

ft_pnr.SK_ACT_EXPRRESTYPE  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_EXPRRES,
                                      mdfch.EXPRRESTYPE,
                                      mdfch.EXPRRESTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EXPRRESTYPE'
                                    );

ft_pnr.SK_ACT_RESQUALVALUE:= FNC_GET_SK_ACT_GENERICA ( BK_DIM_POSNEG,
                                      mdfch.RESQUALVALUE,
                                      mdfch.RESQUALVALUE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESQUALVALUE'
                                    );

ft_pnr.SK_ACT_RESTYPE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_VALTYP,
                                      mdfch.RESTYPE,
                                      mdfch.RESTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESTYPE'
                                    );

ft_pnr.SK_ACT_EVALLIMITTYPE:= FNC_GET_SK_ACT_GENERICA ( BK_DIM_LMTTYP,
                                      mdfch.EVALLIMITTYPE,
                                      mdfch.EVALLIMITTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EVALLIMITTYPE'
                                    );

ft_pnr.SK_ACT_EVALCODE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALCODE,
                                      mdfch.EVALCODE ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALCODE'
                                    );

ft_pnr.SK_ACT_EVALINFO_SAMPTKASSES := FNC_GET_SK_ACT_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALINFO_SAMPTKASSES,
                                      mdfch.EVALINFO_SAMPTKASSES ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALINFO_SAMPTKASSES'
                                    );

ft_pnr.SK_ACT_EVALINFO_CONCLUSION := FNC_GET_SK_ACT_GENERICA ( BK_DIM_CONCLUS,
                                      mdfch.EVALINFO_CONCLUSION,
                                      mdfch.EVALINFO_CONCLUSION ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALINFO_CONCLUSION'
                                    );

ft_pnr.VLD_FLG := mdfch.VLD_FLG;

ft_pnr.VALIDATO := mdfch.VALIDATO;

--ft_pnr.DUP_TEC := mdfch.DUP_TEC;

--ft_pnr.NUP_TEC := mdfch.NUP_TEC;

ft_pnr.ID_UPLOAD_STO := mdfch.ID_UPLOAD_STO;

ft_pnr.ID_REC_STO := mdfch.ID_REC_STO;

ft_pnr.DCR_TEC := adesso;

ft_pnr.PCR_TEC :=  'PKG_DWH_DET_FSALM.prc_ft_det_pnr';--mdfch.PCR_TEC;

ft_pnr.VALIDATO_SEMESTRALE := mdfch.VALIDATO_SEMESTRALE;


ft_pnr.SK_sampdate :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.samp_date,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.samp_date,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'samp_date'
                                    );

ft_pnr.SK_SAMPACCDATE :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.SAMPACC_DATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.SAMPACC_DATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'SAMPACCDATE'
                                    );

      ft_pnr.SK_CODAZALLORIG := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.CODAZALLORIG,
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          mdfch.CODAZALLORIG||' - '||'Numero di Registrazione',
                          'CODAZALLORIG'
                         );
      ft_pnr.sk_ACT_CODAZALLORIG := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.CODAZALLORIG,
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          mdfch.CODAZALLORIG||' - '||'Numero di Registrazione',
                          'CODAZALLORIG'
                         );
--
--
--ricerca nell'anagrafica aziende x SAMPUNIT_SAMPHOLDINGID

     PRC_GET_SK_CODAZALLORIG_NEW( mdfch.SAMPPOINT ,
                              mdfch.CODAZALLORIG ,
                              mdfch.RAGSOC,
                              mdfch.VIA_PIAZ ,
                              mdfch.CITTA ,
                              mdfch.PROVINCIA,
                                  'DIM_AZIENDA'
                                  );


      PRC_GET_SK_AZIENDA( mdfch.SAMPPOINT ,
                              mdfch.OSAID ,
                              --mdfch.SAMPUNIT_SLAUGHTERHOUSEID  ,
                              --mdfch.SAMPUNIT_SAMPPLANTID  ,
                              --rec_az_vld ,
                              mdfch.RAGSOC,
                              mdfch.VIA_PIAZ ,
                              mdfch.CITTA ,
                              mdfch.PROVINCIA,
                                  'DIM_AZIENDA'
                                  );
/*
      --
      if mdfch.SAMPPOINT = 'MS.040.720' and mdfch.SAMPUNIT_SAMPHOLDINGID is not null
      then--acquacoltura
      --ricerca fra le aziende di acquacoltura
        begin
        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
        from dim_azienda
        where apn_n_registrazione = mdfch.SAMPUNIT_SAMPHOLDINGID
        and provenienza = 'acquacoltura'
        and  DAT_FIN_VLD_TEC is null;

            if rec_azienda.RAGSOC = upper(mdfch.RAGSOC)
            and rec_azienda.VIA_PIAZ = upper(mdfch.VIA_PIAZ)
            and rec_azienda.CITTA = upper(mdfch.CITTA)
            and rec_azienda.PROVINCIA = upper(mdfch.PROVINCIA) then

              ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := rec_azienda.sk_azienda;
              ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := rec_azienda.sk_act_azienda;

            else
            --update dell'ultimo in dimensione
                update dim_azienda
                set dat_fin_vld_tec = adesso
                where sk_azienda = rec_azienda.sk_azienda;
             --e inserimento del nuovo

                --select seq_dim_azienda.nextval into sk_ACT from dual;
                --select seq_dim_azienda.nextval into sk from dual;
                select stacco_sk(max(SK_AZIENDA), 1)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_fin_vld_tec)
                values (sk , rec_azienda.sk_act_azienda, 'acquacoltura', mdfch.SAMPUNIT_SAMPHOLDINGID, mdfch.RAGSOC,  mdfch.VIA_PIAZ, mdfch.CITTA, mdfch.PROVINCIA, adesso)
                ;
              ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := sk;
              ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := rec_azienda.sk_act_azienda;

            end if;
        exception
        when no_data_found then
        --inserire nuovo
                --select seq_dim_azienda.nextval into sk_ACT from dual;
                --select seq_dim_azienda.nextval into sk from dual;
                select stacco_sk(max(SK_AZIENDA), 1)  into sk_ACT from DIM_AZIENDA;
                select stacco_sk(max(SK_AZIENDA), 2)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_fin_vld_tec)
                values (sk , sk_ACT, 'acquacoltura', mdfch.SAMPUNIT_SAMPHOLDINGID, mdfch.RAGSOC,  mdfch.VIA_PIAZ, mdfch.CITTA, mdfch.PROVINCIA, adesso)
                ;
              ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := sk;
              ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := sk_ACT;


        end;

      elsif mdfch.SAMPPOINT = 'MS.040.720' and mdfch.SAMPUNIT_SAMPHOLDINGID is null
      then
      desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_AZIENDA'||' - '||'SAMPUNIT_SAMPHOLDINGID is null',1,4000);
      raise errore;

      elsif mdfch.SAMPPOINT = 'MS.040.710' --allevamento
      then

      ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPHOLDINGID,
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||'Numero di Registrazione',
                          'SAMPUNIT_SAMPHOLDINGID'
                         );
      ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPHOLDINGID,
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||'Numero di Registrazione',
                          'SAMPUNIT_SAMPHOLDINGID'
                         );


      else--altro

        if nvl(length(mdfch.SAMPUNIT_SAMPHOLDINGID),0) > 6 then

        ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPHOLDINGID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            substr(mdfch.SAMPUNIT_SAMPHOLDINGID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );
        ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPHOLDINGID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            substr(mdfch.SAMPUNIT_SAMPHOLDINGID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );

        else

        ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPHOLDINGID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SAMPHOLDINGID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );
        ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA,mdfch.SAMPUNIT_SAMPHOLDINGID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SAMPHOLDINGID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );

        end if;
      end if;


--ricerca nell'anagrafica aziende x SAMPUNIT_SLAUGHTERHOUSEID
        if nvl(length(mdfch.SAMPUNIT_SLAUGHTERHOUSEID),0) > 6 then

        ft_pnr.sk_SAMPUNIT_SLAUGHTERHOUSEID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SLAUGHTERHOUSEID,1,6))
                            substr(mdfch.SAMPUNIT_SLAUGHTERHOUSEID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SLAUGHTERHOUSEID'
                           );
        ft_pnr.sk_ACT_SAMPUN_SLAUGHTERHOUSEID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SLAUGHTERHOUSEID,1,6))
                            substr(mdfch.SAMPUNIT_SLAUGHTERHOUSEID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                           'SAMPUNIT_SLAUGHTERHOUSEID'
                           );


        else

        ft_pnr.sk_SAMPUNIT_SLAUGHTERHOUSEID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SLAUGHTERHOUSEID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SLAUGHTERHOUSEID'
                           );
        ft_pnr.sk_ACT_SAMPUN_SLAUGHTERHOUSEID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SLAUGHTERHOUSEID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SLAUGHTERHOUSEID'
                           );

        end if;


--ricerca nell'anagrafica aziende x SAMPUNIT_SAMPPLANTID

      --
      if mdfch.SAMPPOINT = 'MS.040.500' and mdfch.SAMPUNIT_SAMPPLANTID is not null
      then--smielatura
      rec_az_vld_in.APN_N_REGISTRAZIONE := mdfch.SAMPUNIT_SAMPPLANTID;
      rec_az_vld_in.RAGSOC := mdfch.RAGSOC;
      rec_az_vld_in.VIA_PIAZ := mdfch.VIA_PIAZ;
      rec_az_vld_in.CITTA := mdfch.CITTA;
      rec_az_vld_in.PROVINCIA := mdfch.PROVINCIA;

      sk_trovata:= FNC_GET_SK_AZIENDA_GENERICA ( 'smielatura',
                                      rec_az_vld_in,
                                      ft_pnr.sk_SAMPUNIT_SAMPPLANTID ,
                                      ft_pnr.sk_act_SAMPUNIT_SAMPPLANTID
                                    );



      elsif mdfch.SAMPPOINT = 'MS.040.720' and mdfch.SAMPUNIT_SAMPPLANTID is null
      then
      desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_AZIENDA'||' - '||'SAMPUNIT_SAMPPLANTID is null',1,4000);
      raise errore;

      else--altro

        if nvl(length(mdfch.SAMPUNIT_SAMPPLANTID),0) > 6 then

        ft_pnr.sk_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            substr(mdfch.SAMPUNIT_SAMPPLANTID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPPLANTID'
                           );
        ft_pnr.sk_ACT_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPPLANTID,1,6))
                            substr(mdfch.SAMPUNIT_SAMPPLANTID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                           'SAMPUNIT_SAMPPLANTID'
                           );



        else

        ft_pnr.sk_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SAMPPLANTID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPPLANTID'
                           );
        ft_pnr.sk_ACT_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SAMPPLANTID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPPLANTID'
                           );

        end if;

      end if;


*/














--aggiornamento e ricerca della sk nella DIM_GRP_ACTION_REG
/*ft_pnr.SK_GRP_ACTION_REG := FNC_GET_SK_GENERICA ( BK_dim_GRP_ACTION_REG,
                          mdfch.CAMPO_CONC||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          'GRP_ACTION_REG'
                         );*/

/*SELECT listagg (ACTION||' - '||COD_REG, ',') within group(order by COD_REG) CAMPO_CONC
FROM ACTTAKENCODE
WHERE ID_VLD = mdfch.tec_key_rec
GROUP BY ID_VLD
;*/
/*
begin
--ricerco campo_conc nella dimensione
--se la trovo tiro fuori la sk relativa
select SK_GRP_ACTION_REG into ft_pnr.SK_GRP_ACTION_REG from dim_GRP_ACTION_REG
where DES_GRP_ACTION_REG = mdfch.CAMPO_CONC;
--se non la trovo inserisco il nuovo valore di campo_conc in dimensione e tiro fuori la sk relativa
exception
when no_data_found then
select seq_dim_GRP_ACTION_REG.nextval into sk from dual;

insert into dim_GRP_ACTION_REG
(SK_GRP_ACTION_REG, DES_GRP_ACTION_REG, DUP_TEC, NUP_TEC, DCR_TEC, PCR_TEC)
values(sk, mdfch.CAMPO_CONC, null, 0, adesso, 'PKG_DWH_DET_PNR.prc_ft_det_pnr');
ft_pnr.SK_GRP_ACTION_REG := sk;


end;
*/


ft_pnr.sk_GRP_ACTION_REG := FNC_GET_SK_GRP_ACTION_REG (  mdfch.CAMPO_CONC);





ft_pnr.VLD_FLG := 'I';

--DG_ANMETHREFID, DG_SAMPEVENTID, DG_RESINFO_NOTSUMMED, DG_EVALINFO_COM, SK_LABCOUNTRY, SK_ACT_LABCOUNTRY
ft_pnr.DG_ANMETHREFID := mdfch.ANMETHREFID;
ft_pnr.DG_SAMPEVENTID := mdfch.SAMPEVENTID;
ft_pnr.DG_RESINFO_NOTSUMMED := mdfch.RESINFO_NOTSUMMED;
ft_pnr.SK_LABCOUNTRY := FNC_GET_SK_GENERICA ( BK_DIM_COUNTRY,
                                      mdfch.LABCOUNTRY,
                                      mdfch.LABCOUNTRY||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABCOUNTRY'
                                    );
ft_pnr.SK_ACT_LABCOUNTRY := FNC_GET_SK_ACT_GENERICA ( BK_DIM_COUNTRY,
                                      mdfch.LABCOUNTRY,
                                      mdfch.LABCOUNTRY||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABCOUNTRY'
                                    );



ft_pnr.SK_ANALYSIS_END_DATE :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.ANALYSIS_END_DATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.ANALYSIS_END_DATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'ANALYSIS_END_DATE'
                                    );
ft_pnr.SK_ANALYSIS_START_DATE :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.ANALYSIS_START_DATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.ANALYSIS_START_DATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'ANALYSIS_START_DATE'
                                    );


ft_pnr.SK_SAMPMATCODE_ANIMAL_AGE:= FNC_GET_SK_GENERICA ( BK_DIM_ANIMAL_AGE,
                                      mdfch.SAMPMATCODE_ANIMAL_AGE_CLASS,
                                      mdfch.SAMPMATCODE_ANIMAL_AGE_CLASS||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_ANIMAL_AGE_CLASS'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_ANIMAL_AGE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_ANIMAL_AGE,
                                      mdfch.SAMPMATCODE_ANIMAL_AGE_CLASS,
                                      mdfch.SAMPMATCODE_ANIMAL_AGE_CLASS||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_ANIMAL_AGE_CLASS'
                                    );

ft_pnr.SK_ANMATCODE_BUILDING := FNC_GET_SK_GENERICA ( BK_DIM_REPORT,
                                      mdfch.ANMATCODE_BUILDING,
                                      mdfch.ANMATCODE_BUILDING||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMATCODE_BUILDING'
                                    );
ft_pnr.SK_ACT_ANMATCODE_BUILDING := FNC_GET_SK_ACT_GENERICA ( BK_DIM_REPORT,
                                      mdfch.ANMATCODE_BUILDING,
                                      mdfch.ANMATCODE_BUILDING||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABCOUNTRY'
                                    );

ft_pnr.DG_ANMATTEXT := mdfch.ANMATTEXT;

 ft_pnr.SK_ANMETHREFCODE := FNC_GET_SK_GENERICA ( BK_DIM_ANLYREFMD,
                                      mdfch.ANMETHREFCODE,
                                      mdfch.ANMETHREFCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMETHREFCODE'
                                    );
ft_pnr.SK_ACT_ANMETHREFCODE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_ANLYREFMD,
                                      mdfch.ANMETHREFCODE,
                                      mdfch.ANMETHREFCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMETHREFCODE'
                                    );

ft_pnr.DG_ANPORTSEQ := mdfch.ANPORTSEQ;

 ft_pnr.SK_SAMPMATCODE_COOKEXT := FNC_GET_SK_GENERICA ( BK_DIM_COOKEXT,
                                      mdfch.SAMPMATCODE_COOKEXT,
                                      mdfch.SAMPMATCODE_COOKEXT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_COOKEXT'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_COOKEXT := FNC_GET_SK_ACT_GENERICA ( BK_DIM_COOKEXT,
                                      mdfch.SAMPMATCODE_COOKEXT,
                                      mdfch.SAMPMATCODE_COOKEXT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_COOKEXT'
                                    );

ft_pnr.M_EVALHIGHLIMIT := mdfch.EVALHIGHLIMIT;

ft_pnr.SK_SAMPMATCODE_GENDER := FNC_GET_SK_GENERICA ( BK_DIM_GENDER,
                                      mdfch.SAMPMATCODE_GENDER,
                                      mdfch.SAMPMATCODE_GENDER||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_GENDER'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_GENDER := FNC_GET_SK_ACT_GENERICA ( BK_DIM_GENDER,
                                      mdfch.SAMPMATCODE_GENDER,
                                      mdfch.SAMPMATCODE_GENDER||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_GENDER'
                                    );

ft_pnr.DG_INFO_FARMACO:= mdfch.INFO_FARMACO;

ft_pnr.DG_NOTE_MODIFICHE := mdfch.NOTE_MODIFICHE;

ft_pnr.DG_ORIGFISHAREATEXT := mdfch.ORIGFISHAREATEXT;

ft_pnr.DG_RESID := mdfch.RESID;

ft_pnr.DG_RESINFO_COM := mdfch.RESINFO_COM;

ft_pnr.M_RESLLWR := mdfch.RESLLWR;

ft_pnr.M_RESVALREC := mdfch.RESVALREC;

ft_pnr.M_RESVALUNCERT := mdfch.RESVALUNCERT;

ft_pnr.M_RESVALUNCERTSD := mdfch.RESVALUNCERTSD;

ft_pnr.DG_SAMPANID := mdfch.SAMPANID;

ft_pnr.DG_SAMPMATINFO := mdfch.SAMPMATINFO;

ft_pnr.M_SAMPSIZE := mdfch.SAMPSIZE;

ft_pnr.M_RESULWR := mdfch.RESULWR;

ft_pnr.SK_SAMPMATCODE_GEN := FNC_GET_SK_GENERICA ( BK_DIM_GEN,
                                      mdfch.SAMPMATCODE_GEN,
                                      mdfch.SAMPMATCODE_GEN||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_GEN'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_GEN := FNC_GET_SK_ACT_GENERICA ( BK_DIM_GEN,
                                      mdfch.SAMPMATCODE_GEN,
                                      mdfch.SAMPMATCODE_GEN||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_GEN'
                                    );

ft_pnr.SK_SAMPMATCODE_INGRED := FNC_GET_SK_GENERICA ( BK_DIM_INGRED,
                                      mdfch.SAMPMATCODE_INGRED,
                                      mdfch.SAMPMATCODE_INGRED||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_INGRED'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_INGRED := FNC_GET_SK_ACT_GENERICA ( BK_DIM_INGRED,
                                      mdfch.SAMPMATCODE_INGRED,
                                      mdfch.SAMPMATCODE_INGRED||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_INGRED'
                                    );

ft_pnr.SK_SAMPMATCODE_LEGIS := FNC_GET_SK_GENERICA ( BK_DIM_LEGIS,
                                      mdfch.SAMPMATCODE_LEGIS,
                                      mdfch.SAMPMATCODE_LEGIS||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_LEGIS'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_LEGIS := FNC_GET_SK_ACT_GENERICA ( BK_DIM_LEGIS,
                                      mdfch.SAMPMATCODE_LEGIS,
                                      mdfch.SAMPMATCODE_LEGIS||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_LEGIS'
                                    );

ft_pnr.SK_SAMPMATCODE_PACKFORMAT := FNC_GET_SK_GENERICA ( BK_DIM_PACKFORMAT,
                                      mdfch.SAMPMATCODE_PACKFORMAT,
                                      mdfch.SAMPMATCODE_PACKFORMAT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PACKFORMAT'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_PACKFORMAT := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PACKFORMAT,
                                      mdfch.SAMPMATCODE_PACKFORMAT,
                                      mdfch.SAMPMATCODE_PACKFORMAT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PACKFORMAT'
                                    );

ft_pnr.SK_SAMPMATCODE_PACKMAT := FNC_GET_SK_GENERICA ( BK_DIM_PACKMAT,
                                      mdfch.SAMPMATCODE_PACKMAT,
                                      mdfch.SAMPMATCODE_PACKMAT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PACKMAT'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_PACKMAT := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PACKMAT,
                                      mdfch.SAMPMATCODE_PACKMAT,
                                      mdfch.SAMPMATCODE_PACKMAT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PACKMAT'
                                    );

ft_pnr.SK_SAMPMATCODE_PART_NATURE := FNC_GET_SK_GENERICA ( BK_DIM_PART_NATURE,
                                      mdfch.SAMPMATCODE_PART_NATURE,
                                      mdfch.SAMPMATCODE_PART_NATURE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PART_NATURE'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_PART_NATURE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PART_NATURE,
                                      mdfch.SAMPMATCODE_PART_NATURE,
                                      mdfch.SAMPMATCODE_PART_NATURE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PART_NATURE'
                                    );

ft_pnr.SK_SAMPMATCODE_PARTCONSUMED := FNC_GET_SK_GENERICA ( BK_DIM_PARTCONSUMED,
                                      mdfch.SAMPMATCODE_PARTCONSUMED,
                                      mdfch.SAMPMATCODE_PARTCONSUMED||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PARTCONSUMED'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_PARTCONSUME := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PARTCONSUMED,
                                      mdfch.SAMPMATCODE_PARTCONSUMED,
                                      mdfch.SAMPMATCODE_PARTCONSUMED||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PARTCONSUMED'
                                    );

ft_pnr.SK_SAMPMATCODE_PLACE := FNC_GET_SK_GENERICA ( BK_DIM_PLACE,
                                      mdfch.SAMPMATCODE_PLACE,
                                      mdfch.SAMPMATCODE_PLACE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PLACE'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_PLACE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PLACE,
                                      mdfch.SAMPMATCODE_PLACE,
                                      mdfch.SAMPMATCODE_PLACE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PLACE'
                                    );

ft_pnr.SK_SAMPMATCODE_PROCES := FNC_GET_SK_GENERICA ( BK_DIM_PROCES,
                                      mdfch.SAMPMATCODE_PROCESS,
                                      mdfch.SAMPMATCODE_PROCESS||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PROCES'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_PROCES := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PROCES,
                                      mdfch.SAMPMATCODE_PROCESS,
                                      mdfch.SAMPMATCODE_PROCESS||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PROCES'
                                    );

ft_pnr.SK_SAMPMATCODE_PROD_MTH := FNC_GET_SK_GENERICA ( BK_DIM_PRODUCTION_METHOD,
                                      mdfch.SAMPMATCODE_PRODUCTION_METHOD,
                                      mdfch.SAMPMATCODE_PRODUCTION_METHOD||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PRODUCTION_METHOD'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_PROD_MTH := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PRODUCTION_METHOD,
                                      mdfch.SAMPMATCODE_PRODUCTION_METHOD,
                                      mdfch.SAMPMATCODE_PRODUCTION_METHOD||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_PRODUCTION_METHOD'
                                    );

 ft_pnr.SK_SAMPMATCODE_SOURCE := FNC_GET_SK_GENERICA ( BK_DIM_SOURCE,
                                      mdfch.SAMPMATCODE_SOURCE,
                                      mdfch.SAMPMATCODE_SOURCE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_SOURCE'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_SOURCE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_SOURCE,
                                      mdfch.SAMPMATCODE_SOURCE,
                                      mdfch.SAMPMATCODE_SOURCE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_SOURCE'
                                    );

ft_pnr.SK_SAMPMATCODE_USE := FNC_GET_SK_GENERICA ( BK_DIM_USE,
                                      mdfch.SAMPMATCODE_USE,
                                      mdfch.SAMPMATCODE_USE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_USE'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_USE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_USE,
                                      mdfch.SAMPMATCODE_USE,
                                      mdfch.SAMPMATCODE_USE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_USE'
                                    );

ft_pnr.SK_ANMATCODE_PACKMAT := FNC_GET_SK_GENERICA ( BK_DIM_PACKMAT,
                                      mdfch.ANMATCODE_PACKMAT,
                                      mdfch.ANMATCODE_PACKMAT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMATCODE_PACKMAT'
                                    );
ft_pnr.SK_ACT_ANMATCODE_PACKMAT := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PACKMAT,
                                      mdfch.ANMATCODE_PACKMAT,
                                      mdfch.ANMATCODE_PACKMAT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMATCODE_PACKMAT'
                                    );

ft_pnr.SK_SAMPMATCODE_QUAL_INFO := FNC_GET_SK_GENERICA ( BK_DIM_QUALINFO,
                                      mdfch.SAMPMATCODE_QUALITATIVE_INFO,
                                      mdfch.SAMPMATCODE_QUALITATIVE_INFO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_QUALITATIVE_INFO'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_QUAL_INFO := FNC_GET_SK_ACT_GENERICA ( BK_DIM_QUALINFO,
                                      mdfch.SAMPMATCODE_QUALITATIVE_INFO,
                                      mdfch.SAMPMATCODE_QUALITATIVE_INFO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_QUALITATIVE_INFO'
                                    );

ft_pnr.SK_SAMPMATCODE_REPRO_LVL := FNC_GET_SK_GENERICA ( BK_DIM_REPRODUCTIVE,
                                      mdfch.SAMPMATCODE_REPRODUCTIVE_LEVEL,
                                      mdfch.SAMPMATCODE_REPRODUCTIVE_LEVEL||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_REPRODUCTIVE_LEVEL'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_REPRO_LVL := FNC_GET_SK_ACT_GENERICA ( BK_DIM_REPRODUCTIVE,
                                      mdfch.SAMPMATCODE_REPRODUCTIVE_LEVEL,
                                      mdfch.SAMPMATCODE_REPRODUCTIVE_LEVEL||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_REPRODUCTIVE_LEVEL'
                                    );

ft_pnr.DG_UTENTE_PRE_VALIDAZIONE := mdfch.UTENTE_PRE_VALIDAZIONE;

ft_pnr.DG_UTENTE_ULTIMA_MODIFICA := mdfch.UTENTE_ULTIMA_MODIFICA;

ft_pnr.DG_UTENTE_VALIDAZIONE := mdfch.UTENTE_VALIDAZIONE;

ft_pnr.SK_RESVALRECCORR := FNC_GET_SK_GENERICA ( BK_DIM_YESNO,
                                      mdfch.RESVALRECCORR,
                                      mdfch.RESVALRECCORR||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESVALRECCORR'
                                    );
ft_pnr.SK_ACT_RESVALRECCORR := FNC_GET_SK_ACT_GENERICA ( BK_DIM_YESNO,
                                      mdfch.RESVALRECCORR,
                                      mdfch.RESVALRECCORR||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESVALRECCORR'
                                    );

ft_pnr.SK_SAMPSIZEUNIT := FNC_GET_SK_GENERICA ( BK_DIM_UNIT,
                                      mdfch.SAMPSIZEUNIT,
                                      mdfch.SAMPSIZEUNIT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPSIZEUNIT'
                                    );
ft_pnr.SK_ACT_SAMPSIZEUNIT := FNC_GET_SK_ACT_GENERICA ( BK_DIM_UNIT,
                                      mdfch.SAMPSIZEUNIT,
                                      mdfch.SAMPSIZEUNIT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPSIZEUNIT'
                                    );

ft_pnr.SK_TRATTAMENTO_SINO := FNC_GET_SK_GENERICA ( BK_DIM_YESNO,
                                      mdfch.TRATTAMENTO_SINO,
                                      mdfch.TRATTAMENTO_SINO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'TRATTAMENTO_SINO'
                                    );
ft_pnr.SK_ACT_TRATTAMENTO_SINO := FNC_GET_SK_ACT_GENERICA ( BK_DIM_YESNO,
                                      mdfch.TRATTAMENTO_SINO,
                                      mdfch.TRATTAMENTO_SINO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'TRATTAMENTO_SINO'
                                    );

ft_pnr.SK_ORIGFISHAREACODE := FNC_GET_SK_GENERICA ( BK_DIM_FARAREA,
                                      mdfch.ORIGFISHAREACODE,
                                      mdfch.ORIGFISHAREACODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ORIGFISHAREACODE'
                                    );
ft_pnr.SK_ACT_ORIGFISHAREACODE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_FARAREA,
                                      mdfch.ORIGFISHAREACODE,
                                      mdfch.ORIGFISHAREACODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ORIGFISHAREACODE'
                                    );

 ft_pnr.SK_LABACCETT := FNC_GET_SK_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABACCETT,
                                      mdfch.LABACCETT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABACCETT'
                                    );
ft_pnr.SK_ACT_LABACCETT := FNC_GET_SK_ACT_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABACCETT,
                                      mdfch.LABACCETT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABACCETT'
                                    );

 ft_pnr.SK_LABACCRED := FNC_GET_SK_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABACCRED,
                                      mdfch.LABACCRED||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABACCRED'
                                    );
ft_pnr.SK_ACT_LABACCRED := FNC_GET_SK_ACT_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABACCRED,
                                      mdfch.LABACCRED||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABACCRED'
                                    );

ft_pnr.SK_DATA_PRE_VALIDAZIONE :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.DATA_PRE_VALIDAZIONE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.DATA_PRE_VALIDAZIONE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'DATA_ULTIMA_VALIDAZIONE'
                                    );
ft_pnr.SK_DATA_ULTIMA_MODIFICA :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.DATA_ULTIMA_MODIFICA,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.DATA_ULTIMA_MODIFICA,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'DATA_ULTIMA_MODIFICA'
                                    );
ft_pnr.SK_DATA_VALIDAZIONE :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.DATA_VALIDAZIONE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.DATA_VALIDAZIONE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'DATA_VALIDAZIONE'
                                    );

ft_pnr.SK_EVALINFO_RESASSES := FNC_GET_SK_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALINFO_RESASSES,
                                      mdfch.EVALINFO_RESASSES||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EVALINFO_RESASSES'
                                    );
ft_pnr.SK_ACT_EVALINFO_RESASSES := FNC_GET_SK_ACT_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALINFO_RESASSES,
                                      mdfch.EVALINFO_RESASSES||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EVALINFO_RESASSES'
                                    );

ft_pnr.SK_EVALINFO_SAMPANASSES := FNC_GET_SK_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALINFO_SAMPANASSES,
                                      mdfch.EVALINFO_SAMPANASSES||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EVALINFO_SAMPANASSES'
                                    );
ft_pnr.SK_ACT_EVALINFO_SAMPANASSES := FNC_GET_SK_ACT_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALINFO_SAMPANASSES,
                                      mdfch.EVALINFO_SAMPANASSES||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EVALINFO_SAMPANASSES'
                                    );

ft_pnr.DG_UTENTE_PRE_VALIDAZIONE := mdfch.UTENTE_PRE_VALIDAZIONE;

ft_pnr.SK_SAMPMATCODE_SRC_COMO := FNC_GET_SK_GENERICA ( BK_DIM_SOURCE_COM,
                                      mdfch.SAMPMATCODE_SOURCE_COMMODITIES,
                                      mdfch.SAMPMATCODE_SOURCE_COMMODITIES||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_SOURCE_COMMODITIES'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_SRC_COMO := FNC_GET_SK_ACT_GENERICA ( BK_DIM_SOURCE_COM,
                                      mdfch.SAMPMATCODE_SOURCE_COMMODITIES,
                                      mdfch.SAMPMATCODE_SOURCE_COMMODITIES||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_SOURCE_COMMODITIES'
                                    );

ft_pnr.SK_SAMPMATCODE_TARG_CONS := FNC_GET_SK_GENERICA ( BK_DIM_TARGET,
                                      mdfch.SAMPMATCODE_TARGET_CONSUMER,
                                      mdfch.SAMPMATCODE_TARGET_CONSUMER||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_TARGET_CONSUMER'
                                    );
ft_pnr.SK_ACT_SAMPMATCODE_TARG_CONS := FNC_GET_SK_ACT_GENERICA ( BK_DIM_TARGET,
                                      mdfch.SAMPMATCODE_TARGET_CONSUMER,
                                      mdfch.SAMPMATCODE_TARGET_CONSUMER||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATCODE_TARGET_CONSUMER'
                                    );

ft_pnr.DG_CODICE_OPERAZIONE := mdfch.CODICE_OPERAZIONE;

ft_pnr.SK_PROGID := FNC_GET_SK_GENERICA ( BK_DIM_PROGID,
                                      mdfch.PROGID,
                                      mdfch.PROGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PROGID'
                                    );
ft_pnr.SK_ACT_PROGID := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PROGID,
                                      mdfch.PROGID,
                                      mdfch.PROGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PROGID'
                                    );




ft_pnr.SK_CODE_MTX_VMPR_IT :=  FNC_GET_SK_GENERICA ( BK_DIM_MTX_VMPR_IT,
                                      mdfch.CODE_MTX_VMPR_IT, --SAMPMATCODE
                                      mdfch.CODE_MTX_VMPR_IT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),     --SAMPMATCODE
                                      'CODE_MTX_VMPR_IT'
                                    );

ft_pnr.SK_ACT_CODE_MTX_VMPR_IT :=  FNC_GET_SK_ACT_GENERICA ( BK_DIM_MTX_VMPR_IT,
                                      mdfch.CODE_MTX_VMPR_IT, --SAMPMATCODE
                                      mdfch.CODE_MTX_VMPR_IT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),     --SAMPMATCODE
                                      'CODE_MTX_VMPR_IT'
                                    );
















/*with appo as (
SELECT ID_VLD, listagg (ACTION||' - '||COD_REG, ',') within group(order by COD_REG) CAMPO_CONC
FROM ACTTAKENCODE
WHERE ID_VLD = mdfch.tec_key_rec
GROUP BY ID_VLD
)
select a.tec_key_rec, aa.CAMPO_CONC,
a.ACTION, a.ID_VLD, a.NUMERO_UNITA, a.UNITA_DI_MISURA, a.COD_REG from ACTTAKENCODE a, appo aa
where a.id_vld = aa.id_vld
  and  a.ID_VLD = mdfch.tec_key_rec
;*/



    update ft_det_vld
    set vld_flg = 'U',
        DUP_TEC = adesso,
        NUP_TEC = nvl(NUP_TEC,0) + 1
    --
    --
    where TEC_KEY_REC = mdfch.TEC_KEY_REC
      and vld_flg not in('U','D');






    update FT_ESTESO_ACTION
    set vld_flg = 'U',
        DUP_TEC = adesso,
        NUP_TEC = nvl(NUP_TEC,0) + 1
    --
    --
    where id_vld = mdfch.TEC_KEY_REC
      and vld_flg not in('U','D');









    insert into ft_det_vld
/*    ( TEC_KEY_REC, ID_TRATTAMENTO, ID_UPLOAD, Y_RIF, NOM_PERI, ID_MITTENTE, ANM, ID_REC, DAT_UPLOAD,
    DG_NUMVERBALE, SK_REGCODE, DG_FLTYPE, DG_OPTYPE, SK_TIPOCAMPO,
    --
    --
    --
    ----------,
    SK_GRP_ACTION_REG, SK_ACT_REGCODE, SK_ACT_TIPOCAMPO,
    --
    --
    --
    ----------,
    VLD_FLG, VALIDATO, DUP_TEC, NUP_TEC, ID_UPLOAD_STO, ID_REC_STO, DCR_TEC, PCR_TEC, VALIDATO_SEMESTRALE
    --DUP_TEC ,
    --NUP_TEC ,
    --DCR_TEC ,
    --PCR_TEC,

    --vld_flg
    )
    values
    ( ft_pnr.sk_regcode,
    ft_pnr.TEC_KEY_REC, ft_pnr.ID_TRATTAMENTO, ft_pnr.ID_UPLOAD, ft_pnr.Y_RIF, ft_pnr.NOM_PERI, ft_pnr.ID_MITTENTE, ft_pnr.ANM, ft_pnr.ID_REC, ft_pnr.DAT_UPLOAD,
    ft_pnr.NUMVERBALE, ft_pnr.SK_REGCODE, ft_pnr.FLTYPE, ft_pnr.OPTYPE, ft_pnr.SK_TIPOCAMPO,
    --
    --
    --
    ----------,
    ft_pnr.SK_GRP_ACTION_REG, ft_pnr.SK_ACT_REGCODE, ft_pnr.SK_ACT_TIPOCAMPO,
    --
    --
    --
    ----------,
    ft_pnr.VLD_FLG, ft_pnr.VALIDATO, null, null, ft_pnr.ID_UPLOAD_STO, ft_pnr.ID_REC_STO, adesso, 'PKG_DWH_DET_PNR.prc_ft_det_pnr', ft_pnr.VALIDATO_SEMESTRALE
    --null,
    --null,
    --'PKG_DWH_DET_PNR.prc_ft_det_pnr',
    --adesso,

    --'I' */
    (select
    ft_pnr.TEC_KEY_REC, ft_pnr.ID_TRATTAMENTO, ft_pnr.ID_UPLOAD, ft_pnr.Y_RIF, ft_pnr.NOM_PERI, ft_pnr.ID_MITTENTE, ft_pnr.ANM, ft_pnr.ID_REC, ft_pnr.DAT_UPLOAD,
    ft_pnr.DG_NUMVERBALE, ft_pnr.SK_REGCODE, ft_pnr.DG_OPTYPE, ft_pnr.SK_TIPOCAMPO,  --ft_pnr.DG_FLTYPE
    ft_pnr.SK_ASL_SAMPORG,
ft_pnr.SK_LEGREF,
ft_pnr.SK_SAMPSTR,
ft_pnr.SK_PROGTYP,
ft_pnr.SK_SAMPMD,
ft_pnr.SK_SAMPLR,
ft_pnr.SK_SMPNT_ITA,
ft_pnr.DG_PROGINFO_COM,
ft_pnr.SK_SAMPUNTYP,
--ft_pnr.SK_SAMPUNIT_SAMPHOLDINGID,
--ft_pnr.SK_SAMPUNIT_SLAUGHTERHOUSEID,
--ft_pnr.SK_SAMPUNIT_SAMPPLANTID,
ft_pnr.DG_SAMPUNIT_ANIMALID,
--ft_pnr.FLG_SAMPEVENTINFO_COM,
--ft_pnr.DG_SAMPEVENTINFO_MEDICSTATUS,
ft_pnr.SAMPID,
ft_pnr.SK_sampdate,
ft_pnr.SK_SAMPACCDATE,
ft_pnr.DG_SAMPINFO_ORIGSAMPID,
ft_pnr.SK_ORIGREG,
ft_pnr.SK_CODAZALLORIG,
ft_pnr.DG_CODFISSAMPHOLDING,
ft_pnr.DG_CODFISOWNER,
ft_pnr.FLG_SAMPIDONEO,
ft_pnr.SK_MOTIVONONIDONEO,
ft_pnr.DG_ALTROMOTIVONONIDONEO,
--ft_pnr.FLG_METODOPRODUZIONE,
ft_pnr.SK_MODALITALLEVAMENTO,
ft_pnr.SK_SAMPMATTYPE,
ft_pnr.SK_SAMPMATCODE,
ft_pnr.DG_SAMPMATTEXT,
ft_pnr.SK_ORIGCOUNTRY,
ft_pnr.SK_AETATE,
--ft_pnr.SK_ANALYSISDATE,
--ft_pnr.SK_SAMPAN_INFO_COMPDATE,
ft_pnr.DG_SAMPAN_INFO_COM,
ft_pnr.SK_LABANALISI,
--ft_pnr.SK_LABID,
ft_pnr.SK_PARAMTYPE,
ft_pnr.SK_PARAMCODE,
ft_pnr.DG_PARAMTEXT,
ft_pnr.SK_ANMETHTYPE,
ft_pnr.SK_ANMETHCODE,
ft_pnr.DG_ANMETHTEXT,
ft_pnr.SK_ACCREDPROC,
ft_pnr.SK_RESUNIT,
ft_pnr.M_RESLOD,
ft_pnr.M_RESLOQ,
ft_pnr.M_CCALPHA,
ft_pnr.M_CCBETA,
ft_pnr.M_RESVAL,
ft_pnr.M_EXPRRESPERC_FATPERC,
ft_pnr.M_EXPRRESPERC_MOISTPERC,
ft_pnr.M_EXPRRESPERC_ALCOHOLPERC,
ft_pnr.SK_EXPRRESTYPE,
ft_pnr.SK_RESQUALVALUE,
ft_pnr.SK_RESTYPE,
--ft_pnr.DG_RESINFO,
ft_pnr.SK_RAPPROVADATE,
ft_pnr.M_EVALLOWLIMIT,
ft_pnr.SK_EVALLIMITTYPE,
ft_pnr.SK_EVALCODE,
ft_pnr.SK_EVALINFO_SAMPTKASSES,
ft_pnr.SK_EVALINFO_CONCLUSION,
ft_pnr.SK_GRP_ACTION_REG,
ft_pnr.VLD_FLG,
ft_pnr.VALIDATO,
ft_pnr.ID_UPLOAD_STO,
ft_pnr.ID_REC_STO,
ft_pnr.DCR_TEC,
ft_pnr.PCR_TEC,
ft_pnr.VALIDATO_SEMESTRALE,
ft_pnr.DG_ANMETHREFID,
ft_pnr.DG_SAMPEVENTID,
ft_pnr.DG_RESINFO_NOTSUMMED,
ft_pnr.DG_EVALINFO_COM,
ft_pnr.SK_LABCOUNTRY,
ft_pnr.DUP_TEC,
ft_pnr.NUP_TEC,
ft_pnr.SK_ACT_REGCODE,
ft_pnr.SK_ACT_TIPOCAMPO,
ft_pnr.SK_ACT_ASL_SAMPORG,
ft_pnr.SK_ACT_LEGREF,
ft_pnr.SK_ACT_SAMPSTR,
ft_pnr.SK_ACT_PROGTYP,
ft_pnr.SK_ACT_SAMPMD,
ft_pnr.SK_ACT_SAMPLR,
ft_pnr.SK_ACT_SMPNT_ITA,
ft_pnr.SK_ACT_SAMPUNTYP,
--ft_pnr.SK_ACT_SAMPUN_SLAUGHTERHOUSEID,
--ft_pnr.SK_ACT_SAMPUNIT_SAMPPLANTID,
ft_pnr.SK_ACT_ORIGREG,
ft_pnr.SK_ACT_CODAZALLORIG,
ft_pnr.SK_ACT_MOTIVONONIDONEO,
ft_pnr.SK_ACT_MODALITALLEVAMENTO,
ft_pnr.SK_ACT_SAMPMATTYPE,
ft_pnr.SK_ACT_SAMPMATCODE,
ft_pnr.SK_ACT_AETATE,
ft_pnr.SK_ACT_LABANALISI,
--ft_pnr.SK_ACT_LABID,
ft_pnr.SK_ACT_PARAMTYPE,
ft_pnr.SK_ACT_PARAMCODE,
ft_pnr.SK_ACT_ANMETHTYPE,
ft_pnr.SK_ACT_ANMETHCODE,
ft_pnr.SK_ACT_ACCREDPROC,
ft_pnr.SK_ACT_RESUNIT,
ft_pnr.SK_ACT_EXPRRESTYPE,
ft_pnr.SK_ACT_RESQUALVALUE,
ft_pnr.SK_ACT_RESTYPE,
ft_pnr.SK_ACT_EVALLIMITTYPE,
ft_pnr.SK_ACT_EVALCODE,
ft_pnr.SK_ACT_EVALINFO_SAMPTKASSES,
ft_pnr.SK_ACT_EVALINFO_CONCLUSION,
ft_pnr.SK_ACT_LABCOUNTRY,
ft_pnr.SK_ACT_ORIGCOUNTRY,
ft_pnr.SK_OSAID,
ft_pnr.SK_ACT_OSAID,

ft_pnr.SK_ANALYSIS_END_DATE,
ft_pnr.SK_ANALYSIS_START_DATE,
ft_pnr.SK_SAMPMATCODE_ANIMAL_AGE,
ft_pnr.SK_ACT_SAMPMATCODE_ANIMAL_AGE,
ft_pnr.SK_ANMATCODE_BUILDING,
ft_pnr.SK_ACT_ANMATCODE_BUILDING,
ft_pnr.DG_ANMATTEXT,
ft_pnr.SK_ANMETHREFCODE,
ft_pnr.SK_ACT_ANMETHREFCODE,
ft_pnr.DG_ANPORTSEQ,
ft_pnr.SK_SAMPMATCODE_COOKEXT,
ft_pnr.SK_ACT_SAMPMATCODE_COOKEXT,
ft_pnr.M_EVALHIGHLIMIT,
ft_pnr.SK_SAMPMATCODE_GENDER,
ft_pnr.SK_ACT_SAMPMATCODE_GENDER,
ft_pnr.DG_INFO_FARMACO,
ft_pnr.DG_NOTE_MODIFICHE,
ft_pnr.DG_ORIGFISHAREATEXT,
ft_pnr.DG_RESID,
ft_pnr.DG_RESINFO_COM,
ft_pnr.M_RESLLWR,
ft_pnr.M_RESVALREC,
ft_pnr.M_RESVALUNCERT,
ft_pnr.M_RESVALUNCERTSD,
ft_pnr.DG_SAMPANID,
ft_pnr.DG_SAMPMATINFO,
ft_pnr.M_SAMPSIZE,
ft_pnr.M_RESULWR,
ft_pnr.SK_SAMPMATCODE_GEN,
ft_pnr.SK_ACT_SAMPMATCODE_GEN,
ft_pnr.SK_SAMPMATCODE_INGRED,
ft_pnr.SK_ACT_SAMPMATCODE_INGRED,
ft_pnr.SK_SAMPMATCODE_LEGIS,
ft_pnr.SK_ACT_SAMPMATCODE_LEGIS,
ft_pnr.SK_SAMPMATCODE_PACKFORMAT,
ft_pnr.SK_ACT_SAMPMATCODE_PACKFORMAT,
ft_pnr.SK_SAMPMATCODE_PACKMAT,
ft_pnr.SK_ACT_SAMPMATCODE_PACKMAT,
ft_pnr.SK_SAMPMATCODE_PART_NATURE,
ft_pnr.SK_ACT_SAMPMATCODE_PART_NATURE,
ft_pnr.SK_SAMPMATCODE_PARTCONSUMED,
ft_pnr.SK_ACT_SAMPMATCODE_PARTCONSUME,
ft_pnr.SK_SAMPMATCODE_PLACE,
ft_pnr.SK_ACT_SAMPMATCODE_PLACE,
ft_pnr.SK_SAMPMATCODE_PROCES,
ft_pnr.SK_ACT_SAMPMATCODE_PROCES,
ft_pnr.SK_SAMPMATCODE_PROD_MTH,
ft_pnr.SK_ACT_SAMPMATCODE_PROD_MTH,
ft_pnr.SK_SAMPMATCODE_SOURCE,
ft_pnr.SK_ACT_SAMPMATCODE_SOURCE,
ft_pnr.SK_SAMPMATCODE_USE,
ft_pnr.SK_ACT_SAMPMATCODE_USE,
ft_pnr.SK_ANMATCODE_PACKMAT,
ft_pnr.SK_ACT_ANMATCODE_PACKMAT,
ft_pnr.SK_SAMPMATCODE_QUAL_INFO,
ft_pnr.SK_ACT_SAMPMATCODE_QUAL_INFO,
ft_pnr.SK_SAMPMATCODE_REPRO_LVL,
ft_pnr.SK_ACT_SAMPMATCODE_REPRO_LVL,
ft_pnr.DG_PRE_VALIDATO,
ft_pnr.DG_UTENTE_ULTIMA_MODIFICA,
ft_pnr.DG_UTENTE_VALIDAZIONE,
ft_pnr.SK_RESVALRECCORR,
ft_pnr.SK_ACT_RESVALRECCORR,
ft_pnr.SK_SAMPSIZEUNIT,
ft_pnr.SK_ACT_SAMPSIZEUNIT,
ft_pnr.SK_TRATTAMENTO_SINO,
ft_pnr.SK_ACT_TRATTAMENTO_SINO,
ft_pnr.SK_ORIGFISHAREACODE,
ft_pnr.SK_ACT_ORIGFISHAREACODE,
ft_pnr.SK_LABACCETT,
ft_pnr.SK_ACT_LABACCETT,
ft_pnr.SK_LABACCRED,
ft_pnr.SK_ACT_LABACCRED,
ft_pnr.SK_DATA_PRE_VALIDAZIONE,
ft_pnr.SK_DATA_ULTIMA_MODIFICA,
ft_pnr.SK_DATA_VALIDAZIONE,
ft_pnr.SK_EVALINFO_RESASSES,
ft_pnr.SK_ACT_EVALINFO_RESASSES,
ft_pnr.SK_EVALINFO_SAMPANASSES,
ft_pnr.SK_ACT_EVALINFO_SAMPANASSES,
ft_pnr.DG_UTENTE_PRE_VALIDAZIONE,
ft_pnr.SK_SAMPMATCODE_SRC_COMO,
ft_pnr.SK_ACT_SAMPMATCODE_SRC_COMO,
ft_pnr.SK_SAMPMATCODE_TARG_CONS,
ft_pnr.SK_ACT_SAMPMATCODE_TARG_CONS,
ft_pnr.DG_CODICE_OPERAZIONE,
ft_pnr.SK_PROGID,
ft_pnr.SK_ACT_PROGID,
ft_pnr.SK_CODE_MTX_VMPR_IT,
ft_pnr.SK_ACT_CODE_MTX_VMPR_IT






from dual
    );


  PRC_INS_TAB_LOG_ETL(
                  'LOG',
                  null,
                  'INIZIO fatto esteso x TEC_KEY_REC = '||mdfch.TEC_KEY_REC,
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );


    prc_ft_esteso_det_pnr (mdfch.TEC_KEY_REC, mdfch.samp_date, 'I',
                           mdfch.VALIDATO, mdfch.VALIDATO_SEMESTRALE);

    end loop;











    --controlli

/*
    select (select count(1) num_r_vld from sn_vld where vld_flg = '1') - (select count(1) num_r_ft from ft_det_vld where vld_flg = 'I') into differenza from dual;

    if (differenza) <> 0 then

    desc_errore := substr('ERRORE Caricamento del Fatto : '||'ft_det_vld'||' - '||'dovuto al controllo finale',1,4000);

    raise errore;
    end if;


    select (select count(1) num_r_vld from vld a, ACTTAKENCODE b
            where a.vld_flg = '1'
              and a.tec_key_rec = b.id_vld) -
           (select count(1) num_r_ft from ft_esteso_action where vld_flg = 'I') into differenza from dual;

    if (differenza) <> 0 then
    desc_errore := substr('ERRORE Caricamento del Fatto : '||'ft_esteso_action'||' - '||'dovuto al controllo finale',1,4000);
    raise errore;
    end if;

*/



    commit;

    --refresh sn_vld_ante
    DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.sn_vld_ante'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);


  PRC_INS_TAB_LOG_ETL(
                  'LOG',
                  null,
                  'FINE OK',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );


--begin
  -- Initialization
  --<Statement>;

EXCEPTION
when errore then
rollback;
  PRC_INS_TAB_LOG_ETL(
                  'ERRORE',
                  null,
                  desc_errore||dbms_utility.format_error_backtrace,
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );


WHEN OTHERS THEN
rollback;
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr(sqlerrm||dbms_utility.format_error_backtrace,1,4000);
  PRC_INS_TAB_LOG_ETL(
                  'ERRORE',
                  null,
                  null,
                  sqlcode,
                  desc_errore--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

  end prc_ft_det_pnr;
/*
procedure prc_ft_det_pnr_test (Param in varchar2) is
  primo_loop boolean;
  sk_trovata integer;
  id_trovata integer;
  rec_az_vld_in r_dim_azienda;

  begin
  PRC_INS_TAB_LOG_ETL(
                  'LOG',
                  null,
                  'INIZIO',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );
  --refresh sn_vld


/*

    --aggiornamento dimensioni
    PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'aggiornamento dimensioni',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );




    --
    --



    prc_dim_GRP_ACTION_REG (null);

    prc_dim(null);
*/

/*                                      -- 
    PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'INIZIO FATTI',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );


  DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.sn_vld'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);

  DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.sn_vld_delta'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);




  CARICAMENTO_BULK_REL(null);




---------------------------------------------------------------------------

    --cancellazioni
    PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'cancellazioni',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

    for cnclzn in (  select TEC_KEY_REC --chiave tecnica gestionale
                     from ft_det_vld where vld_flg not in('U','D')
                     minus
                     select TEC_KEY_REC
                     from sn_vld
                     --where -----------
                  )
    loop

    update ft_det_vld
    set vld_flg = 'D',
        DUP_TEC = adesso,
        NUP_TEC = nvl(NUP_TEC,0) + 1
    where TEC_KEY_REC = cnclzn.TEC_KEY_REC
      and vld_flg not in('U','D');



    update FT_ESTESO_ACTION
    set vld_flg = 'D',
        DUP_TEC = adesso,
        NUP_TEC = nvl(NUP_TEC,0) + 1
    where ID_VLD = cnclzn.TEC_KEY_REC
      and vld_flg not in('U','D');


    end loop;





    --modifiche







    PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'modifiche',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

    primo_loop := true;
    for mdfch in (  select * --tutti i campi della tebella
                     from sn_vld_delta order by DAT_UPLOAD,  ID_REC
                     --where -----------
                     --minus
                     --select *
                     --from sn_vld_ante
                  )
    loop

      --ricavare le sk
      if primo_loop = true then


      --refresh sn_vld
      DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.SN_vld_delta_samp_date'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);  */         -- 



/*     DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.SN_vld_delta_DAT_UPLOAD'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);       */


/*          -- 
      PRC_INS_TAB_LOG_ETL(
                  'TRACE',
                  null,
                  'CARICAMENTO_BULK',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

      CARICAMENTO_BULK_sampdate(null);
      --CARICAMENTO_BULK_DAT_UPLOAD(null);



      primo_loop := false;
      end if;

---------------------------------------------------------------------------
-- controlli sulle REL per i valori interessati presenti su SN_VLD_DELTA
---------------------------------------------------------------------------

/*select EVALCODE||
SAMPTKASSESS from
REL_EVALCODE_SMPASSESS*/


/*                  -- 

      id_trovata := FNC_GET_rel_GENERICA ( BK_dim_REL_EVALCODE_SMPASSESS,
                          mdfch.EVALCODE||' - '||mdfch.EVALINFO_SAMPTKASSES,
                          'REL_EVALCODE_SMPASSESS'
                         );
      if id_trovata < 0 then
       desc_errore := substr('ERRORE ricerca id nella relazionale : '||'REL_EVALCODE_SMPASSESS'||' per il valore '||mdfch.EVALCODE|| mdfch.EVALINFO_SAMPTKASSES,1,4000);
       raise errore;
      end if;


--
--








      ft_pnr.TEC_KEY_REC := mdfch.TEC_KEY_REC;

      ft_pnr.ID_TRATTAMENTO := mdfch.ID_TRATTAMENTO;

      ft_pnr.ID_UPLOAD:= mdfch.ID_UPLOAD;

      ft_pnr.Y_RIF := mdfch.Y_RIF;

      ft_pnr.NOM_PERI := mdfch.NOM_PERI;

      ft_pnr.ID_MITTENTE := mdfch.ID_MITTENTE;

       ft_pnr.ANM := mdfch.ANM;

       ft_pnr.ID_REC := mdfch.ID_REC;

       ft_pnr.DAT_UPLOAD :=  mdfch.DAT_UPLOAD;

       ft_pnr.DG_NUMVERBALE :=  nvl(mdfch.NUMVERBALE,'ND');

       ft_pnr.SK_REGCODE := FNC_GET_SK_GENERICA ( BK_DIM_REG,
                                      mdfch.REGCODE,
                                      mdfch.REGCODE||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'REGCODE'
                                    );

       --ft_pnr.DG_FLTYPE := nvl(mdfch.FLTYPE,'ND');

       ft_pnr.DG_OPTYPE := nvl(mdfch.OPTYPE,'ND');

       ft_pnr.SK_TIPOCAMPO := FNC_GET_SK_GENERICA ( BK_DIM_TIPOCAMPO,
                                      mdfch.TIPCAMP,
                                      mdfch.TIPCAMP||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'TIPCAMP'
                                    );

       ft_pnr.SK_ASL_SAMPORG := FNC_GET_SK_GENERICA ( BK_DIM_ASL,
                                      mdfch.SAMPORG,
                                      mdfch.SAMPORG||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPORG'
                                    );

ft_pnr.SK_LEGREF := FNC_GET_SK_GENERICA ( BK_DIM_LEGREF,
                                      mdfch.PROGLEGALREF,
                                      mdfch.PROGLEGALREF||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PROGLEGALREF'
                                    );

ft_pnr.SK_SAMPSTR :=  FNC_GET_SK_GENERICA ( BK_DIM_SAMPSTR,
                                      mdfch.SAMPSTRATEGY,
                                      mdfch.SAMPSTRATEGY ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPSTRATEGY'
                                    );

ft_pnr.SK_PROGTYP :=  FNC_GET_SK_GENERICA ( BK_DIM_PROGTYP,
                                      mdfch.PROGTYPE,
                                      mdfch.PROGTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PROGTYPE'
                                    );

ft_pnr.SK_SAMPMD :=  FNC_GET_SK_GENERICA ( BK_DIM_SAMPMD,
                                      mdfch.SAMPMETHOD,
                                      mdfch.SAMPMETHOD ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMETHOD'
                                    );

ft_pnr.SK_SAMPLR :=  FNC_GET_SK_GENERICA ( BK_DIM_SAMPLR,
                                      mdfch.SAMPLER,
                                      mdfch.SAMPLER ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPLER'
                                    );

ft_pnr.SK_SMPNT_ITA :=  FNC_GET_SK_GENERICA ( BK_DIM_SMPNT_ITA,
                                      mdfch.SAMPPOINT,
                                      mdfch.SAMPPOINT ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'SAMPPOINT'
                                    );

ft_pnr.DG_PROGINFO_COM :=  nvl(mdfch.PROGINFO_COM,'ND');

ft_pnr.SK_SAMPUNTYP := FNC_GET_SK_GENERICA ( BK_DIM_SAMPUNTYP,
                                      mdfch.SAMPUNITTYPE,
                                      mdfch.SAMPUNITTYPE ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPUNITTYPE'
                                    );


ft_pnr.DG_SAMPUNIT_ANIMALID :=  nvl(mdfch.SAMPUNIT_ANIMALID,'ND');
--ft_pnr.FLG_SAMPEVENTINFO_COM :=  nvl(mdfch.SAMPEVENTINFO_COM,'ND');
--ft_pnr.DG_SAMPEVENTINFO_MEDICSTATUS := nvl(mdfch.SAMPEVENTINFO_MEDICSTATUS,'ND');

ft_pnr.SAMPID := mdfch.SAMPID;

ft_pnr.DG_SAMPINFO_ORIGSAMPID :=  nvl(mdfch.SAMPINFO_ORIGSAMPID,'ND');

ft_pnr.SK_ORIGREG := FNC_GET_SK_GENERICA ( BK_dim_REG,
                                      mdfch.ORIGREG,
                                      mdfch.ORIGREG||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ORIGREG'
                                    );

ft_pnr.DG_CODFISSAMPHOLDING := nvl(mdfch.CODFISSAMPHOLDING,'ND');

ft_pnr.DG_CODFISOWNER := nvl(mdfch.CODFISOWNER,'ND');

ft_pnr.FLG_SAMPIDONEO := nvl(mdfch.SAMPIDONEO,'ND');

ft_pnr.SK_MOTIVONONIDONEO := FNC_GET_SK_GENERICA ( BK_DIM_NONIDON,
                                      mdfch.MOTIVONONIDONEO,
                                      mdfch.MOTIVONONIDONEO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'MOTIVONONIDONEO'
                                    );

ft_pnr.DG_ALTROMOTIVONONIDONEO := nvl(mdfch.ALTROMOTIVONONIDONEO,'ND');

--ft_pnr.FLG_METODOPRODUZIONE := nvl(mdfch.METODOPRODUZIONE,'ND');

ft_pnr.SK_MODALITALLEVAMENTO :=  FNC_GET_SK_GENERICA ( BK_DIM_MODALLEV,
                                      mdfch.MODALITALLEVAMENTO,
                                      mdfch.MODALITALLEVAMENTO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'MODALITALLEVAMENTO'
                                    );

ft_pnr.SK_SAMPMATTYPE :=  FNC_GET_SK_GENERICA ( BK_DIM_MTXTYP,
                                      mdfch.SAMPMATTYPE,
                                      mdfch.SAMPMATTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATTYPE'
                                    );

ft_pnr.SK_SAMPMATCODE :=  FNC_GET_SK_GENERICA ( BK_DIM_MTX_VMPR_IT,
                                      mdfch.SAMPMATCODE_BUILDING,  --MDFCH.SAMPMATCODE
                                      mdfch.SAMPMATCODE_BUILDING||' - '||to_char(mdfch.samp_date,'yyyymmdd'),       --MDFCH.SAMPMATCODE
                                      'SAMPMATCODE'
                                    );

ft_pnr.DG_SAMPMATTEXT := nvl(mdfch.SAMPMATTEXT,'ND');

ft_pnr.SK_ORIGCOUNTRY := FNC_GET_SK_GENERICA ( BK_DIM_COUNTRY,
                                      mdfch.ORIGCOUNTRY,
                                      mdfch.ORIGCOUNTRY||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ORIGCOUNTRY'
                                    );

ft_pnr.SK_AETATE :=  FNC_GET_SK_GENERICA ( BK_DIM_AETATE,
                                      mdfch.AETATE,
                                      mdfch.AETATE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'AETATE'
                                    );

            */ -- 




/*ft_pnr.SK_ANALYSISDATE :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.analysisdate,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.analysisdate,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'ANALYSISDATE'
                                    );   --DIM_TEMPO

ft_pnr.SK_SAMPAN_INFO_COMPDATE :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.SAMPAN_INFO_COMPDATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.SAMPAN_INFO_COMPDATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'SAMPAN_INFO_COMPDATE'
                                    );  --DIM_TEMPO*/

--ft_pnr.DG_SAMPAN_INFO_COM :=   nvl(mdfch.SAMPAN_INFO_COM,'ND');

/*ft_pnr.SK_LABANALISI := FNC_GET_SK_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABANALISI,
                                      mdfch.LABANALISI||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABANALISI'
                                    );

/*ft_pnr.SK_LABID  := FNC_GET_SK_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABID,
                                      mdfch.LABID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABID'
                                    );  */
/*          -- 
ft_pnr.SK_PARAMTYPE  := FNC_GET_SK_GENERICA ( BK_DIM_PARAMTYP,
                                      mdfch.PARAMTYPE,
                                      mdfch.PARAMTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PARAMTYPE'
                                    );

ft_pnr.SK_PARAMCODE := FNC_GET_SK_GENERICA ( BK_DIM_PARAM_VMPR_IT,
                                      mdfch.PARAMCODE,
                                      mdfch.PARAMCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PARAMCODE'
                                    );
ft_pnr.DG_PARAMTEXT := nvl(mdfch.PARAMTEXT,'ND');

ft_pnr.SK_ANMETHTYPE := FNC_GET_SK_GENERICA ( BK_DIM_ANLYTYP,
                                      mdfch.ANMETHTYPE,
                                      mdfch.ANMETHTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMETHTYPE'
                                    );

ft_pnr.SK_ANMETHCODE := FNC_GET_SK_GENERICA ( BK_DIM_ANLYMD,
                                      mdfch.ANMETHCODE,
                                      mdfch.ANMETHCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMETHCODE'
                                    );

ft_pnr.DG_ANMETHTEXT := nvl(mdfch.ANMETHTEXT,'ND');

ft_pnr.SK_ACCREDPROC := FNC_GET_SK_GENERICA ( BK_DIM_MDACC,
                                      mdfch.ACCREDPROC,
                                      mdfch.ACCREDPROC||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ACCREDPROC'
                                    );

ft_pnr.SK_RESUNIT := FNC_GET_SK_GENERICA ( BK_DIM_UNIT,
                                      mdfch.RESUNIT,
                                      mdfch.RESUNIT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESUNIT'
                                    );

ft_pnr.M_RESLOD := mdfch.RESLOD; --MISURA

ft_pnr.M_RESLOQ := mdfch.RESLOQ; --MISURA

ft_pnr.M_CCALPHA := mdfch.CCALPHA; --MISURA

ft_pnr.M_CCBETA := mdfch.CCBETA; --MISURA

ft_pnr.M_RESVAL := mdfch.RESVAL;  --MISURA

ft_pnr.M_EXPRRESPERC_FATPERC := mdfch.EXPRRESPERC_FATPERC; --MISURA

ft_pnr.M_EXPRRESPERC_MOISTPERC := mdfch.EXPRRESPERC_MOISTPERC;  --MISURA

ft_pnr.M_EXPRRESPERC_ALCOHOLPERC := mdfch.EXPRRESPERC_ALCOHOLPERC;  --MISURA

ft_pnr.SK_EXPRRESTYPE := FNC_GET_SK_GENERICA ( BK_DIM_EXPRRES,
                                      mdfch.EXPRRESTYPE,
                                      mdfch.EXPRRESTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EXPRRESTYPE'
                                    );

ft_pnr.SK_RESQUALVALUE := FNC_GET_SK_GENERICA ( BK_DIM_POSNEG,
                                      mdfch.RESQUALVALUE,
                                      mdfch.RESQUALVALUE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESQUALVALUE'
                                    );

ft_pnr.SK_RESTYPE := FNC_GET_SK_GENERICA ( BK_DIM_VALTYP,
                                      mdfch.RESTYPE,
                                      mdfch.RESTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESTYPE'
                                    );

--ft_pnr.DG_RESINFO := nvl(mdfch.RESINFO,'ND');

ft_pnr.SK_RAPPROVADATE  :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.RAPPROVADATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.RAPPROVADATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'RAPPROVADATE'
                                    );  --DIM_TEMPO --DIM_TEMPO

ft_pnr.M_EVALLOWLIMIT := mdfch.EVALLOWLIMIT;

ft_pnr.SK_EVALLIMITTYPE := FNC_GET_SK_GENERICA ( BK_DIM_LMTTYP,
                                      mdfch.EVALLIMITTYPE,
                                      mdfch.EVALLIMITTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EVALLIMITTYPE'
                                    );

ft_pnr.SK_EVALCODE := FNC_GET_SK_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALCODE,
                                      mdfch.EVALCODE ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALCODE'
                                    );

ft_pnr.SK_EVALINFO_SAMPTKASSES := FNC_GET_SK_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALINFO_SAMPTKASSES,
                                      mdfch.EVALINFO_SAMPTKASSES ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALINFO_SAMPTKASSES'
                                    );

ft_pnr.SK_EVALINFO_CONCLUSION := FNC_GET_SK_GENERICA ( BK_DIM_CONCLUS,
                                      mdfch.EVALINFO_CONCLUSION,
                                      mdfch.EVALINFO_CONCLUSION ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALINFO_CONCLUSION'
                                    );

--ft_pnr.SK_GRP_ACTION_REG, --NON RIPORTATA ORIGINE SU EXCEL
ft_pnr.SK_ACT_REGCODE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_REG,
                                      mdfch.REGCODE,
                                      mdfch.REGCODE||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'REGCODE'
                                    );

ft_pnr.SK_ACT_TIPOCAMPO := FNC_GET_SK_ACT_GENERICA ( BK_DIM_TIPOCAMPO,
                                      mdfch.TIPCAMP,
                                      mdfch.TIPCAMP||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'TIPCAMP'
                                    );

ft_pnr.SK_ACT_ASL_SAMPORG := FNC_GET_SK_ACT_GENERICA ( BK_DIM_ASL,
                                      mdfch.SAMPORG,
                                      mdfch.SAMPORG||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'SAMPORG'
                                    );

ft_pnr.SK_ACT_LEGREF := FNC_GET_SK_ACT_GENERICA ( BK_DIM_LEGREF,
                                      mdfch.PROGLEGALREF,
                                      mdfch.PROGLEGALREF||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'PROGLEGALREF'
                                    );

ft_pnr.SK_ACT_SAMPSTR := FNC_GET_SK_ACT_GENERICA ( BK_DIM_SAMPSTR,
                                      mdfch.SAMPSTRATEGY,
                                      mdfch.SAMPSTRATEGY||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'SAMPSTRATEGY'
                                    );

ft_pnr.SK_ACT_PROGTYP := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PROGTYP,
                                      mdfch.PROGTYPE,
                                      mdfch.PROGTYPE||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'PROGTYPE'
                                    );

ft_pnr.SK_ACT_SAMPMD := FNC_GET_SK_ACT_GENERICA ( BK_DIM_SAMPMD,
                                      mdfch.SAMPMETHOD,
                                      mdfch.SAMPMETHOD||' - '||to_char( mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMETHOD'
                                    );

ft_pnr.SK_ACT_SAMPLR := FNC_GET_SK_ACT_GENERICA ( BK_DIM_SAMPLR,
                                      mdfch.SAMPLER,
                                      mdfch.SAMPLER ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPLER'
                                    );

ft_pnr.SK_ACT_SMPNT_ITA :=  FNC_GET_SK_ACT_GENERICA ( BK_DIM_SMPNT_ITA,
                                      mdfch.SAMPPOINT,
                                      mdfch.SAMPPOINT ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'SAMPPOINT'
                                    );

ft_pnr.SK_ACT_SAMPUNTYP := FNC_GET_SK_ACT_GENERICA ( BK_DIM_SAMPUNTYP,
                                      mdfch.SAMPUNITTYPE,
                                      mdfch.SAMPUNITTYPE ||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPUNITTYPE'
                                    );

ft_pnr.SK_ACT_ORIGREG := FNC_GET_SK_ACT_GENERICA ( BK_dim_REG,
                                      mdfch.ORIGREG,
                                      mdfch.ORIGREG||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ORIGREG'
                                    );

ft_pnr.SK_ACT_MOTIVONONIDONEO  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_NONIDON,
                                      mdfch.MOTIVONONIDONEO,
                                      mdfch.MOTIVONONIDONEO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'MOTIVONONIDONEO'
                                    );

ft_pnr.SK_ACT_MODALITALLEVAMENTO  :=  FNC_GET_SK_ACT_GENERICA ( BK_DIM_MODALLEV,
                                      mdfch.MODALITALLEVAMENTO,
                                      mdfch.MODALITALLEVAMENTO||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'MODALITALLEVAMENTO'
                                    );

ft_pnr.SK_ACT_SAMPMATTYPE :=  FNC_GET_SK_ACT_GENERICA ( BK_DIM_MTXTYP,
                                      mdfch.SAMPMATTYPE,
                                      mdfch.SAMPMATTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'SAMPMATTYPE'
                                    );

ft_pnr.SK_ACT_SAMPMATCODE  :=  FNC_GET_SK_ACT_GENERICA ( BK_DIM_MTX_VMPR_IT,
                                      mdfch.SAMPMATCODE_BUILDING,  --MDFCH.SAMPMATCODE
                                      mdfch.SAMPMATCODE_BUILDING||' - '||to_char(mdfch.samp_date,'yyyymmdd'),      --MDFCH.SAMPMATCODE
                                      'SAMPMATCODE'
                                    );

ft_pnr.SK_ACT_ORIGCOUNTRY := FNC_GET_SK_ACT_GENERICA ( BK_DIM_COUNTRY,
                                      mdfch.ORIGCOUNTRY,
                                      mdfch.ORIGCOUNTRY||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ORIGCOUNTRY'
                                    );

ft_pnr.SK_ACT_AETATE  :=  FNC_GET_SK_ACT_GENERICA ( BK_DIM_AETATE,
                                      mdfch.AETATE,
                                      mdfch.AETATE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'AETATE'
                                    );

ft_pnr.SK_ACT_LABANALISI := FNC_GET_SK_ACT_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABANALISI,
                                      mdfch.LABANALISI||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABANALISI'
                                    );

*/          -- 


/*ft_pnr.SK_ACT_LABID   := FNC_GET_SK_ACT_GENERICA ( BK_DIM_LABORATORI,
                                      mdfch.LABID,
                                      mdfch.LABID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABID'
                                    );  */
/*          -- 


ft_pnr.SK_ACT_PARAMTYPE  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PARAMTYP,
                                      mdfch.PARAMTYPE,
                                      mdfch.PARAMTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PARAMTYPE'
                                    );

ft_pnr.SK_ACT_PARAMCODE  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_PARAM_VMPR_IT,
                                      mdfch.PARAMCODE,
                                      mdfch.PARAMCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'PARAMCODE'
                                    );

ft_pnr.SK_ACT_ANMETHTYPE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_ANLYTYP,
                                      mdfch.ANMETHTYPE,
                                      mdfch.ANMETHTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMETHTYPE'
                                    );

ft_pnr.SK_ACT_ANMETHCODE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_ANLYMD,
                                      mdfch.ANMETHCODE,
                                      mdfch.ANMETHCODE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ANMETHCODE'
                                    );

ft_pnr.SK_ACT_ACCREDPROC  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_MDACC,
                                      mdfch.ACCREDPROC,
                                      mdfch.ACCREDPROC||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'ACCREDPROC'
                                    );

ft_pnr.SK_ACT_RESUNIT  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_UNIT,
                                      mdfch.RESUNIT,
                                      mdfch.RESUNIT||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESUNIT'
                                    );

ft_pnr.SK_ACT_EXPRRESTYPE  := FNC_GET_SK_ACT_GENERICA ( BK_DIM_EXPRRES,
                                      mdfch.EXPRRESTYPE,
                                      mdfch.EXPRRESTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EXPRRESTYPE'
                                    );

ft_pnr.SK_ACT_RESQUALVALUE:= FNC_GET_SK_ACT_GENERICA ( BK_DIM_POSNEG,
                                      mdfch.RESQUALVALUE,
                                      mdfch.RESQUALVALUE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESQUALVALUE'
                                    );

ft_pnr.SK_ACT_RESTYPE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_VALTYP,
                                      mdfch.RESTYPE,
                                      mdfch.RESTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'RESTYPE'
                                    );

ft_pnr.SK_ACT_EVALLIMITTYPE:= FNC_GET_SK_ACT_GENERICA ( BK_DIM_LMTTYP,
                                      mdfch.EVALLIMITTYPE,
                                      mdfch.EVALLIMITTYPE||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'EVALLIMITTYPE'
                                    );

ft_pnr.SK_ACT_EVALCODE := FNC_GET_SK_ACT_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALCODE,
                                      mdfch.EVALCODE ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALCODE'
                                    );

ft_pnr.SK_ACT_EVALINFO_SAMPTKASSES := FNC_GET_SK_ACT_GENERICA ( BK_DIM_RESEVAL,
                                      mdfch.EVALINFO_SAMPTKASSES,
                                      mdfch.EVALINFO_SAMPTKASSES ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALINFO_SAMPTKASSES'
                                    );

ft_pnr.SK_ACT_EVALINFO_CONCLUSION := FNC_GET_SK_ACT_GENERICA ( BK_DIM_CONCLUS,
                                      mdfch.EVALINFO_CONCLUSION,
                                      mdfch.EVALINFO_CONCLUSION ||' - '||to_char(mdfch.samp_date,'yyyymmdd') ,
                                      'EVALINFO_CONCLUSION'
                                    );

ft_pnr.VLD_FLG := mdfch.VLD_FLG;

ft_pnr.VALIDATO := mdfch.VALIDATO;

--ft_pnr.DUP_TEC := mdfch.DUP_TEC;

--ft_pnr.NUP_TEC := mdfch.NUP_TEC;

ft_pnr.ID_UPLOAD_STO := mdfch.ID_UPLOAD_STO;

ft_pnr.ID_REC_STO := mdfch.ID_REC_STO;

ft_pnr.DCR_TEC := adesso;

ft_pnr.PCR_TEC :=  'pkg_dwh_det_pnr.prc_ft_det_pnr';--mdfch.PCR_TEC;

ft_pnr.VALIDATO_SEMESTRALE := mdfch.VALIDATO_SEMESTRALE;


ft_pnr.SK_sampdate :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.samp_date,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.samp_date,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'samp_date'
                                    );

ft_pnr.SK_SAMPACCDATE :=  FNC_GET_SK_GENERICA ( BK_DIM_TEM,
                                      to_char(nvl(mdfch.SAMPACC_DATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      to_char(nvl(mdfch.SAMPACC_DATE,to_date('01011900','ddmmyyyy')),'yyyymmdd'),
                                      'SAMPACCDATE'
                                    );

      ft_pnr.SK_CODAZALLORIG := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.CODAZALLORIG,
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          mdfch.CODAZALLORIG||' - '||'Numero di Registrazione',
                          'CODAZALLORIG'
                         );
      ft_pnr.sk_ACT_CODAZALLORIG := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.CODAZALLORIG,
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          mdfch.CODAZALLORIG||' - '||'Numero di Registrazione',
                          'CODAZALLORIG'
                         );

--ricerca nell'anagrafica aziende x SAMPUNIT_SAMPHOLDINGID


      PRC_GET_SK_AZIENDA( mdfch.SAMPPOINT ,
                              mdfch.OSAID ,
                              --mdfch.SAMPUNIT_SLAUGHTERHOUSEID  ,
                              --mdfch.SAMPUNIT_SAMPPLANTID  ,
                              --rec_az_vld ,
                              mdfch.RAGSOC,
                              mdfch.VIA_PIAZ ,
                              mdfch.CITTA ,
                              mdfch.PROVINCIA,
                                  'DIM_AZIENDA'
                                  );

                                  */            -- 

/*
      --
      if mdfch.SAMPPOINT = 'MS.040.720' and mdfch.SAMPUNIT_SAMPHOLDINGID is not null
      then--acquacoltura
      --ricerca fra le aziende di acquacoltura
        begin
        select sk_azienda , sk_act_azienda, upper(RAGSOC),  upper(VIA_PIAZ), upper(CITTA), upper(PROVINCIA)
        into rec_azienda.sk_azienda , rec_azienda.sk_act_azienda, rec_azienda.RAGSOC,  rec_azienda.VIA_PIAZ, rec_azienda.CITTA, rec_azienda.PROVINCIA
        from dim_azienda
        where apn_n_registrazione = mdfch.SAMPUNIT_SAMPHOLDINGID
        and provenienza = 'acquacoltura'
        and  DAT_FIN_VLD_TEC is null;

            if rec_azienda.RAGSOC = upper(mdfch.RAGSOC)
            and rec_azienda.VIA_PIAZ = upper(mdfch.VIA_PIAZ)
            and rec_azienda.CITTA = upper(mdfch.CITTA)
            and rec_azienda.PROVINCIA = upper(mdfch.PROVINCIA) then

              ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := rec_azienda.sk_azienda;
              ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := rec_azienda.sk_act_azienda;

            else
            --update dell'ultimo in dimensione
                update dim_azienda
                set dat_fin_vld_tec = adesso
                where sk_azienda = rec_azienda.sk_azienda;
             --e inserimento del nuovo

                --select seq_dim_azienda.nextval into sk_ACT from dual;
                --select seq_dim_azienda.nextval into sk from dual;
                select stacco_sk(max(SK_AZIENDA), 1)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_fin_vld_tec)
                values (sk , rec_azienda.sk_act_azienda, 'acquacoltura', mdfch.SAMPUNIT_SAMPHOLDINGID, mdfch.RAGSOC,  mdfch.VIA_PIAZ, mdfch.CITTA, mdfch.PROVINCIA, adesso)
                ;
              ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := sk;
              ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := rec_azienda.sk_act_azienda;

            end if;
        exception
        when no_data_found then
        --inserire nuovo
                --select seq_dim_azienda.nextval into sk_ACT from dual;
                --select seq_dim_azienda.nextval into sk from dual;
                select stacco_sk(max(SK_AZIENDA), 1)  into sk_ACT from DIM_AZIENDA;
                select stacco_sk(max(SK_AZIENDA), 2)  into sk from DIM_AZIENDA;

                insert into dim_azienda
                (sk_azienda , sk_act_azienda, provenienza, apn_n_registrazione, RAGSOC,  VIA_PIAZ, CITTA, PROVINCIA, dat_fin_vld_tec)
                values (sk , sk_ACT, 'acquacoltura', mdfch.SAMPUNIT_SAMPHOLDINGID, mdfch.RAGSOC,  mdfch.VIA_PIAZ, mdfch.CITTA, mdfch.PROVINCIA, adesso)
                ;
              ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := sk;
              ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := sk_ACT;


        end;

      elsif mdfch.SAMPPOINT = 'MS.040.720' and mdfch.SAMPUNIT_SAMPHOLDINGID is null
      then
      desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_AZIENDA'||' - '||'SAMPUNIT_SAMPHOLDINGID is null',1,4000);
      raise errore;

      elsif mdfch.SAMPPOINT = 'MS.040.710' --allevamento
      then

      ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPHOLDINGID,
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||'Numero di Registrazione',
                          'SAMPUNIT_SAMPHOLDINGID'
                         );
      ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPHOLDINGID,
                          --mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          mdfch.SAMPUNIT_SAMPHOLDINGID||' - '||'Numero di Registrazione',
                          'SAMPUNIT_SAMPHOLDINGID'
                         );


      else--altro

        if nvl(length(mdfch.SAMPUNIT_SAMPHOLDINGID),0) > 6 then

        ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPHOLDINGID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            substr(mdfch.SAMPUNIT_SAMPHOLDINGID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );
        ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPHOLDINGID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            substr(mdfch.SAMPUNIT_SAMPHOLDINGID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );

        else

        ft_pnr.sk_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPHOLDINGID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SAMPHOLDINGID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );
        ft_pnr.sk_ACT_SAMPUNIT_SAMPHOLDINGID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA,mdfch.SAMPUNIT_SAMPHOLDINGID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SAMPHOLDINGID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPHOLDINGID'
                           );

        end if;
      end if;


--ricerca nell'anagrafica aziende x SAMPUNIT_SLAUGHTERHOUSEID
        if nvl(length(mdfch.SAMPUNIT_SLAUGHTERHOUSEID),0) > 6 then

        ft_pnr.sk_SAMPUNIT_SLAUGHTERHOUSEID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SLAUGHTERHOUSEID,1,6))
                            substr(mdfch.SAMPUNIT_SLAUGHTERHOUSEID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SLAUGHTERHOUSEID'
                           );
        ft_pnr.sk_ACT_SAMPUN_SLAUGHTERHOUSEID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SLAUGHTERHOUSEID,1,6))
                            substr(mdfch.SAMPUNIT_SLAUGHTERHOUSEID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                           'SAMPUNIT_SLAUGHTERHOUSEID'
                           );


        else

        ft_pnr.sk_SAMPUNIT_SLAUGHTERHOUSEID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SLAUGHTERHOUSEID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SLAUGHTERHOUSEID'
                           );
        ft_pnr.sk_ACT_SAMPUN_SLAUGHTERHOUSEID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SLAUGHTERHOUSEID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SLAUGHTERHOUSEID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SLAUGHTERHOUSEID'
                           );

        end if;


--ricerca nell'anagrafica aziende x SAMPUNIT_SAMPPLANTID

      --
      if mdfch.SAMPPOINT = 'MS.040.500' and mdfch.SAMPUNIT_SAMPPLANTID is not null
      then--smielatura
      rec_az_vld_in.APN_N_REGISTRAZIONE := mdfch.SAMPUNIT_SAMPPLANTID;
      rec_az_vld_in.RAGSOC := mdfch.RAGSOC;
      rec_az_vld_in.VIA_PIAZ := mdfch.VIA_PIAZ;
      rec_az_vld_in.CITTA := mdfch.CITTA;
      rec_az_vld_in.PROVINCIA := mdfch.PROVINCIA;

      sk_trovata:= FNC_GET_SK_AZIENDA_GENERICA ( 'smielatura',
                                      rec_az_vld_in,
                                      ft_pnr.sk_SAMPUNIT_SAMPPLANTID ,
                                      ft_pnr.sk_act_SAMPUNIT_SAMPPLANTID
                                    );



      elsif mdfch.SAMPPOINT = 'MS.040.720' and mdfch.SAMPUNIT_SAMPPLANTID is null
      then
      desc_errore := substr('ERRORE Caricamento della dimensione : '||'DIM_AZIENDA'||' - '||'SAMPUNIT_SAMPPLANTID is null',1,4000);
      raise errore;

      else--altro

        if nvl(length(mdfch.SAMPUNIT_SAMPPLANTID),0) > 6 then

        ft_pnr.sk_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            substr(mdfch.SAMPUNIT_SAMPPLANTID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPPLANTID'
                           );
        ft_pnr.sk_ACT_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPPLANTID,1,6))
                            substr(mdfch.SAMPUNIT_SAMPPLANTID,6)
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                           'SAMPUNIT_SAMPPLANTID'
                           );



        else

        ft_pnr.sk_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SAMPPLANTID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPPLANTID'
                           );
        ft_pnr.sk_ACT_SAMPUNIT_SAMPPLANTID := FNC_GET_SK_ACT_GENERICA ( BK_dim_AZIENDA, mdfch.SAMPUNIT_SAMPPLANTID,
                            --trim(substr(mdfch.SAMPUNIT_SAMPHOLDINGID,1,6))
                            mdfch.SAMPUNIT_SAMPPLANTID
                            --||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                            ||' - '||'Approval number',
                            'SAMPUNIT_SAMPPLANTID'
                           );

        end if;

      end if;


*/














--aggiornamento e ricerca della sk nella DIM_GRP_ACTION_REG
/*ft_pnr.SK_GRP_ACTION_REG := FNC_GET_SK_GENERICA ( BK_dim_GRP_ACTION_REG,
                          mdfch.CAMPO_CONC||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                          'GRP_ACTION_REG'
                         );*/

/*SELECT listagg (ACTION||' - '||COD_REG, ',') within group(order by COD_REG) CAMPO_CONC
FROM ACTTAKENCODE
WHERE ID_VLD = mdfch.tec_key_rec
GROUP BY ID_VLD
;*/
/*
begin
--ricerco campo_conc nella dimensione
--se la trovo tiro fuori la sk relativa
select SK_GRP_ACTION_REG into ft_pnr.SK_GRP_ACTION_REG from dim_GRP_ACTION_REG
where DES_GRP_ACTION_REG = mdfch.CAMPO_CONC;
--se non la trovo inserisco il nuovo valore di campo_conc in dimensione e tiro fuori la sk relativa
exception
when no_data_found then
select seq_dim_GRP_ACTION_REG.nextval into sk from dual;

insert into dim_GRP_ACTION_REG
(SK_GRP_ACTION_REG, DES_GRP_ACTION_REG, DUP_TEC, NUP_TEC, DCR_TEC, PCR_TEC)
values(sk, mdfch.CAMPO_CONC, null, 0, adesso, 'PKG_DWH_DET_PNR.prc_ft_det_pnr');
ft_pnr.SK_GRP_ACTION_REG := sk;


end;
*/


--ft_pnr.sk_GRP_ACTION_REG := FNC_GET_SK_GRP_ACTION_REG (  mdfch.CAMPO_CONC);




/*              -- 
ft_pnr.VLD_FLG := 'I';

--DG_ANMETHREFID, DG_SAMPEVENTID, DG_RESINFO_NOTSUMMED, DG_EVALINFO_COM, SK_LABCOUNTRY, SK_ACT_LABCOUNTRY
ft_pnr.DG_ANMETHREFID := mdfch.ANMETHREFID;
ft_pnr.DG_SAMPEVENTID := mdfch.SAMPEVENTID;
ft_pnr.DG_RESINFO_NOTSUMMED := mdfch.RESINFO_NOTSUMMED;
ft_pnr.SK_LABCOUNTRY := FNC_GET_SK_GENERICA ( BK_DIM_COUNTRY,
                                      mdfch.LABCOUNTRY,
                                      mdfch.LABCOUNTRY||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABCOUNTRY'
                                    );
ft_pnr.SK_ACT_LABCOUNTRY := FNC_GET_SK_ACT_GENERICA ( BK_DIM_COUNTRY,
                                      mdfch.LABCOUNTRY,
                                      mdfch.LABCOUNTRY||' - '||to_char(mdfch.samp_date,'yyyymmdd'),
                                      'LABCOUNTRY'
                                    );
        */          -- 

/*with appo as (
SELECT ID_VLD, listagg (ACTION||' - '||COD_REG, ',') within group(order by COD_REG) CAMPO_CONC
FROM ACTTAKENCODE
WHERE ID_VLD = mdfch.tec_key_rec
GROUP BY ID_VLD
)
select a.tec_key_rec, aa.CAMPO_CONC,
a.ACTION, a.ID_VLD, a.NUMERO_UNITA, a.UNITA_DI_MISURA, a.COD_REG from ACTTAKENCODE a, appo aa
where a.id_vld = aa.id_vld
  and  a.ID_VLD = mdfch.tec_key_rec
;*/

/*                  -- 

    update ft_det_vld
    set vld_flg = 'U',
        DUP_TEC = adesso,
        NUP_TEC = nvl(NUP_TEC,0) + 1
    --
    --
    where TEC_KEY_REC = mdfch.TEC_KEY_REC
      and vld_flg not in('U','D');






    update FT_ESTESO_ACTION
    set vld_flg = 'U',
        DUP_TEC = adesso,
        NUP_TEC = nvl(NUP_TEC,0) + 1
    --
    --
    where id_vld = mdfch.TEC_KEY_REC
      and vld_flg not in('U','D');


*/          -- 






    --insert into ft_det_vld
/*    ( TEC_KEY_REC, ID_TRATTAMENTO, ID_UPLOAD, Y_RIF, NOM_PERI, ID_MITTENTE, ANM, ID_REC, DAT_UPLOAD,
    DG_NUMVERBALE, SK_REGCODE, DG_FLTYPE, DG_OPTYPE, SK_TIPOCAMPO,
    --
    --
    --
    ----------,
    SK_GRP_ACTION_REG, SK_ACT_REGCODE, SK_ACT_TIPOCAMPO,
    --
    --
    --
    ----------,
    VLD_FLG, VALIDATO, DUP_TEC, NUP_TEC, ID_UPLOAD_STO, ID_REC_STO, DCR_TEC, PCR_TEC, VALIDATO_SEMESTRALE
    --DUP_TEC ,
    --NUP_TEC ,
    --DCR_TEC ,
    --PCR_TEC,

    --vld_flg
    )
    values
    ( ft_pnr.sk_regcode,
    ft_pnr.TEC_KEY_REC, ft_pnr.ID_TRATTAMENTO, ft_pnr.ID_UPLOAD, ft_pnr.Y_RIF, ft_pnr.NOM_PERI, ft_pnr.ID_MITTENTE, ft_pnr.ANM, ft_pnr.ID_REC, ft_pnr.DAT_UPLOAD,
    ft_pnr.NUMVERBALE, ft_pnr.SK_REGCODE, ft_pnr.FLTYPE, ft_pnr.OPTYPE, ft_pnr.SK_TIPOCAMPO,
    --
    --
    --
    ----------,
    ft_pnr.SK_GRP_ACTION_REG, ft_pnr.SK_ACT_REGCODE, ft_pnr.SK_ACT_TIPOCAMPO,
    --
    --
    --
    ----------,
    ft_pnr.VLD_FLG, ft_pnr.VALIDATO, null, null, ft_pnr.ID_UPLOAD_STO, ft_pnr.ID_REC_STO, adesso, 'PKG_DWH_DET_PNR.prc_ft_det_pnr', ft_pnr.VALIDATO_SEMESTRALE
    --null,
    --null,
    --'PKG_DWH_DET_PNR.prc_ft_det_pnr',
    --adesso,

    --'I' */

    /*              -- 
    (select
    ft_pnr.TEC_KEY_REC, ft_pnr.ID_TRATTAMENTO, ft_pnr.ID_UPLOAD, ft_pnr.Y_RIF, ft_pnr.NOM_PERI, ft_pnr.ID_MITTENTE, ft_pnr.ANM, ft_pnr.ID_REC, ft_pnr.DAT_UPLOAD,
    ft_pnr.DG_NUMVERBALE, ft_pnr.SK_REGCODE, ft_pnr.DG_OPTYPE, ft_pnr.SK_TIPOCAMPO,  --ft_pnr.DG_FLTYPE
    ft_pnr.SK_ASL_SAMPORG,
ft_pnr.SK_LEGREF,
ft_pnr.SK_SAMPSTR,
ft_pnr.SK_PROGTYP,
ft_pnr.SK_SAMPMD,
ft_pnr.SK_SAMPLR,
ft_pnr.SK_SMPNT_ITA,
ft_pnr.DG_PROGINFO_COM,
ft_pnr.SK_SAMPUNTYP,
--ft_pnr.SK_SAMPUNIT_SAMPHOLDINGID,
--ft_pnr.SK_SAMPUNIT_SLAUGHTERHOUSEID,
--ft_pnr.SK_SAMPUNIT_SAMPPLANTID,
ft_pnr.DG_SAMPUNIT_ANIMALID,
--ft_pnr.FLG_SAMPEVENTINFO_COM,
--ft_pnr.DG_SAMPEVENTINFO_MEDICSTATUS,
ft_pnr.SAMPID,
ft_pnr.SK_sampdate,
ft_pnr.SK_SAMPACCDATE,
ft_pnr.DG_SAMPINFO_ORIGSAMPID,
ft_pnr.SK_ORIGREG,
ft_pnr.SK_CODAZALLORIG,
ft_pnr.DG_CODFISSAMPHOLDING,
ft_pnr.DG_CODFISOWNER,
ft_pnr.FLG_SAMPIDONEO,
ft_pnr.SK_MOTIVONONIDONEO,
ft_pnr.DG_ALTROMOTIVONONIDONEO,
--ft_pnr.FLG_METODOPRODUZIONE,
ft_pnr.SK_MODALITALLEVAMENTO,
ft_pnr.SK_SAMPMATTYPE,
ft_pnr.SK_SAMPMATCODE,
ft_pnr.DG_SAMPMATTEXT,
ft_pnr.SK_ORIGCOUNTRY,
ft_pnr.SK_AETATE,
--ft_pnr.SK_ANALYSISDATE,
--ft_pnr.SK_SAMPAN_INFO_COMPDATE,
ft_pnr.DG_SAMPAN_INFO_COM,
ft_pnr.SK_LABANALISI,
--ft_pnr.SK_LABID,
ft_pnr.SK_PARAMTYPE,
ft_pnr.SK_PARAMCODE,
ft_pnr.DG_PARAMTEXT,
ft_pnr.SK_ANMETHTYPE,
ft_pnr.SK_ANMETHCODE,
ft_pnr.DG_ANMETHTEXT,
ft_pnr.SK_ACCREDPROC,
ft_pnr.SK_RESUNIT,
ft_pnr.M_RESLOD,
ft_pnr.M_RESLOQ,
ft_pnr.M_CCALPHA,
ft_pnr.M_CCBETA,
ft_pnr.M_RESVAL,
ft_pnr.M_EXPRRESPERC_FATPERC,
ft_pnr.M_EXPRRESPERC_MOISTPERC,
ft_pnr.M_EXPRRESPERC_ALCOHOLPERC,
ft_pnr.SK_EXPRRESTYPE,
ft_pnr.SK_RESQUALVALUE,
ft_pnr.SK_RESTYPE,
--ft_pnr.DG_RESINFO,
ft_pnr.SK_RAPPROVADATE,
ft_pnr.M_EVALLOWLIMIT,
ft_pnr.SK_EVALLIMITTYPE,
ft_pnr.SK_EVALCODE,
ft_pnr.SK_EVALINFO_SAMPTKASSES,
ft_pnr.SK_EVALINFO_CONCLUSION,
ft_pnr.SK_GRP_ACTION_REG,
ft_pnr.VLD_FLG,
ft_pnr.VALIDATO,
ft_pnr.ID_UPLOAD_STO,
ft_pnr.ID_REC_STO,
ft_pnr.DCR_TEC,
ft_pnr.PCR_TEC,
ft_pnr.VALIDATO_SEMESTRALE,
ft_pnr.DG_ANMETHREFID,
ft_pnr.DG_SAMPEVENTID,
ft_pnr.DG_RESINFO_NOTSUMMED,
ft_pnr.DG_EVALINFO_COM,
ft_pnr.SK_LABCOUNTRY,
ft_pnr.DUP_TEC,
ft_pnr.NUP_TEC,
ft_pnr.SK_ACT_REGCODE,
ft_pnr.SK_ACT_TIPOCAMPO,
ft_pnr.SK_ACT_ASL_SAMPORG,
ft_pnr.SK_ACT_LEGREF,
ft_pnr.SK_ACT_SAMPSTR,
ft_pnr.SK_ACT_PROGTYP,
ft_pnr.SK_ACT_SAMPMD,
ft_pnr.SK_ACT_SAMPLR,
ft_pnr.SK_ACT_SMPNT_ITA,
ft_pnr.SK_ACT_SAMPUNTYP,
--ft_pnr.SK_ACT_SAMPUN_SLAUGHTERHOUSEID,
--ft_pnr.SK_ACT_SAMPUNIT_SAMPPLANTID,
ft_pnr.SK_ACT_ORIGREG,
ft_pnr.SK_ACT_CODAZALLORIG,
ft_pnr.SK_ACT_MOTIVONONIDONEO,
ft_pnr.SK_ACT_MODALITALLEVAMENTO,
ft_pnr.SK_ACT_SAMPMATTYPE,
ft_pnr.SK_ACT_SAMPMATCODE,
ft_pnr.SK_ACT_AETATE,
ft_pnr.SK_ACT_LABANALISI,
--ft_pnr.SK_ACT_LABID,
ft_pnr.SK_ACT_PARAMTYPE,
ft_pnr.SK_ACT_PARAMCODE,
ft_pnr.SK_ACT_ANMETHTYPE,
ft_pnr.SK_ACT_ANMETHCODE,
ft_pnr.SK_ACT_ACCREDPROC,
ft_pnr.SK_ACT_RESUNIT,
ft_pnr.SK_ACT_EXPRRESTYPE,
ft_pnr.SK_ACT_RESQUALVALUE,
ft_pnr.SK_ACT_RESTYPE,
ft_pnr.SK_ACT_EVALLIMITTYPE,
ft_pnr.SK_ACT_EVALCODE,
ft_pnr.SK_ACT_EVALINFO_SAMPTKASSES,
ft_pnr.SK_ACT_EVALINFO_CONCLUSION,
ft_pnr.SK_ACT_LABCOUNTRY,
ft_pnr.SK_ACT_ORIGCOUNTRY,
ft_pnr.SK_OSAID,
ft_pnr.SK_ACT_OSAID
from dual
    );


  PRC_INS_TAB_LOG_ETL(
                  'LOG',
                  null,
                  'INIZIO fatto esteso x TEC_KEY_REC = '||mdfch.TEC_KEY_REC,
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );


    prc_ft_esteso_det_pnr (mdfch.TEC_KEY_REC, mdfch.samp_date, 'I',
                           mdfch.VALIDATO, mdfch.VALIDATO_SEMESTRALE);

    end loop;






    --controlli
    select (select count(1) num_r_vld from vld where vld_flg = '1') - (select count(1) num_r_ft from ft_det_vld where vld_flg = 'I') into differenza from dual;

    if (differenza) <> 0 then

    desc_errore := substr('ERRORE Caricamento del Fatto : '||'ft_det_vld'||' - '||'dovuto al controllo finale',1,4000);

    raise errore;
    end if;


    select (select count(1) num_r_vld from vld a, ACTTAKENCODE b
            where a.vld_flg = '1'
              and a.tec_key_rec = b.id_vld) -
           (select count(1) num_r_ft from ft_esteso_action where vld_flg = 'I') into differenza from dual;

    if (differenza) <> 0 then
    desc_errore := substr('ERRORE Caricamento del Fatto : '||'ft_esteso_action'||' - '||'dovuto al controllo finale',1,4000);
    raise errore;
    end if;


    commit;

    --refresh sn_vld_ante
    DBMS_SNAPSHOT.REFRESH(
                                                LIST                 => 'DWH_EDW_FSALM.sn_vld_ante'
                                               ,PUSH_DEFERRED_RPC    => TRUE
                                               ,REFRESH_AFTER_ERRORS => FALSE
                                               ,PURGE_OPTION         => 1
                                               ,PARALLELISM          => 0
                                               ,ATOMIC_REFRESH       => TRUE
                                               ,NESTED               => FALSE);


  PRC_INS_TAB_LOG_ETL(
                  'LOG',
                  null,
                  'FINE OK',
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );


--begin
  -- Initialization
  --<Statement>;

EXCEPTION
when errore then
rollback;
  PRC_INS_TAB_LOG_ETL(
                  'ERRORE',
                  null,
                  desc_errore||dbms_utility.format_error_backtrace,
                  null,
                  null--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );


WHEN OTHERS THEN
rollback;
        --cod_errore  := '101';
        --cod_errore_ora := sqlcode;
        --desc_errore_ora := substr(sqlerrm,1,4000);
        desc_errore := substr(sqlerrm||dbms_utility.format_error_backtrace,1,4000);
  PRC_INS_TAB_LOG_ETL(
                  'ERRORE',
                  null,
                  null,
                  sqlcode,
                  desc_errore--,
                  --P_OUT_ERR      OUT VARCHAR2,
                  --P_OUT_DESC_ERR OUT VARCHAR2
                  );

  end;
*/      -- 

end PKG_DWH_DET_FSALM;